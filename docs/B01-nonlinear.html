<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.629">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Introduction to Machine Learning for Economists (Under Construction) - 1&nbsp; Non-linear function estimation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./B02-bias-variance-tradeoff.html" rel="next">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<link href="style.css" rel="stylesheet" type="text/css">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-45VKT2HZSL"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'G-45VKT2HZSL');
</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Non-linear function estimation</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Introduction to Machine Learning for Economists (Under Construction)</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/tmieno2/ML-Economist" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="" title="Share" id="sidebar-tool-dropdown-0" class="sidebar-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-share"></i></a>
    <ul class="dropdown-menu" aria-labelledby="sidebar-tool-dropdown-0">
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
            <i class="bi bi-bi-twitter pe-1"></i>
          Twitter
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
            <i class="bi bi-bi-facebook pe-1"></i>
          Facebook
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
            <i class="bi bi-bi-linkedin pe-1"></i>
          LinkedIn
          </a>
        </li>
    </ul>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Welcome</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./H00-preface.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Basics</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B01-nonlinear.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Non-linear function estimation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B02-bias-variance-tradeoff.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Bias-variance Trade-off</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B03-cross-validation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Cross-validation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B04-regularization.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Regression Shrinkage Methods</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B05-bootstrap.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Bootstrap</span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Prediction ML</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P01-random-forest.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Random Forest</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P02-boosted-regression-forest.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Boosted Regression Forest</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P03-xgb.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Extreme Gradient Boosting</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P04-local-linear-forest.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Local Linear Forest</span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./C0P-causal-ml.html" class="sidebar-item-text sidebar-link">Causal Machine Learning (CML) Methods</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C00-why-not-this.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Why can’t we just do this?</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C01-dml.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Double Machine Learning</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C02-xstr-learner.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">S-, X-, T-, and R-learner</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C03-cf-orf.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Forest-based CATE Estimators</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C04-cf-extension.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Extensions of Causal Forest</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C05-causal-model-selection.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Causal Model Selection</span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./E0P-extensions.html" class="sidebar-item-text sidebar-link">Extensions</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./E01-spatial-cv.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Spatial Cross-validation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./E02-grf.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Generalized Random Forest</span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">Programming Guide: R</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PROG-R-01-mlr3.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Machine Learning with <code>mlr3</code> in R</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PROG-R-02-reticulate.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Running Python from R</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PROG-R-03-model-selection-prediction.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Model Selection (Prediction)</span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">Programming Guide: Python</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PROG-P-01-scikitlearn.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Prediction using <code>scikitlearn</code></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PROG-P-02-CATE-econml.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">CATE estimation using <code>econml</code></span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">Appendices</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A01-mc-simulation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Monte Carlo (MC) Simulation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A02-method-of-moment.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Primer on method of moment</span></a>
  </div>
</li>
    </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-functional-form" id="toc-sec-functional-form" class="nav-link active" data-scroll-target="#sec-functional-form"> <span class="header-section-number">1.1</span> Flexible functional form estimation</a></li>
  <li><a href="#sec-smoothing-splines" id="toc-sec-smoothing-splines" class="nav-link" data-scroll-target="#sec-smoothing-splines"> <span class="header-section-number">1.2</span> Smoothing Splines (semi-parametric)</a></li>
  <li><a href="#sec-local" id="toc-sec-local" class="nav-link" data-scroll-target="#sec-local"> <span class="header-section-number">1.3</span> Local Regression</a>
  <ul class="collapse">
  <li><a href="#sec-local-reg" id="toc-sec-local-reg" class="nav-link" data-scroll-target="#sec-local-reg"> <span class="header-section-number">1.3.1</span> Local linear regression</a></li>
  <li><a href="#k-nearest-neighbor" id="toc-k-nearest-neighbor" class="nav-link" data-scroll-target="#k-nearest-neighbor"> <span class="header-section-number">1.3.2</span> K-nearest neighbor</a></li>
  </ul></li>
  <li><a href="#efficiency-parametric-vs-non-parametric-methods" id="toc-efficiency-parametric-vs-non-parametric-methods" class="nav-link" data-scroll-target="#efficiency-parametric-vs-non-parametric-methods"> <span class="header-section-number">1.4</span> Efficiency: Parametric vs Non-parametric Methods</a>
  <ul class="collapse">
  <li><a href="#monte-carlo-simulation-parametric-vs-non-parametric" id="toc-monte-carlo-simulation-parametric-vs-non-parametric" class="nav-link" data-scroll-target="#monte-carlo-simulation-parametric-vs-non-parametric"> <span class="header-section-number">1.4.1</span> Monte Carlo Simulation (parametric vs non-parametric)</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/tmieno2/ML-Economist/edit/master/B01-nonlinear.qmd" class="toc-action">Edit this page</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-nonlinear" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Non-linear function estimation</span></span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<p>The purpose of this section is to introduce you to the idea of semi-parametric and non-parametric regression methods. The world of semi-parametric and non-parametric regression is vast. But, we only scratch the surface by just looking at smoothing splines and local regression methods in this chapter. Learning these methods also provide us with excellent opportunities to learn the phenomenon called over-fitting and also the importance of hyper-parameters. Understanding local regression in particular is essential in understanding generalized random forest covered in <a href="E02-grf.html"><span>Chapter&nbsp;17</span></a>.</p>
<div class="callout-note callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
What you will learn
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Limitations of linear-in-parameter parametric model in representing non-linear functions</li>
<li>Regression splines</li>
<li>Local regression
<ul>
<li>Local constant regression</li>
<li>Local linear regression</li>
</ul></li>
<li>Over-fitting and hyper-parameters</li>
</ul>
</div>
</div>
<section id="sec-functional-form" class="level2 page-columns page-full" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="sec-functional-form"><span class="header-section-number">1.1</span> Flexible functional form estimation</h2>

<div class="no-row-height column-margin column-container"><div class="">
<p><strong>Packages to load for replications</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div></div><p>There is a clear limit to liner (in parameter) parametric models in flexibility to represent quantitative relationships between variables. For example, consider crop yield response to fertilizer. Typically, yield increases at the diminishing rate as fertilizer rate increases. However, at a high enough fertilizer rate, yield stops increasing (fertilizer is not a limiting factor at that point). This relationship is illustrated in the figure below.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">83944</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">#=== generate data ===#</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">400</span> <span class="co"># number of observations</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">250</span>, <span class="at">length =</span> N) </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>y_det <span class="ot">&lt;-</span> <span class="dv">240</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fl">0.4</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span> <span class="fl">0.03</span> <span class="sc">*</span> x))</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> <span class="dv">25</span> <span class="sc">*</span> <span class="fu">rnorm</span>(N) <span class="co"># error</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">x =</span> x, <span class="at">y =</span> y_det <span class="sc">+</span> e, <span class="at">y_det =</span> y_det)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">#=== plot ===#</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>g_base <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(data) <span class="sc">+</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_det, <span class="at">x =</span> x)) <span class="sc">+</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="B01-nonlinear_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>Let’s try to fit this data using linear parametric models with <span class="math inline">\(sqrt(x)\)</span>, <span class="math inline">\(log(x)\)</span>, and <span class="math inline">\(x + x^2\)</span>, where the dependent variable is <code>y_det</code>, which is <span class="math inline">\(E[y|x]\)</span> (no error added).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== sqrt ===#</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>lm_sq <span class="ot">&lt;-</span> <span class="fu">lm</span>(y_det <span class="sc">~</span> <span class="fu">sqrt</span>(x), <span class="at">data =</span> data)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>data[, y_hat_sqrt <span class="sc">:</span><span class="er">=</span> lm_sq<span class="sc">$</span>fit]</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">#=== log ===#</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>lm_log <span class="ot">&lt;-</span> <span class="fu">lm</span>(y_det <span class="sc">~</span> <span class="fu">log</span>(x), <span class="at">data =</span> data)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>data[, y_hat_log <span class="sc">:</span><span class="er">=</span> lm_log<span class="sc">$</span>fit]</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">#=== quadratic ===#</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>lm_quad <span class="ot">&lt;-</span> <span class="fu">lm</span>(y_det <span class="sc">~</span> x <span class="sc">+</span> x<span class="sc">^</span><span class="dv">2</span>, <span class="at">data =</span> data)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>data[, y_hat_quad <span class="sc">:</span><span class="er">=</span> lm_quad<span class="sc">$</span>fit]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">melt</span>(data, <span class="at">id.var =</span> <span class="st">"x"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  .[variable <span class="sc">!=</span> <span class="st">"y"</span>, ] <span class="sc">%&gt;%</span> </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  .[, fit_case <span class="sc">:</span><span class="er">=</span> <span class="fu">fcase</span>(</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    variable <span class="sc">==</span> <span class="st">"y_det"</span>, <span class="st">"True response"</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    variable <span class="sc">==</span> <span class="st">"y_hat_sqrt"</span>, <span class="st">"sqrt"</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    variable <span class="sc">==</span> <span class="st">"y_hat_log"</span>, <span class="st">"log"</span>,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    variable <span class="sc">==</span> <span class="st">"y_hat_quad"</span>, <span class="st">"quadratic"</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  )]</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_data) <span class="sc">+</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> value, <span class="at">x =</span> x, <span class="at">color =</span> fit_case)) <span class="sc">+</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_discrete</span>(<span class="at">name =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="B01-nonlinear_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>None of the specifications do quite well. Indeed, you cannot represent the relationship well using well-known popular functional forms. Let’s now look at methods that are flexible enough to capture the relationship. First, smoothing splines, and then K-nearest neighbor next.</p>
</section>
<section id="sec-smoothing-splines" class="level2 page-columns page-full" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="sec-smoothing-splines"><span class="header-section-number">1.2</span> Smoothing Splines (semi-parametric)</h2>
<p>Detailed discussion of smoothing splines is out of the scope of this book. Only its basic ideas will be presented in this chapter. See <span class="citation" data-cites="wood2006generalized">Wood (<a href="#ref-wood2006generalized" role="doc-biblioref">2006</a>)</span> for a fuller treatment of this topic.</p>
<p>Consider a simple quantitative relationship of two variables <span class="math inline">\(y\)</span> and <span class="math inline">\(x\)</span>: <span class="math inline">\(y = f(x)\)</span>.</p>
<p><span class="math display">\[
\begin{aligned}
y = f(x)
\end{aligned}
\]</span></p>
<p>It is possible to characterize this function by using many functions in additive manner: <span class="math inline">\(b_1(x), \dots, b_K(x)\)</span>.</p>
<p><span class="math display">\[
\begin{aligned}
y = \sum_{k=1}^K \beta_k b_k(x)
\end{aligned}
\]</span></p>
<p>where <span class="math inline">\(\beta_k\)</span> is the coefficient on <span class="math inline">\(b_k(x)\)</span>.</p>
<p>Here are what <span class="math inline">\(b_1(x), \dots, b_K(x)\)</span> may look like (1 intercept and 9 cubic spline functions).</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>basis_data <span class="ot">&lt;-</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gam</span>(y_det <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">10</span>, <span class="at">bs =</span> <span class="st">"cr"</span>), <span class="at">data =</span> data) <span class="sc">%&gt;%</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(., <span class="at">type =</span> <span class="st">"lpmatrix"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  .[, x <span class="sc">:</span><span class="er">=</span> data[, x]] <span class="sc">%&gt;%</span> </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">melt</span>(<span class="at">id.var =</span> <span class="st">"x"</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> basis_data) <span class="sc">+</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> value, <span class="at">x =</span> x)) <span class="sc">+</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(variable <span class="sc">~</span> .) <span class="sc">+</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="B01-nonlinear_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>By assigning different values to <span class="math inline">\(b_1(x), \dots, b_K(x)\)</span>, their summation can represent different functional relationships.</p>
<p>Here is what <span class="math inline">\(\sum_{k=1}^K \beta_k b_k(x)\)</span> looks like when <span class="math inline">\(\beta_1\)</span> through <span class="math inline">\(\beta_{10}\)</span> are all <span class="math inline">\(200\)</span>.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p><span class="math display">\[
y = \sum_{k=1}^{10} 200 b_k(x)
\]</span></p>
</div></div><div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.table</span>(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable =</span> <span class="fu">unique</span>(basis_data<span class="sc">$</span>variable),</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef =</span> <span class="fu">rep</span>(<span class="dv">200</span>, <span class="dv">10</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>.[basis_data, on <span class="ot">=</span> <span class="st">"variable"</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>.[, <span class="fu">sum</span>(coef <span class="sc">*</span> value), by <span class="ot">=</span> x] <span class="sc">%&gt;%</span> </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> .) <span class="sc">+</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> V1, <span class="at">x =</span> x)) <span class="sc">+</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="B01-nonlinear_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>Here is what <span class="math inline">\(\sum_{k=1}^K \beta_k b_k(x)\)</span> looks like when <span class="math inline">\(\beta_1\)</span> through <span class="math inline">\(\beta_4\)</span> are all <span class="math inline">\(50\)</span> and <span class="math inline">\(\beta_5\)</span> through <span class="math inline">\(\beta_9\)</span> are all <span class="math inline">\(200\)</span>.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p><span class="math display">\[
y = \sum_{k=1}^5 50 b_k(x) + \sum_{k=6}^{10} 200 b_k(x)
\]</span></p>
</div></div><div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.table</span>(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable =</span> <span class="fu">unique</span>(basis_data<span class="sc">$</span>variable),</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">50</span>, <span class="dv">5</span>), <span class="fu">rep</span>(<span class="dv">200</span>, <span class="dv">5</span>))</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>.[basis_data, on <span class="ot">=</span> <span class="st">"variable"</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>.[, <span class="fu">sum</span>(coef <span class="sc">*</span> value), by <span class="ot">=</span> x] <span class="sc">%&gt;%</span> </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> .) <span class="sc">+</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> V1, <span class="at">x =</span> x)) <span class="sc">+</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="B01-nonlinear_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>In practice, we fit the model to a dataset to find coefficient estimates that fit the data well. Here, we use the <code>gam()</code> function from the <code>mgcv</code> package. Note that, we use <span class="math inline">\(E[y|x]\)</span> (<code>y_det</code>) as the dependent variable to demonstrate the ability of smoothing splines to imitate the true function.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p><code>gam</code> stands for <span style="color:red"> G</span>eneralized <span style="color:red">A</span>dditive <span style="color:red">M</span>odel. It is a much wider class of model than our examples in this section. See <span class="citation" data-cites="wood2006generalized">Wood (<a href="#ref-wood2006generalized" role="doc-biblioref">2006</a>)</span> for more details.</p>
</div></div><div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>gam_fit <span class="ot">&lt;-</span> <span class="fu">gam</span>(y_det <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">10</span>, <span class="at">bs =</span> <span class="st">"cr"</span>), <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>s(x, k = 10, bs = "cr")</code> in the regression formula tells <code>gam()</code> to use 10 knots, which results in an intercept and nine spline basis functions. <code>bs = "cr"</code> tells <code>gam()</code> to use cubic spline basis functions.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>There are many other spline basis options offered by the <code>mgcv</code> package. Interested readers are referred to <span class="citation" data-cites="wood2006generalized">Wood (<a href="#ref-wood2006generalized" role="doc-biblioref">2006</a>)</span>.</p>
</div></div><p>Here are the coefficient estimates:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>gam_fit<span class="sc">$</span>coefficient</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)      s(x).1      s(x).2      s(x).3      s(x).4      s(x).5 
 227.449797   -1.487811   16.749494   28.308769   32.116284   34.173014 
     s(x).6      s(x).7      s(x).8      s(x).9 
  35.179359   34.540353   38.592136   21.874699 </code></pre>
</div>
</div>
<p>This translate into the following fitted curve.</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.table</span>(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable =</span> <span class="fu">unique</span>(basis_data<span class="sc">$</span>variable)[<span class="sc">-</span><span class="dv">1</span>],</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef =</span> gam_fit<span class="sc">$</span>coefficient[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>.[basis_data, on <span class="ot">=</span> <span class="st">"variable"</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>.[, .(<span class="at">y_no_int =</span> <span class="fu">sum</span>(coef <span class="sc">*</span> value)), by <span class="ot">=</span> x] <span class="sc">%&gt;%</span> </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>.[, y_hat <span class="sc">:</span><span class="er">=</span> gam_fit<span class="sc">$</span>coefficient[<span class="dv">1</span>] <span class="sc">+</span> y_no_int] <span class="sc">%&gt;%</span> </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> .) <span class="sc">+</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_hat, <span class="at">x =</span> x, <span class="at">color =</span> <span class="st">"gam-fitted"</span>)) <span class="sc">+</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> data, <span class="fu">aes</span>(<span class="at">y =</span> y_det, <span class="at">x =</span> x, <span class="at">color =</span> <span class="st">"True"</span>)) <span class="sc">+</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">""</span>,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"gam-fitted"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"True"</span> <span class="ot">=</span> <span class="st">"blue"</span>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"y"</span>) <span class="sc">+</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"x"</span>) <span class="sc">+</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="B01-nonlinear_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>As you can see, the trained model is almost perfect in representing the functional relationship of <span class="math inline">\(y\)</span> and <span class="math inline">\(x\)</span>.</p>
<p>Now, when <code>gam()</code> fits a model to a dataset, it penalizes the wiggliness (how wavy the curve is) of the estimated function to safe-guard against fitting the model too well to the data. Specifically, it finds coefficients that minimizes the sum of the squared residuals (for regression) plus an additional term that captures how wavy the resulting function is.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>Here is an example of wiggly (first) v.s. smooth (second) functions.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>gam_fit_wiggly <span class="ot">&lt;-</span> <span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">40</span>, <span class="at">bs =</span> <span class="st">"cr"</span>, <span class="at">sp =</span> <span class="dv">0</span>), <span class="at">data =</span> data)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(gam_fit_wiggly, <span class="at">se =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="B01-nonlinear_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>gam_fit_smooth <span class="ot">&lt;-</span> <span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">5</span>, <span class="at">bs =</span> <span class="st">"cr"</span>), <span class="at">data =</span> data)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(gam_fit_smooth, <span class="at">se =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="B01-nonlinear_files/figure-html/unnamed-chunk-12-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</div></div><p><span class="math display">\[
\begin{aligned}
Min_{\hat{f}(x)} \sum_{i=1}^N(y_i - \hat{f}(x_i))^2 + \lambda \Omega(\hat{f}(x))
\end{aligned}
\]</span></p>
<p>where <span class="math inline">\(\Omega(\hat{f}(x)) &gt; 0\)</span> is a function that captures how wavy the resulting function is. It takes a higher value when <span class="math inline">\(\hat{f}(x)\)</span> is more wiggly. <span class="math inline">\(\lambda &gt; 0\)</span> is the penalization parameter. As <span class="math inline">\(\lambda\)</span> gets larger, a greater penalty on the wiggliness of <span class="math inline">\(\hat{f}(x)\)</span>, thus resulting in a smoother curve.</p>
<p>You can specify <span class="math inline">\(\lambda\)</span> by <code>sp</code> parameter in <code>gam()</code>. When <code>sp</code> is not specified by the user, <code>gam()</code> finds the optimal value of <code>sp</code> internally using cross-validation (cross-validation will be introduce formally in <a href="B03-cross-validation.html"><span>Chapter&nbsp;3</span></a>). For now, just consider it as a method to find parameters that make the trained model a good representation of the underlying conditional mean function (<span class="math inline">\(E[y|x]\)</span>).</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>More specifically, it uses generalized cross-validation (GCV). A special type of cross-validation that can be done when the model is linear in parameter.</p>
</div></div><p>If you do not pick the value of <code>sp</code> well, the estimated curve will be very wiggly. Let’s see an example by setting the value of <code>sp</code> to 0, meaning no punishment for being very wiggly. We also set the number of splines to <span class="math inline">\(39\)</span> so that <span class="math inline">\(\sum_{k=1}^K \beta_k b_k(x)\)</span> is <span style="color:red"> very </span>flexible.</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== fit ===#</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>gam_fit_wiggly <span class="ot">&lt;-</span> <span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">40</span>, <span class="at">bs =</span> <span class="st">"cr"</span>, <span class="at">sp =</span> <span class="dv">0</span>), <span class="at">data =</span> data)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== assign the fitted values to a variable ===#</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>data[, y_hat <span class="sc">:</span><span class="er">=</span> gam_fit_wiggly<span class="sc">$</span>fitted.values]</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">#=== plot ===#</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> data) <span class="sc">+</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_hat, <span class="at">x =</span> x), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">x =</span> x), <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="B01-nonlinear_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>We call this phenomenon over-fitting (of the data by the model). An over-fitted model does well in predicting <span class="math inline">\(y\)</span> when applied to the data the model used to train itself. However, it would do a terrible job in prediction on the data it has never seen clearly because it is not predicting <span class="math inline">\(E[y|x]\)</span> well.</p>
<div class="callout-important callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><span style="color:red"> Hyper-parameter</span>: parameters that one has freedom to specify before fitting the model and affect the fitting process in ways that change the outcome of the fitting.</li>
<li><span style="color:red"> Parameter tuning</span>: process that attempts to find the optimal set of hyper-parameter values.</li>
</ul>
</div>
</div>
<p>In <code>mgcv::gam()</code>, the hyper-parameters are the penalty parameter <span class="math inline">\(\lambda\)</span> (specified by. <code>sp</code>), the number of knots (specified by <code>k</code>)<span class="math inline">\(^1\)</span>, the type of splines (specified by <code>bs</code>). Coefficient estimates (<span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\beta_1, \dots, \beta_K\)</span>) change when the value of <code>sp</code> is altered. Here is what happens when <code>k</code> <span class="math inline">\(= 3\)</span> (less flexible than the <code>k</code> <span class="math inline">\(= 39\)</span> case above).</p>

<div class="no-row-height column-margin column-container"><div class="">
<p><span class="math inline">\(^1\)</span> or more precisely, how many knots and where to place them</p>
</div></div><div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== fit ===#</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>gam_fit_wiggly <span class="ot">&lt;-</span> <span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">3</span>, <span class="at">bs =</span> <span class="st">"cr"</span>, <span class="at">sp =</span> <span class="dv">0</span>), <span class="at">data =</span> data)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== assign the fitted values to a variable ===#</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>data[, y_hat <span class="sc">:</span><span class="er">=</span> gam_fit_wiggly<span class="sc">$</span>fitted.values]</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">#=== plot ===#</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> data) <span class="sc">+</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_hat, <span class="at">x =</span> x), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">x =</span> x), <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="B01-nonlinear_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>Hyper-parameters can significantly influence the outcome. Since the user gets to pick any numbers, it can potentially be used to twist the results in a way that favors the outcomes they want to have. Therefore, it is important to pick the values of hyper-parameters wisely. One way of achieving the goal is cross-validation, which is a data-driven way of finding the best value of hyper-parameters. We will discuss cross-validation in <span class="quarto-unresolved-ref">?sec-cv</span> in detail.</p>
<p>Here is the fitted curve when the optimal value of <code>sp</code> is picked by <code>gam()</code> automatically given <code>k = 40</code> and <code>bs = "cr"</code> using cross-validation.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>That is, we are not tuning <code>k</code> and <code>bs</code> here. <code>gam()</code> uses generalized cross-validation, which we do not cover in this book.</p>
</div></div><div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== fit ===#</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>gam_fit_cv <span class="ot">&lt;-</span> <span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">40</span>, <span class="at">bs =</span> <span class="st">"cr"</span>), <span class="at">data =</span> data)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== assign the fitted values to a variable ===#</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>data[, y_hat <span class="sc">:</span><span class="er">=</span> gam_fit_cv<span class="sc">$</span>fitted.values]</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">#=== plot ===#</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> data) <span class="sc">+</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_hat, <span class="at">x =</span> x), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">x =</span> x), <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="B01-nonlinear_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>You can see that the tuning of <code>sp</code> is successful and has resulted in a much better fitted curve compared to the case where <code>sp</code> was forced to be 0. As you will see, hyper-parameter tuning will be critical for many of the machine learning methods we will look at later.</p>
</section>
<section id="sec-local" class="level2 page-columns page-full" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="sec-local"><span class="header-section-number">1.3</span> Local Regression</h2>
<p>Local regression is a non-parametric method that predicts <span class="math inline">\(y\)</span> at the target value of <span class="math inline">\(X\)</span> (say <span class="math inline">\(x_0\)</span>) using the observations that are “close” to it (called neighbors). One of such methods is Nadaraya-Watson (NW) estimator.</p>
<p>Prediction of <span class="math inline">\(y\)</span> at a particular value of <span class="math inline">\(X\)</span> by the NW estimator takes the following steps:</p>
<ol type="1">
<li>Find the weights for all the observations based on the choice of Kernel function (<span class="math inline">\(K(\cdot)\)</span>) and bandwidth value (<span class="math inline">\(h\)</span>)</li>
<li>Calculate the weighted mean of <span class="math inline">\(y\)</span></li>
</ol>
<p>Mathematically, it can be written as follows:</p>
<p><span class="math display">\[
\begin{aligned}
\hat{f}(X = x_0) &amp; = \sum_{i=1}^N W_i(x_0)\cdot Y_i \\
\mbox{where, } W_i(x_0) &amp; = \frac{K(\frac{x_0 - X_i}{h})}{\sum_{i=1}^n K(\frac{x_0 - X_i}{h})}
\end{aligned}
\]</span></p>
<ul>
<li><span class="math inline">\(K()\)</span>: Kernel function</li>
<li><span class="math inline">\(h\)</span>: bandwidth</li>
</ul>
<p>Note that <span class="math inline">\(\sum_{i=1}^N W_i = 1\)</span>, and <span class="math inline">\(W_i(x_0)\)</span> is considered a weight for observation <span class="math inline">\(i\)</span>. So, this estimator simply calculates the weighted average of observed values of the dependent variable.</p>
<p>Now, let’s have a closer look at the weight. There are many types of Kernel functions. Some of them include</p>
<ul>
<li>Uniform: <span class="math inline">\(K(u) = 1/2\cdot I{|u| &lt; 1}\)</span></li>
<li>Epanechnikov: <span class="math inline">\(K(u) = \frac{3}{4}(1-u^2)\cdot I{|u| &lt; 1}\)</span></li>
<li>Gaussian: <span class="math inline">\(K(u) = \frac{1}{\sqrt{2\pi}}\cdot e^{-\frac{1}{2}u^2}\)</span> (density function of standard normal distribution)</li>
</ul>

<div class="no-row-height column-margin column-container"><div class="">
<p><span class="math inline">\(I\{\cdot\}\)</span> is an indicator function that takes 1 if the statement inside the curly brackets is true, and 0 otherwise.</p>
</div></div><p><a href="#fig-kernel">Figure&nbsp;<span>1.1</span></a> presents graphical representations of these functions.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>u_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">3</span>, <span class="at">length =</span> <span class="dv">1000</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>uni_data <span class="ot">&lt;-</span> </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">u =</span> u_seq,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">d =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  .[, type <span class="sc">:</span><span class="er">=</span> <span class="st">"Uniform"</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  .[<span class="fu">abs</span>(u) <span class="sc">&gt;</span> <span class="dv">1</span>, d <span class="sc">:</span><span class="er">=</span> <span class="dv">0</span>]</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>epanechnikov_data <span class="ot">&lt;-</span> </span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">u =</span> u_seq</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  .[, d <span class="sc">:</span><span class="er">=</span> <span class="dv">3</span> <span class="sc">/</span> <span class="dv">4</span> <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>u<span class="sc">^</span><span class="dv">2</span>)] <span class="sc">%&gt;%</span> </span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  .[, type <span class="sc">:</span><span class="er">=</span> <span class="st">"Epanechnikov"</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  .[<span class="fu">abs</span>(u) <span class="sc">&gt;</span> <span class="dv">1</span>, d <span class="sc">:</span><span class="er">=</span> <span class="dv">0</span>]</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>gaussian_data <span class="ot">&lt;-</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">u =</span> u_seq</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>  .[, d <span class="sc">:</span><span class="er">=</span> <span class="fu">dnorm</span>(u)] <span class="sc">%&gt;%</span> </span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>  .[, type<span class="sc">:</span><span class="er">=</span> <span class="st">"Gaussian"</span>]</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>all_data <span class="ot">&lt;-</span> </span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbind</span>(uni_data, epanechnikov_data, gaussian_data) <span class="sc">%&gt;%</span> </span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>  .[, type <span class="sc">:</span><span class="er">=</span> <span class="fu">factor</span>(type, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Uniform"</span>, <span class="st">"Epanechnikov"</span>, <span class="st">"Gaussian"</span>))]</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(all_data) <span class="sc">+</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> d, <span class="at">x =</span> u), <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(type <span class="sc">~</span> .) <span class="sc">+</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-kernel" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="B01-nonlinear_files/figure-html/fig-kernel-1.png" class="img-fluid figure-img" width="576"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Figure 1.1: Kernel function examples</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Clearly, the choice of Kernel function affects the weights given to each observation. Bandwidth (<span class="math inline">\(h\)</span>) determines how “local” the estimator is. The lower the value of <span class="math inline">\(h\)</span> is, the more “local” the estimator is. Let’s see this using the uniform Kernel with bandwidth values of <span class="math inline">\(2\)</span> and <span class="math inline">\(5\)</span>. We use the same data generated in <a href="#sec-smoothing-splines"><span>Section&nbsp;1.2</span></a>. Suppose we are interested in estimating <code>y</code> at <code>x = 100</code>.</p>
<p><a href="#fig-weights">Figure&nbsp;<span>1.2</span></a> presents the the data points on the first row for <span class="math inline">\(h = 2\)</span> (left) and <span class="math inline">\(h=5\)</span> (right) and corresponding weights on the second row <span class="math inline">\(h = 2\)</span> (left) and <span class="math inline">\(h=5\)</span> (right).</p>
<p>As you can see, when <span class="math inline">\(h\)</span> is higher, more data points will involve in estimating <span class="math inline">\(y\)</span>: 5 observations when <span class="math inline">\(h=2\)</span> and 12 observations when <span class="math inline">\(h=5\)</span>.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-weights" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="B01-nonlinear_files/figure-html/fig-weights-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Figure 1.2: Weights under h = 2 and h = 5.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Let’s write a code to predict <code>y</code> at several different values of <code>x</code> using <code>data</code> for illustration. We will use the Epanechnikov Kernel function with bandwidth value of <span class="math inline">\(20\)</span>. First, we work on prediction at <code>x = 120</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>x0 <span class="ot">&lt;-</span> <span class="dv">120</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>lr_data <span class="ot">&lt;-</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">copy</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== calculate u ===#</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  .[, u <span class="sc">:</span><span class="er">=</span> (x <span class="sc">-</span> x0)<span class="sc">/</span>h] <span class="sc">%&gt;%</span> </span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== K(u) ===#</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  .[, k_of_u <span class="sc">:</span><span class="er">=</span> <span class="dv">3</span> <span class="sc">/</span> <span class="dv">4</span> <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>u<span class="sc">^</span><span class="dv">2</span>)] <span class="sc">%&gt;%</span> </span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== turn k_of_u to 0 if abs(u) &gt; 1  ===#</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  .[<span class="fu">abs</span>(u) <span class="sc">&gt;=</span> <span class="dv">1</span>, k_of_u <span class="sc">:</span><span class="er">=</span> <span class="dv">0</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== find the weight ===#</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  .[, weight <span class="sc">:</span><span class="er">=</span> k_of_u <span class="sc">/</span> <span class="fu">sum</span>(k_of_u)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here are some of the data points that have non-zero weights:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>lr_data[weight <span class="sc">!=</span> <span class="dv">0</span>, .(x, y, k_of_u, weight)] <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          x        y     k_of_u       weight
1: 100.2256 243.1649 0.01682189 0.0005248584
2: 100.8496 219.0103 0.06236832 0.0019459481
3: 101.4737 250.9886 0.10645429 0.0033214707
4: 102.0977 214.2540 0.14907983 0.0046514262
5: 102.7218 221.5801 0.19024493 0.0059358145
6: 103.3459 262.3424 0.22994958 0.0071746358</code></pre>
</div>
</div>
<p>We can then simply calculate the weighted mean.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>y_hat_x120 <span class="ot">&lt;-</span> lr_data[, <span class="fu">sum</span>(weight <span class="sc">*</span> y)]</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 233.8969</code></pre>
</div>
</div>
<p>We can do this for many values of <span class="math inline">\(X\)</span> and and connects the dots to find the “fitted curve.” First, let’s define a function that predicts <code>y</code> at a particular value of <code>x</code> using the Epanechnikov Kernel function for a given value of <span class="math inline">\(h\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>est_y_nw <span class="ot">&lt;-</span> <span class="cf">function</span>(x0, data, h)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  y_hat <span class="ot">&lt;-</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">copy</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">#=== calculate u ===#</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    .[, u <span class="sc">:</span><span class="er">=</span> (x <span class="sc">-</span> x0)<span class="sc">/</span>h] <span class="sc">%&gt;%</span> </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">#=== K(u) ===#</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    .[, k_of_u <span class="sc">:</span><span class="er">=</span> <span class="dv">3</span> <span class="sc">/</span> <span class="dv">4</span> <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>u<span class="sc">^</span><span class="dv">2</span>)] <span class="sc">%&gt;%</span> </span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">#=== turn k_of_u to 0 if abs(u) &gt; 1  ===#</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    .[<span class="fu">abs</span>(u) <span class="sc">&gt;=</span> <span class="dv">1</span>, k_of_u <span class="sc">:</span><span class="er">=</span> <span class="dv">0</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">#=== find the weight ===#</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    .[, weight <span class="sc">:</span><span class="er">=</span> k_of_u <span class="sc">/</span> <span class="fu">sum</span>(k_of_u)] <span class="sc">%&gt;%</span> </span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    .[, <span class="fu">sum</span>(weight <span class="sc">*</span> y)]</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  return_data <span class="ot">&lt;-</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.table</span>(</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> x0,</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">y_hat =</span> y_hat</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(return_data)</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we do predictions at various values of <code>x</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== sequence of values of x to do predictions at ===#</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>x_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(data[, <span class="fu">min</span>(x)], data[, <span class="fu">max</span>(x)], <span class="at">length =</span> <span class="dv">100</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== predict ===#</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>y_hat_lc <span class="ot">&lt;-</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    x_seq,</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">est_y_nw</span>(x, data, h)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  .[, type <span class="sc">:</span><span class="er">=</span> <span class="st">"Local Constant"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-nw">Figure&nbsp;<span>1.3</span></a> visualizes the prediction results.</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> y_hat_lc,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> y_hat, <span class="at">x =</span> x),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> y_hat_lc,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> y_hat, <span class="at">x =</span> x),</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span>,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">0.6</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data,</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">x =</span> x),</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">0.6</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-nw" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="B01-nonlinear_files/figure-html/fig-nw-1.png" class="img-fluid figure-img" width="480"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Figure 1.3: Predictions at various values of x</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>One critical difference between local non-parametric regression and smoothing splines is that the former fits the data locally (unless <span class="math inline">\(h\)</span> is very high) while smoothing splines fits the data globally (it uses all the data points to fit a single curve).</p>
<p>Another important distinction between the two approaches is that local non-parametric regression requires going through the entire process above whenever predicting <span class="math inline">\(y\)</span> at a particular value of <span class="math inline">\(X\)</span>. This means that you need the entire train dataset every time. On the other hand, once smoothing splines regression is conducted, then you no longer need the train data any more because the fitted curve is characterized completely by the basis functions and their estimated coefficients.</p>
<p>Now, let’s see how the choice of <span class="math inline">\(h\)</span> affects the fitted “curve.” We will try <code>h = 2, 10, 20, 50</code></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>get_y_hat_given_h <span class="ot">&lt;-</span> <span class="cf">function</span>(data, x_seq, h_val)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  return_data <span class="ot">&lt;-</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>      x_seq,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">function</span>(x) <span class="fu">est_y_nw</span>(x, data, h_val)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbindlist</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    .[, h <span class="sc">:</span><span class="er">=</span> h_val]</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(return_data)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>y_hat_h_various <span class="ot">&lt;-</span> </span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">50</span>),</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">get_y_hat_given_h</span>(data, x_seq, x)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>()</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(y_hat_h_various) <span class="sc">+</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> data, <span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">x =</span> x), <span class="at">size =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_hat, <span class="at">x =</span> x), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(h <span class="sc">~</span> .) <span class="sc">+</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-fitted-curves-h" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="B01-nonlinear_files/figure-html/fig-fitted-curves-h-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Figure 1.4: Fitted curves at different values of h</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>As you can see in <a href="#fig-fitted-curves-h">Figure&nbsp;<span>1.4</span></a>, at <span class="math inline">\(h = 2\)</span>, the fitted curve is extremely wiggly and over-fitted. Increasing the value of <span class="math inline">\(h\)</span> make the fitted curves smoother. Nobody uses NW estimator for any practical applications when the problem at hand is high-dimensional as it suffers from the curse of dimensionality. However, NW estimator is a great example to illustrate the importance of the choice of an arbitrary parameter (hyper-parameter). As discussed above, we will later look at cross-validation as a way to tune hyper-parameters.</p>
<section id="sec-local-reg" class="level3" data-number="1.3.1">
<h3 data-number="1.3.1" class="anchored" data-anchor-id="sec-local-reg"><span class="header-section-number">1.3.1</span> Local linear regression</h3>
<p>The NW estimator is a locally constant regression. You can see this from the fact that the NW estimator comes from solving the following minimization problem:</p>
<p><span class="math display">\[
\begin{aligned}
\hat{f}(x = x_0) = argmin_{\alpha} \sum_{i=1}^N W_i(x_0)(Y_i - \alpha)^2
\end{aligned}
\]</span></p>
<p>By modifying the objective function slightly, we will have local linear regression:</p>
<p><span class="math display">\[
\begin{aligned}
\{\hat{\alpha}, \hat{\beta}\} = argmin_{\alpha,\beta} \sum_{i=1}^N W_i(x_0)(Y_i - \alpha - \beta (x_i - x_0))^2
\end{aligned}
\]</span></p>
<p>Then the fitted value is given by <span class="math inline">\(\hat{f}(x = x_0) = \hat{\alpha}\)</span>. This is because the value of <span class="math inline">\(x\)</span> is re-centered around the evaluation point. Alternatively, you can solve the following without re-centering,</p>
<p><span class="math display">\[
\begin{aligned}
\{\hat{\alpha}, \hat{\beta}\} = argmin_{\alpha,\beta} \sum_{i=1}^N W_i(x_0)(Y_i - \alpha - \beta x_i)^2
\end{aligned}
\]</span></p>
<p>, and then calculate <span class="math inline">\(\hat{f}(x = x_0) = \hat{\alpha} + \hat{\beta}x_0\)</span>. They will provide the same estimate of <span class="math inline">\(\hat{f}(x = x_0)\)</span>.</p>
<p>Let’s implement this as an illustration for <span class="math inline">\(x_0 = 150\)</span> with the Epanechnikov kernel function with <span class="math inline">\(h=20\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>x0 <span class="ot">&lt;-</span> <span class="dv">150</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>lr_data <span class="ot">&lt;-</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">copy</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== calculate u ===#</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  .[, u <span class="sc">:</span><span class="er">=</span> (x <span class="sc">-</span> x0)<span class="sc">/</span>h] <span class="sc">%&gt;%</span> </span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== K(u) ===#</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  .[, k_of_u <span class="sc">:</span><span class="er">=</span> <span class="dv">3</span> <span class="sc">/</span> <span class="dv">4</span> <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>u<span class="sc">^</span><span class="dv">2</span>)] <span class="sc">%&gt;%</span> </span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== turn k_of_u to 0 if abs(u) &gt; 1  ===#</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  .[<span class="fu">abs</span>(u) <span class="sc">&gt;=</span> <span class="dv">1</span>, k_of_u <span class="sc">:</span><span class="er">=</span> <span class="dv">0</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== find the weight ===#</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  .[, weight <span class="sc">:</span><span class="er">=</span> k_of_u <span class="sc">/</span> <span class="fu">sum</span>(k_of_u)] <span class="sc">%&gt;%</span> </span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  .[, x_diff <span class="sc">:</span><span class="er">=</span> x <span class="sc">-</span> x0]</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="co">#=== run linear regression with the weights ===#</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>ols_res <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x_diff, <span class="at">data =</span> lr_data, <span class="at">weights =</span> weight)</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a><span class="co">#=== predict ===#</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>y_hat_x0 <span class="ot">&lt;-</span> ols_res<span class="sc">$</span>coefficient[<span class="st">"(Intercept)"</span>]</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept) 
   238.5055 </code></pre>
</div>
</div>
<p>Alternatively,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== run linear regression with the weights no centering around x0 ===#</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>ols_res <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x, <span class="at">data =</span> lr_data, <span class="at">weights =</span> weight)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== predict ===#</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>y_hat_x0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(ols_res, <span class="at">newdata =</span> <span class="fu">data.table</span>(<span class="at">x =</span> x0))</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       1 
238.5055 </code></pre>
</div>
</div>
<p>Local linear regression is better than local constant regression if the underlying curve is significantly non-linear instead of a flat line. Local linear regression also does better near the boundary of the support of <span class="math inline">\(x\)</span>. <a href="#fig-nw-ll">Figure&nbsp;<span>1.5</span></a> presents predicted values by local constant and linear regressions. In this case, it is hard to see the difference between the two except at the edges of <span class="math inline">\(x\)</span> support.</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>est_y_ll <span class="ot">&lt;-</span> <span class="cf">function</span>(x0, data, h){</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  lr_data <span class="ot">&lt;-</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">copy</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">#=== calculate u ===#</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    .[, u <span class="sc">:</span><span class="er">=</span> (x <span class="sc">-</span> x0)<span class="sc">/</span>h] <span class="sc">%&gt;%</span> </span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">#=== K(u) ===#</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    .[, k_of_u <span class="sc">:</span><span class="er">=</span> <span class="dv">3</span> <span class="sc">/</span> <span class="dv">4</span> <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>u<span class="sc">^</span><span class="dv">2</span>)] <span class="sc">%&gt;%</span> </span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">#=== turn k_of_u to 0 if abs(u) &gt; 1  ===#</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    .[<span class="fu">abs</span>(u) <span class="sc">&gt;=</span> <span class="dv">1</span>, k_of_u <span class="sc">:</span><span class="er">=</span> <span class="dv">0</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">#=== find the weight ===#</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    .[, weight <span class="sc">:</span><span class="er">=</span> k_of_u <span class="sc">/</span> <span class="fu">sum</span>(k_of_u)] <span class="sc">%&gt;%</span> </span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    .[, x_diff <span class="sc">:</span><span class="er">=</span> x <span class="sc">-</span> x0]</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== run linear regression with the weights ===#</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>  ols_res <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x_diff, <span class="at">data =</span> lr_data, <span class="at">weights =</span> weight)</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>  return_data <span class="ot">&lt;-</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.table</span>(</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> x0,</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">y_hat =</span> ols_res<span class="sc">$</span>coefficient[<span class="st">"(Intercept)"</span>]</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(return_data)</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>y_hat_ll <span class="ot">&lt;-</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>    x_seq,</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">est_y_ll</span>(x, data, h)</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>  .[, type <span class="sc">:</span><span class="er">=</span> <span class="st">"Local Linear"</span>]</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a><span class="co">#=== combine with the local constant results ===#</span></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>data_all <span class="ot">&lt;-</span> <span class="fu">rbind</span>(y_hat_lc, y_hat_ll)</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a><span class="co">#=== plot ===#</span></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data_all,</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> y_hat, <span class="at">x =</span> x, <span class="at">color =</span> type)</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data_all,</span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> y_hat, <span class="at">x =</span> x, <span class="at">color =</span> type),</span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">0.6</span></span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data,</span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">x =</span> x),</span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">0.6</span></span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_discrete</span>(<span class="at">name =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-nw-ll" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="B01-nonlinear_files/figure-html/fig-nw-ll-1.png" class="img-fluid figure-img" width="576"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Figure 1.5: Predictions at various values of x by NW and LL</figcaption><p></p>
</figure>
</div>
</div>
</div>

<!-- ```{r}
N <- 500

data <- 
  data.table(
    x = rnorm(N),
    e = rnorm(N)
  ) %>% 
  .[, y_det := 2 * sin(2 * x)] %>% 
  .[, y := y_det + e]

h <- 0.3

x_seq <- seq(min(data$x), max(data$x), length = 200)

y_hat_ll <-
  lapply(
    x_seq,
    function(x) est_y_ll(x, data, h)
  ) %>% 
  rbindlist() %>% 
  .[, type := "Local Linear"]

y_hat_lc <-
  lapply(
    x_seq,
    function(x) est_y_nw(x, data, h)
  ) %>% 
  rbindlist() %>% 
  .[, type := "Local Constant"]

data_true <- 
  data[, .(x, y_det)] %>% 
  setnames("y_det", "y_hat") %>% 
  .[, type := "True"]

#=== combine with the local constant results ===#
data_all <- rbind(y_hat_lc, y_hat_ll, data_true)


#=== plot ===#
ggplot() +
  geom_line(
    data = data_all,
    aes(y = y_hat, x = x, color = type)
  ) +
  geom_point(
    data = data_all,
    aes(y = y_hat, x = x, color = type),
    size = 0.6
  ) +
  geom_point(
    data = data,
    aes(y = y, x = x),
    size = 0.6
  ) +
  scale_color_discrete(name = "") +
  theme_bw() +
  theme(legend.position = "bottom")


```
 -->
<div class="callout-tip callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>In <a href="P01-random-forest.html#sec-rf"><span>Section&nbsp;6.2</span></a>, we will see that random forest is a special case of local constant regression</p></li>
<li><p>Understanding local regression helps you understand how generalized random forest works in <a href="E02-grf.html"><span>Chapter&nbsp;17</span></a></p></li>
</ul>
</div>
</div>
<p>You can make the function locally more flexible by including polynomials of <span class="math inline">\(x\)</span>. For example, this is a locally cubic regression.</p>
<p><span class="math display">\[
\begin{aligned}
Min_{\alpha,\beta_1,\beta_2,\beta_3} \sum_{i=1}^N W_i(x_0)(Y_i - \alpha - \beta (x_i-x_0) - \beta_2 (x_i-x_0)^2 - \beta_3 (x_i-x_0)^3)^2
\end{aligned}
\]</span></p>
<div class="callout-tip callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Useful Resource
</div>
</div>
<div class="callout-body-container callout-body">
<p>For those who are interested in fuller treatments of local regression, <a href="https://bookdown.org/egarpor/PM-UC3M/npreg-kre.html#npreg-kre-locpoly">this chapter</a> of <span class="citation" data-cites="Garcia-Portugues2022">García-Portugués (<a href="#ref-Garcia-Portugues2022" role="doc-biblioref">2022</a>)</span>.</p>
</div>
</div>
</section>
<section id="k-nearest-neighbor" class="level3 page-columns page-full" data-number="1.3.2">
<h3 data-number="1.3.2" class="anchored" data-anchor-id="k-nearest-neighbor"><span class="header-section-number">1.3.2</span> K-nearest neighbor</h3>
<p>K-nearest neighbor (KNN) regression is a special case of local constant regression. The prediction of <span class="math inline">\(y\)</span> conditional on <span class="math inline">\(x\)</span> is simply the average of <span class="math inline">\(y\)</span> observed for the K closest (in terms of distance to <span class="math inline">\(x\)</span>) observations in the data. So, it is like the NW estimator with the uniform Kernel function. But, it is not a NW estimator because NW estimator does not fix the number of observations in the <strong>neighbor</strong>.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>Predictions at points around a more densely populated area have larger numbers of observations in their <strong>neighbors</strong>.</p>
</div></div><p>The hyper-parameter for KNN regression is <code>k</code> (the number of neighbors). The choice of the value of <span class="math inline">\(k\)</span> has a dramatic impacts on the fitted curve just like how the choice of <span class="math inline">\(h\)</span> affects the fitted curve by the NW estimator.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">knn_fit =</span> <span class="fu">list</span>(</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">knnreg</span>(y <span class="sc">~</span> x, <span class="at">k =</span> k, <span class="at">data =</span> data)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span> </span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">eval_data =</span> <span class="fu">list</span>(</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.table</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">250</span>, <span class="at">length =</span> <span class="dv">1000</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    .[, <span class="at">y :=</span> <span class="fu">predict</span>(knn_fit, <span class="at">newdata =</span> .)]</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span> </span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(k, eval_data) <span class="sc">%&gt;%</span> </span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">k_txt =</span> <span class="fu">paste0</span>(<span class="st">"k = "</span>, k)) <span class="sc">%&gt;%</span> </span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">k_txt =</span> <span class="fu">factor</span>(k_txt, <span class="at">levels =</span> <span class="fu">paste0</span>(<span class="st">"k = "</span>, <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>))))</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> data, <span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">x =</span> x), <span class="at">color =</span> <span class="st">"darkgray"</span>, <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> plot_data, <span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">x =</span> x), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(k_txt <span class="sc">~</span> ., <span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="B01-nonlinear_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>As you can see, at <code>k</code> <span class="math inline">\(= 1\)</span>, the fitted curve fits perfectly with the observed data, and it is highly over-fitted. While increasing <code>k</code> to <span class="math inline">\(5\)</span> alleviates the over-fitting problem, the fitted curve is still very much wiggly.</p>
</section>
</section>
<section id="efficiency-parametric-vs-non-parametric-methods" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="efficiency-parametric-vs-non-parametric-methods"><span class="header-section-number">1.4</span> Efficiency: Parametric vs Non-parametric Methods</h2>
<p>Semi-parametric and non-parametric approached are more flexible in representing relationships between the dependent and independent variables than linear-in-parameter models. So, why don’t we just use semi-parametric or non-parametric approaches instead for all the econometric tasks? One reason you might prefer linear-in-parameter models has something to do with efficiency.</p>
<div class="callout-tip callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>parametric:
<ul>
<li>pro: can be efficient than non-parametric approach when the underlying process is modeled well with parametric models</li>
<li>cons: not robust to functional form mis-specifications</li>
</ul></li>
<li>semi-, non-parametric:
<ul>
<li>pro: safe-guard against model mis-specification especially when you are modeling highly complex (non-linear in a way that is hard to capture with parametric models and multi-way interactions of variables)</li>
<li>cons: possible loss in efficiency compared to parametric approach when the underlying model can be approximated well with parametric models</li>
</ul></li>
</ul>
</div>
</div>
<section id="monte-carlo-simulation-parametric-vs-non-parametric" class="level3" data-number="1.4.1">
<h3 data-number="1.4.1" class="anchored" data-anchor-id="monte-carlo-simulation-parametric-vs-non-parametric"><span class="header-section-number">1.4.1</span> Monte Carlo Simulation (parametric vs non-parametric)</h3>
<p>Consider the following data generating process:</p>
<p><span class="math display">\[
\begin{aligned}
y = log(x) + v
\end{aligned}
\]</span></p>
<p>Your objective is to understand the impact of treatment (increasing <span class="math inline">\(x = 1\)</span> to <span class="math inline">\(x = 2\)</span>). The true impact of the treatment is <span class="math inline">\(TE[x=1 \rightarrow x=2] = log(2) - log(1) = 0.6931472\)</span>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>mc_run <span class="ot">&lt;-</span> <span class="cf">function</span>(i)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(i) <span class="co"># progress tracker</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== set the number of observations (not really have to be inside the function..) ===#</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== generate the data ===#</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fu">runif</span>(N)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  e <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">rnorm</span>(N)</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">log</span>(x) <span class="sc">+</span> e</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.table</span>(</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> x,</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> y</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>  eval_data <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== linear model with OLS ===#</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>  lm_trained <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> <span class="fu">log</span>(x), <span class="at">data =</span> data)</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>  te_lm <span class="ot">&lt;-</span> lm_trained<span class="sc">$</span>coefficient[<span class="st">"log(x)"</span>] <span class="sc">*</span> <span class="fu">log</span>(<span class="dv">2</span>)</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== gam ===#</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>  gam_trained <span class="ot">&lt;-</span> <span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">5</span>), <span class="at">data =</span> data)</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>  y_hat_gam <span class="ot">&lt;-</span> <span class="fu">predict</span>(gam_trained, <span class="at">newdata =</span> eval_data)</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>  te_gam <span class="ot">&lt;-</span> y_hat_gam[<span class="dv">2</span>] <span class="sc">-</span> y_hat_gam[<span class="dv">1</span>]</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== KNN ===#</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>  knn_trained <span class="ot">&lt;-</span> <span class="fu">knnreg</span>(y <span class="sc">~</span> x, <span class="at">k =</span> <span class="dv">10</span>, <span class="at">data =</span> data)</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>  y_hat_knn <span class="ot">&lt;-</span> <span class="fu">predict</span>(knn_trained, <span class="at">newdata =</span> eval_data)</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>  te_knn <span class="ot">&lt;-</span> y_hat_knn[<span class="dv">2</span>] <span class="sc">-</span> y_hat_knn[<span class="dv">1</span>]</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== combined the results ===#</span></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>  return_data <span class="ot">&lt;-</span></span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.table</span>(</span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">te =</span> <span class="fu">c</span>(te_lm, te_gam, te_knn),</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"lm"</span>, <span class="st">"gam"</span>, <span class="st">"knn"</span>)</span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(return_data)</span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">5293</span>)</span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a>mc_results <span class="ot">&lt;-</span></span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mclapply</span>(</span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span><span class="dv">500</span>,</span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a>    mc_run,</span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">mc.cores =</span> <span class="fu">detectCores</span>() <span class="sc">*</span> <span class="dv">3</span> <span class="sc">/</span> <span class="dv">4</span></span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>()</span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a><span class="co"># lapply(</span></span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a><span class="co">#   1:100,</span></span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a><span class="co">#   mc_run</span></span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><a href="#fig-mc-efficiency">Figure&nbsp;<span>1.6</span></a> presents the density plots of treatment effect estimates by method. As you can see, the (correctly-specified) linear model performs better than the other methods. All the methods are unbiased, however they differ substantially in terms of efficiency. Note that there was no point in applying random forest at all as there is only a single explanatory variable and the none of the strong points of RF over linear model manifest in this simulation. Clearly, this simulation by no means is intended to claim that linear model is the best. It is merely showcasing <span style="color:red"> a </span>scenario where (correctly-specified) linear model performs far better than the non-parametric models. This is also a reminder that no method works the best all the time. There are many cases where parametric models perform better (contextual knowledge is critical so that your parametric model can represent the true data generating process well). There are of course many cases non-parametric modeling work better than parametric modeling.</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> mc_results) <span class="sc">+</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x =</span> te, <span class="at">fill =</span> type), <span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">log</span>(<span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-mc-efficiency" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="B01-nonlinear_files/figure-html/fig-mc-efficiency-1.png" class="img-fluid figure-img" width="576"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Figure 1.6: Results of the MC simulations on the efficiency of various methods</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="references" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="references">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-Garcia-Portugues2022" class="csl-entry" role="doc-biblioentry">
García-Portugués, E. 2022. <em>Notes for Predictive Modeling</em>. <a href="https://bookdown.org/egarpor/PM-UC3M/">https://bookdown.org/egarpor/PM-UC3M/</a>.
</div>
<div id="ref-wood2006generalized" class="csl-entry" role="doc-biblioentry">
Wood, Simon N. 2006. <em>Generalized Additive Models: An Introduction with r</em>. chapman; hall/CRC.
</div>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
  </div>
  <div class="nav-page nav-page-next">
      <a href="./B02-bias-variance-tradeoff.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Bias-variance Trade-off</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb35" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Non-linear function estimation {#sec-nonlinear}</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>The purpose of this section is to introduce you to the idea of semi-parametric and non-parametric regression methods. The world of semi-parametric and non-parametric regression is vast. But, we only scratch the surface by just looking at smoothing splines and local regression methods in this chapter. Learning these methods also provide us with excellent opportunities to learn the phenomenon called over-fitting and also the importance of hyper-parameters. Understanding local regression in particular is essential in understanding generalized random forest covered in @sec-grf.</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="fu">## What you will learn</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Limitations of linear-in-parameter parametric model in representing non-linear functions</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Regression splines</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Local regression</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>Local constant regression</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>Local linear regression</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Over-fitting and hyper-parameters</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a><span class="fu">## Flexible functional form estimation {#sec-functional-form}</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>**Packages to load for replications**</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>There is a clear limit to liner (in parameter) parametric models in flexibility to represent quantitative relationships between variables. For example, consider crop yield response to fertilizer. Typically, yield increases at the diminishing rate as fertilizer rate increases. However, at a high enough fertilizer rate, yield stops increasing (fertilizer is not a limiting factor at that point). This relationship is illustrated in the figure below.</span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 3</span></span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 5</span></span>
<span id="cb35-58"><a href="#cb35-58" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: center</span></span>
<span id="cb35-59"><a href="#cb35-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-60"><a href="#cb35-60" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">83944</span>)</span>
<span id="cb35-61"><a href="#cb35-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-62"><a href="#cb35-62" aria-hidden="true" tabindex="-1"></a><span class="co">#=== generate data ===#</span></span>
<span id="cb35-63"><a href="#cb35-63" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">400</span> <span class="co"># number of observations</span></span>
<span id="cb35-64"><a href="#cb35-64" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">250</span>, <span class="at">length =</span> N) </span>
<span id="cb35-65"><a href="#cb35-65" aria-hidden="true" tabindex="-1"></a>y_det <span class="ot">&lt;-</span> <span class="dv">240</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fl">0.4</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span> <span class="fl">0.03</span> <span class="sc">*</span> x))</span>
<span id="cb35-66"><a href="#cb35-66" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> <span class="dv">25</span> <span class="sc">*</span> <span class="fu">rnorm</span>(N) <span class="co"># error</span></span>
<span id="cb35-67"><a href="#cb35-67" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">x =</span> x, <span class="at">y =</span> y_det <span class="sc">+</span> e, <span class="at">y_det =</span> y_det)</span>
<span id="cb35-68"><a href="#cb35-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-69"><a href="#cb35-69" aria-hidden="true" tabindex="-1"></a><span class="co">#=== plot ===#</span></span>
<span id="cb35-70"><a href="#cb35-70" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb35-71"><a href="#cb35-71" aria-hidden="true" tabindex="-1"></a>g_base <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(data) <span class="sc">+</span></span>
<span id="cb35-72"><a href="#cb35-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_det, <span class="at">x =</span> x)) <span class="sc">+</span></span>
<span id="cb35-73"><a href="#cb35-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb35-74"><a href="#cb35-74" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-75"><a href="#cb35-75" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-76"><a href="#cb35-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-77"><a href="#cb35-77" aria-hidden="true" tabindex="-1"></a>Let's try to fit this data using linear parametric models with $sqrt(x)$, $log(x)$, and $x + x^2$, where the dependent variable is <span class="in">`y_det`</span>, which is $E<span class="co">[</span><span class="ot">y|x</span><span class="co">]</span>$ (no error added). </span>
<span id="cb35-78"><a href="#cb35-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-81"><a href="#cb35-81" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-82"><a href="#cb35-82" aria-hidden="true" tabindex="-1"></a><span class="co">#=== sqrt ===#</span></span>
<span id="cb35-83"><a href="#cb35-83" aria-hidden="true" tabindex="-1"></a>lm_sq <span class="ot">&lt;-</span> <span class="fu">lm</span>(y_det <span class="sc">~</span> <span class="fu">sqrt</span>(x), <span class="at">data =</span> data)</span>
<span id="cb35-84"><a href="#cb35-84" aria-hidden="true" tabindex="-1"></a>data[, y_hat_sqrt <span class="sc">:</span><span class="er">=</span> lm_sq<span class="sc">$</span>fit]</span>
<span id="cb35-85"><a href="#cb35-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-86"><a href="#cb35-86" aria-hidden="true" tabindex="-1"></a><span class="co">#=== log ===#</span></span>
<span id="cb35-87"><a href="#cb35-87" aria-hidden="true" tabindex="-1"></a>lm_log <span class="ot">&lt;-</span> <span class="fu">lm</span>(y_det <span class="sc">~</span> <span class="fu">log</span>(x), <span class="at">data =</span> data)</span>
<span id="cb35-88"><a href="#cb35-88" aria-hidden="true" tabindex="-1"></a>data[, y_hat_log <span class="sc">:</span><span class="er">=</span> lm_log<span class="sc">$</span>fit]</span>
<span id="cb35-89"><a href="#cb35-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-90"><a href="#cb35-90" aria-hidden="true" tabindex="-1"></a><span class="co">#=== quadratic ===#</span></span>
<span id="cb35-91"><a href="#cb35-91" aria-hidden="true" tabindex="-1"></a>lm_quad <span class="ot">&lt;-</span> <span class="fu">lm</span>(y_det <span class="sc">~</span> x <span class="sc">+</span> x<span class="sc">^</span><span class="dv">2</span>, <span class="at">data =</span> data)</span>
<span id="cb35-92"><a href="#cb35-92" aria-hidden="true" tabindex="-1"></a>data[, y_hat_quad <span class="sc">:</span><span class="er">=</span> lm_quad<span class="sc">$</span>fit]</span>
<span id="cb35-93"><a href="#cb35-93" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-94"><a href="#cb35-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-97"><a href="#cb35-97" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-98"><a href="#cb35-98" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb35-99"><a href="#cb35-99" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 3</span></span>
<span id="cb35-100"><a href="#cb35-100" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 6</span></span>
<span id="cb35-101"><a href="#cb35-101" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: center</span></span>
<span id="cb35-102"><a href="#cb35-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-103"><a href="#cb35-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-104"><a href="#cb35-104" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span></span>
<span id="cb35-105"><a href="#cb35-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">melt</span>(data, <span class="at">id.var =</span> <span class="st">"x"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb35-106"><a href="#cb35-106" aria-hidden="true" tabindex="-1"></a>  .[variable <span class="sc">!=</span> <span class="st">"y"</span>, ] <span class="sc">%&gt;%</span> </span>
<span id="cb35-107"><a href="#cb35-107" aria-hidden="true" tabindex="-1"></a>  .[, fit_case <span class="sc">:</span><span class="er">=</span> <span class="fu">fcase</span>(</span>
<span id="cb35-108"><a href="#cb35-108" aria-hidden="true" tabindex="-1"></a>    variable <span class="sc">==</span> <span class="st">"y_det"</span>, <span class="st">"True response"</span>,</span>
<span id="cb35-109"><a href="#cb35-109" aria-hidden="true" tabindex="-1"></a>    variable <span class="sc">==</span> <span class="st">"y_hat_sqrt"</span>, <span class="st">"sqrt"</span>,</span>
<span id="cb35-110"><a href="#cb35-110" aria-hidden="true" tabindex="-1"></a>    variable <span class="sc">==</span> <span class="st">"y_hat_log"</span>, <span class="st">"log"</span>,</span>
<span id="cb35-111"><a href="#cb35-111" aria-hidden="true" tabindex="-1"></a>    variable <span class="sc">==</span> <span class="st">"y_hat_quad"</span>, <span class="st">"quadratic"</span></span>
<span id="cb35-112"><a href="#cb35-112" aria-hidden="true" tabindex="-1"></a>  )]</span>
<span id="cb35-113"><a href="#cb35-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-114"><a href="#cb35-114" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_data) <span class="sc">+</span></span>
<span id="cb35-115"><a href="#cb35-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> value, <span class="at">x =</span> x, <span class="at">color =</span> fit_case)) <span class="sc">+</span></span>
<span id="cb35-116"><a href="#cb35-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_discrete</span>(<span class="at">name =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb35-117"><a href="#cb35-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb35-118"><a href="#cb35-118" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-119"><a href="#cb35-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-120"><a href="#cb35-120" aria-hidden="true" tabindex="-1"></a>None of the specifications do quite well. Indeed, you cannot represent the relationship well using well-known popular functional forms. Let's now look at methods that are flexible enough to capture the relationship. First, smoothing splines, and then K-nearest neighbor next. </span>
<span id="cb35-121"><a href="#cb35-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-122"><a href="#cb35-122" aria-hidden="true" tabindex="-1"></a><span class="fu">## Smoothing Splines (semi-parametric) {#sec-smoothing-splines}</span></span>
<span id="cb35-123"><a href="#cb35-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-124"><a href="#cb35-124" aria-hidden="true" tabindex="-1"></a>Detailed discussion of smoothing splines is out of the scope of this book. Only its basic ideas will be presented in this chapter. See @wood2006generalized for a fuller treatment of this topic.</span>
<span id="cb35-125"><a href="#cb35-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-126"><a href="#cb35-126" aria-hidden="true" tabindex="-1"></a>Consider a simple quantitative relationship of two variables $y$ and $x$: $y = f(x)$. </span>
<span id="cb35-127"><a href="#cb35-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-128"><a href="#cb35-128" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb35-129"><a href="#cb35-129" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb35-130"><a href="#cb35-130" aria-hidden="true" tabindex="-1"></a>y = f(x)</span>
<span id="cb35-131"><a href="#cb35-131" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb35-132"><a href="#cb35-132" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb35-133"><a href="#cb35-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-134"><a href="#cb35-134" aria-hidden="true" tabindex="-1"></a>It is possible to characterize this function by using many functions in additive manner: $b_1(x), \dots, b_K(x)$.</span>
<span id="cb35-135"><a href="#cb35-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-136"><a href="#cb35-136" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb35-137"><a href="#cb35-137" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb35-138"><a href="#cb35-138" aria-hidden="true" tabindex="-1"></a>y = \sum_{k=1}^K \beta_k b_k(x) </span>
<span id="cb35-139"><a href="#cb35-139" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb35-140"><a href="#cb35-140" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb35-141"><a href="#cb35-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-142"><a href="#cb35-142" aria-hidden="true" tabindex="-1"></a>where $\beta_k$ is the coefficient on $b_k(x)$. </span>
<span id="cb35-143"><a href="#cb35-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-144"><a href="#cb35-144" aria-hidden="true" tabindex="-1"></a>Here are what $b_1(x), \dots, b_K(x)$ may look like (1 intercept and 9 cubic spline functions).</span>
<span id="cb35-145"><a href="#cb35-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-148"><a href="#cb35-148" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-149"><a href="#cb35-149" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb35-150"><a href="#cb35-150" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 9 </span></span>
<span id="cb35-151"><a href="#cb35-151" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 5 </span></span>
<span id="cb35-152"><a href="#cb35-152" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: center</span></span>
<span id="cb35-153"><a href="#cb35-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-154"><a href="#cb35-154" aria-hidden="true" tabindex="-1"></a>basis_data <span class="ot">&lt;-</span></span>
<span id="cb35-155"><a href="#cb35-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gam</span>(y_det <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">10</span>, <span class="at">bs =</span> <span class="st">"cr"</span>), <span class="at">data =</span> data) <span class="sc">%&gt;%</span> </span>
<span id="cb35-156"><a href="#cb35-156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(., <span class="at">type =</span> <span class="st">"lpmatrix"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb35-157"><a href="#cb35-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb35-158"><a href="#cb35-158" aria-hidden="true" tabindex="-1"></a>  .[, x <span class="sc">:</span><span class="er">=</span> data[, x]] <span class="sc">%&gt;%</span> </span>
<span id="cb35-159"><a href="#cb35-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">melt</span>(<span class="at">id.var =</span> <span class="st">"x"</span>)</span>
<span id="cb35-160"><a href="#cb35-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-161"><a href="#cb35-161" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> basis_data) <span class="sc">+</span></span>
<span id="cb35-162"><a href="#cb35-162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> value, <span class="at">x =</span> x)) <span class="sc">+</span></span>
<span id="cb35-163"><a href="#cb35-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(variable <span class="sc">~</span> .) <span class="sc">+</span></span>
<span id="cb35-164"><a href="#cb35-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb35-165"><a href="#cb35-165" aria-hidden="true" tabindex="-1"></a><span class="in">```</span> </span>
<span id="cb35-166"><a href="#cb35-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-167"><a href="#cb35-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-168"><a href="#cb35-168" aria-hidden="true" tabindex="-1"></a>By assigning different values to $b_1(x), \dots, b_K(x)$, their summation can represent different functional relationships.</span>
<span id="cb35-169"><a href="#cb35-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-170"><a href="#cb35-170" aria-hidden="true" tabindex="-1"></a>Here is what $\sum_{k=1}^K \beta_k b_k(x)$ looks like when $\beta_1$ through $\beta_{10}$ are all $200$.</span>
<span id="cb35-171"><a href="#cb35-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-172"><a href="#cb35-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-173"><a href="#cb35-173" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb35-174"><a href="#cb35-174" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb35-175"><a href="#cb35-175" aria-hidden="true" tabindex="-1"></a>y = \sum_{k=1}^{10} 200 b_k(x)</span>
<span id="cb35-176"><a href="#cb35-176" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb35-177"><a href="#cb35-177" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb35-178"><a href="#cb35-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-179"><a href="#cb35-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-182"><a href="#cb35-182" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-183"><a href="#cb35-183" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb35-184"><a href="#cb35-184" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 3</span></span>
<span id="cb35-185"><a href="#cb35-185" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 5</span></span>
<span id="cb35-186"><a href="#cb35-186" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: center</span></span>
<span id="cb35-187"><a href="#cb35-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-188"><a href="#cb35-188" aria-hidden="true" tabindex="-1"></a><span class="fu">data.table</span>(</span>
<span id="cb35-189"><a href="#cb35-189" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable =</span> <span class="fu">unique</span>(basis_data<span class="sc">$</span>variable),</span>
<span id="cb35-190"><a href="#cb35-190" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef =</span> <span class="fu">rep</span>(<span class="dv">200</span>, <span class="dv">10</span>)</span>
<span id="cb35-191"><a href="#cb35-191" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb35-192"><a href="#cb35-192" aria-hidden="true" tabindex="-1"></a>.[basis_data, on <span class="ot">=</span> <span class="st">"variable"</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb35-193"><a href="#cb35-193" aria-hidden="true" tabindex="-1"></a>.[, <span class="fu">sum</span>(coef <span class="sc">*</span> value), by <span class="ot">=</span> x] <span class="sc">%&gt;%</span> </span>
<span id="cb35-194"><a href="#cb35-194" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> .) <span class="sc">+</span></span>
<span id="cb35-195"><a href="#cb35-195" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> V1, <span class="at">x =</span> x)) <span class="sc">+</span></span>
<span id="cb35-196"><a href="#cb35-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb35-197"><a href="#cb35-197" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-198"><a href="#cb35-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-199"><a href="#cb35-199" aria-hidden="true" tabindex="-1"></a>Here is what $\sum_{k=1}^K \beta_k b_k(x)$ looks like when $\beta_1$ through $\beta_4$ are all $50$ and $\beta_5$ through $\beta_9$ are all $200$.</span>
<span id="cb35-200"><a href="#cb35-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-201"><a href="#cb35-201" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb35-202"><a href="#cb35-202" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb35-203"><a href="#cb35-203" aria-hidden="true" tabindex="-1"></a>y = \sum_{k=1}^5 50 b_k(x) + \sum_{k=6}^{10} 200 b_k(x)</span>
<span id="cb35-204"><a href="#cb35-204" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb35-205"><a href="#cb35-205" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb35-206"><a href="#cb35-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-209"><a href="#cb35-209" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-210"><a href="#cb35-210" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb35-211"><a href="#cb35-211" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 3</span></span>
<span id="cb35-212"><a href="#cb35-212" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 5</span></span>
<span id="cb35-213"><a href="#cb35-213" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: center</span></span>
<span id="cb35-214"><a href="#cb35-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-215"><a href="#cb35-215" aria-hidden="true" tabindex="-1"></a><span class="fu">data.table</span>(</span>
<span id="cb35-216"><a href="#cb35-216" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable =</span> <span class="fu">unique</span>(basis_data<span class="sc">$</span>variable),</span>
<span id="cb35-217"><a href="#cb35-217" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">50</span>, <span class="dv">5</span>), <span class="fu">rep</span>(<span class="dv">200</span>, <span class="dv">5</span>))</span>
<span id="cb35-218"><a href="#cb35-218" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb35-219"><a href="#cb35-219" aria-hidden="true" tabindex="-1"></a>.[basis_data, on <span class="ot">=</span> <span class="st">"variable"</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb35-220"><a href="#cb35-220" aria-hidden="true" tabindex="-1"></a>.[, <span class="fu">sum</span>(coef <span class="sc">*</span> value), by <span class="ot">=</span> x] <span class="sc">%&gt;%</span> </span>
<span id="cb35-221"><a href="#cb35-221" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> .) <span class="sc">+</span></span>
<span id="cb35-222"><a href="#cb35-222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> V1, <span class="at">x =</span> x)) <span class="sc">+</span></span>
<span id="cb35-223"><a href="#cb35-223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb35-224"><a href="#cb35-224" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-225"><a href="#cb35-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-226"><a href="#cb35-226" aria-hidden="true" tabindex="-1"></a>In practice, we fit the model to a dataset to find coefficient estimates that fit the data well. Here, we use the <span class="in">`gam()`</span> function from the <span class="in">`mgcv`</span> package. Note that, we use $E<span class="co">[</span><span class="ot">y|x</span><span class="co">]</span>$ (<span class="in">`y_det`</span>) as the dependent variable to demonstrate the ability of smoothing splines to imitate the true function.</span>
<span id="cb35-227"><a href="#cb35-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-228"><a href="#cb35-228" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb35-229"><a href="#cb35-229" aria-hidden="true" tabindex="-1"></a><span class="in">`gam`</span> stands for <span class="kw">&lt;span</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:red"</span><span class="kw">&gt;</span> G<span class="kw">&lt;/span&gt;</span>eneralized <span class="kw">&lt;span</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:red"</span><span class="kw">&gt;</span>A<span class="kw">&lt;/span&gt;</span>dditive <span class="kw">&lt;span</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:red"</span><span class="kw">&gt;</span>M<span class="kw">&lt;/span&gt;</span>odel. It is a much wider class of model than our examples in this section. See @wood2006generalized for more details.</span>
<span id="cb35-230"><a href="#cb35-230" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb35-231"><a href="#cb35-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-234"><a href="#cb35-234" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-235"><a href="#cb35-235" aria-hidden="true" tabindex="-1"></a>gam_fit <span class="ot">&lt;-</span> <span class="fu">gam</span>(y_det <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">10</span>, <span class="at">bs =</span> <span class="st">"cr"</span>), <span class="at">data =</span> data)</span>
<span id="cb35-236"><a href="#cb35-236" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-237"><a href="#cb35-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-238"><a href="#cb35-238" aria-hidden="true" tabindex="-1"></a><span class="in">`s(x, k = 10, bs = "cr")`</span> in the regression formula tells <span class="in">`gam()`</span> to use 10 knots, which results in an intercept and nine spline basis functions. <span class="in">`bs = "cr"`</span> tells <span class="in">`gam()`</span> to use cubic spline basis functions.</span>
<span id="cb35-239"><a href="#cb35-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-240"><a href="#cb35-240" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb35-241"><a href="#cb35-241" aria-hidden="true" tabindex="-1"></a>There are many other spline basis options offered by the <span class="in">`mgcv`</span> package. Interested readers are referred to @wood2006generalized. </span>
<span id="cb35-242"><a href="#cb35-242" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb35-243"><a href="#cb35-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-244"><a href="#cb35-244" aria-hidden="true" tabindex="-1"></a>Here are the coefficient estimates: </span>
<span id="cb35-245"><a href="#cb35-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-248"><a href="#cb35-248" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-249"><a href="#cb35-249" aria-hidden="true" tabindex="-1"></a>gam_fit<span class="sc">$</span>coefficient</span>
<span id="cb35-250"><a href="#cb35-250" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-251"><a href="#cb35-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-252"><a href="#cb35-252" aria-hidden="true" tabindex="-1"></a>This translate into the following fitted curve.</span>
<span id="cb35-253"><a href="#cb35-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-256"><a href="#cb35-256" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-257"><a href="#cb35-257" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb35-258"><a href="#cb35-258" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 3</span></span>
<span id="cb35-259"><a href="#cb35-259" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 6</span></span>
<span id="cb35-260"><a href="#cb35-260" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: center</span></span>
<span id="cb35-261"><a href="#cb35-261" aria-hidden="true" tabindex="-1"></a><span class="fu">data.table</span>(</span>
<span id="cb35-262"><a href="#cb35-262" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable =</span> <span class="fu">unique</span>(basis_data<span class="sc">$</span>variable)[<span class="sc">-</span><span class="dv">1</span>],</span>
<span id="cb35-263"><a href="#cb35-263" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef =</span> gam_fit<span class="sc">$</span>coefficient[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb35-264"><a href="#cb35-264" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb35-265"><a href="#cb35-265" aria-hidden="true" tabindex="-1"></a>.[basis_data, on <span class="ot">=</span> <span class="st">"variable"</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb35-266"><a href="#cb35-266" aria-hidden="true" tabindex="-1"></a>.[, .(<span class="at">y_no_int =</span> <span class="fu">sum</span>(coef <span class="sc">*</span> value)), by <span class="ot">=</span> x] <span class="sc">%&gt;%</span> </span>
<span id="cb35-267"><a href="#cb35-267" aria-hidden="true" tabindex="-1"></a>.[, y_hat <span class="sc">:</span><span class="er">=</span> gam_fit<span class="sc">$</span>coefficient[<span class="dv">1</span>] <span class="sc">+</span> y_no_int] <span class="sc">%&gt;%</span> </span>
<span id="cb35-268"><a href="#cb35-268" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> .) <span class="sc">+</span></span>
<span id="cb35-269"><a href="#cb35-269" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_hat, <span class="at">x =</span> x, <span class="at">color =</span> <span class="st">"gam-fitted"</span>)) <span class="sc">+</span></span>
<span id="cb35-270"><a href="#cb35-270" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> data, <span class="fu">aes</span>(<span class="at">y =</span> y_det, <span class="at">x =</span> x, <span class="at">color =</span> <span class="st">"True"</span>)) <span class="sc">+</span></span>
<span id="cb35-271"><a href="#cb35-271" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb35-272"><a href="#cb35-272" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">""</span>,</span>
<span id="cb35-273"><a href="#cb35-273" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"gam-fitted"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"True"</span> <span class="ot">=</span> <span class="st">"blue"</span>)</span>
<span id="cb35-274"><a href="#cb35-274" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb35-275"><a href="#cb35-275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"y"</span>) <span class="sc">+</span></span>
<span id="cb35-276"><a href="#cb35-276" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"x"</span>) <span class="sc">+</span></span>
<span id="cb35-277"><a href="#cb35-277" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb35-278"><a href="#cb35-278" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-279"><a href="#cb35-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-280"><a href="#cb35-280" aria-hidden="true" tabindex="-1"></a>As you can see, the trained model is almost perfect in representing the functional relationship of $y$ and $x$.</span>
<span id="cb35-281"><a href="#cb35-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-282"><a href="#cb35-282" aria-hidden="true" tabindex="-1"></a>Now, when <span class="in">`gam()`</span> fits a model to a dataset, it penalizes the wiggliness (how wavy the curve is) of the estimated function to safe-guard against fitting the model too well to the data. Specifically, it finds coefficients that minimizes the sum of the squared residuals (for regression) plus an additional term that captures how wavy the resulting function is.</span>
<span id="cb35-283"><a href="#cb35-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-284"><a href="#cb35-284" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb35-285"><a href="#cb35-285" aria-hidden="true" tabindex="-1"></a>Here is an example of wiggly (first) v.s. smooth (second) functions.</span>
<span id="cb35-288"><a href="#cb35-288" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-289"><a href="#cb35-289" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb35-290"><a href="#cb35-290" aria-hidden="true" tabindex="-1"></a>gam_fit_wiggly <span class="ot">&lt;-</span> <span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">40</span>, <span class="at">bs =</span> <span class="st">"cr"</span>, <span class="at">sp =</span> <span class="dv">0</span>), <span class="at">data =</span> data)</span>
<span id="cb35-291"><a href="#cb35-291" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(gam_fit_wiggly, <span class="at">se =</span> <span class="cn">FALSE</span>)</span>
<span id="cb35-292"><a href="#cb35-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-293"><a href="#cb35-293" aria-hidden="true" tabindex="-1"></a>gam_fit_smooth <span class="ot">&lt;-</span> <span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">5</span>, <span class="at">bs =</span> <span class="st">"cr"</span>), <span class="at">data =</span> data)</span>
<span id="cb35-294"><a href="#cb35-294" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(gam_fit_smooth, <span class="at">se =</span> <span class="cn">FALSE</span>)</span>
<span id="cb35-295"><a href="#cb35-295" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-296"><a href="#cb35-296" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb35-297"><a href="#cb35-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-298"><a href="#cb35-298" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb35-299"><a href="#cb35-299" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb35-300"><a href="#cb35-300" aria-hidden="true" tabindex="-1"></a>Min_{\hat{f}(x)} \sum_{i=1}^N(y_i - \hat{f}(x_i))^2 + \lambda \Omega(\hat{f}(x))</span>
<span id="cb35-301"><a href="#cb35-301" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb35-302"><a href="#cb35-302" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb35-303"><a href="#cb35-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-304"><a href="#cb35-304" aria-hidden="true" tabindex="-1"></a>where $\Omega(\hat{f}(x)) &gt; 0$ is a function that captures how wavy the resulting function is. It takes a higher value when $\hat{f}(x)$ is more wiggly. $\lambda &gt; 0$ is the penalization parameter. As $\lambda$ gets larger, a greater penalty on the wiggliness of $\hat{f}(x)$, thus resulting in a smoother curve.</span>
<span id="cb35-305"><a href="#cb35-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-306"><a href="#cb35-306" aria-hidden="true" tabindex="-1"></a>You can specify $\lambda$ by <span class="in">`sp`</span> parameter in <span class="in">`gam()`</span>. When <span class="in">`sp`</span> is not specified by the user, <span class="in">`gam()`</span> finds the optimal value of <span class="in">`sp`</span> internally using cross-validation (cross-validation will be introduce formally in @sec-cross-validation). For now, just consider it as a method to find parameters that make the trained model a good representation of the underlying conditional mean function ($E<span class="co">[</span><span class="ot">y|x</span><span class="co">]</span>$). </span>
<span id="cb35-307"><a href="#cb35-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-308"><a href="#cb35-308" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb35-309"><a href="#cb35-309" aria-hidden="true" tabindex="-1"></a>More specifically, it uses generalized cross-validation (GCV). A special type of cross-validation that can be done when the model is linear in parameter.</span>
<span id="cb35-310"><a href="#cb35-310" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb35-311"><a href="#cb35-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-312"><a href="#cb35-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-313"><a href="#cb35-313" aria-hidden="true" tabindex="-1"></a>If you do not pick the value of <span class="in">`sp`</span> well, the estimated curve will be very wiggly. Let's see an example by setting the value of <span class="in">`sp`</span> to 0, meaning no punishment for being very wiggly. We also set the number of splines to $39$ so that $\sum_{k=1}^K \beta_k b_k(x)$  is <span class="kw">&lt;span</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:red"</span><span class="kw">&gt;</span> very <span class="kw">&lt;/span&gt;</span>flexible.</span>
<span id="cb35-314"><a href="#cb35-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-317"><a href="#cb35-317" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-318"><a href="#cb35-318" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb35-319"><a href="#cb35-319" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 3</span></span>
<span id="cb35-320"><a href="#cb35-320" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 5</span></span>
<span id="cb35-321"><a href="#cb35-321" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: center</span></span>
<span id="cb35-322"><a href="#cb35-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-323"><a href="#cb35-323" aria-hidden="true" tabindex="-1"></a><span class="co">#=== fit ===#</span></span>
<span id="cb35-324"><a href="#cb35-324" aria-hidden="true" tabindex="-1"></a>gam_fit_wiggly <span class="ot">&lt;-</span> <span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">40</span>, <span class="at">bs =</span> <span class="st">"cr"</span>, <span class="at">sp =</span> <span class="dv">0</span>), <span class="at">data =</span> data)</span>
<span id="cb35-325"><a href="#cb35-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-326"><a href="#cb35-326" aria-hidden="true" tabindex="-1"></a><span class="co">#=== assign the fitted values to a variable ===#</span></span>
<span id="cb35-327"><a href="#cb35-327" aria-hidden="true" tabindex="-1"></a>data[, y_hat <span class="sc">:</span><span class="er">=</span> gam_fit_wiggly<span class="sc">$</span>fitted.values]</span>
<span id="cb35-328"><a href="#cb35-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-329"><a href="#cb35-329" aria-hidden="true" tabindex="-1"></a><span class="co">#=== plot ===#</span></span>
<span id="cb35-330"><a href="#cb35-330" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> data) <span class="sc">+</span></span>
<span id="cb35-331"><a href="#cb35-331" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_hat, <span class="at">x =</span> x), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb35-332"><a href="#cb35-332" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">x =</span> x), <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb35-333"><a href="#cb35-333" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb35-334"><a href="#cb35-334" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-335"><a href="#cb35-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-336"><a href="#cb35-336" aria-hidden="true" tabindex="-1"></a>We call this phenomenon over-fitting (of the data by the model). An over-fitted model does well in predicting $y$ when applied to the data the model used to train itself. However, it would do a terrible job in prediction on the data it has never seen clearly because it is not predicting $E<span class="co">[</span><span class="ot">y|x</span><span class="co">]</span>$ well. </span>
<span id="cb35-337"><a href="#cb35-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-338"><a href="#cb35-338" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb35-339"><a href="#cb35-339" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="kw">&lt;span</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:red"</span><span class="kw">&gt;</span> Hyper-parameter<span class="kw">&lt;/span&gt;</span>: parameters that one has freedom to specify before fitting the model and affect the fitting process in ways that change the outcome of the fitting.</span>
<span id="cb35-340"><a href="#cb35-340" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="kw">&lt;span</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:red"</span><span class="kw">&gt;</span> Parameter tuning<span class="kw">&lt;/span&gt;</span>: process that attempts to find the optimal set of hyper-parameter values.</span>
<span id="cb35-341"><a href="#cb35-341" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb35-342"><a href="#cb35-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-343"><a href="#cb35-343" aria-hidden="true" tabindex="-1"></a>In <span class="in">`mgcv::gam()`</span>, the hyper-parameters are the penalty parameter $\lambda$ (specified by. <span class="in">`sp`</span>), the number of knots (specified by <span class="in">`k`</span>)$^1$, the type of splines (specified by <span class="in">`bs`</span>). Coefficient estimates ($\alpha$, $\beta_1, \dots, \beta_K$) change when the value of <span class="in">`sp`</span> is altered. Here is what happens when <span class="in">`k`</span> $= 3$ (less flexible than the <span class="in">`k`</span> $= 39$ case above).</span>
<span id="cb35-344"><a href="#cb35-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-345"><a href="#cb35-345" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb35-346"><a href="#cb35-346" aria-hidden="true" tabindex="-1"></a>$^1$ or more precisely, how many knots and where to place them</span>
<span id="cb35-347"><a href="#cb35-347" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb35-348"><a href="#cb35-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-351"><a href="#cb35-351" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-352"><a href="#cb35-352" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 3</span></span>
<span id="cb35-353"><a href="#cb35-353" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 5</span></span>
<span id="cb35-354"><a href="#cb35-354" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: center</span></span>
<span id="cb35-355"><a href="#cb35-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-356"><a href="#cb35-356" aria-hidden="true" tabindex="-1"></a><span class="co">#=== fit ===#</span></span>
<span id="cb35-357"><a href="#cb35-357" aria-hidden="true" tabindex="-1"></a>gam_fit_wiggly <span class="ot">&lt;-</span> <span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">3</span>, <span class="at">bs =</span> <span class="st">"cr"</span>, <span class="at">sp =</span> <span class="dv">0</span>), <span class="at">data =</span> data)</span>
<span id="cb35-358"><a href="#cb35-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-359"><a href="#cb35-359" aria-hidden="true" tabindex="-1"></a><span class="co">#=== assign the fitted values to a variable ===#</span></span>
<span id="cb35-360"><a href="#cb35-360" aria-hidden="true" tabindex="-1"></a>data[, y_hat <span class="sc">:</span><span class="er">=</span> gam_fit_wiggly<span class="sc">$</span>fitted.values]</span>
<span id="cb35-361"><a href="#cb35-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-362"><a href="#cb35-362" aria-hidden="true" tabindex="-1"></a><span class="co">#=== plot ===#</span></span>
<span id="cb35-363"><a href="#cb35-363" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> data) <span class="sc">+</span></span>
<span id="cb35-364"><a href="#cb35-364" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_hat, <span class="at">x =</span> x), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb35-365"><a href="#cb35-365" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">x =</span> x), <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb35-366"><a href="#cb35-366" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb35-367"><a href="#cb35-367" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-368"><a href="#cb35-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-369"><a href="#cb35-369" aria-hidden="true" tabindex="-1"></a>Hyper-parameters can significantly influence the outcome. Since the user gets to pick any numbers, it can potentially be used to twist the results in a way that favors the outcomes they want to have. Therefore, it is important to pick the values of hyper-parameters wisely. One way of achieving the goal is cross-validation, which is a data-driven way of finding the best value of hyper-parameters. We will discuss cross-validation in @sec-cv in detail. </span>
<span id="cb35-370"><a href="#cb35-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-371"><a href="#cb35-371" aria-hidden="true" tabindex="-1"></a>Here is the fitted curve when the optimal value of <span class="in">`sp`</span> is picked by <span class="in">`gam()`</span> automatically given <span class="in">`k = 40`</span> and <span class="in">`bs = "cr"`</span> using cross-validation.</span>
<span id="cb35-372"><a href="#cb35-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-373"><a href="#cb35-373" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb35-374"><a href="#cb35-374" aria-hidden="true" tabindex="-1"></a>That is, we are not tuning <span class="in">`k`</span> and <span class="in">`bs`</span> here. <span class="in">`gam()`</span> uses generalized cross-validation, which we do not cover in this book.</span>
<span id="cb35-375"><a href="#cb35-375" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb35-376"><a href="#cb35-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-379"><a href="#cb35-379" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-380"><a href="#cb35-380" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 3</span></span>
<span id="cb35-381"><a href="#cb35-381" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 5</span></span>
<span id="cb35-382"><a href="#cb35-382" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: center</span></span>
<span id="cb35-383"><a href="#cb35-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-384"><a href="#cb35-384" aria-hidden="true" tabindex="-1"></a><span class="co">#=== fit ===#</span></span>
<span id="cb35-385"><a href="#cb35-385" aria-hidden="true" tabindex="-1"></a>gam_fit_cv <span class="ot">&lt;-</span> <span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">40</span>, <span class="at">bs =</span> <span class="st">"cr"</span>), <span class="at">data =</span> data)</span>
<span id="cb35-386"><a href="#cb35-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-387"><a href="#cb35-387" aria-hidden="true" tabindex="-1"></a><span class="co">#=== assign the fitted values to a variable ===#</span></span>
<span id="cb35-388"><a href="#cb35-388" aria-hidden="true" tabindex="-1"></a>data[, y_hat <span class="sc">:</span><span class="er">=</span> gam_fit_cv<span class="sc">$</span>fitted.values]</span>
<span id="cb35-389"><a href="#cb35-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-390"><a href="#cb35-390" aria-hidden="true" tabindex="-1"></a><span class="co">#=== plot ===#</span></span>
<span id="cb35-391"><a href="#cb35-391" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> data) <span class="sc">+</span></span>
<span id="cb35-392"><a href="#cb35-392" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_hat, <span class="at">x =</span> x), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb35-393"><a href="#cb35-393" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">x =</span> x), <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb35-394"><a href="#cb35-394" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb35-395"><a href="#cb35-395" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-396"><a href="#cb35-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-397"><a href="#cb35-397" aria-hidden="true" tabindex="-1"></a>You can see that the tuning of <span class="in">`sp`</span> is successful and has resulted in a much better fitted curve compared to the case where <span class="in">`sp`</span> was forced to be 0. As you will see, hyper-parameter tuning will be critical for many of the machine learning methods we will look at later. </span>
<span id="cb35-398"><a href="#cb35-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-399"><a href="#cb35-399" aria-hidden="true" tabindex="-1"></a><span class="fu">## Local Regression {#sec-local}</span></span>
<span id="cb35-400"><a href="#cb35-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-401"><a href="#cb35-401" aria-hidden="true" tabindex="-1"></a>Local regression is a non-parametric method that predicts $y$ at the target value of $X$ (say $x_0$) using the observations that are "close" to it (called neighbors). One of such methods is Nadaraya-Watson (NW) estimator.</span>
<span id="cb35-402"><a href="#cb35-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-403"><a href="#cb35-403" aria-hidden="true" tabindex="-1"></a>Prediction of $y$ at a particular value of $X$ by the NW estimator takes the following steps:</span>
<span id="cb35-404"><a href="#cb35-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-405"><a href="#cb35-405" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Find the weights for all the observations based on the choice of Kernel function ($K(\cdot)$) and bandwidth value ($h$)</span>
<span id="cb35-406"><a href="#cb35-406" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Calculate the weighted mean of $y$</span>
<span id="cb35-407"><a href="#cb35-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-408"><a href="#cb35-408" aria-hidden="true" tabindex="-1"></a>Mathematically, it can be written as follows:</span>
<span id="cb35-409"><a href="#cb35-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-410"><a href="#cb35-410" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb35-411"><a href="#cb35-411" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb35-412"><a href="#cb35-412" aria-hidden="true" tabindex="-1"></a>\hat{f}(X = x_0) &amp; = \sum_{i=1}^N W_i(x_0)\cdot Y_i <span class="sc">\\</span></span>
<span id="cb35-413"><a href="#cb35-413" aria-hidden="true" tabindex="-1"></a>\mbox{where, } W_i(x_0) &amp; = \frac{K(\frac{x_0 - X_i}{h})}{\sum_{i=1}^n K(\frac{x_0 - X_i}{h})}</span>
<span id="cb35-414"><a href="#cb35-414" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb35-415"><a href="#cb35-415" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb35-416"><a href="#cb35-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-417"><a href="#cb35-417" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>$K()$: Kernel function</span>
<span id="cb35-418"><a href="#cb35-418" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>$h$: bandwidth</span>
<span id="cb35-419"><a href="#cb35-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-420"><a href="#cb35-420" aria-hidden="true" tabindex="-1"></a>Note that $\sum_{i=1}^N W_i = 1$, and $W_i(x_0)$ is considered a weight for observation $i$. So, this estimator simply calculates the weighted average of observed values of the dependent variable. </span>
<span id="cb35-421"><a href="#cb35-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-422"><a href="#cb35-422" aria-hidden="true" tabindex="-1"></a>Now, let's have a closer look at the weight. There are many types of Kernel functions. Some of them include</span>
<span id="cb35-423"><a href="#cb35-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-424"><a href="#cb35-424" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Uniform: $K(u) = 1/2\cdot I{|u| &lt; 1}$ </span>
<span id="cb35-425"><a href="#cb35-425" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Epanechnikov: $K(u) = \frac{3}{4}(1-u^2)\cdot I{|u| &lt; 1}$</span>
<span id="cb35-426"><a href="#cb35-426" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Gaussian: $K(u) = \frac{1}{\sqrt{2\pi}}\cdot e^{-\frac{1}{2}u^2}$ (density function of standard normal distribution)</span>
<span id="cb35-427"><a href="#cb35-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-428"><a href="#cb35-428" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb35-429"><a href="#cb35-429" aria-hidden="true" tabindex="-1"></a>$I<span class="sc">\{</span>\cdot<span class="sc">\}</span>$ is an indicator function that takes 1 if the statement inside the curly brackets is true, and 0 otherwise.</span>
<span id="cb35-430"><a href="#cb35-430" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb35-431"><a href="#cb35-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-432"><a href="#cb35-432" aria-hidden="true" tabindex="-1"></a>@fig-kernel presents graphical representations of these functions. </span>
<span id="cb35-433"><a href="#cb35-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-436"><a href="#cb35-436" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-437"><a href="#cb35-437" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Kernel function examples</span></span>
<span id="cb35-438"><a href="#cb35-438" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-kernel </span></span>
<span id="cb35-439"><a href="#cb35-439" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb35-440"><a href="#cb35-440" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 6</span></span>
<span id="cb35-441"><a href="#cb35-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-442"><a href="#cb35-442" aria-hidden="true" tabindex="-1"></a>u_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">3</span>, <span class="at">length =</span> <span class="dv">1000</span>)</span>
<span id="cb35-443"><a href="#cb35-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-444"><a href="#cb35-444" aria-hidden="true" tabindex="-1"></a>uni_data <span class="ot">&lt;-</span> </span>
<span id="cb35-445"><a href="#cb35-445" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(</span>
<span id="cb35-446"><a href="#cb35-446" aria-hidden="true" tabindex="-1"></a>    <span class="at">u =</span> u_seq,</span>
<span id="cb35-447"><a href="#cb35-447" aria-hidden="true" tabindex="-1"></a>    <span class="at">d =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span></span>
<span id="cb35-448"><a href="#cb35-448" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb35-449"><a href="#cb35-449" aria-hidden="true" tabindex="-1"></a>  .[, type <span class="sc">:</span><span class="er">=</span> <span class="st">"Uniform"</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb35-450"><a href="#cb35-450" aria-hidden="true" tabindex="-1"></a>  .[<span class="fu">abs</span>(u) <span class="sc">&gt;</span> <span class="dv">1</span>, d <span class="sc">:</span><span class="er">=</span> <span class="dv">0</span>]</span>
<span id="cb35-451"><a href="#cb35-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-452"><a href="#cb35-452" aria-hidden="true" tabindex="-1"></a>epanechnikov_data <span class="ot">&lt;-</span> </span>
<span id="cb35-453"><a href="#cb35-453" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(</span>
<span id="cb35-454"><a href="#cb35-454" aria-hidden="true" tabindex="-1"></a>    <span class="at">u =</span> u_seq</span>
<span id="cb35-455"><a href="#cb35-455" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb35-456"><a href="#cb35-456" aria-hidden="true" tabindex="-1"></a>  .[, d <span class="sc">:</span><span class="er">=</span> <span class="dv">3</span> <span class="sc">/</span> <span class="dv">4</span> <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>u<span class="sc">^</span><span class="dv">2</span>)] <span class="sc">%&gt;%</span> </span>
<span id="cb35-457"><a href="#cb35-457" aria-hidden="true" tabindex="-1"></a>  .[, type <span class="sc">:</span><span class="er">=</span> <span class="st">"Epanechnikov"</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb35-458"><a href="#cb35-458" aria-hidden="true" tabindex="-1"></a>  .[<span class="fu">abs</span>(u) <span class="sc">&gt;</span> <span class="dv">1</span>, d <span class="sc">:</span><span class="er">=</span> <span class="dv">0</span>]</span>
<span id="cb35-459"><a href="#cb35-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-460"><a href="#cb35-460" aria-hidden="true" tabindex="-1"></a>gaussian_data <span class="ot">&lt;-</span></span>
<span id="cb35-461"><a href="#cb35-461" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(</span>
<span id="cb35-462"><a href="#cb35-462" aria-hidden="true" tabindex="-1"></a>    <span class="at">u =</span> u_seq</span>
<span id="cb35-463"><a href="#cb35-463" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb35-464"><a href="#cb35-464" aria-hidden="true" tabindex="-1"></a>  .[, d <span class="sc">:</span><span class="er">=</span> <span class="fu">dnorm</span>(u)] <span class="sc">%&gt;%</span> </span>
<span id="cb35-465"><a href="#cb35-465" aria-hidden="true" tabindex="-1"></a>  .[, type<span class="sc">:</span><span class="er">=</span> <span class="st">"Gaussian"</span>]</span>
<span id="cb35-466"><a href="#cb35-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-467"><a href="#cb35-467" aria-hidden="true" tabindex="-1"></a>all_data <span class="ot">&lt;-</span> </span>
<span id="cb35-468"><a href="#cb35-468" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbind</span>(uni_data, epanechnikov_data, gaussian_data) <span class="sc">%&gt;%</span> </span>
<span id="cb35-469"><a href="#cb35-469" aria-hidden="true" tabindex="-1"></a>  .[, type <span class="sc">:</span><span class="er">=</span> <span class="fu">factor</span>(type, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Uniform"</span>, <span class="st">"Epanechnikov"</span>, <span class="st">"Gaussian"</span>))]</span>
<span id="cb35-470"><a href="#cb35-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-471"><a href="#cb35-471" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(all_data) <span class="sc">+</span></span>
<span id="cb35-472"><a href="#cb35-472" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> d, <span class="at">x =</span> u), <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb35-473"><a href="#cb35-473" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(type <span class="sc">~</span> .) <span class="sc">+</span></span>
<span id="cb35-474"><a href="#cb35-474" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb35-475"><a href="#cb35-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-476"><a href="#cb35-476" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-477"><a href="#cb35-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-478"><a href="#cb35-478" aria-hidden="true" tabindex="-1"></a>Clearly, the choice of Kernel function affects the weights given to each observation. Bandwidth ($h$) determines how "local" the estimator is. The lower the value of $h$ is, the more "local" the estimator is. Let's see this using the uniform Kernel with bandwidth values of $2$ and $5$. We use the same data generated in @sec-smoothing-splines. Suppose we are interested in estimating <span class="in">`y`</span> at <span class="in">`x = 100`</span>. </span>
<span id="cb35-479"><a href="#cb35-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-480"><a href="#cb35-480" aria-hidden="true" tabindex="-1"></a>@fig-weights presents the the data points on the first row for $h = 2$ (left) and $h=5$ (right) and corresponding weights on the second row $h = 2$ (left) and $h=5$ (right). </span>
<span id="cb35-481"><a href="#cb35-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-482"><a href="#cb35-482" aria-hidden="true" tabindex="-1"></a>As you can see, when $h$ is higher, more data points will involve in estimating $y$: 5 observations when $h=2$ and 12 observations when $h=5$.</span>
<span id="cb35-483"><a href="#cb35-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-486"><a href="#cb35-486" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-487"><a href="#cb35-487" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Weights under h = 2 and h = 5.</span></span>
<span id="cb35-488"><a href="#cb35-488" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-weights</span></span>
<span id="cb35-489"><a href="#cb35-489" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb35-490"><a href="#cb35-490" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------</span></span>
<span id="cb35-491"><a href="#cb35-491" aria-hidden="true" tabindex="-1"></a><span class="co"># h = 2</span></span>
<span id="cb35-492"><a href="#cb35-492" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------</span></span>
<span id="cb35-493"><a href="#cb35-493" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb35-494"><a href="#cb35-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-495"><a href="#cb35-495" aria-hidden="true" tabindex="-1"></a>kernel_data <span class="ot">&lt;-</span> </span>
<span id="cb35-496"><a href="#cb35-496" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(</span>
<span id="cb35-497"><a href="#cb35-497" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">seq</span>(<span class="dv">90</span>, <span class="dv">110</span>, <span class="at">length =</span> <span class="dv">1000</span>),</span>
<span id="cb35-498"><a href="#cb35-498" aria-hidden="true" tabindex="-1"></a>    <span class="at">d =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span></span>
<span id="cb35-499"><a href="#cb35-499" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb35-500"><a href="#cb35-500" aria-hidden="true" tabindex="-1"></a>  .[<span class="fu">abs</span>((x <span class="sc">-</span> <span class="dv">100</span>)<span class="sc">/</span>h) <span class="sc">&gt;</span> <span class="dv">1</span>, d <span class="sc">:</span><span class="er">=</span> <span class="dv">0</span>]</span>
<span id="cb35-501"><a href="#cb35-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-502"><a href="#cb35-502" aria-hidden="true" tabindex="-1"></a>weight_data_h2 <span class="ot">&lt;-</span> </span>
<span id="cb35-503"><a href="#cb35-503" aria-hidden="true" tabindex="-1"></a>  <span class="fu">copy</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb35-504"><a href="#cb35-504" aria-hidden="true" tabindex="-1"></a>  .[, u <span class="sc">:</span><span class="er">=</span> (x <span class="sc">-</span> <span class="dv">100</span>) <span class="sc">/</span> h] <span class="sc">%&gt;%</span> </span>
<span id="cb35-505"><a href="#cb35-505" aria-hidden="true" tabindex="-1"></a>  .[, weight <span class="sc">:</span><span class="er">=</span> <span class="fu">fifelse</span>(<span class="fu">abs</span>(u) <span class="sc">&lt;=</span> <span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="dv">0</span>)] <span class="sc">%&gt;%</span> </span>
<span id="cb35-506"><a href="#cb35-506" aria-hidden="true" tabindex="-1"></a>  .[weight <span class="sc">!=</span> <span class="dv">0</span>, id <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span><span class="sc">:</span>.N]</span>
<span id="cb35-507"><a href="#cb35-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-508"><a href="#cb35-508" aria-hidden="true" tabindex="-1"></a>g_point_h2 <span class="ot">&lt;-</span> </span>
<span id="cb35-509"><a href="#cb35-509" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb35-510"><a href="#cb35-510" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb35-511"><a href="#cb35-511" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> weight_data_h2, </span>
<span id="cb35-512"><a href="#cb35-512" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">x =</span> x),</span>
<span id="cb35-513"><a href="#cb35-513" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">0.5</span></span>
<span id="cb35-514"><a href="#cb35-514" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb35-515"><a href="#cb35-515" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb35-516"><a href="#cb35-516" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> weight_data_h2[weight <span class="sc">!=</span> <span class="dv">0</span>, ], </span>
<span id="cb35-517"><a href="#cb35-517" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">x =</span> x),</span>
<span id="cb35-518"><a href="#cb35-518" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span></span>
<span id="cb35-519"><a href="#cb35-519" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb35-520"><a href="#cb35-520" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb35-521"><a href="#cb35-521" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> weight_data_h2[weight <span class="sc">!=</span> <span class="dv">0</span>, ], </span>
<span id="cb35-522"><a href="#cb35-522" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> y , <span class="at">x =</span> x <span class="sc">-</span> <span class="dv">1</span>, <span class="at">label =</span> id),</span>
<span id="cb35-523"><a href="#cb35-523" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"blue"</span>,</span>
<span id="cb35-524"><a href="#cb35-524" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb35-525"><a href="#cb35-525" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb35-526"><a href="#cb35-526" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb35-527"><a href="#cb35-527" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">90</span>, <span class="dv">110</span>) <span class="sc">+</span></span>
<span id="cb35-528"><a href="#cb35-528" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Data points: h = 2"</span>)</span>
<span id="cb35-529"><a href="#cb35-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-530"><a href="#cb35-530" aria-hidden="true" tabindex="-1"></a>g_weight_h2 <span class="ot">&lt;-</span></span>
<span id="cb35-531"><a href="#cb35-531" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb35-532"><a href="#cb35-532" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb35-533"><a href="#cb35-533" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> kernel_data,</span>
<span id="cb35-534"><a href="#cb35-534" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> d, <span class="at">x =</span> x)</span>
<span id="cb35-535"><a href="#cb35-535" aria-hidden="true" tabindex="-1"></a>  )  <span class="sc">+</span></span>
<span id="cb35-536"><a href="#cb35-536" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb35-537"><a href="#cb35-537" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> weight_data_h2[weight<span class="sc">!=</span><span class="dv">0</span>, ], </span>
<span id="cb35-538"><a href="#cb35-538" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> weight, <span class="at">x =</span> x),</span>
<span id="cb35-539"><a href="#cb35-539" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span></span>
<span id="cb35-540"><a href="#cb35-540" aria-hidden="true" tabindex="-1"></a>  )  <span class="sc">+</span></span>
<span id="cb35-541"><a href="#cb35-541" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb35-542"><a href="#cb35-542" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> weight_data_h2[weight<span class="sc">==</span><span class="dv">0</span>, ], </span>
<span id="cb35-543"><a href="#cb35-543" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> weight, <span class="at">x =</span> x),</span>
<span id="cb35-544"><a href="#cb35-544" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"black"</span></span>
<span id="cb35-545"><a href="#cb35-545" aria-hidden="true" tabindex="-1"></a>  )  <span class="sc">+</span></span>
<span id="cb35-546"><a href="#cb35-546" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb35-547"><a href="#cb35-547" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> weight_data_h2[weight <span class="sc">!=</span> <span class="dv">0</span>, ], </span>
<span id="cb35-548"><a href="#cb35-548" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> weight <span class="sc">+</span> <span class="fl">0.02</span>, <span class="at">x =</span> x, <span class="at">label =</span> id),</span>
<span id="cb35-549"><a href="#cb35-549" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"blue"</span>,</span>
<span id="cb35-550"><a href="#cb35-550" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb35-551"><a href="#cb35-551" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb35-552"><a href="#cb35-552" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">90</span>, <span class="dv">110</span>) <span class="sc">+</span></span>
<span id="cb35-553"><a href="#cb35-553" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb35-554"><a href="#cb35-554" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"K((x - 100)/h)"</span>) <span class="sc">+</span></span>
<span id="cb35-555"><a href="#cb35-555" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"x"</span>) <span class="sc">+</span></span>
<span id="cb35-556"><a href="#cb35-556" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Corresponding weights: h = 2"</span>)</span>
<span id="cb35-557"><a href="#cb35-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-558"><a href="#cb35-558" aria-hidden="true" tabindex="-1"></a>g_h2 <span class="ot">&lt;-</span> g_point_h2 <span class="sc">/</span> g_weight_h2</span>
<span id="cb35-559"><a href="#cb35-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-560"><a href="#cb35-560" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------</span></span>
<span id="cb35-561"><a href="#cb35-561" aria-hidden="true" tabindex="-1"></a><span class="co"># h = 2</span></span>
<span id="cb35-562"><a href="#cb35-562" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------------------</span></span>
<span id="cb35-563"><a href="#cb35-563" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb35-564"><a href="#cb35-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-565"><a href="#cb35-565" aria-hidden="true" tabindex="-1"></a>kernel_data <span class="ot">&lt;-</span> </span>
<span id="cb35-566"><a href="#cb35-566" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(</span>
<span id="cb35-567"><a href="#cb35-567" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">seq</span>(<span class="dv">90</span>, <span class="dv">110</span>, <span class="at">length =</span> <span class="dv">1000</span>),</span>
<span id="cb35-568"><a href="#cb35-568" aria-hidden="true" tabindex="-1"></a>    <span class="at">d =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span></span>
<span id="cb35-569"><a href="#cb35-569" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb35-570"><a href="#cb35-570" aria-hidden="true" tabindex="-1"></a>  .[<span class="fu">abs</span>((x <span class="sc">-</span> <span class="dv">100</span>)<span class="sc">/</span>h) <span class="sc">&gt;</span> <span class="dv">1</span>, d <span class="sc">:</span><span class="er">=</span> <span class="dv">0</span>]</span>
<span id="cb35-571"><a href="#cb35-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-572"><a href="#cb35-572" aria-hidden="true" tabindex="-1"></a>weight_data_h5 <span class="ot">&lt;-</span> </span>
<span id="cb35-573"><a href="#cb35-573" aria-hidden="true" tabindex="-1"></a>  <span class="fu">copy</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb35-574"><a href="#cb35-574" aria-hidden="true" tabindex="-1"></a>  .[, u <span class="sc">:</span><span class="er">=</span> (x <span class="sc">-</span> <span class="dv">100</span>) <span class="sc">/</span> h] <span class="sc">%&gt;%</span> </span>
<span id="cb35-575"><a href="#cb35-575" aria-hidden="true" tabindex="-1"></a>  .[, weight <span class="sc">:</span><span class="er">=</span> <span class="fu">fifelse</span>(<span class="fu">abs</span>(u) <span class="sc">&lt;=</span> <span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="dv">0</span>)] <span class="sc">%&gt;%</span> </span>
<span id="cb35-576"><a href="#cb35-576" aria-hidden="true" tabindex="-1"></a>  .[weight <span class="sc">!=</span> <span class="dv">0</span>, id <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span><span class="sc">:</span>.N]</span>
<span id="cb35-577"><a href="#cb35-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-578"><a href="#cb35-578" aria-hidden="true" tabindex="-1"></a>g_point_h5 <span class="ot">&lt;-</span> </span>
<span id="cb35-579"><a href="#cb35-579" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb35-580"><a href="#cb35-580" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb35-581"><a href="#cb35-581" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> weight_data_h5, </span>
<span id="cb35-582"><a href="#cb35-582" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">x =</span> x),</span>
<span id="cb35-583"><a href="#cb35-583" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">0.5</span></span>
<span id="cb35-584"><a href="#cb35-584" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb35-585"><a href="#cb35-585" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb35-586"><a href="#cb35-586" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> weight_data_h5[weight <span class="sc">!=</span> <span class="dv">0</span>, ], </span>
<span id="cb35-587"><a href="#cb35-587" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">x =</span> x),</span>
<span id="cb35-588"><a href="#cb35-588" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span></span>
<span id="cb35-589"><a href="#cb35-589" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb35-590"><a href="#cb35-590" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb35-591"><a href="#cb35-591" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> weight_data_h5[weight <span class="sc">!=</span> <span class="dv">0</span>, ], </span>
<span id="cb35-592"><a href="#cb35-592" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> y , <span class="at">x =</span> x <span class="sc">-</span> <span class="dv">1</span>, <span class="at">label =</span> id),</span>
<span id="cb35-593"><a href="#cb35-593" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"blue"</span>,</span>
<span id="cb35-594"><a href="#cb35-594" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb35-595"><a href="#cb35-595" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb35-596"><a href="#cb35-596" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb35-597"><a href="#cb35-597" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">90</span>, <span class="dv">110</span>) <span class="sc">+</span></span>
<span id="cb35-598"><a href="#cb35-598" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Data points: h = 5"</span>)</span>
<span id="cb35-599"><a href="#cb35-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-600"><a href="#cb35-600" aria-hidden="true" tabindex="-1"></a>g_weight_h5 <span class="ot">&lt;-</span></span>
<span id="cb35-601"><a href="#cb35-601" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb35-602"><a href="#cb35-602" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb35-603"><a href="#cb35-603" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> kernel_data,</span>
<span id="cb35-604"><a href="#cb35-604" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> d, <span class="at">x =</span> x)</span>
<span id="cb35-605"><a href="#cb35-605" aria-hidden="true" tabindex="-1"></a>  )  <span class="sc">+</span></span>
<span id="cb35-606"><a href="#cb35-606" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb35-607"><a href="#cb35-607" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> weight_data_h5[weight<span class="sc">!=</span><span class="dv">0</span>, ], </span>
<span id="cb35-608"><a href="#cb35-608" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> weight, <span class="at">x =</span> x),</span>
<span id="cb35-609"><a href="#cb35-609" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span></span>
<span id="cb35-610"><a href="#cb35-610" aria-hidden="true" tabindex="-1"></a>  )  <span class="sc">+</span></span>
<span id="cb35-611"><a href="#cb35-611" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb35-612"><a href="#cb35-612" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> weight_data_h5[weight<span class="sc">==</span><span class="dv">0</span>, ], </span>
<span id="cb35-613"><a href="#cb35-613" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> weight, <span class="at">x =</span> x),</span>
<span id="cb35-614"><a href="#cb35-614" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"black"</span></span>
<span id="cb35-615"><a href="#cb35-615" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb35-616"><a href="#cb35-616" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb35-617"><a href="#cb35-617" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> weight_data_h5[weight <span class="sc">!=</span> <span class="dv">0</span>, ], </span>
<span id="cb35-618"><a href="#cb35-618" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> weight <span class="sc">+</span> <span class="fl">0.02</span>, <span class="at">x =</span> x, <span class="at">label =</span> id),</span>
<span id="cb35-619"><a href="#cb35-619" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"blue"</span>,</span>
<span id="cb35-620"><a href="#cb35-620" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb35-621"><a href="#cb35-621" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb35-622"><a href="#cb35-622" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">90</span>, <span class="dv">110</span>) <span class="sc">+</span></span>
<span id="cb35-623"><a href="#cb35-623" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb35-624"><a href="#cb35-624" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"K((x - 100)/h)"</span>) <span class="sc">+</span></span>
<span id="cb35-625"><a href="#cb35-625" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"x"</span>) <span class="sc">+</span></span>
<span id="cb35-626"><a href="#cb35-626" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Corresponding weights: h = 5"</span>)</span>
<span id="cb35-627"><a href="#cb35-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-628"><a href="#cb35-628" aria-hidden="true" tabindex="-1"></a>g_h5 <span class="ot">&lt;-</span> g_point_h5 <span class="sc">/</span> g_weight_h5</span>
<span id="cb35-629"><a href="#cb35-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-630"><a href="#cb35-630" aria-hidden="true" tabindex="-1"></a>g_h2 <span class="sc">|</span> g_h5</span>
<span id="cb35-631"><a href="#cb35-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-632"><a href="#cb35-632" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-633"><a href="#cb35-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-634"><a href="#cb35-634" aria-hidden="true" tabindex="-1"></a>Let's write a code to predict <span class="in">`y`</span> at several different values of <span class="in">`x`</span> using <span class="in">`data`</span> for illustration. We will use the Epanechnikov Kernel function with bandwidth value of $20$. First, we work on prediction at <span class="in">`x = 120`</span>.</span>
<span id="cb35-635"><a href="#cb35-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-636"><a href="#cb35-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-639"><a href="#cb35-639" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-640"><a href="#cb35-640" aria-hidden="true" tabindex="-1"></a>x0 <span class="ot">&lt;-</span> <span class="dv">120</span></span>
<span id="cb35-641"><a href="#cb35-641" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb35-642"><a href="#cb35-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-643"><a href="#cb35-643" aria-hidden="true" tabindex="-1"></a>lr_data <span class="ot">&lt;-</span></span>
<span id="cb35-644"><a href="#cb35-644" aria-hidden="true" tabindex="-1"></a>  <span class="fu">copy</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb35-645"><a href="#cb35-645" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== calculate u ===#</span></span>
<span id="cb35-646"><a href="#cb35-646" aria-hidden="true" tabindex="-1"></a>  .[, u <span class="sc">:</span><span class="er">=</span> (x <span class="sc">-</span> x0)<span class="sc">/</span>h] <span class="sc">%&gt;%</span> </span>
<span id="cb35-647"><a href="#cb35-647" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== K(u) ===#</span></span>
<span id="cb35-648"><a href="#cb35-648" aria-hidden="true" tabindex="-1"></a>  .[, k_of_u <span class="sc">:</span><span class="er">=</span> <span class="dv">3</span> <span class="sc">/</span> <span class="dv">4</span> <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>u<span class="sc">^</span><span class="dv">2</span>)] <span class="sc">%&gt;%</span> </span>
<span id="cb35-649"><a href="#cb35-649" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== turn k_of_u to 0 if abs(u) &gt; 1  ===#</span></span>
<span id="cb35-650"><a href="#cb35-650" aria-hidden="true" tabindex="-1"></a>  .[<span class="fu">abs</span>(u) <span class="sc">&gt;=</span> <span class="dv">1</span>, k_of_u <span class="sc">:</span><span class="er">=</span> <span class="dv">0</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb35-651"><a href="#cb35-651" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== find the weight ===#</span></span>
<span id="cb35-652"><a href="#cb35-652" aria-hidden="true" tabindex="-1"></a>  .[, weight <span class="sc">:</span><span class="er">=</span> k_of_u <span class="sc">/</span> <span class="fu">sum</span>(k_of_u)]</span>
<span id="cb35-653"><a href="#cb35-653" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-654"><a href="#cb35-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-655"><a href="#cb35-655" aria-hidden="true" tabindex="-1"></a>Here are some of the data points that have non-zero weights:</span>
<span id="cb35-656"><a href="#cb35-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-659"><a href="#cb35-659" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-660"><a href="#cb35-660" aria-hidden="true" tabindex="-1"></a>lr_data[weight <span class="sc">!=</span> <span class="dv">0</span>, .(x, y, k_of_u, weight)] <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span>
<span id="cb35-661"><a href="#cb35-661" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-662"><a href="#cb35-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-663"><a href="#cb35-663" aria-hidden="true" tabindex="-1"></a>We can then simply calculate the weighted mean.</span>
<span id="cb35-664"><a href="#cb35-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-667"><a href="#cb35-667" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-668"><a href="#cb35-668" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb35-669"><a href="#cb35-669" aria-hidden="true" tabindex="-1"></a>y_hat_x120 <span class="ot">&lt;-</span> lr_data[, <span class="fu">sum</span>(weight <span class="sc">*</span> y)]</span>
<span id="cb35-670"><a href="#cb35-670" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-671"><a href="#cb35-671" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-672"><a href="#cb35-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-673"><a href="#cb35-673" aria-hidden="true" tabindex="-1"></a>We can do this for many values of $X$ and and connects the dots to find the "fitted curve." First, let's define a function that predicts <span class="in">`y`</span> at a particular value of <span class="in">`x`</span> using the Epanechnikov Kernel function for a given value of $h$. </span>
<span id="cb35-674"><a href="#cb35-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-677"><a href="#cb35-677" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-678"><a href="#cb35-678" aria-hidden="true" tabindex="-1"></a>est_y_nw <span class="ot">&lt;-</span> <span class="cf">function</span>(x0, data, h)</span>
<span id="cb35-679"><a href="#cb35-679" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb35-680"><a href="#cb35-680" aria-hidden="true" tabindex="-1"></a>  y_hat <span class="ot">&lt;-</span></span>
<span id="cb35-681"><a href="#cb35-681" aria-hidden="true" tabindex="-1"></a>    <span class="fu">copy</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb35-682"><a href="#cb35-682" aria-hidden="true" tabindex="-1"></a>    <span class="co">#=== calculate u ===#</span></span>
<span id="cb35-683"><a href="#cb35-683" aria-hidden="true" tabindex="-1"></a>    .[, u <span class="sc">:</span><span class="er">=</span> (x <span class="sc">-</span> x0)<span class="sc">/</span>h] <span class="sc">%&gt;%</span> </span>
<span id="cb35-684"><a href="#cb35-684" aria-hidden="true" tabindex="-1"></a>    <span class="co">#=== K(u) ===#</span></span>
<span id="cb35-685"><a href="#cb35-685" aria-hidden="true" tabindex="-1"></a>    .[, k_of_u <span class="sc">:</span><span class="er">=</span> <span class="dv">3</span> <span class="sc">/</span> <span class="dv">4</span> <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>u<span class="sc">^</span><span class="dv">2</span>)] <span class="sc">%&gt;%</span> </span>
<span id="cb35-686"><a href="#cb35-686" aria-hidden="true" tabindex="-1"></a>    <span class="co">#=== turn k_of_u to 0 if abs(u) &gt; 1  ===#</span></span>
<span id="cb35-687"><a href="#cb35-687" aria-hidden="true" tabindex="-1"></a>    .[<span class="fu">abs</span>(u) <span class="sc">&gt;=</span> <span class="dv">1</span>, k_of_u <span class="sc">:</span><span class="er">=</span> <span class="dv">0</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb35-688"><a href="#cb35-688" aria-hidden="true" tabindex="-1"></a>    <span class="co">#=== find the weight ===#</span></span>
<span id="cb35-689"><a href="#cb35-689" aria-hidden="true" tabindex="-1"></a>    .[, weight <span class="sc">:</span><span class="er">=</span> k_of_u <span class="sc">/</span> <span class="fu">sum</span>(k_of_u)] <span class="sc">%&gt;%</span> </span>
<span id="cb35-690"><a href="#cb35-690" aria-hidden="true" tabindex="-1"></a>    .[, <span class="fu">sum</span>(weight <span class="sc">*</span> y)]</span>
<span id="cb35-691"><a href="#cb35-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-692"><a href="#cb35-692" aria-hidden="true" tabindex="-1"></a>  return_data <span class="ot">&lt;-</span></span>
<span id="cb35-693"><a href="#cb35-693" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.table</span>(</span>
<span id="cb35-694"><a href="#cb35-694" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> x0,</span>
<span id="cb35-695"><a href="#cb35-695" aria-hidden="true" tabindex="-1"></a>      <span class="at">y_hat =</span> y_hat</span>
<span id="cb35-696"><a href="#cb35-696" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-697"><a href="#cb35-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-698"><a href="#cb35-698" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(return_data)</span>
<span id="cb35-699"><a href="#cb35-699" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-700"><a href="#cb35-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-701"><a href="#cb35-701" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-702"><a href="#cb35-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-703"><a href="#cb35-703" aria-hidden="true" tabindex="-1"></a>Now, we do predictions at various values of <span class="in">`x`</span>.</span>
<span id="cb35-704"><a href="#cb35-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-707"><a href="#cb35-707" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-708"><a href="#cb35-708" aria-hidden="true" tabindex="-1"></a><span class="co">#=== sequence of values of x to do predictions at ===#</span></span>
<span id="cb35-709"><a href="#cb35-709" aria-hidden="true" tabindex="-1"></a>x_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(data[, <span class="fu">min</span>(x)], data[, <span class="fu">max</span>(x)], <span class="at">length =</span> <span class="dv">100</span>)</span>
<span id="cb35-710"><a href="#cb35-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-711"><a href="#cb35-711" aria-hidden="true" tabindex="-1"></a><span class="co">#=== predict ===#</span></span>
<span id="cb35-712"><a href="#cb35-712" aria-hidden="true" tabindex="-1"></a>y_hat_lc <span class="ot">&lt;-</span></span>
<span id="cb35-713"><a href="#cb35-713" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb35-714"><a href="#cb35-714" aria-hidden="true" tabindex="-1"></a>    x_seq,</span>
<span id="cb35-715"><a href="#cb35-715" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">est_y_nw</span>(x, data, h)</span>
<span id="cb35-716"><a href="#cb35-716" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb35-717"><a href="#cb35-717" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb35-718"><a href="#cb35-718" aria-hidden="true" tabindex="-1"></a>  .[, type <span class="sc">:</span><span class="er">=</span> <span class="st">"Local Constant"</span>]</span>
<span id="cb35-719"><a href="#cb35-719" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-720"><a href="#cb35-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-721"><a href="#cb35-721" aria-hidden="true" tabindex="-1"></a>@fig-nw visualizes the prediction results. </span>
<span id="cb35-722"><a href="#cb35-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-725"><a href="#cb35-725" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-726"><a href="#cb35-726" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb35-727"><a href="#cb35-727" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Predictions at various values of x</span></span>
<span id="cb35-728"><a href="#cb35-728" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-nw</span></span>
<span id="cb35-729"><a href="#cb35-729" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: center</span></span>
<span id="cb35-730"><a href="#cb35-730" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 5</span></span>
<span id="cb35-731"><a href="#cb35-731" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4</span></span>
<span id="cb35-732"><a href="#cb35-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-733"><a href="#cb35-733" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb35-734"><a href="#cb35-734" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb35-735"><a href="#cb35-735" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> y_hat_lc,</span>
<span id="cb35-736"><a href="#cb35-736" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> y_hat, <span class="at">x =</span> x),</span>
<span id="cb35-737"><a href="#cb35-737" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span></span>
<span id="cb35-738"><a href="#cb35-738" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb35-739"><a href="#cb35-739" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb35-740"><a href="#cb35-740" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> y_hat_lc,</span>
<span id="cb35-741"><a href="#cb35-741" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> y_hat, <span class="at">x =</span> x),</span>
<span id="cb35-742"><a href="#cb35-742" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span>,</span>
<span id="cb35-743"><a href="#cb35-743" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">0.6</span></span>
<span id="cb35-744"><a href="#cb35-744" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb35-745"><a href="#cb35-745" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb35-746"><a href="#cb35-746" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data,</span>
<span id="cb35-747"><a href="#cb35-747" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">x =</span> x),</span>
<span id="cb35-748"><a href="#cb35-748" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">0.6</span></span>
<span id="cb35-749"><a href="#cb35-749" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb35-750"><a href="#cb35-750" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb35-751"><a href="#cb35-751" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-752"><a href="#cb35-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-753"><a href="#cb35-753" aria-hidden="true" tabindex="-1"></a>One critical difference between local non-parametric regression and smoothing splines is that the former fits the data locally (unless $h$ is very high) while smoothing splines fits the data globally (it uses all the data points to fit a single curve).</span>
<span id="cb35-754"><a href="#cb35-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-755"><a href="#cb35-755" aria-hidden="true" tabindex="-1"></a>Another important distinction between the two approaches is that local non-parametric regression requires going through the entire process above whenever predicting $y$ at a particular value of $X$. This means that you need the entire train dataset every time. On the other hand, once smoothing splines regression is conducted, then you no longer need the train data any more because the fitted curve is characterized completely by the basis functions and their estimated coefficients.</span>
<span id="cb35-756"><a href="#cb35-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-757"><a href="#cb35-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-758"><a href="#cb35-758" aria-hidden="true" tabindex="-1"></a>Now, let's see how the choice of $h$ affects the fitted "curve." We will try <span class="in">`h = 2, 10, 20, 50`</span></span>
<span id="cb35-759"><a href="#cb35-759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-762"><a href="#cb35-762" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-763"><a href="#cb35-763" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb35-764"><a href="#cb35-764" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Fitted curves at different values of h </span></span>
<span id="cb35-765"><a href="#cb35-765" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-fitted-curves-h</span></span>
<span id="cb35-766"><a href="#cb35-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-767"><a href="#cb35-767" aria-hidden="true" tabindex="-1"></a>get_y_hat_given_h <span class="ot">&lt;-</span> <span class="cf">function</span>(data, x_seq, h_val)</span>
<span id="cb35-768"><a href="#cb35-768" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb35-769"><a href="#cb35-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-770"><a href="#cb35-770" aria-hidden="true" tabindex="-1"></a>  return_data <span class="ot">&lt;-</span></span>
<span id="cb35-771"><a href="#cb35-771" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(</span>
<span id="cb35-772"><a href="#cb35-772" aria-hidden="true" tabindex="-1"></a>      x_seq,</span>
<span id="cb35-773"><a href="#cb35-773" aria-hidden="true" tabindex="-1"></a>      <span class="cf">function</span>(x) <span class="fu">est_y_nw</span>(x, data, h_val)</span>
<span id="cb35-774"><a href="#cb35-774" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb35-775"><a href="#cb35-775" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbindlist</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb35-776"><a href="#cb35-776" aria-hidden="true" tabindex="-1"></a>    .[, h <span class="sc">:</span><span class="er">=</span> h_val]</span>
<span id="cb35-777"><a href="#cb35-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-778"><a href="#cb35-778" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(return_data)</span>
<span id="cb35-779"><a href="#cb35-779" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-780"><a href="#cb35-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-781"><a href="#cb35-781" aria-hidden="true" tabindex="-1"></a>y_hat_h_various <span class="ot">&lt;-</span> </span>
<span id="cb35-782"><a href="#cb35-782" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb35-783"><a href="#cb35-783" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">50</span>),</span>
<span id="cb35-784"><a href="#cb35-784" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">get_y_hat_given_h</span>(data, x_seq, x)</span>
<span id="cb35-785"><a href="#cb35-785" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb35-786"><a href="#cb35-786" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>()</span>
<span id="cb35-787"><a href="#cb35-787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-788"><a href="#cb35-788" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(y_hat_h_various) <span class="sc">+</span></span>
<span id="cb35-789"><a href="#cb35-789" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> data, <span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">x =</span> x), <span class="at">size =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb35-790"><a href="#cb35-790" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_hat, <span class="at">x =</span> x), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb35-791"><a href="#cb35-791" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(h <span class="sc">~</span> .) <span class="sc">+</span></span>
<span id="cb35-792"><a href="#cb35-792" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb35-793"><a href="#cb35-793" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-794"><a href="#cb35-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-795"><a href="#cb35-795" aria-hidden="true" tabindex="-1"></a>As you can see in @fig-fitted-curves-h, at $h = 2$, the fitted curve is extremely wiggly and over-fitted. Increasing the value of $h$ make the fitted curves smoother. Nobody uses NW estimator for any practical applications when the problem at hand is high-dimensional as it suffers from the curse of dimensionality. However, NW estimator is a great example to illustrate the importance of the choice of an arbitrary parameter (hyper-parameter). As discussed above, we will later look at cross-validation as a way to tune hyper-parameters.</span>
<span id="cb35-796"><a href="#cb35-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-797"><a href="#cb35-797" aria-hidden="true" tabindex="-1"></a><span class="fu">### Local linear regression {#sec-local-reg}</span></span>
<span id="cb35-798"><a href="#cb35-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-799"><a href="#cb35-799" aria-hidden="true" tabindex="-1"></a>The NW estimator is a locally constant regression. You can see this from the fact that the NW estimator comes from solving the following minimization problem:</span>
<span id="cb35-800"><a href="#cb35-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-801"><a href="#cb35-801" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb35-802"><a href="#cb35-802" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb35-803"><a href="#cb35-803" aria-hidden="true" tabindex="-1"></a>\hat{f}(x = x_0) = argmin_{\alpha} \sum_{i=1}^N W_i(x_0)(Y_i - \alpha)^2</span>
<span id="cb35-804"><a href="#cb35-804" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb35-805"><a href="#cb35-805" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb35-806"><a href="#cb35-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-807"><a href="#cb35-807" aria-hidden="true" tabindex="-1"></a>By modifying the objective function slightly, we will have local linear regression:</span>
<span id="cb35-808"><a href="#cb35-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-809"><a href="#cb35-809" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb35-810"><a href="#cb35-810" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb35-811"><a href="#cb35-811" aria-hidden="true" tabindex="-1"></a><span class="sc">\{</span>\hat{\alpha}, \hat{\beta}<span class="sc">\}</span> = argmin_{\alpha,\beta} \sum_{i=1}^N W_i(x_0)(Y_i - \alpha - \beta (x_i - x_0))^2</span>
<span id="cb35-812"><a href="#cb35-812" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb35-813"><a href="#cb35-813" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb35-814"><a href="#cb35-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-815"><a href="#cb35-815" aria-hidden="true" tabindex="-1"></a>Then the fitted value is given by $\hat{f}(x = x_0) = \hat{\alpha}$. This is because the value of $x$ is re-centered around the evaluation point. Alternatively, you can solve the following without re-centering,</span>
<span id="cb35-816"><a href="#cb35-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-817"><a href="#cb35-817" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb35-818"><a href="#cb35-818" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb35-819"><a href="#cb35-819" aria-hidden="true" tabindex="-1"></a><span class="sc">\{</span>\hat{\alpha}, \hat{\beta}<span class="sc">\}</span> = argmin_{\alpha,\beta} \sum_{i=1}^N W_i(x_0)(Y_i - \alpha - \beta x_i)^2</span>
<span id="cb35-820"><a href="#cb35-820" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb35-821"><a href="#cb35-821" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb35-822"><a href="#cb35-822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-823"><a href="#cb35-823" aria-hidden="true" tabindex="-1"></a>, and then calculate $\hat{f}(x = x_0) = \hat{\alpha} + \hat{\beta}x_0$. They will provide the same estimate of $\hat{f}(x = x_0)$.</span>
<span id="cb35-824"><a href="#cb35-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-825"><a href="#cb35-825" aria-hidden="true" tabindex="-1"></a>Let's implement this as an illustration for $x_0 = 150$ with the Epanechnikov kernel function with $h=20$.</span>
<span id="cb35-826"><a href="#cb35-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-827"><a href="#cb35-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-830"><a href="#cb35-830" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-831"><a href="#cb35-831" aria-hidden="true" tabindex="-1"></a>x0 <span class="ot">&lt;-</span> <span class="dv">150</span></span>
<span id="cb35-832"><a href="#cb35-832" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb35-833"><a href="#cb35-833" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-834"><a href="#cb35-834" aria-hidden="true" tabindex="-1"></a>lr_data <span class="ot">&lt;-</span></span>
<span id="cb35-835"><a href="#cb35-835" aria-hidden="true" tabindex="-1"></a>  <span class="fu">copy</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb35-836"><a href="#cb35-836" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== calculate u ===#</span></span>
<span id="cb35-837"><a href="#cb35-837" aria-hidden="true" tabindex="-1"></a>  .[, u <span class="sc">:</span><span class="er">=</span> (x <span class="sc">-</span> x0)<span class="sc">/</span>h] <span class="sc">%&gt;%</span> </span>
<span id="cb35-838"><a href="#cb35-838" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== K(u) ===#</span></span>
<span id="cb35-839"><a href="#cb35-839" aria-hidden="true" tabindex="-1"></a>  .[, k_of_u <span class="sc">:</span><span class="er">=</span> <span class="dv">3</span> <span class="sc">/</span> <span class="dv">4</span> <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>u<span class="sc">^</span><span class="dv">2</span>)] <span class="sc">%&gt;%</span> </span>
<span id="cb35-840"><a href="#cb35-840" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== turn k_of_u to 0 if abs(u) &gt; 1  ===#</span></span>
<span id="cb35-841"><a href="#cb35-841" aria-hidden="true" tabindex="-1"></a>  .[<span class="fu">abs</span>(u) <span class="sc">&gt;=</span> <span class="dv">1</span>, k_of_u <span class="sc">:</span><span class="er">=</span> <span class="dv">0</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb35-842"><a href="#cb35-842" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== find the weight ===#</span></span>
<span id="cb35-843"><a href="#cb35-843" aria-hidden="true" tabindex="-1"></a>  .[, weight <span class="sc">:</span><span class="er">=</span> k_of_u <span class="sc">/</span> <span class="fu">sum</span>(k_of_u)] <span class="sc">%&gt;%</span> </span>
<span id="cb35-844"><a href="#cb35-844" aria-hidden="true" tabindex="-1"></a>  .[, x_diff <span class="sc">:</span><span class="er">=</span> x <span class="sc">-</span> x0]</span>
<span id="cb35-845"><a href="#cb35-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-846"><a href="#cb35-846" aria-hidden="true" tabindex="-1"></a><span class="co">#=== run linear regression with the weights ===#</span></span>
<span id="cb35-847"><a href="#cb35-847" aria-hidden="true" tabindex="-1"></a>ols_res <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x_diff, <span class="at">data =</span> lr_data, <span class="at">weights =</span> weight)</span>
<span id="cb35-848"><a href="#cb35-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-849"><a href="#cb35-849" aria-hidden="true" tabindex="-1"></a><span class="co">#=== predict ===#</span></span>
<span id="cb35-850"><a href="#cb35-850" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb35-851"><a href="#cb35-851" aria-hidden="true" tabindex="-1"></a>y_hat_x0 <span class="ot">&lt;-</span> ols_res<span class="sc">$</span>coefficient[<span class="st">"(Intercept)"</span>]</span>
<span id="cb35-852"><a href="#cb35-852" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-853"><a href="#cb35-853" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-854"><a href="#cb35-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-855"><a href="#cb35-855" aria-hidden="true" tabindex="-1"></a>Alternatively,</span>
<span id="cb35-856"><a href="#cb35-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-859"><a href="#cb35-859" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-860"><a href="#cb35-860" aria-hidden="true" tabindex="-1"></a><span class="co">#=== run linear regression with the weights no centering around x0 ===#</span></span>
<span id="cb35-861"><a href="#cb35-861" aria-hidden="true" tabindex="-1"></a>ols_res <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x, <span class="at">data =</span> lr_data, <span class="at">weights =</span> weight)</span>
<span id="cb35-862"><a href="#cb35-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-863"><a href="#cb35-863" aria-hidden="true" tabindex="-1"></a><span class="co">#=== predict ===#</span></span>
<span id="cb35-864"><a href="#cb35-864" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb35-865"><a href="#cb35-865" aria-hidden="true" tabindex="-1"></a>y_hat_x0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(ols_res, <span class="at">newdata =</span> <span class="fu">data.table</span>(<span class="at">x =</span> x0))</span>
<span id="cb35-866"><a href="#cb35-866" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-867"><a href="#cb35-867" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-868"><a href="#cb35-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-869"><a href="#cb35-869" aria-hidden="true" tabindex="-1"></a>Local linear regression is better than local constant regression if the underlying curve is significantly non-linear instead of a flat line. Local linear regression also does better near the boundary of the support of $x$. @fig-nw-ll presents predicted values by local constant and linear regressions. In this case, it is hard to see the difference between the two except at the edges of $x$ support. </span>
<span id="cb35-870"><a href="#cb35-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-873"><a href="#cb35-873" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-874"><a href="#cb35-874" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb35-875"><a href="#cb35-875" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Predictions at various values of x by NW and LL</span></span>
<span id="cb35-876"><a href="#cb35-876" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-nw-ll</span></span>
<span id="cb35-877"><a href="#cb35-877" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: center</span></span>
<span id="cb35-878"><a href="#cb35-878" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 6</span></span>
<span id="cb35-879"><a href="#cb35-879" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 5</span></span>
<span id="cb35-880"><a href="#cb35-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-881"><a href="#cb35-881" aria-hidden="true" tabindex="-1"></a>est_y_ll <span class="ot">&lt;-</span> <span class="cf">function</span>(x0, data, h){</span>
<span id="cb35-882"><a href="#cb35-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-883"><a href="#cb35-883" aria-hidden="true" tabindex="-1"></a>  lr_data <span class="ot">&lt;-</span></span>
<span id="cb35-884"><a href="#cb35-884" aria-hidden="true" tabindex="-1"></a>    <span class="fu">copy</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb35-885"><a href="#cb35-885" aria-hidden="true" tabindex="-1"></a>    <span class="co">#=== calculate u ===#</span></span>
<span id="cb35-886"><a href="#cb35-886" aria-hidden="true" tabindex="-1"></a>    .[, u <span class="sc">:</span><span class="er">=</span> (x <span class="sc">-</span> x0)<span class="sc">/</span>h] <span class="sc">%&gt;%</span> </span>
<span id="cb35-887"><a href="#cb35-887" aria-hidden="true" tabindex="-1"></a>    <span class="co">#=== K(u) ===#</span></span>
<span id="cb35-888"><a href="#cb35-888" aria-hidden="true" tabindex="-1"></a>    .[, k_of_u <span class="sc">:</span><span class="er">=</span> <span class="dv">3</span> <span class="sc">/</span> <span class="dv">4</span> <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>u<span class="sc">^</span><span class="dv">2</span>)] <span class="sc">%&gt;%</span> </span>
<span id="cb35-889"><a href="#cb35-889" aria-hidden="true" tabindex="-1"></a>    <span class="co">#=== turn k_of_u to 0 if abs(u) &gt; 1  ===#</span></span>
<span id="cb35-890"><a href="#cb35-890" aria-hidden="true" tabindex="-1"></a>    .[<span class="fu">abs</span>(u) <span class="sc">&gt;=</span> <span class="dv">1</span>, k_of_u <span class="sc">:</span><span class="er">=</span> <span class="dv">0</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb35-891"><a href="#cb35-891" aria-hidden="true" tabindex="-1"></a>    <span class="co">#=== find the weight ===#</span></span>
<span id="cb35-892"><a href="#cb35-892" aria-hidden="true" tabindex="-1"></a>    .[, weight <span class="sc">:</span><span class="er">=</span> k_of_u <span class="sc">/</span> <span class="fu">sum</span>(k_of_u)] <span class="sc">%&gt;%</span> </span>
<span id="cb35-893"><a href="#cb35-893" aria-hidden="true" tabindex="-1"></a>    .[, x_diff <span class="sc">:</span><span class="er">=</span> x <span class="sc">-</span> x0]</span>
<span id="cb35-894"><a href="#cb35-894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-895"><a href="#cb35-895" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== run linear regression with the weights ===#</span></span>
<span id="cb35-896"><a href="#cb35-896" aria-hidden="true" tabindex="-1"></a>  ols_res <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x_diff, <span class="at">data =</span> lr_data, <span class="at">weights =</span> weight)</span>
<span id="cb35-897"><a href="#cb35-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-898"><a href="#cb35-898" aria-hidden="true" tabindex="-1"></a>  return_data <span class="ot">&lt;-</span></span>
<span id="cb35-899"><a href="#cb35-899" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.table</span>(</span>
<span id="cb35-900"><a href="#cb35-900" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> x0,</span>
<span id="cb35-901"><a href="#cb35-901" aria-hidden="true" tabindex="-1"></a>      <span class="at">y_hat =</span> ols_res<span class="sc">$</span>coefficient[<span class="st">"(Intercept)"</span>]</span>
<span id="cb35-902"><a href="#cb35-902" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-903"><a href="#cb35-903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-904"><a href="#cb35-904" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(return_data)</span>
<span id="cb35-905"><a href="#cb35-905" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-906"><a href="#cb35-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-907"><a href="#cb35-907" aria-hidden="true" tabindex="-1"></a>y_hat_ll <span class="ot">&lt;-</span></span>
<span id="cb35-908"><a href="#cb35-908" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb35-909"><a href="#cb35-909" aria-hidden="true" tabindex="-1"></a>    x_seq,</span>
<span id="cb35-910"><a href="#cb35-910" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">est_y_ll</span>(x, data, h)</span>
<span id="cb35-911"><a href="#cb35-911" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb35-912"><a href="#cb35-912" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb35-913"><a href="#cb35-913" aria-hidden="true" tabindex="-1"></a>  .[, type <span class="sc">:</span><span class="er">=</span> <span class="st">"Local Linear"</span>]</span>
<span id="cb35-914"><a href="#cb35-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-915"><a href="#cb35-915" aria-hidden="true" tabindex="-1"></a><span class="co">#=== combine with the local constant results ===#</span></span>
<span id="cb35-916"><a href="#cb35-916" aria-hidden="true" tabindex="-1"></a>data_all <span class="ot">&lt;-</span> <span class="fu">rbind</span>(y_hat_lc, y_hat_ll)</span>
<span id="cb35-917"><a href="#cb35-917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-918"><a href="#cb35-918" aria-hidden="true" tabindex="-1"></a><span class="co">#=== plot ===#</span></span>
<span id="cb35-919"><a href="#cb35-919" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb35-920"><a href="#cb35-920" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb35-921"><a href="#cb35-921" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data_all,</span>
<span id="cb35-922"><a href="#cb35-922" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> y_hat, <span class="at">x =</span> x, <span class="at">color =</span> type)</span>
<span id="cb35-923"><a href="#cb35-923" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb35-924"><a href="#cb35-924" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb35-925"><a href="#cb35-925" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data_all,</span>
<span id="cb35-926"><a href="#cb35-926" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> y_hat, <span class="at">x =</span> x, <span class="at">color =</span> type),</span>
<span id="cb35-927"><a href="#cb35-927" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">0.6</span></span>
<span id="cb35-928"><a href="#cb35-928" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb35-929"><a href="#cb35-929" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb35-930"><a href="#cb35-930" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data,</span>
<span id="cb35-931"><a href="#cb35-931" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">x =</span> x),</span>
<span id="cb35-932"><a href="#cb35-932" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">0.6</span></span>
<span id="cb35-933"><a href="#cb35-933" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb35-934"><a href="#cb35-934" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_discrete</span>(<span class="at">name =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb35-935"><a href="#cb35-935" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb35-936"><a href="#cb35-936" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb35-937"><a href="#cb35-937" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-938"><a href="#cb35-938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-939"><a href="#cb35-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-940"><a href="#cb35-940" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r}</span></span>
<span id="cb35-941"><a href="#cb35-941" aria-hidden="true" tabindex="-1"></a><span class="co">N &lt;- 500</span></span>
<span id="cb35-942"><a href="#cb35-942" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-943"><a href="#cb35-943" aria-hidden="true" tabindex="-1"></a><span class="co">data &lt;- </span></span>
<span id="cb35-944"><a href="#cb35-944" aria-hidden="true" tabindex="-1"></a><span class="co">  data.table(</span></span>
<span id="cb35-945"><a href="#cb35-945" aria-hidden="true" tabindex="-1"></a><span class="co">    x = rnorm(N),</span></span>
<span id="cb35-946"><a href="#cb35-946" aria-hidden="true" tabindex="-1"></a><span class="co">    e = rnorm(N)</span></span>
<span id="cb35-947"><a href="#cb35-947" aria-hidden="true" tabindex="-1"></a><span class="co">  ) %&gt;% </span></span>
<span id="cb35-948"><a href="#cb35-948" aria-hidden="true" tabindex="-1"></a><span class="co">  .[, y_det := 2 * sin(2 * x)] %&gt;% </span></span>
<span id="cb35-949"><a href="#cb35-949" aria-hidden="true" tabindex="-1"></a><span class="co">  .[, y := y_det + e]</span></span>
<span id="cb35-950"><a href="#cb35-950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-951"><a href="#cb35-951" aria-hidden="true" tabindex="-1"></a><span class="co">h &lt;- 0.3</span></span>
<span id="cb35-952"><a href="#cb35-952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-953"><a href="#cb35-953" aria-hidden="true" tabindex="-1"></a><span class="co">x_seq &lt;- seq(min(data$x), max(data$x), length = 200)</span></span>
<span id="cb35-954"><a href="#cb35-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-955"><a href="#cb35-955" aria-hidden="true" tabindex="-1"></a><span class="co">y_hat_ll &lt;-</span></span>
<span id="cb35-956"><a href="#cb35-956" aria-hidden="true" tabindex="-1"></a><span class="co">  lapply(</span></span>
<span id="cb35-957"><a href="#cb35-957" aria-hidden="true" tabindex="-1"></a><span class="co">    x_seq,</span></span>
<span id="cb35-958"><a href="#cb35-958" aria-hidden="true" tabindex="-1"></a><span class="co">    function(x) est_y_ll(x, data, h)</span></span>
<span id="cb35-959"><a href="#cb35-959" aria-hidden="true" tabindex="-1"></a><span class="co">  ) %&gt;% </span></span>
<span id="cb35-960"><a href="#cb35-960" aria-hidden="true" tabindex="-1"></a><span class="co">  rbindlist() %&gt;% </span></span>
<span id="cb35-961"><a href="#cb35-961" aria-hidden="true" tabindex="-1"></a><span class="co">  .[, type := "Local Linear"]</span></span>
<span id="cb35-962"><a href="#cb35-962" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-963"><a href="#cb35-963" aria-hidden="true" tabindex="-1"></a><span class="co">y_hat_lc &lt;-</span></span>
<span id="cb35-964"><a href="#cb35-964" aria-hidden="true" tabindex="-1"></a><span class="co">  lapply(</span></span>
<span id="cb35-965"><a href="#cb35-965" aria-hidden="true" tabindex="-1"></a><span class="co">    x_seq,</span></span>
<span id="cb35-966"><a href="#cb35-966" aria-hidden="true" tabindex="-1"></a><span class="co">    function(x) est_y_nw(x, data, h)</span></span>
<span id="cb35-967"><a href="#cb35-967" aria-hidden="true" tabindex="-1"></a><span class="co">  ) %&gt;% </span></span>
<span id="cb35-968"><a href="#cb35-968" aria-hidden="true" tabindex="-1"></a><span class="co">  rbindlist() %&gt;% </span></span>
<span id="cb35-969"><a href="#cb35-969" aria-hidden="true" tabindex="-1"></a><span class="co">  .[, type := "Local Constant"]</span></span>
<span id="cb35-970"><a href="#cb35-970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-971"><a href="#cb35-971" aria-hidden="true" tabindex="-1"></a><span class="co">data_true &lt;- </span></span>
<span id="cb35-972"><a href="#cb35-972" aria-hidden="true" tabindex="-1"></a><span class="co">  data[, .(x, y_det)] %&gt;% </span></span>
<span id="cb35-973"><a href="#cb35-973" aria-hidden="true" tabindex="-1"></a><span class="co">  setnames("y_det", "y_hat") %&gt;% </span></span>
<span id="cb35-974"><a href="#cb35-974" aria-hidden="true" tabindex="-1"></a><span class="co">  .[, type := "True"]</span></span>
<span id="cb35-975"><a href="#cb35-975" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-976"><a href="#cb35-976" aria-hidden="true" tabindex="-1"></a><span class="co">#=== combine with the local constant results ===#</span></span>
<span id="cb35-977"><a href="#cb35-977" aria-hidden="true" tabindex="-1"></a><span class="co">data_all &lt;- rbind(y_hat_lc, y_hat_ll, data_true)</span></span>
<span id="cb35-978"><a href="#cb35-978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-979"><a href="#cb35-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-980"><a href="#cb35-980" aria-hidden="true" tabindex="-1"></a><span class="co">#=== plot ===#</span></span>
<span id="cb35-981"><a href="#cb35-981" aria-hidden="true" tabindex="-1"></a><span class="co">ggplot() +</span></span>
<span id="cb35-982"><a href="#cb35-982" aria-hidden="true" tabindex="-1"></a><span class="co">  geom_line(</span></span>
<span id="cb35-983"><a href="#cb35-983" aria-hidden="true" tabindex="-1"></a><span class="co">    data = data_all,</span></span>
<span id="cb35-984"><a href="#cb35-984" aria-hidden="true" tabindex="-1"></a><span class="co">    aes(y = y_hat, x = x, color = type)</span></span>
<span id="cb35-985"><a href="#cb35-985" aria-hidden="true" tabindex="-1"></a><span class="co">  ) +</span></span>
<span id="cb35-986"><a href="#cb35-986" aria-hidden="true" tabindex="-1"></a><span class="co">  geom_point(</span></span>
<span id="cb35-987"><a href="#cb35-987" aria-hidden="true" tabindex="-1"></a><span class="co">    data = data_all,</span></span>
<span id="cb35-988"><a href="#cb35-988" aria-hidden="true" tabindex="-1"></a><span class="co">    aes(y = y_hat, x = x, color = type),</span></span>
<span id="cb35-989"><a href="#cb35-989" aria-hidden="true" tabindex="-1"></a><span class="co">    size = 0.6</span></span>
<span id="cb35-990"><a href="#cb35-990" aria-hidden="true" tabindex="-1"></a><span class="co">  ) +</span></span>
<span id="cb35-991"><a href="#cb35-991" aria-hidden="true" tabindex="-1"></a><span class="co">  geom_point(</span></span>
<span id="cb35-992"><a href="#cb35-992" aria-hidden="true" tabindex="-1"></a><span class="co">    data = data,</span></span>
<span id="cb35-993"><a href="#cb35-993" aria-hidden="true" tabindex="-1"></a><span class="co">    aes(y = y, x = x),</span></span>
<span id="cb35-994"><a href="#cb35-994" aria-hidden="true" tabindex="-1"></a><span class="co">    size = 0.6</span></span>
<span id="cb35-995"><a href="#cb35-995" aria-hidden="true" tabindex="-1"></a><span class="co">  ) +</span></span>
<span id="cb35-996"><a href="#cb35-996" aria-hidden="true" tabindex="-1"></a><span class="co">  scale_color_discrete(name = "") +</span></span>
<span id="cb35-997"><a href="#cb35-997" aria-hidden="true" tabindex="-1"></a><span class="co">  theme_bw() +</span></span>
<span id="cb35-998"><a href="#cb35-998" aria-hidden="true" tabindex="-1"></a><span class="co">  theme(legend.position = "bottom")</span></span>
<span id="cb35-999"><a href="#cb35-999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1000"><a href="#cb35-1000" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1001"><a href="#cb35-1001" aria-hidden="true" tabindex="-1"></a><span class="co">```</span></span>
<span id="cb35-1002"><a href="#cb35-1002" aria-hidden="true" tabindex="-1"></a><span class="co"> --&gt;</span></span>
<span id="cb35-1003"><a href="#cb35-1003" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb35-1004"><a href="#cb35-1004" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1005"><a href="#cb35-1005" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>In @sec-rf, we will see that random forest is a special case of local constant regression</span>
<span id="cb35-1006"><a href="#cb35-1006" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1007"><a href="#cb35-1007" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Understanding local regression helps you understand how generalized random forest works in @sec-grf</span>
<span id="cb35-1008"><a href="#cb35-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1009"><a href="#cb35-1009" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb35-1010"><a href="#cb35-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1011"><a href="#cb35-1011" aria-hidden="true" tabindex="-1"></a>You can make the function locally more flexible by including polynomials of $x$. For example, this is a locally cubic regression.</span>
<span id="cb35-1012"><a href="#cb35-1012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1013"><a href="#cb35-1013" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb35-1014"><a href="#cb35-1014" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb35-1015"><a href="#cb35-1015" aria-hidden="true" tabindex="-1"></a>Min_{\alpha,\beta_1,\beta_2,\beta_3} \sum_{i=1}^N W_i(x_0)(Y_i - \alpha - \beta (x_i-x_0) - \beta_2 (x_i-x_0)^2 - \beta_3 (x_i-x_0)^3)^2</span>
<span id="cb35-1016"><a href="#cb35-1016" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb35-1017"><a href="#cb35-1017" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb35-1018"><a href="#cb35-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1019"><a href="#cb35-1019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1020"><a href="#cb35-1020" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb35-1021"><a href="#cb35-1021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1022"><a href="#cb35-1022" aria-hidden="true" tabindex="-1"></a><span class="fu">## Useful Resource</span></span>
<span id="cb35-1023"><a href="#cb35-1023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1024"><a href="#cb35-1024" aria-hidden="true" tabindex="-1"></a>For those who are interested in fuller treatments of local regression, <span class="co">[</span><span class="ot">this chapter</span><span class="co">](https://bookdown.org/egarpor/PM-UC3M/npreg-kre.html#npreg-kre-locpoly)</span> of @Garcia-Portugues2022.</span>
<span id="cb35-1025"><a href="#cb35-1025" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb35-1026"><a href="#cb35-1026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1027"><a href="#cb35-1027" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1028"><a href="#cb35-1028" aria-hidden="true" tabindex="-1"></a><span class="fu">### K-nearest neighbor</span></span>
<span id="cb35-1029"><a href="#cb35-1029" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1030"><a href="#cb35-1030" aria-hidden="true" tabindex="-1"></a>K-nearest neighbor (KNN) regression is a special case of local constant regression. The prediction of $y$ conditional on $x$ is simply the average of $y$ observed for the K closest (in terms of distance to $x$) observations in the data. So, it is like the NW estimator with the uniform Kernel function. But, it is not a NW estimator because NW estimator does not fix the number of observations in the **neighbor**.  </span>
<span id="cb35-1031"><a href="#cb35-1031" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1032"><a href="#cb35-1032" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb35-1033"><a href="#cb35-1033" aria-hidden="true" tabindex="-1"></a>Predictions at points around a more densely populated area have larger numbers of observations in their **neighbors**.</span>
<span id="cb35-1034"><a href="#cb35-1034" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb35-1035"><a href="#cb35-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1036"><a href="#cb35-1036" aria-hidden="true" tabindex="-1"></a>The hyper-parameter for KNN regression is <span class="in">`k`</span> (the number of neighbors). The choice of the value of $k$ has a dramatic impacts on the fitted curve just like how the choice of $h$ affects the fitted curve by the NW estimator.</span>
<span id="cb35-1037"><a href="#cb35-1037" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1040"><a href="#cb35-1040" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-1041"><a href="#cb35-1041" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb35-1042"><a href="#cb35-1042" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1043"><a href="#cb35-1043" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span></span>
<span id="cb35-1044"><a href="#cb35-1044" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(</span>
<span id="cb35-1045"><a href="#cb35-1045" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>)</span>
<span id="cb35-1046"><a href="#cb35-1046" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb35-1047"><a href="#cb35-1047" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb35-1048"><a href="#cb35-1048" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">knn_fit =</span> <span class="fu">list</span>(</span>
<span id="cb35-1049"><a href="#cb35-1049" aria-hidden="true" tabindex="-1"></a>    <span class="fu">knnreg</span>(y <span class="sc">~</span> x, <span class="at">k =</span> k, <span class="at">data =</span> data)</span>
<span id="cb35-1050"><a href="#cb35-1050" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span> </span>
<span id="cb35-1051"><a href="#cb35-1051" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">eval_data =</span> <span class="fu">list</span>(</span>
<span id="cb35-1052"><a href="#cb35-1052" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.table</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">250</span>, <span class="at">length =</span> <span class="dv">1000</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb35-1053"><a href="#cb35-1053" aria-hidden="true" tabindex="-1"></a>    .[, <span class="at">y :=</span> <span class="fu">predict</span>(knn_fit, <span class="at">newdata =</span> .)]</span>
<span id="cb35-1054"><a href="#cb35-1054" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span> </span>
<span id="cb35-1055"><a href="#cb35-1055" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(k, eval_data) <span class="sc">%&gt;%</span> </span>
<span id="cb35-1056"><a href="#cb35-1056" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb35-1057"><a href="#cb35-1057" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">k_txt =</span> <span class="fu">paste0</span>(<span class="st">"k = "</span>, k)) <span class="sc">%&gt;%</span> </span>
<span id="cb35-1058"><a href="#cb35-1058" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">k_txt =</span> <span class="fu">factor</span>(k_txt, <span class="at">levels =</span> <span class="fu">paste0</span>(<span class="st">"k = "</span>, <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>))))</span>
<span id="cb35-1059"><a href="#cb35-1059" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1060"><a href="#cb35-1060" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb35-1061"><a href="#cb35-1061" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> data, <span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">x =</span> x), <span class="at">color =</span> <span class="st">"darkgray"</span>, <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb35-1062"><a href="#cb35-1062" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> plot_data, <span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">x =</span> x), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb35-1063"><a href="#cb35-1063" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(k_txt <span class="sc">~</span> ., <span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb35-1064"><a href="#cb35-1064" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb35-1065"><a href="#cb35-1065" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1066"><a href="#cb35-1066" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-1067"><a href="#cb35-1067" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1068"><a href="#cb35-1068" aria-hidden="true" tabindex="-1"></a>As you can see, at <span class="in">`k`</span> $= 1$, the fitted curve fits perfectly with the observed data, and it is highly over-fitted. While increasing <span class="in">`k`</span> to $5$ alleviates the over-fitting problem, the fitted curve is still very much wiggly. </span>
<span id="cb35-1069"><a href="#cb35-1069" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1070"><a href="#cb35-1070" aria-hidden="true" tabindex="-1"></a><span class="fu">## Efficiency: Parametric vs Non-parametric Methods</span></span>
<span id="cb35-1071"><a href="#cb35-1071" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1072"><a href="#cb35-1072" aria-hidden="true" tabindex="-1"></a>Semi-parametric and non-parametric approached are more flexible in representing relationships between the dependent and independent variables than linear-in-parameter models. So, why don't we just use semi-parametric or non-parametric approaches instead for all the econometric tasks? One reason you might prefer linear-in-parameter models has something to do with efficiency. </span>
<span id="cb35-1073"><a href="#cb35-1073" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1074"><a href="#cb35-1074" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb35-1075"><a href="#cb35-1075" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>parametric: </span>
<span id="cb35-1076"><a href="#cb35-1076" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>pro: can be efficient than non-parametric approach when the underlying process is modeled well with parametric models</span>
<span id="cb35-1077"><a href="#cb35-1077" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>cons: not robust to functional form mis-specifications</span>
<span id="cb35-1078"><a href="#cb35-1078" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>semi-, non-parametric: </span>
<span id="cb35-1079"><a href="#cb35-1079" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>pro: safe-guard against model mis-specification especially when you are modeling highly complex (non-linear in a way that is hard to capture with parametric models and multi-way interactions of variables) </span>
<span id="cb35-1080"><a href="#cb35-1080" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>cons: possible loss in efficiency compared to parametric approach when the underlying model can be approximated well with parametric models</span>
<span id="cb35-1081"><a href="#cb35-1081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1082"><a href="#cb35-1082" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb35-1083"><a href="#cb35-1083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1084"><a href="#cb35-1084" aria-hidden="true" tabindex="-1"></a><span class="fu">### Monte Carlo Simulation (parametric vs non-parametric)</span></span>
<span id="cb35-1085"><a href="#cb35-1085" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1086"><a href="#cb35-1086" aria-hidden="true" tabindex="-1"></a>Consider the following data generating process:</span>
<span id="cb35-1087"><a href="#cb35-1087" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1088"><a href="#cb35-1088" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb35-1089"><a href="#cb35-1089" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb35-1090"><a href="#cb35-1090" aria-hidden="true" tabindex="-1"></a>y = log(x) + v</span>
<span id="cb35-1091"><a href="#cb35-1091" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb35-1092"><a href="#cb35-1092" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb35-1093"><a href="#cb35-1093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1094"><a href="#cb35-1094" aria-hidden="true" tabindex="-1"></a>Your objective is to understand the impact of treatment (increasing $x = 1$ to $x = 2$). The true impact of the treatment is $TE<span class="co">[</span><span class="ot">x=1 \rightarrow x=2</span><span class="co">]</span> = log(2) - log(1) = <span class="in">`r log(2)`</span>$.</span>
<span id="cb35-1095"><a href="#cb35-1095" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1096"><a href="#cb35-1096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1099"><a href="#cb35-1099" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-1100"><a href="#cb35-1100" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb35-1101"><a href="#cb35-1101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1102"><a href="#cb35-1102" aria-hidden="true" tabindex="-1"></a>mc_run <span class="ot">&lt;-</span> <span class="cf">function</span>(i)</span>
<span id="cb35-1103"><a href="#cb35-1103" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb35-1104"><a href="#cb35-1104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(i) <span class="co"># progress tracker</span></span>
<span id="cb35-1105"><a href="#cb35-1105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1106"><a href="#cb35-1106" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== set the number of observations (not really have to be inside the function..) ===#</span></span>
<span id="cb35-1107"><a href="#cb35-1107" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb35-1108"><a href="#cb35-1108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1109"><a href="#cb35-1109" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== generate the data ===#</span></span>
<span id="cb35-1110"><a href="#cb35-1110" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fu">runif</span>(N)</span>
<span id="cb35-1111"><a href="#cb35-1111" aria-hidden="true" tabindex="-1"></a>  e <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">rnorm</span>(N)</span>
<span id="cb35-1112"><a href="#cb35-1112" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">log</span>(x) <span class="sc">+</span> e</span>
<span id="cb35-1113"><a href="#cb35-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1114"><a href="#cb35-1114" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span></span>
<span id="cb35-1115"><a href="#cb35-1115" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.table</span>(</span>
<span id="cb35-1116"><a href="#cb35-1116" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> x,</span>
<span id="cb35-1117"><a href="#cb35-1117" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> y</span>
<span id="cb35-1118"><a href="#cb35-1118" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-1119"><a href="#cb35-1119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1120"><a href="#cb35-1120" aria-hidden="true" tabindex="-1"></a>  eval_data <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb35-1121"><a href="#cb35-1121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1122"><a href="#cb35-1122" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== linear model with OLS ===#</span></span>
<span id="cb35-1123"><a href="#cb35-1123" aria-hidden="true" tabindex="-1"></a>  lm_trained <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> <span class="fu">log</span>(x), <span class="at">data =</span> data)</span>
<span id="cb35-1124"><a href="#cb35-1124" aria-hidden="true" tabindex="-1"></a>  te_lm <span class="ot">&lt;-</span> lm_trained<span class="sc">$</span>coefficient[<span class="st">"log(x)"</span>] <span class="sc">*</span> <span class="fu">log</span>(<span class="dv">2</span>)</span>
<span id="cb35-1125"><a href="#cb35-1125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1126"><a href="#cb35-1126" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== gam ===#</span></span>
<span id="cb35-1127"><a href="#cb35-1127" aria-hidden="true" tabindex="-1"></a>  gam_trained <span class="ot">&lt;-</span> <span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">5</span>), <span class="at">data =</span> data)</span>
<span id="cb35-1128"><a href="#cb35-1128" aria-hidden="true" tabindex="-1"></a>  y_hat_gam <span class="ot">&lt;-</span> <span class="fu">predict</span>(gam_trained, <span class="at">newdata =</span> eval_data)</span>
<span id="cb35-1129"><a href="#cb35-1129" aria-hidden="true" tabindex="-1"></a>  te_gam <span class="ot">&lt;-</span> y_hat_gam[<span class="dv">2</span>] <span class="sc">-</span> y_hat_gam[<span class="dv">1</span>]</span>
<span id="cb35-1130"><a href="#cb35-1130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1131"><a href="#cb35-1131" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== KNN ===#</span></span>
<span id="cb35-1132"><a href="#cb35-1132" aria-hidden="true" tabindex="-1"></a>  knn_trained <span class="ot">&lt;-</span> <span class="fu">knnreg</span>(y <span class="sc">~</span> x, <span class="at">k =</span> <span class="dv">10</span>, <span class="at">data =</span> data)</span>
<span id="cb35-1133"><a href="#cb35-1133" aria-hidden="true" tabindex="-1"></a>  y_hat_knn <span class="ot">&lt;-</span> <span class="fu">predict</span>(knn_trained, <span class="at">newdata =</span> eval_data)</span>
<span id="cb35-1134"><a href="#cb35-1134" aria-hidden="true" tabindex="-1"></a>  te_knn <span class="ot">&lt;-</span> y_hat_knn[<span class="dv">2</span>] <span class="sc">-</span> y_hat_knn[<span class="dv">1</span>]</span>
<span id="cb35-1135"><a href="#cb35-1135" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-1136"><a href="#cb35-1136" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== combined the results ===#</span></span>
<span id="cb35-1137"><a href="#cb35-1137" aria-hidden="true" tabindex="-1"></a>  return_data <span class="ot">&lt;-</span></span>
<span id="cb35-1138"><a href="#cb35-1138" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.table</span>(</span>
<span id="cb35-1139"><a href="#cb35-1139" aria-hidden="true" tabindex="-1"></a>      <span class="at">te =</span> <span class="fu">c</span>(te_lm, te_gam, te_knn),</span>
<span id="cb35-1140"><a href="#cb35-1140" aria-hidden="true" tabindex="-1"></a>      <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"lm"</span>, <span class="st">"gam"</span>, <span class="st">"knn"</span>)</span>
<span id="cb35-1141"><a href="#cb35-1141" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-1142"><a href="#cb35-1142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1143"><a href="#cb35-1143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(return_data)</span>
<span id="cb35-1144"><a href="#cb35-1144" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-1145"><a href="#cb35-1145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1146"><a href="#cb35-1146" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">5293</span>)</span>
<span id="cb35-1147"><a href="#cb35-1147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1148"><a href="#cb35-1148" aria-hidden="true" tabindex="-1"></a>mc_results <span class="ot">&lt;-</span></span>
<span id="cb35-1149"><a href="#cb35-1149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mclapply</span>(</span>
<span id="cb35-1150"><a href="#cb35-1150" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span><span class="dv">500</span>,</span>
<span id="cb35-1151"><a href="#cb35-1151" aria-hidden="true" tabindex="-1"></a>    mc_run,</span>
<span id="cb35-1152"><a href="#cb35-1152" aria-hidden="true" tabindex="-1"></a>    <span class="at">mc.cores =</span> <span class="fu">detectCores</span>() <span class="sc">*</span> <span class="dv">3</span> <span class="sc">/</span> <span class="dv">4</span></span>
<span id="cb35-1153"><a href="#cb35-1153" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb35-1154"><a href="#cb35-1154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>()</span>
<span id="cb35-1155"><a href="#cb35-1155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1156"><a href="#cb35-1156" aria-hidden="true" tabindex="-1"></a><span class="co"># lapply(</span></span>
<span id="cb35-1157"><a href="#cb35-1157" aria-hidden="true" tabindex="-1"></a><span class="co">#   1:100,</span></span>
<span id="cb35-1158"><a href="#cb35-1158" aria-hidden="true" tabindex="-1"></a><span class="co">#   mc_run</span></span>
<span id="cb35-1159"><a href="#cb35-1159" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb35-1160"><a href="#cb35-1160" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-1161"><a href="#cb35-1161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1162"><a href="#cb35-1162" aria-hidden="true" tabindex="-1"></a>@fig-mc-efficiency presents the density plots of treatment effect estimates by method. As you can see, the (correctly-specified) linear model performs better than the other methods. All the methods are unbiased, however they differ substantially in terms of efficiency. Note that there was no point in applying random forest at all as there is only a single explanatory variable and the none of the strong points of RF over linear model manifest in this simulation. Clearly, this simulation by no means is intended to claim that linear model is the best. It is merely showcasing <span class="kw">&lt;span</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:red"</span><span class="kw">&gt;</span> a <span class="kw">&lt;/span&gt;</span>scenario where (correctly-specified) linear model performs far better than the non-parametric models. This is also a reminder that no method works the best all the time. There are many cases where parametric models perform better (contextual knowledge is critical so that your parametric model can represent the true data generating process well). There are of course many cases non-parametric modeling work better than parametric modeling. </span>
<span id="cb35-1163"><a href="#cb35-1163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1166"><a href="#cb35-1166" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-1167"><a href="#cb35-1167" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Results of the MC simulations on the efficiency of various methods</span></span>
<span id="cb35-1168"><a href="#cb35-1168" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-mc-efficiency</span></span>
<span id="cb35-1169"><a href="#cb35-1169" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb35-1170"><a href="#cb35-1170" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4 </span></span>
<span id="cb35-1171"><a href="#cb35-1171" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 6 </span></span>
<span id="cb35-1172"><a href="#cb35-1172" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: center </span></span>
<span id="cb35-1173"><a href="#cb35-1173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1174"><a href="#cb35-1174" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> mc_results) <span class="sc">+</span></span>
<span id="cb35-1175"><a href="#cb35-1175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x =</span> te, <span class="at">fill =</span> type), <span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb35-1176"><a href="#cb35-1176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">log</span>(<span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb35-1177"><a href="#cb35-1177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb35-1178"><a href="#cb35-1178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1179"><a href="#cb35-1179" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-1180"><a href="#cb35-1180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1181"><a href="#cb35-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1182"><a href="#cb35-1182" aria-hidden="true" tabindex="-1"></a><span class="fu">## References {.unnumbered}</span></span>
<span id="cb35-1183"><a href="#cb35-1183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1184"><a href="#cb35-1184" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;div</span> <span class="er">id</span><span class="ot">=</span><span class="st">"refs"</span><span class="kw">&gt;&lt;/div&gt;</span></span>
<span id="cb35-1185"><a href="#cb35-1185" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>