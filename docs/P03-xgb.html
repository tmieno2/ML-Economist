<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.563">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Introduction to Machine Learning for Economists - 9&nbsp; Extreme Gradient Boosting</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./causal-ml.html" rel="next">
<link href="./P02-boosted-regression-forest.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><script src="site_libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><script src="site_libs/viz-1.8.2/viz.js"></script><link href="site_libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="site_libs/grViz-binding-1.0.9/grViz.js"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">
<span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Extreme Gradient Boosting</span>
</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Introduction to Machine Learning for Economists</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/tmieno2/ML-Economist" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="" title="Share" id="sidebar-tool-dropdown-0" class="sidebar-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-share"></i></a>
    <ul class="dropdown-menu" aria-labelledby="sidebar-tool-dropdown-0">
<li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=%7Curl%7C">
            <i class="bi bi-bi-twitter pe-1"></i>
          Twitter
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=%7Curl%7C">
            <i class="bi bi-bi-facebook pe-1"></i>
          Facebook
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=%7Curl%7C">
            <i class="bi bi-bi-linkedin pe-1"></i>
          LinkedIn
          </a>
        </li>
    </ul>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Welcome</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Preface: Prediction v.s. Causal Inference</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./basics.html" class="sidebar-item-text sidebar-link">Basics</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B01-nonlinear.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Non-linear function estimation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B02-bias-variance-tradeoff.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Bias-variance Trade-off</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B03-cross-validation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Cross-validation based on mean squared error (MSE)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B04-regularization.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Regression Shrinkage Methods</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B05-bootstrap.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Bootstrap</span></a>
  </div>
</li>
    </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./prediction-ml.html" class="sidebar-item-text sidebar-link">Prediction ML</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P01-random-forest.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Random Forest</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P02-boosted-regression-forest.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Boosted Regression Forest</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P03-xgb.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Extreme Gradient Boosting</span></a>
  </div>
</li>
    </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./causal-ml.html" class="sidebar-item-text sidebar-link">Causal Machine Learning (CML) Methods</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">Appendices</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A01-mc-simulation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Monte Carlo (MC) Simulation</span></a>
  </div>
</li>
    </ul>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#preparation" id="toc-preparation" class="nav-link active" data-scroll-target="#preparation">Preparation</a></li>
  <li><a href="#tree-updating-in-xgb-general" id="toc-tree-updating-in-xgb-general" class="nav-link" data-scroll-target="#tree-updating-in-xgb-general"> <span class="header-section-number">9.1</span> Tree updating in XGB (general)</a></li>
  <li><a href="#tree-updating-in-xgb-regression" id="toc-tree-updating-in-xgb-regression" class="nav-link" data-scroll-target="#tree-updating-in-xgb-regression"> <span class="header-section-number">9.2</span> Tree updating in XGB (regression)</a></li>
  <li><a href="#illustration-of-xgb-for-regression" id="toc-illustration-of-xgb-for-regression" class="nav-link" data-scroll-target="#illustration-of-xgb-for-regression"> <span class="header-section-number">9.3</span> Illustration of XGB for regression</a></li>
  <li><a href="#implementation" id="toc-implementation" class="nav-link" data-scroll-target="#implementation"> <span class="header-section-number">9.4</span> Implementation</a></li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/tmieno2/ML-Economist/edit/master/P03-xgb.qmd" class="toc-action">Edit this page</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title d-none d-lg-block">
<span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Extreme Gradient Boosting</span>
</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header><p>Extreme gradient boosting (XGB) is a variant of gradient boosting that has been extremely popular due to its superb performance. The basic concept is the same as the gradient boosting algorithm described above, however, it has its own way of building a tree, which is more mindful of avoiding over-fitting trees.</p>
<section id="preparation" class="level2 unnumbered"><h2 class="unnumbered anchored" data-anchor-id="preparation">Preparation</h2>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="tree-updating-in-xgb-general" class="level2 page-columns page-full" data-number="9.1"><h2 data-number="9.1" class="anchored" data-anchor-id="tree-updating-in-xgb-general">
<span class="header-section-number">9.1</span> Tree updating in XGB (general)</h2>
<p>Let <span class="math inline">\(f_{i,b}(x_i)\)</span> be the prediction for the <span class="math inline">\(i\)</span>th observation at the <span class="math inline">\(b\)</span>-th iteration. Further, let <span class="math inline">\(w_t(x_i)\)</span> is the term that is added to <span class="math inline">\(f_{i,b}(x_i)\)</span> to obtain <span class="math inline">\(f_{i,b+1}(x_i)\)</span>. In XGB, <span class="math inline">\(w_t(x_i)\)</span> is such that it minimizes the following objective:</p>
<p><span id="eq-obj"><span class="math display">\[
\Psi_t = \sum_{i=1}^N [L(y_i, f_{i,b}(x_i) + w_t(x_i))] + \Omega(w_t)
\tag{9.1}\]</span></span></p>
<p>where <span class="math inline">\(L()\)</span> is the user-specified loss-function that is differentiable and <span class="math inline">\(\Omega(w_t)\)</span> is the regularization term. Instead of <a href="#eq-obj">Equation&nbsp;<span>9.1</span></a>, XGB uses the second order Taylor expansion of <span class="math inline">\(L()\)</span> about <span class="math inline">\(w\)</span><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<p><span id="eq-obj-taylor"><span class="math display">\[
\tilde{\Psi}_t = \sum_{i=1}^N [L(y_i, f_{i,b}(x_i)) + g_i w_t(x_i) + \frac{1}{2}h_i w_t(x_i)^2] + \Omega(w_t)
\tag{9.2}\]</span></span></p>
<p>where <span class="math inline">\(g_i = \frac{\partial L(y_i, p_i)}{\partial p_i}\)</span> (first-order derivative) and <span class="math inline">\(h_i = \frac{\partial^2 L(y_i, p_i)}{\partial p_i^2}\)</span> (second-order derivative). Since <span class="math inline">\(L(y_i, f_{i,b}(x_i))\)</span> is just a constant, we can safely remove it from the objective function, which leads to</p>
<p><span id="eq-obj-taylor-final"><span class="math display">\[
\tilde{\Psi}_t = \sum_{i=1}^N [g_i w_t(x_i) + \frac{1}{2}h_i w_t(x_i)^2] + \Omega(w_t)
\tag{9.3}\]</span></span></p>
<p>Let <span class="math inline">\(I_j\)</span> denote a set of observations that belong to leaf <span class="math inline">\(j\)</span> (<span class="math inline">\(j = 1, \dots, J\)</span>). Then, <a href="#eq-obj-taylor-final">Equation&nbsp;<span>9.3</span></a> is written as follows:</p>
<p><span id="eq-obj-taylor-tree"><span class="math display">\[
\tilde{\Psi}_t = \sum_{j=1}^J\huge[\normalsize (\sum_{i\in I_j}g_i)w_j + \frac{1}{2}(\sum_{i\in I_j}h_i + \lambda)w_j^2 \huge]\normalsize + \gamma J
\tag{9.4}\]</span></span></p>

<div class="no-row-height column-margin column-container"><div class="">
<p>Remember that all the observations in the same leaf shares the same prediction. So, for all <span class="math inline">\(i\)</span>s that belong to leaf <span class="math inline">\(j\)</span>, the prediction is denoted as <span class="math inline">\(w_j\)</span> in <a href="#eq-obj-taylor-tree">Equation&nbsp;<span>9.4</span></a>. That is, <span class="math inline">\(w_t(x_i)\)</span> that belongs to leaf <span class="math inline">\(j\)</span> is <span class="math inline">\(w_j\)</span>.</p>
</div></div><p>For a given tree structure (denoted as <span class="math inline">\(q(x)\)</span>), the leaves can be treated independently in minimizing this objective.</p>
<p>Taking the derivative of <span class="math inline">\(\tilde{\Psi}_t\)</span> w.r.t <span class="math inline">\(w_j\)</span>,</p>
<p><span id="eq-foc-leaf"><span class="math display">\[
\begin{aligned}
(\sum_{i\in I_j}g_i) + (\sum_{i\in I_j}h_i + \lambda)w_j = 0 \\
\Rightarrow w_j^* = \frac{-\sum_{i\in I_j}g_i}{\sum_{i\in I_j}h_i + \lambda}
\end{aligned}
\tag{9.5}\]</span></span></p>
<p>The minimized value of <span class="math inline">\(\tilde{\Psi}_t\)</span> is then (obtained by plugging <span class="math inline">\(w_j^*\)</span> into <a href="#eq-obj-taylor-tree">Equation&nbsp;<span>9.4</span></a>),</p>
<p><span id="eq-minimized-obj"><span class="math display">\[
\begin{aligned}
\tilde{\Psi}_t(q)^* &amp; = \sum_{j=1}^J\huge[\normalsize (\sum_{i\in I_j}g_i)\frac{-\sum_{i\in I_j}g_i}{\sum_{i\in I_j}h_i + \lambda} + \frac{1}{2}(\sum_{i\in I_j}h_i + \lambda)(\frac{-\sum_{i\in I_j}g_i}{\sum_{i\in I_j}h_i + \lambda})^2 \huge]\normalsize + \gamma J \\
&amp; = \sum_{j=1}^J\huge[\normalsize \frac{-(\sum_{i\in I_j}g_i)^2}{\sum_{i\in I_j}h_i + \lambda} + \frac{1}{2}\frac{(\sum_{i\in I_j}g_i)^2}{\sum_{i\in I_j}h_i + \lambda} \huge]\normalsize + \gamma J \\
&amp; = -\frac{1}{2} \sum_{j=1}^J \huge[\normalsize\frac{(\sum_{i\in I_j}g_i)^2}{\sum_{i\in I_j}h_i + \lambda}\huge]\normalsize + \gamma J
\end{aligned}
\tag{9.6}\]</span></span></p>
<p>For notatinal convenience, we call <span class="math inline">\(\frac{(\sum_{i\in I_j}g_i)^2}{\sum_{i\in I_j}h_i + \lambda}\)</span> quality score and denote it by <span class="math inline">\(Q_j\)</span> (<span style="color:red"> Q</span>uality score for leaf <span class="math inline">\(j\)</span>).</p>
<p>We could find the best tree structure by finding <span class="math inline">\(w_j^*(q)\)</span> according to <a href="#eq-obj-taylor-tree">Equation&nbsp;<span>9.4</span></a> and calculate <span class="math inline">\(\tilde{\Psi}_t(q)^*\)</span> according to <a href="#eq-minimized-obj">Equation&nbsp;<span>9.6</span></a> for each of all the possible tree structures, and then pick the tree structure q(x) that has the lowest <span class="math inline">\(\tilde{\Psi}_t(q)^*\)</span>.</p>
<p>However, it is impossible to consider all possible tree structures practically. So, a greedy (myopic) approach that starts from a single leaf and iteratively splits leaves is used instead.</p>
<p>Consider splitting an existing leaf <span class="math inline">\(s\)</span> (where in the tree it may be located) into two leaves <span class="math inline">\(L\)</span> and <span class="math inline">\(R\)</span> when there are <span class="math inline">\(J\)</span> existing leaves. Then, we find <span class="math inline">\(w_j^*\)</span> and calculate <span class="math inline">\(\tilde{\Psi}_t(q)^*\)</span> for each leaf, and the resulting minimized objective is</p>
<p><span class="math display">\[
-\frac{1}{2} \huge[\normalsize Q_L + Q_R + \Gamma \huge]\normalsize + \gamma(J+1)
\]</span></p>
<p>where <span class="math inline">\(\Gamma\)</span> is the sum of quality scores for all the leaves except <span class="math inline">\(L\)</span> and <span class="math inline">\(R\)</span>.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p><span class="math display">\[
\Gamma = \sum_{j\ne \{L, R\}}^J Q_j
\]</span></p>
</div></div><p>The minimized objective before splitting is</p>
<p><span class="math display">\[
-\frac{1}{2} \huge[\normalsize Q_s + \Gamma \huge]\normalsize + \gamma J
\]</span></p>
<p>So, the <span style="color:blue">reduction </span> in loss after the split is</p>
<p><span class="math display">\[
G(s, L, R) = \frac{1}{2} \huge[\normalsize Q_L + Q_R - Q_s \huge]\normalsize - \gamma
\]</span></p>
<p>Let’s call <span class="math inline">\(G(s, L, R)\)</span> simply a gain (of the split).</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>A more positive value of gain (<span class="math inline">\(G(s, L, R)\)</span>) means a more successful split.</p>
</div></div><p>We can try many different patterns of <span class="math inline">\(I_L\)</span> and <span class="math inline">\(I_R\)</span> (how to split tree <span class="math inline">\(s\)</span>), calculate the gain for each of them and pick the split that has the highest gain.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>Different patterns of <span class="math inline">\(I_L\)</span> and <span class="math inline">\(I_R\)</span> arise from different variable-cutpoint combinations</p>
</div></div><p>If the highest gain is negative, then the leaf under consideration for splitting is not split.</p>
<p>Once the best tree is chosen (the tree that has the highest gain among the ones investigated), then we update our prediction based on <span class="math inline">\(w^*\)</span> of the tree. For observation <span class="math inline">\(i\)</span> that belongs to leaf <span class="math inline">\(j\)</span> of the tree,</p>
<p><span id="eq-update"><span class="math display">\[
\begin{aligned}
f_{i,b} = f_{i,b-1} + \eta \cdot w_j^*
\end{aligned}
\tag{9.7}\]</span></span></p>
<p>where <span class="math inline">\(\eta\)</span> is the learning rate.</p>
</section><section id="tree-updating-in-xgb-regression" class="level2" data-number="9.2"><h2 data-number="9.2" class="anchored" data-anchor-id="tree-updating-in-xgb-regression">
<span class="header-section-number">9.2</span> Tree updating in XGB (regression)</h2>
<p>We now make the general tree updating algorithm specific to regression problems, where the loss function is squared error: <span class="math inline">\(L(y_i, p_i) = \frac{1}{2}(y_i - p_i)^2\)</span>, where <span class="math inline">\(p_i\)</span> is the predicted value for <span class="math inline">\(i\)</span>.</p>
<!-- We first set the mean of $y$ as the predicted value for all the observations and denote it by $y_0$.  -->
<p>First, let’s find <span class="math inline">\(g_i\)</span> and <span class="math inline">\(h_i\)</span> for <span class="math inline">\(L(y_i, p_i) = \frac{1}{2}(y_i - p_i)^2\)</span>.</p>
<p><span class="math display">\[
\begin{aligned}
g_i = \frac{\partial L(y_i, p_i)}{\partial p_i}  = -(y_i - p_i)\\
h_i = \frac{\partial^2 L(y_i, p_i)}{\partial p_i^2} = 1 \\
\end{aligned}
\]</span></p>
<p>So, <span class="math inline">\(g_i\)</span> is simply the negative of the residual for <span class="math inline">\(i\)</span>.</p>
<p>Now, suppose your are at iteration <span class="math inline">\(b\)</span> and the predicted value for <span class="math inline">\(i\)</span> is denoted as <span class="math inline">\(f_{i,b}(x_i)\)</span>. Further, let <span class="math inline">\(r_{i,b}\)</span> denote the residual (<span class="math inline">\(y_i - f_{i,b}(x_i)\)</span>).</p>
<p>Plugging these into <a href="#eq-foc-leaf">Equation&nbsp;<span>9.5</span></a>,</p>
<p><span id="eq-w-reg"><span class="math display">\[
\begin{aligned}
w_j^* &amp; = \frac{\sum_{i\in I_j}r_{i,b}}{\sum_{i\in I_j}1 + \lambda} \\
      &amp; = \frac{\sum_{i\in I_j}r_{i,b}}{N_j + \lambda}
\end{aligned}
\tag{9.8}\]</span></span></p>
<p>That is for a given leaf <span class="math inline">\(j\)</span>, the optimal predicted value (<span class="math inline">\(w_j^*\)</span>) is the sum of the residuals of all the observations in leaf <span class="math inline">\(j\)</span> divided by the number of observations in leaf <span class="math inline">\(j\)</span> plus <span class="math inline">\(\lambda\)</span>. When <span class="math inline">\(\lambda = 0\)</span>, the optimal predicted value (<span class="math inline">\(w_j^*\)</span>) is simply the mean of the residuals.</p>
<p>The quality score for leaf <span class="math inline">\(j\)</span> is then,</p>
<p><span id="eq-q-reg"><span class="math display">\[
Q_j = \frac{(\sum_{i\in I_j}r_{i,b})^2}{N_j + \lambda}
\tag{9.9}\]</span></span></p>
</section><section id="illustration-of-xgb-for-regression" class="level2 page-columns page-full" data-number="9.3"><h2 data-number="9.3" class="anchored" data-anchor-id="illustration-of-xgb-for-regression">
<span class="header-section-number">9.3</span> Illustration of XGB for regression</h2>
<p>In order to further our understanding of the entire XGB algorithm, let’s take a lookt at a simple regression problem as an illustration. We consider a four-observation data as follows:</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="op">(</span>
<span class="va">data</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>
    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">7</span>, <span class="fl">8</span>, <span class="fl">12</span><span class="op">)</span>,
    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">8</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    y x
1: -3 1
2:  7 4
3:  8 6
4: 12 8</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="op">(</span>
<span class="va">g_0</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span>, x <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="P03-xgb_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>First step (<span class="math inline">\(b = 0\)</span>) is to make an initial prediction. This can be any number, but let’s use the mean of <code>y</code> and set it as the predicted value for all the observations.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="op">(</span>
<span class="va">f_0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="co"># f_0: the predicted value for all the observations</span>
<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6</code></pre>
</div>
</div>
<p>Let’s set <span class="math inline">\(\gamma\)</span>, <span class="math inline">\(\lambda\)</span>, and <span class="math inline">\(\eta\)</span> to <span class="math inline">\(10\)</span>, <span class="math inline">\(1\)</span>, and <span class="math inline">\(0.3\)</span>, respectively.</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">gamma</span> <span class="op">&lt;-</span> <span class="fl">10</span>
<span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="va">eta</span> <span class="op">&lt;-</span> <span class="fl">0.3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We have a single-leaf tree at the moment. And the quality score for this leaf is</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>quality score for leaf <span class="math inline">\(j\)</span> is <span class="math inline">\(\frac{(\sum_{i\in I_j}r_{i,b})^2}{N_j + \lambda}\)</span></p>
</div></div><div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co">#=== get residuals ===#</span>
<span class="va">data</span><span class="op">[</span>, <span class="va">resid</span> <span class="op">:=</span> <span class="va">y</span> <span class="op">-</span> <span class="va">f_0</span><span class="op">]</span>

<span class="co">#=== get quality score ===#</span>
<span class="op">(</span>
<span class="va">q_0</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">resid</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>
<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
</div>
<p>Quality score of the leaf is 0.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>Since we are using the mean of <span class="math inline">\(y\)</span> as the prediction, of course, the sum of the residuals is zero, which then means that the quality score is zero.</p>
</div></div><p>Now, we have three potential to split patterns: {<code>x</code>, 2}, {<code>x</code>, 5}, {<code>x</code>, 7}.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>{<code>x</code>, 2} means the leaf is split into two leaves: <span class="math inline">\({x | x &lt;2}\)</span> and <span class="math inline">\({x | x &gt;= 2}\)</span>. Note that any number between <span class="math inline">\(1\)</span> and <span class="math inline">\(4\)</span> will result in the same split results.</p>
</div></div><p>Let’s consider them one by one.</p>
<section id="split-x-2" class="level4 page-columns page-full" data-number="9.3.0.1"><h4 data-number="9.3.0.1" class="anchored" data-anchor-id="split-x-2">
<span class="header-section-number">9.3.0.1</span> <span style="color:blue"> Split: {<code>x</code>, 2} </span>
</h4>
<p>Here are graphical representations of the split:</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">g_0</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">2</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">1.25</span>, y <span class="op">=</span> <span class="fl">6</span>, label <span class="op">=</span> <span class="st">"leaf L"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">5</span>, y <span class="op">=</span> <span class="fl">6</span>, label <span class="op">=</span> <span class="st">"leaf R"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="P03-xgb_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu">DiagrammeR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DiagrammeR/man/grViz.html">grViz</a></span><span class="op">(</span>
<span class="st">"
digraph {
  graph [ranksep = 0.2]
  node [shape = box]
    T1R [label = 'L: -9']
    T1L [label = 'R: 1 , 2 , 6']
    T0 [label = '-9, 1 , 2 , 6']
  edge [minlen = 2]
    T0-&gt;T1L
    T0-&gt;T1R
  { rank = same; T1R; T1L}
}
"</span>
<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="htmlwidget-b55a30d50eeb49636485" style="width:100%;height:464px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-b55a30d50eeb49636485">{"x":{"diagram":"\ndigraph {\n  graph [ranksep = 0.2]\n  node [shape = box]\n    T1R [label = \"L: -9\"]\n    T1L [label = \"R: 1 , 2 , 6\"]\n    T0 [label = \"-9, 1 , 2 , 6\"]\n  edge [minlen = 2]\n    T0->T1L\n    T0->T1R\n  { rank = same; T1R; T1L}\n}\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</div></div><p>Let’s split the data.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co">#=== leaf L ===#</span>
<span class="op">(</span>
<span class="va">data_L_1</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">x</span> <span class="op">&lt;</span> <span class="fl">2</span>, <span class="op">]</span>
<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    y x resid
1: -3 1    -9</code></pre>
</div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co">#=== leaf R ===#</span>
<span class="op">(</span>
<span class="va">data_R_1</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">x</span> <span class="op">&gt;=</span> <span class="fl">2</span>, <span class="op">]</span>
<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    y x resid
1:  7 4     1
2:  8 6     2
3: 12 8     6</code></pre>
</div>
</div>
<p>Using <a href="#eq-w-reg">Equation&nbsp;<span>9.8</span></a>,</p>

<div class="no-row-height column-margin column-container"><div class="">
<p><span class="math inline">\(w_j^* = \frac{\sum_{i\in I_j}r_{i,b}}{N_j + \lambda}\)</span></p>
</div></div><div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">w_L</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">data_L_1</span><span class="op">$</span><span class="va">resid</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_L_1</span><span class="op">)</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">)</span>
<span class="va">w_R</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">data_R_1</span><span class="op">$</span><span class="va">resid</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_R_1</span><span class="op">)</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><span class="math display">\[
\begin{aligned}
w_L^* &amp; = -9 / (1 + 1) = -4.5 \\
w_R^* &amp; = 1 + 2 + 6 / (3 + 1) = 2.25
\end{aligned}
\]</span></p>
<p>Using <a href="#eq-q-reg">Equation&nbsp;<span>9.9</span></a>, the quality scores for the leaves are</p>

<div class="no-row-height column-margin column-container"><div class="">
<p><span class="math inline">\(Q_j = \frac{(\sum_{i\in I_j}r_{i,b})^2}{N_j + \lambda}\)</span></p>
</div></div><div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">q_L</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">data_L_1</span><span class="op">$</span><span class="va">resid</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_L_1</span><span class="op">)</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">)</span>
<span class="va">q_R</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">data_R_1</span><span class="op">$</span><span class="va">resid</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_R_1</span><span class="op">)</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu">DiagrammeR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DiagrammeR/man/grViz.html">grViz</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
  <span class="st">"
  digraph {
    graph [ranksep = 0.2]
    node [shape = box]
      T1R [label = 'L: -9 \n Q score = "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">q_L</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="st">"']
      T1L [label = 'R: 1 , 2 , 6 \n Q score = "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">q_R</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="st">"']
      T0 [label = '-9, 1 , 2 , 6']
    edge [minlen = 2]
      T0-&gt;T1L
      T0-&gt;T1R
    { rank = same; T1R; T1L}
  }
  "</span>
  <span class="op">)</span>

<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="htmlwidget-68f100e0810a82c9cc08" style="width:100%;height:464px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-68f100e0810a82c9cc08">{"x":{"diagram":"\n  digraph {\n    graph [ranksep = 0.2]\n    node [shape = box]\n      T1R [label = \"L: -9 \n Q score = 40.5\"]\n      T1L [label = \"R: 1 , 2 , 6 \n Q score = 20.25\"]\n      T0 [label = \"-9, 1 , 2 , 6\"]\n    edge [minlen = 2]\n      T0->T1L\n      T0->T1R\n    { rank = same; T1R; T1L}\n  }\n  ","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</div></div><p><span class="math display">\[
\begin{aligned}
q_L^* &amp; = (-9)^2 / (1 + 1) = 40.5 \\
q_R^* &amp; = (1 + 2 + 6)^2 / (3 + 1) = 20.25
\end{aligned}
\]</span></p>
<p>Notice that residuals are first summed and then squared in the denominator of the quality score (the higher, the better). This means that if the prediction is off in the same direction (meaning they are similar) among the observations within the leaf, then the quality score is higher. On the other hand, if the prediction is off in both directions (meaning they are not similar), then the residuals cancel each other out, resulting in a lower quality score. Since we would like to create leaves consisting of similar observations, a more successful split has a higher quality score.</p>
<p>Finally, the gain of this split is</p>

<div class="no-row-height column-margin column-container"><div class="">
<p><span class="math display">\[
G(s, L, R) = \frac{1}{2} \huge[\normalsize Q_L + Q_R - Q_s \huge]\normalsize - \gamma
\]</span></p>
<p>where <span class="math inline">\(s\)</span> is the leaf before split, <span class="math inline">\(L\)</span> and <span class="math inline">\(R\)</span> are leaves after the split of leaf <span class="math inline">\(s\)</span>.</p>
</div></div><div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">gain_1</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">q_L</span> <span class="op">+</span> <span class="va">q_R</span> <span class="op">-</span> <span class="va">q_0</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span> <span class="op">-</span> <span class="va">gamma</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><span class="math display">\[
G_1 = \frac{40.5 + 20.25 - 0}{2} - 10 = 20.375
\]</span></p>
<p>Now that we have gone through the process of finding update value (<span class="math inline">\(w\)</span>), quality score (<span class="math inline">\(q\)</span>), and gain (<span class="math inline">\(G\)</span>) for a given split structure, let’s write a function that returns the values of these measures by feeding the cutpoint before moving onto the next split candidate.</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">get_info</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">cutpoint</span>, <span class="va">lambda</span>, <span class="va">gamma</span><span class="op">)</span>
<span class="op">{</span>
  <span class="va">q_0</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">resid</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">)</span>

  <span class="va">data_L</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">x</span> <span class="op">&lt;</span> <span class="va">cutpoint</span>, <span class="op">]</span>
  <span class="va">data_R</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">x</span> <span class="op">&gt;=</span> <span class="va">cutpoint</span>, <span class="op">]</span>

  <span class="va">w_L</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">data_L</span><span class="op">$</span><span class="va">resid</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_L</span><span class="op">)</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">)</span>
  <span class="va">w_R</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">data_R</span><span class="op">$</span><span class="va">resid</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_R</span><span class="op">)</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">)</span>

  <span class="va">q_L</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">data_L</span><span class="op">$</span><span class="va">resid</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_L</span><span class="op">)</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">)</span>
  <span class="va">q_R</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">data_R</span><span class="op">$</span><span class="va">resid</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_R</span><span class="op">)</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">)</span>

  <span class="va">gain</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">q_L</span> <span class="op">+</span> <span class="va">q_R</span> <span class="op">-</span> <span class="va">q_0</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span> <span class="op">-</span> <span class="va">gamma</span>

  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    w_L <span class="op">=</span> <span class="va">w_L</span>, 
    w_R <span class="op">=</span> <span class="va">w_R</span>, 
    q_L <span class="op">=</span> <span class="va">q_L</span>, 
    q_R <span class="op">=</span> <span class="va">q_R</span>, 
    gain <span class="op">=</span> <span class="va">gain</span> 
  <span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="split-x-5" class="level4 page-columns page-full" data-number="9.3.0.2"><h4 data-number="9.3.0.2" class="anchored" data-anchor-id="split-x-5">
<span class="header-section-number">9.3.0.2</span> <span style="color:blue"> Split: {<code>x</code>, 5} </span>
</h4>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">measures_2</span> <span class="op">&lt;-</span> <span class="fu">get_info</span><span class="op">(</span><span class="va">data</span>, <span class="fl">5</span>, <span class="va">lambda</span>, <span class="va">gamma</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">g_0</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">5</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">3</span>, y <span class="op">=</span> <span class="fl">6</span>, label <span class="op">=</span> <span class="st">"leaf L"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">7</span>, y <span class="op">=</span> <span class="fl">6</span>, label <span class="op">=</span> <span class="st">"leaf R"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="P03-xgb_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid" width="672"></p>
</div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu">DiagrammeR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DiagrammeR/man/grViz.html">grViz</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
    <span class="st">"
    digraph {
      graph [ranksep = 0.2]
      node [shape = box]
        T1R [label = 'L: -9, 1 \n Q score = "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">measures_2</span><span class="op">$</span><span class="va">q_L</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="st">"']
        T1L [label = 'R: 2 , 6 \n Q score = "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">measures_2</span><span class="op">$</span><span class="va">q_R</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="st">"']
        T0 [label = '-9, 1 , 2 , 6']
      edge [minlen = 2]
        T0-&gt;T1L
        T0-&gt;T1R
      { rank = same; T1R; T1L}
    }
    "</span>
  <span class="op">)</span>
<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="htmlwidget-50b70d557969637ce38c" style="width:100%;height:464px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-50b70d557969637ce38c">{"x":{"diagram":"\n    digraph {\n      graph [ranksep = 0.2]\n      node [shape = box]\n        T1R [label = \"L: -9, 1 \n Q score = 21.33\"]\n        T1L [label = \"R: 2 , 6 \n Q score = 21.33\"]\n        T0 [label = \"-9, 1 , 2 , 6\"]\n      edge [minlen = 2]\n        T0->T1L\n        T0->T1R\n      { rank = same; T1R; T1L}\n    }\n    ","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</div></div><p><span class="math display">\[
\begin{aligned}
q_L^* &amp; = (-9)^2 / (2 + 1) = 21.33 \\
q_R^* &amp; = (1 + 2 + 6)^2 / (2 + 1) = 21.33
\end{aligned}
\]</span></p>
<p><span class="math display">\[
G_2 = \frac{21.33 + 21.33 - 0}{2} - 10 = 11.3333333
\]</span></p>
</section><section id="split-x-7" class="level4 page-columns page-full" data-number="9.3.0.3"><h4 data-number="9.3.0.3" class="anchored" data-anchor-id="split-x-7">
<span class="header-section-number">9.3.0.3</span> <span style="color:blue"> Split: {<code>x</code>, 7} </span>
</h4>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">measures_3</span> <span class="op">&lt;-</span> <span class="fu">get_info</span><span class="op">(</span><span class="va">data</span>, <span class="fl">7</span>, <span class="va">lambda</span>, <span class="va">gamma</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">g_0</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">7</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">4</span>, y <span class="op">=</span> <span class="fl">6</span>, label <span class="op">=</span> <span class="st">"leaf L"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">8</span>, y <span class="op">=</span> <span class="fl">6</span>, label <span class="op">=</span> <span class="st">"leaf R"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="P03-xgb_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid" width="672"></p>
</div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu">DiagrammeR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DiagrammeR/man/grViz.html">grViz</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
    <span class="st">"
    digraph {
      graph [ranksep = 0.2]
      node [shape = box]
        T1R [label = 'L: -9, 1, 2 \n Q score = "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">measures_3</span><span class="op">$</span><span class="va">q_L</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="st">"']
        T1L [label = 'R: 6 \n Q score = "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">measures_3</span><span class="op">$</span><span class="va">q_R</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="st">"']
        T0 [label = '-9, 1 , 2 , 6']
      edge [minlen = 2]
        T0-&gt;T1L
        T0-&gt;T1R
      { rank = same; T1R; T1L}
    }
    "</span>
  <span class="op">)</span>
<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="htmlwidget-18af0cc9e54ccb02a06b" style="width:100%;height:464px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-18af0cc9e54ccb02a06b">{"x":{"diagram":"\n    digraph {\n      graph [ranksep = 0.2]\n      node [shape = box]\n        T1R [label = \"L: -9, 1, 2 \n Q score = 9\"]\n        T1L [label = \"R: 6 \n Q score = 18\"]\n        T0 [label = \"-9, 1 , 2 , 6\"]\n      edge [minlen = 2]\n        T0->T1L\n        T0->T1R\n      { rank = same; T1R; T1L}\n    }\n    ","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</div></div><p><span class="math display">\[
\begin{aligned}
q_L^* &amp; = (-9)^2 / (1 + 1) = 9 \\
q_R^* &amp; = (1 + 2 + 6)^2 / (3 + 1) = 18
\end{aligned}
\]</span></p>
<p><span class="math display">\[
G_3 = \frac{9 + 18 - 0}{2} - 10 = 3.5
\]</span></p>
<p>Among all the splits we considered, the first case (Split: {<code>x</code>, 2}) has the highest score. This is easy to confirm visually and shows picking a split based on the gain measure indeed makes sense.</p>
<p>Now we consider how to split leaf R (leaf L cannot be split further as it has only one observation). We have two split candidates: {<code>x</code>, 5} and {<code>x</code>, 7}. Let’s get the gain measures using <code>get_info()</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co">#=== first split ===#</span>
<span class="fu">get_info</span><span class="op">(</span><span class="va">data_R_1</span>, <span class="fl">5</span>, <span class="va">lambda</span>, <span class="va">gamma</span><span class="op">)</span><span class="op">$</span><span class="va">gain</span> </code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -9.208333</code></pre>
</div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co">#=== second split ===#</span>
<span class="fu">get_info</span><span class="op">(</span><span class="va">data_R_1</span>, <span class="fl">7</span>, <span class="va">lambda</span>, <span class="va">gamma</span><span class="op">)</span><span class="op">$</span><span class="va">gain</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -9.625</code></pre>
</div>
</div>
<p>So, neither of the splits has a positive gain value. Therefore, we do not adopt either of the splits. For this iteration (<span class="math inline">\(b=1\)</span>), this is the end of tree building.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>If the value of <span class="math inline">\(\gamma\)</span> is lower (say, 0), then we would have adopted the second split.</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu">get_info</span><span class="op">(</span><span class="va">data_R_1</span>, <span class="fl">5</span>, <span class="va">lambda</span>, <span class="fl">0</span><span class="op">)</span><span class="op">$</span><span class="va">gain</span> <span class="co"># first split</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7916667</code></pre>
</div>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu">get_info</span><span class="op">(</span><span class="va">data_R_1</span>, <span class="fl">7</span>, <span class="va">lambda</span>, <span class="fl">0</span><span class="op">)</span><span class="op">$</span><span class="va">gain</span> <span class="co"># second split</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.375</code></pre>
</div>
</div>
<p>As you can see, a higher value of <span class="math inline">\(\gamma\)</span> leads to a more aggressive tree pruning.</p>
</div>
</div>
<p>So, the final tree for this iteration (<span class="math inline">\(b = 1\)</span>) is</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu">DiagrammeR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DiagrammeR/man/grViz.html">grViz</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
  <span class="st">"
  digraph {
    graph [ranksep = 0.2]
    node [shape = box, width = 0.3, height = 0.15, fontsize = 3, fixedsize = TRUE, penwidth = 0.2]
      T1R [label = 'L: -9 \n w* = "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">w_L</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="st">"']
      T1L [label = 'R: 1 , 2 , 6 \n w* = "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">w_R</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="st">"']
      T0 [label = '-9, 1 , 2 , 6']
    edge [penwidth = 0.2, arrowsize = 0.3, len = 0.3]
      T0-&gt;T1L
      T0-&gt;T1R
    { rank = same; T1R; T1L}
  }
  "</span>
  <span class="op">)</span>

<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="htmlwidget-c3304400b6cd1dbb2e21" style="width:100%;height:325px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-c3304400b6cd1dbb2e21">{"x":{"diagram":"\n  digraph {\n    graph [ranksep = 0.2]\n    node [shape = box, width = 0.3, height = 0.15, fontsize = 3, fixedsize = TRUE, penwidth = 0.2]\n      T1R [label = \"L: -9 \n w* = -4.5\"]\n      T1L [label = \"R: 1 , 2 , 6 \n w* = 2.25\"]\n      T0 [label = \"-9, 1 , 2 , 6\"]\n    edge [penwidth = 0.2, arrowsize = 0.3, len = 0.3]\n      T0->T1L\n      T0->T1R\n    { rank = same; T1R; T1L}\n  }\n  ","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>We now use <span class="math inline">\(w^*\)</span> from this tree to update our prediction according to <a href="#eq-update">Equation&nbsp;<span>9.7</span></a>.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p><span class="math inline">\(f_{i,b} = f_{i,b-1} + \eta \cdot w_j^*\)</span></p>
</div></div><div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">measures_1</span> <span class="op">&lt;-</span> <span class="fu">get_info</span><span class="op">(</span><span class="va">data</span>, <span class="fl">2</span>, <span class="va">lambda</span>, <span class="va">gamma</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Since the first observation is in <span class="math inline">\(L\)</span>,</p>
<p><span class="math display">\[
f_{i = 1,b = 1} = 6 + 0.3 \times -4.5 = 4.65
\]</span></p>
<p>Since the second, third, and fourth observations are in <span class="math inline">\(R\)</span>,</p>
<p><span class="math display">\[
\begin{aligned}
f_{i = 2,b = 1} = 6 + 0.3 \times 2.25 = 6.68 \\
f_{i = 3,b = 1} = 6 + 0.3 \times 2.25  = 6.68\\
f_{i = 4,b = 1} = 6 + 0.3 \times 2.25 = 6.68
\end{aligned}
\]</span></p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="va">.</span><span class="op">[</span>, <span class="va">f_0</span> <span class="op">:=</span> <span class="va">f_0</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="va">.</span><span class="op">[</span><span class="fl">1</span>, <span class="va">f_1</span> <span class="op">:=</span> <span class="va">f_0</span> <span class="op">+</span> <span class="va">measures_1</span><span class="op">$</span><span class="va">w_L</span> <span class="op">*</span> <span class="va">eta</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="va">.</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">4</span>, <span class="va">f_1</span> <span class="op">:=</span> <span class="va">f_0</span> <span class="op">+</span> <span class="va">measures_1</span><span class="op">$</span><span class="va">w_R</span> <span class="op">*</span> <span class="va">eta</span><span class="op">]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The prediction updates can be seen below. Though small, we made small improvements in our prediction.</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span>, x <span class="op">=</span> <span class="va">x</span>, color <span class="op">=</span> <span class="st">"observed"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">f_1</span>, x <span class="op">=</span> <span class="va">x</span>, color <span class="op">=</span> <span class="st">"after (f1)"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">f_0</span>, x <span class="op">=</span> <span class="va">x</span>, color <span class="op">=</span> <span class="st">"before (f0)"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>
    values <span class="op">=</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
        <span class="st">"before (f0)"</span> <span class="op">=</span> <span class="st">"blue"</span>, 
        <span class="st">"after (f1)"</span> <span class="op">=</span> <span class="st">"red"</span>,
        <span class="st">"observed"</span> <span class="op">=</span> <span class="st">"black"</span>
      <span class="op">)</span>, 
    name <span class="op">=</span> <span class="st">""</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span><span class="op">(</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">f_0</span>, x <span class="op">=</span> <span class="va">x</span>, yend <span class="op">=</span> <span class="va">f_1</span>, xend <span class="op">=</span> <span class="va">x</span><span class="op">)</span>, 
    color <span class="op">=</span> <span class="st">"blue"</span>,
    arrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html">arrow</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="P03-xgb_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now, we move on to <span class="math inline">\(b=2\)</span>. We first update residuals:</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">data</span><span class="op">[</span>, <span class="va">resid</span> <span class="op">:=</span> <span class="va">y</span> <span class="op">-</span> <span class="va">f_1</span><span class="op">]</span>

<span class="va">data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    y x  resid f_0   f_1
1: -3 1 -7.650   6 4.650
2:  7 4  0.325   6 6.675
3:  8 6  1.325   6 6.675
4: 12 8  5.325   6 6.675</code></pre>
</div>
</div>
<p>Just like at <span class="math inline">\(b=1\)</span>, all the possible splits are {<code>x</code>, 2}, {<code>x</code>, 5}, {<code>x</code>, 7}. Let’s find the gain for each split.</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">5</span>, <span class="fl">7</span><span class="op">)</span>,
  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">get_info</span><span class="op">(</span><span class="va">data</span>, <span class="va">x</span>, <span class="va">lambda</span>, <span class="va">gamma</span><span class="op">)</span><span class="op">$</span><span class="va">gain</span>
<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 10.66639

[[2]]
[1] 6.267458

[[3]]
[1] 1.543344</code></pre>
</div>
</div>
<p>So, the first split is again the best split. Should we split the right leaf, which has the observations except the first one?</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">7</span><span class="op">)</span>,
  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">get_info</span><span class="op">(</span><span class="va">data</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, <span class="op">]</span>, <span class="va">x</span>, <span class="va">lambda</span>, <span class="va">gamma</span><span class="op">)</span><span class="op">$</span><span class="va">gain</span>
<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] -9.988437

[[2]]
[1] -10</code></pre>
</div>
</div>
<p>All the splits have negative gains. So, we do not split this leaf just like at <span class="math inline">\(b=1\)</span>.</p>
<p>So, the final tree for this iteration (<span class="math inline">\(b = 1\)</span>) is</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">measures_b2</span> <span class="op">&lt;-</span> <span class="fu">get_info</span><span class="op">(</span><span class="va">data</span>, <span class="fl">2</span>, <span class="va">lambda</span>, <span class="va">gamma</span><span class="op">)</span>

<span class="co">#| code-fold: true</span>
<span class="co">#| fig-height: 2</span>
<span class="co">#| fig-width: 4</span>

<span class="fu">DiagrammeR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DiagrammeR/man/grViz.html">grViz</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
  <span class="st">"
  digraph {
    graph [ranksep = 0.2]
    node [shape = box, width = 0.4, height = 0.15, fontsize = 3, fixedsize = TRUE, penwidth = 0.2]
      T1R [label = 'L: -8.18 \n w* = "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">measures_b2</span><span class="op">$</span><span class="va">w_L</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="st">"']
      T1L [label = 'R: 0.71 , 1.71 , 5.71 \n w* = "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">measures_b2</span><span class="op">$</span><span class="va">w_R</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="st">"']
      T0 [label = '-8.18, 0.71 , 1.71 , 5.71']
    edge [penwidth = 0.2, arrowsize = 0.3, len = 0.3]
      T0-&gt;T1L
      T0-&gt;T1R
    { rank = same; T1R; T1L}
  }
  "</span>
  <span class="op">)</span>

<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="htmlwidget-5307f49618aa154a9b70" style="width:100%;height:464px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-5307f49618aa154a9b70">{"x":{"diagram":"\n  digraph {\n    graph [ranksep = 0.2]\n    node [shape = box, width = 0.4, height = 0.15, fontsize = 3, fixedsize = TRUE, penwidth = 0.2]\n      T1R [label = \"L: -8.18 \n w* = -3.83\"]\n      T1L [label = \"R: 0.71 , 1.71 , 5.71 \n w* = 1.74\"]\n      T0 [label = \"-8.18, 0.71 , 1.71 , 5.71\"]\n    edge [penwidth = 0.2, arrowsize = 0.3, len = 0.3]\n      T0->T1L\n      T0->T1R\n    { rank = same; T1R; T1L}\n  }\n  ","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Let’s now update our predictions.</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="va">.</span><span class="op">[</span><span class="fl">1</span>, <span class="va">f_2</span> <span class="op">:=</span> <span class="va">f_1</span> <span class="op">+</span> <span class="va">measures_b2</span><span class="op">$</span><span class="va">w_L</span> <span class="op">*</span> <span class="va">eta</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  
  <span class="va">.</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">4</span>, <span class="va">f_2</span> <span class="op">:=</span> <span class="va">f_1</span> <span class="op">+</span> <span class="va">measures_b2</span><span class="op">$</span><span class="va">w_R</span> <span class="op">*</span> <span class="va">eta</span><span class="op">]</span> </code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span>, x <span class="op">=</span> <span class="va">x</span>, color <span class="op">=</span> <span class="st">"observed"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">f_2</span>, x <span class="op">=</span> <span class="va">x</span>, color <span class="op">=</span> <span class="st">"f2"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">f_1</span>, x <span class="op">=</span> <span class="va">x</span>, color <span class="op">=</span> <span class="st">"f1"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">f_0</span>, x <span class="op">=</span> <span class="va">x</span>, color <span class="op">=</span> <span class="st">"f0"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>
    values <span class="op">=</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
        <span class="st">"f0"</span> <span class="op">=</span> <span class="st">"blue"</span>, 
        <span class="st">"f1"</span> <span class="op">=</span> <span class="st">"red"</span>,
        <span class="st">"f2"</span> <span class="op">=</span> <span class="st">"red"</span>,
        <span class="st">"observed"</span> <span class="op">=</span> <span class="st">"black"</span>
      <span class="op">)</span>, 
    name <span class="op">=</span> <span class="st">""</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span><span class="op">(</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">f_0</span>, x <span class="op">=</span> <span class="va">x</span>, yend <span class="op">=</span> <span class="va">f_1</span>, xend <span class="op">=</span> <span class="va">x</span><span class="op">)</span>, 
    color <span class="op">=</span> <span class="st">"blue"</span>,
    arrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html">arrow</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span><span class="op">(</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">f_1</span>, x <span class="op">=</span> <span class="va">x</span>, yend <span class="op">=</span> <span class="va">f_2</span>, xend <span class="op">=</span> <span class="va">x</span><span class="op">)</span>, 
    color <span class="op">=</span> <span class="st">"blue"</span>,
    arrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html">arrow</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="P03-xgb_files/figure-html/unnamed-chunk-66-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Again, we made small improvements in our predictions. This process continues until user-specified stopping criteria is met.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>
<span class="math inline">\(\lambda\)</span>:
<ul>
<li>A higher value of <span class="math inline">\(\lambda\)</span> leads to a lower value of prediction updates (<span class="math inline">\(w^*\)</span>).</li>
<li>A higher value of <span class="math inline">\(\lambda\)</span> leads to a lower value of quality score (<span class="math inline">\(Q\)</span>), thus leading to a lower value of gain (<span class="math inline">\(G\)</span>), which then leads to more aggressive pruning for a given value of <span class="math inline">\(\gamma\)</span>.</li>
</ul>
</li>
<li>
<span class="math inline">\(\gamma\)</span>:
<ul>
<li>A higher value of <span class="math inline">\(\gamma\)</span> leads to more aggressive pruning.</li>
</ul>
</li>
<li>
<span class="math inline">\(\eta\)</span>:
<ul>
<li>A higher value of <span class="math inline">\(\eta\)</span> leads to faster learning.</li>
</ul>
</li>
</ul>
</div>
</div>
</section></section><section id="implementation" class="level2" data-number="9.4"><h2 data-number="9.4" class="anchored" data-anchor-id="implementation">
<span class="header-section-number">9.4</span> Implementation</h2>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" aria-current="page">R</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Python</a></li>
</ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<p>You can use the <code>xgboost</code> package to implement XGB modeling.</p>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dmlc/xgboost">xgboost</a></span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'xgboost'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:dplyr':

    slice</code></pre>
</div>
</div>
<p>The first task is to create a class of matrix called <code>xgb.DMatrix</code> using the <code><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html">xgb.DMatrix()</a></code> function. You provide the explanatory variable data matrix to the <code>data</code> option and the dependent variable matrix (vector) to the <code>label</code> option in <code><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html">xgb.DMatrix()</a></code> like below.</p>
<p>Let’s get the <code>mlb1</code> data from the <code>wooldridge</code> package for demonstration.</p>
<div class="cell">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://justinmshea.github.io/wooldridge/">wooldridge</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">mlb1</span><span class="op">)</span>

<span class="va">mlb1_dt</span> <span class="op">&lt;-</span> 
  <span class="va">mlb1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># turn into data.table </span>
  <span class="va">.</span><span class="op">[</span>, <span class="va">salary</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># remove salary (use lsalary instead)</span>
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/na.omit.data.table.html">na.omit</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># remove observations with NA in any of the variables</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">mlb1_dm_X</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html">xgb.DMatrix</a></span><span class="op">(</span>
    data <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">mlb1_dt</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">hruns</span>, <span class="va">years</span>, <span class="va">rbisyr</span>, <span class="va">allstar</span>, <span class="va">runsyr</span>, <span class="va">hits</span>, <span class="va">bavg</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,
    label <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">mlb1_dt</span><span class="op">[</span>, <span class="va">lsalary</span><span class="op">]</span><span class="op">)</span>
  <span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can then use <code><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html">xgb.train()</a></code> to train a model using the XGB algorithm.</p>
<div class="cell">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">xgb_fit</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html">xgb.train</a></span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">mlb1_dm_X</span>, <span class="co"># independent variable</span>
    nrounds <span class="op">=</span> <span class="fl">100</span>, <span class="co"># number of iterations (trees to add)</span>
    eta <span class="op">=</span> <span class="fl">1</span>, <span class="co"># learning rate</span>
    objective <span class="op">=</span> <span class="st">"reg:squarederror"</span> <span class="co"># objective function</span>
  <span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">

</div>
</div>
</div>


</section><section class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1" role="doc-endnote"><p>This helps for some of the commonly used loss functions<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./P02-boosted-regression-forest.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Boosted Regression Forest</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./causal-ml.html" class="pagination-link">
        <span class="nav-page-text">Causal Machine Learning (CML) Methods</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>