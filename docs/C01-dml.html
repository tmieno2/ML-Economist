<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.568">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Introduction to Machine Learning for Economists - 10&nbsp; Double Machine Learning</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./C02-r-learner.html" rel="next">
<link href="./C00-why-not-this.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><link href="style.css" rel="stylesheet" type="text/css">
<!-- Global site tag (gtag.js) - Google Analytics --><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-45VKT2HZSL"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'G-45VKT2HZSL');
</script><script src="site_libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><script src="site_libs/viz-1.8.2/viz.js"></script><link href="site_libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="site_libs/grViz-binding-1.0.9/grViz.js"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Double Machine Learning</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Introduction to Machine Learning for Economists</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/tmieno2/ML-Economist" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="" title="Share" id="sidebar-tool-dropdown-0" class="sidebar-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-share"></i></a>
    <ul class="dropdown-menu" aria-labelledby="sidebar-tool-dropdown-0">
<li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=%7Curl%7C">
            <i class="bi bi-bi-twitter pe-1"></i>
          Twitter
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=%7Curl%7C">
            <i class="bi bi-bi-facebook pe-1"></i>
          Facebook
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=%7Curl%7C">
            <i class="bi bi-bi-linkedin pe-1"></i>
          LinkedIn
          </a>
        </li>
    </ul>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Welcome</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./H00-preface.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./B0P-basics.html" class="sidebar-item-text sidebar-link">Basics</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B01-nonlinear.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Non-linear function estimation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B02-bias-variance-tradeoff.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Bias-variance Trade-off</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B03-cross-validation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Cross-validation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B04-regularization.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Regression Shrinkage Methods</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B05-bootstrap.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Bootstrap</span></a>
  </div>
</li>
    </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./P0P-prediction-ml.html" class="sidebar-item-text sidebar-link">Prediction ML</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P01-random-forest.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Random Forest</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P02-boosted-regression-forest.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Boosted Regression Forest</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P03-xgb.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Extreme Gradient Boosting</span></a>
  </div>
</li>
    </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./C0P-causal-ml.html" class="sidebar-item-text sidebar-link">Causal Machine Learning (CML) Methods</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C00-why-not-this.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Why can’t we just do this?</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C01-dml.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Double Machine Learning</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C02-r-learner.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">R-learner</span></a>
  </div>
</li>
    </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./E0P-extensions.html" class="sidebar-item-text sidebar-link">Extensions</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./E01-spatial-cv.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Spatial Cross-validation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./E02-grf.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Generalized Random Forest</span></a>
  </div>
</li>
    </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./PROG-00-programming.html" class="sidebar-item-text sidebar-link">Programming Guide</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PROG-01-mlr3.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Machine Learning with <code>mlr3</code> in R</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PROG-02-reticulate.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Running Python from R</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PROG-03-model-selection-prediction.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Model Selection (Prediction)</span></a>
  </div>
</li>
    </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">Appendices</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A01-mc-simulation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Monte Carlo (MC) Simulation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A02-method-of-moment.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Primer on method of moment</span></a>
  </div>
</li>
    </ul>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#dml-the-basic-idea" id="toc-dml-the-basic-idea" class="nav-link active" data-scroll-target="#dml-the-basic-idea"> <span class="header-section-number">10.1</span> DML: the basic idea</a>
  <ul class="collapse">
<li><a href="#problem-setting" id="toc-problem-setting" class="nav-link" data-scroll-target="#problem-setting"> <span class="header-section-number">10.1.1</span> Problem Setting</a></li>
  <li><a href="#sec-dml-naive" id="toc-sec-dml-naive" class="nav-link" data-scroll-target="#sec-dml-naive"> <span class="header-section-number">10.1.2</span> An intuitive, yet naive approach</a></li>
  <li><a href="#overcoming-the-regularization-bias" id="toc-overcoming-the-regularization-bias" class="nav-link" data-scroll-target="#overcoming-the-regularization-bias"> <span class="header-section-number">10.1.3</span> Overcoming the regularization bias</a></li>
  <li><a href="#sec-cf" id="toc-sec-cf" class="nav-link" data-scroll-target="#sec-cf"> <span class="header-section-number">10.1.4</span> Overcoming the over-fitting bias</a></li>
  </ul>
</li>
  <li>
<a href="#models-and-implementation-by-doubleml" id="toc-models-and-implementation-by-doubleml" class="nav-link" data-scroll-target="#models-and-implementation-by-doubleml"> <span class="header-section-number">10.2</span> Models and implementation by <code>DoubleML</code></a>
  <ul class="collapse">
<li><a href="#partially-linear-model" id="toc-partially-linear-model" class="nav-link" data-scroll-target="#partially-linear-model"> <span class="header-section-number">10.2.1</span> Partially linear model</a></li>
  <li><a href="#partially-linear-iv-model" id="toc-partially-linear-iv-model" class="nav-link" data-scroll-target="#partially-linear-iv-model"> <span class="header-section-number">10.2.2</span> Partially linear IV model</a></li>
  </ul>
</li>
  <li><a href="#suggested-exercises" id="toc-suggested-exercises" class="nav-link" data-scroll-target="#suggested-exercises"> <span class="header-section-number">10.3</span> Suggested Exercises</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/tmieno2/ML-Economist/edit/master/C01-dml.qmd" class="toc-action">Edit this page</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-dml" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Double Machine Learning</span></span></h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header><p>One of the most important ideas of the recent development of causal machine learning (CML) methods originate from <span class="citation" data-cites="Chernozhukov2018">Chernozhukov et al. (<a href="#ref-Chernozhukov2018" role="doc-biblioref">2018</a>)</span>, which proposed Double/Debiased ML methods. In this section, we go over those key ideas that are at the heart of many other important CML methods we will learn later. We then learn various models you can estimate using the R and Python <code>DoubleML</code> package <span class="citation" data-cites="DoubleML2021R DoubleML2022Python">(<a href="#ref-DoubleML2021R" role="doc-biblioref">P. Bach et al. 2021</a>; <a href="#ref-DoubleML2022Python" role="doc-biblioref">Philipp Bach et al. 2022</a>)</span>.</p>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
What you will learn
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>How double/debiased machine learning works
<ul>
<li>avoiding regularlization bias through orthogonalization</li>
<li>avoiding over-fitting bias through cross-fitting</li>
</ul>
</li>
<li>Mechanics of DML
<ul>
<li>method of moment</li>
<li>score function</li>
<li>cross-fitting</li>
</ul>
</li>
<li>How to estimate ATE under conditional unconfoundedness using <code><a href="https://rdrr.io/pkg/DoubleML/man/DoubleMLPLR.html">DoubleMLPLR()</a></code> and under confoundedness using <code><a href="https://rdrr.io/pkg/DoubleML/man/DoubleMLPLIV.html">DoubleMLPLIV()</a></code>.</li>
</ul>
</div>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Preferable background knowledge
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>how to use <code>mlr3</code> (see <span class="quarto-unresolved-ref">?sec-mlr3</span>)</li>
<li>idea of method of moment</li>
<li>causal diagram</li>
</ul>
</div>
</div>
<section id="dml-the-basic-idea" class="level2 page-columns page-full" data-number="10.1"><h2 data-number="10.1" class="anchored" data-anchor-id="dml-the-basic-idea">
<span class="header-section-number">10.1</span> DML: the basic idea</h2>
<section id="problem-setting" class="level3 page-columns page-full" data-number="10.1.1"><h3 data-number="10.1.1" class="anchored" data-anchor-id="problem-setting">
<span class="header-section-number">10.1.1</span> Problem Setting</h3>
<p>Throughout this section, we are interested in estimating the following econometric model , which is called a partially linear regression model (PLR).</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>We try to follow the notations of <span class="citation" data-cites="Chernozhukov2018">Chernozhukov et al. (<a href="#ref-Chernozhukov2018" role="doc-biblioref">2018</a>)</span> as much as possible.</p>
</div></div><p><span class="math display">\[
\begin{aligned}
y = \theta d + g_0(X) + \mu \\
d = m_0(X) + \eta
\end{aligned}
\]</span></p>

<div class="no-row-height column-margin column-container"><div class="">
<p>Partially linear regression model is a class of models where some of the variables are linear in parameter (here, <span class="math inline">\(\theta d\)</span>) and the rest of the variables are modeled non-parametrically (here, <span class="math inline">\(g_0(X)\)</span>).</p>
</div></div><p>Your sole interest is in estimating <span class="math inline">\(\theta\)</span>: the impact of the treatment (<span class="math inline">\(d\)</span>). <span class="math inline">\(g_0(X)\)</span> is the impact of a collection of variables <span class="math inline">\(X\)</span>. <span class="math inline">\(m_0(X)\)</span> expresses how <span class="math inline">\(X\)</span> affects the treatment status, <span class="math inline">\(d\)</span>. <span class="math inline">\(d\)</span> may be binary or continuous. $</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Assumptions on the error terms
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><span class="math inline">\(E[\mu|D,X] = 0\)</span></li>
<li><span class="math inline">\(E[\eta|X] = 0\)</span></li>
</ul>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The treatment effect is assumed to be constant irrespective of the value of <span class="math inline">\(X\)</span>. So, the treatment effect is not heterogeneous. We will cover heterogeneous treatment effect estimation later.</p>
</div>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Terminology alert
</div>
</div>
<div class="callout-body-container callout-body">
<p><span class="math inline">\(g_0(X)\)</span> and <span class="math inline">\(m_0(X)\)</span> are called <span style="color:blue"> nuisance functions </span>because knowing them is not the ultimate goal. We are only interested in <strong>controlling for</strong> them to estimate <span class="math inline">\(\theta\)</span> accurately.</p>
</div>
</div>
</section><section id="sec-dml-naive" class="level3 page-columns page-full" data-number="10.1.2"><h3 data-number="10.1.2" class="anchored" data-anchor-id="sec-dml-naive">
<span class="header-section-number">10.1.2</span> An intuitive, yet naive approach</h3>

<div class="no-row-height column-margin column-container"><div class="">
<p><strong>Packages to load for replication</strong></p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/magick/">magick</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.doubleml.org/stable/index.html">DoubleML</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3.mlr-org.com">mlr3</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3learners.mlr-org.com">mlr3learners</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">ggbrace</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rsample.tidymodels.org">rsample</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/">MASS</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/imbs-hl/ranger">ranger</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div></div><p>Consider the estimating equation of interest below.</p>
<p><span id="eq-model-naive"><span class="math display">\[
\begin{aligned}
y = \theta d + g_0(X) + \mu
\end{aligned}
\tag{10.1}\]</span></span></p>
<p>Subtracting <span class="math inline">\(g_0(x)\)</span> from both sides,</p>
<p><span class="math display">\[
\begin{aligned}
y - g_0(x) = \theta d + \mu
\end{aligned}
\]</span></p>
<p>So, if we know <span class="math inline">\(g_0(X)\)</span>, then we can simply regress <span class="math inline">\(y - g_0(x)\)</span> on <span class="math inline">\(d\)</span>. Of course, we do not know <span class="math inline">\(g_0(X)\)</span>, so we need to estimate <span class="math inline">\(g_0(x)\)</span>. Let <span class="math inline">\(\hat{g}_0(x)\)</span> denote <span class="math inline">\(g_0(x)\)</span> estimated by any appropriate machine learning method. Then, we can regress <span class="math inline">\(y - \hat{g}_0(x)\)</span> on <span class="math inline">\(d\)</span> to estimate <span class="math inline">\(\theta\)</span> using OLS. Mathematically, it can be written as follows:</p>
<p><span class="math display">\[
\begin{aligned}
\hat{\theta} = (\frac{1}{n}\sum_{i=1}^N d_i d_i)^{-1}\frac{1}{n}\sum_{i=1}^N d_i (y_i - \hat{g}_0(X_i))
\end{aligned}
\]</span></p>
<p>Now, subtracting <span class="math inline">\(\hat{g}_0(x)\)</span> from both sides of <a href="#eq-model-naive">Equation&nbsp;<span>10.1</span></a>,</p>
<p><span class="math display">\[
\begin{aligned}
y - \hat{g}_0(x) = \theta d + (g_0(x) - \hat{g}_0(x) + \mu)
\end{aligned}
\]</span></p>
<p>So, as long as <span class="math inline">\(d\)</span> is not correlated with <span class="math inline">\(g_0(x) - \hat{g}_0(x) + \mu\)</span>, then the regression of <span class="math inline">\(y - \hat{g}_0(x)\)</span> on <span class="math inline">\(d\)</span> should work. Unfortunately, this approach turns out to be naive and suffer from bias in general <span class="citation" data-cites="Chernozhukov2018">(<a href="#ref-Chernozhukov2018" role="doc-biblioref">Chernozhukov et al. 2018</a>)</span>.</p>
<p>As a way to implement this naive approach, consider the following procedures.</p>
<ul>
<li>Step 1: Estimate <span class="math inline">\(g_0(X)\)</span> and then subtract the fitted value of <span class="math inline">\(g_0(X)\)</span> from <span class="math inline">\(y\)</span>.
<ul>
<li>Step 1.1: Regress <span class="math inline">\(y\)</span> on <span class="math inline">\(X\)</span> to estimate <span class="math inline">\(E[y|X]\)</span> and call it <span class="math inline">\(\hat{l}_0(x)\)</span>
</li>
<li>Step 1.2: Regress <span class="math inline">\(d\)</span> on <span class="math inline">\(X\)</span> to estimate <span class="math inline">\(E[d|X]\)</span> (<span class="math inline">\(m_0(X)\)</span>), call it <span class="math inline">\(\hat{m}_0(x)\)</span>, and calculate <span class="math inline">\(\tilde{d} = d - \hat{m}_0(X)\)</span>.</li>
<li>Step 1.3: Get an initial estimate of <span class="math inline">\(\theta\)</span> using <span id="eq-partial-out"><span class="math display">\[
\begin{aligned}
\hat{\theta}_{init} = (\frac{1}{n}\sum_{i=1}^N \tilde{d}_i \tilde{d}_i)^{-1}\frac{1}{n}\sum_{i=1}^N \tilde{d}_i (y_i - \hat{l}_0(X_i))
\end{aligned}
\tag{10.2}\]</span></span>
</li>
<li>Step 1.4: Regress <span class="math inline">\(y_i - \hat{\theta}_{init}d\)</span> on <span class="math inline">\(X\)</span> to estimate <span class="math inline">\(g_0(X)\)</span> and call it <span class="math inline">\(\hat{g}_0(X)\)</span>.</li>
</ul>
</li>
<li>Step 2: Regress <span class="math inline">\(y - \hat{g}_0(X)\)</span> on <span class="math inline">\(d\)</span> using OLS. Or equivalently, use the following formula <span id="eq-theta-partial"><span class="math display">\[
\begin{aligned}
  \hat{\theta} = (\frac{1}{n}\sum_{i=1}^N d_i d_i)^{-1}\frac{1}{n}\sum_{i=1}^N d_i (y_i - \hat{g}_0(X_i))
\end{aligned}
\tag{10.3}\]</span></span>
</li>
</ul>
<p>To demonstrate the bias problem, we work on the following data generating process used in <a href="https://docs.doubleml.org/stable/guide/basics.html">the user guide for the DoubleML package</a>.</p>
<p><span id="eq-simple-synthetic"><span class="math display">\[
\begin{aligned}
y_i = 0.5 d_i  + \frac{exp(x_{i,1})}{1 + exp(x_{i,1})} + \frac{1}{4}\cdot x_{i,3} + \mu_i \\
d_i = x_{i,1} + \frac{1}{4}\cdot\frac{exp(x_{i,3})}{1 + exp(x_{i,3})} \eta_i
\end{aligned}
\tag{10.4}\]</span></span></p>
<p>where <span class="math inline">\(\mu_i \sim N(0, 1)\)</span> and <span class="math inline">\(\eta_i \sim N(0, 1)\)</span>. The error terms (<span class="math inline">\(\mu_i\)</span> and <span class="math inline">\(\eta_i\)</span>) are independent. In this data generating process, <span class="math inline">\(d\)</span> is continuous (not binary) and its effect on <span class="math inline">\(y\)</span> is assumed to be linear.</p>
<p>We use the <code>gen_data()</code> function (defined on the right), which is a slightly generalized version of the <code><a href="https://rdrr.io/pkg/DoubleML/man/make_plr_CCDDHNR2018.html">make_plr_CCDDHNR2018()</a></code> function from the <code>DoubleML</code> package.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p><code>gen_data()</code> allows you to specify <span class="math inline">\(g_0(X)\)</span> and <span class="math inline">\(m_0(X)\)</span> unlike <code><a href="https://rdrr.io/pkg/DoubleML/man/make_plr_CCDDHNR2018.html">make_plr_CCDDHNR2018()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gen_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">g_formula</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">formula</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x1</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">x3</span><span class="op">/</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span>, <span class="co"># formula that defines m(x)</span></span>
<span>  <span class="va">m_formula</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">formula</a></span><span class="op">(</span><span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x3</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x3</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span>, <span class="co"># formula that defines g(x)</span></span>
<span>  <span class="va">te_formula</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">formula</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">*</span><span class="va">d</span><span class="op">)</span><span class="op">)</span>, <span class="co"># formula that defines theta(x) * t</span></span>
<span>  <span class="va">n_obs</span> <span class="op">=</span> <span class="fl">500</span>, </span>
<span>  <span class="va">n_vars</span> <span class="op">=</span> <span class="fl">20</span>, </span>
<span>  <span class="va">mu_x</span> <span class="op">=</span> <span class="fl">0</span>, </span>
<span>  <span class="va">vcov_x</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">sigma</span> <span class="op">=</span> <span class="fl">1</span> <span class="co"># sd of the error term in the y equation</span></span>
<span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">vcov_x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">vcov_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n_vars</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">n_vars</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">n_vars</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">vcov_x</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.7</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">i</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">n_vars</span><span class="op">)</span><span class="op">)</span> </span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co">#=== draw from multivariate normal ===#</span></span>
<span>  <span class="va">data</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html">mvrnorm</a></span><span class="op">(</span><span class="va">n_obs</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n_vars</span><span class="op">)</span>, Sigma <span class="op">=</span> <span class="va">vcov_x</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html">setnames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="fl">1</span><span class="op">:</span><span class="va">n_vars</span><span class="op">)</span><span class="op">)</span>  </span>
<span></span>
<span>  <span class="co">#=== generate d ===#</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">m_formula</span> <span class="op">==</span> <span class="st">"independent"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">data</span><span class="op">[</span>, <span class="va">d</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n_obs</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">data</span><span class="op">[</span>, <span class="va">d</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.frame.html">model.frame</a></span><span class="op">(</span><span class="va">m_formula</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n_obs</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co">#=== generate y ===#</span></span>
<span>  <span class="va">data</span><span class="op">[</span>, <span class="va">g</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.frame.html">model.frame</a></span><span class="op">(</span><span class="va">g_formula</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co">#=== generate treatment effect ===#</span></span>
<span>  <span class="va">data</span><span class="op">[</span>, <span class="va">te</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.frame.html">model.frame</a></span><span class="op">(</span><span class="va">te_formula</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co">#=== generate y ===#</span></span>
<span>  <span class="va">data</span><span class="op">[</span>, <span class="va">y</span> <span class="op">:=</span> <span class="va">te</span> <span class="op">+</span> <span class="va">g</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n_obs</span>, sd <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div></div><div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">782394</span><span class="op">)</span></span>
<span></span>
<span><span class="va">training_data</span> <span class="op">&lt;-</span> <span class="fu">gen_data</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It has 20 <code>x</code> variables (for <span class="math inline">\(X\)</span>) along with <code>d</code> (treatment) and <code>y</code> (dependent variable). Only <code>x1</code> and <code>x3</code> are the relevant variables. The rest of <span class="math inline">\(X\)</span> do not play any role in explaining either <span class="math inline">\(Y\)</span> or <span class="math inline">\(d\)</span>. However, they are correlated with <code>x1</code> and <code>x3</code> and interfere with estimating the nuisance functions.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">training_data</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Classes 'data.table' and 'data.frame':  500 obs. of  24 variables:
 $ x1 : num  -0.337 1.024 0.806 1.853 0.665 ...
 $ x2 : num  -0.589 0.332 -0.231 1.148 0.22 ...
 $ x3 : num  -0.552 0.747 0.368 0.393 0.787 ...
 $ x4 : num  -0.382 1.319 0.448 1.27 0.7 ...
 $ x5 : num  -0.767 0.267 2.248 0.631 1.119 ...
 $ x6 : num  -1.215 1.443 2.286 0.345 0.98 ...
 $ x7 : num  -1.264 0.71 1.501 0.377 0.5 ...
 $ x8 : num  0.0721 0.3655 0.3619 -0.5356 -0.273 ...
 $ x9 : num  -0.173 0.606 1.154 -0.696 -0.51 ...
 $ x10: num  0.819 -0.999 0.631 -0.557 0.785 ...
 $ x11: num  -0.472 -0.315 1.852 -0.211 0.9 ...
 $ x12: num  0.103 0.567 1.94 -1.213 1.242 ...
 $ x13: num  0.3928 0.0847 0.7765 0.6242 0.1518 ...
 $ x14: num  -0.595 -0.251 -0.136 0.463 -0.579 ...
 $ x15: num  -1.072 -0.162 0.453 0.936 0.622 ...
 $ x16: num  -2.018 -0.618 0.258 0.938 0.943 ...
 $ x17: num  -2.295 -0.145 0.244 0.86 1.65 ...
 $ x18: num  -1.17695 0.00813 -0.31748 0.18926 -0.43306 ...
 $ x19: num  -0.7709 -1.0058 -0.0689 0.91 0.4431 ...
 $ x20: num  -0.603 -1.071 1.052 0.722 0.933 ...
 $ d  : num  -0.654 0.515 -1.818 -0.551 1.041 ...
 $ g  : num  0.278 0.923 0.783 0.963 0.857 ...
 $ te : num  -0.327 0.258 -0.909 -0.275 0.52 ...
 $ y  : num  -0.0139 0.2852 0.871 1.4636 1.8665 ...
 - attr(*, ".internal.selfref")=&lt;externalptr&gt; </code></pre>
</div>
</div>
<section id="step-1" class="level4 page-columns page-full" data-number="10.1.2.1"><h4 data-number="10.1.2.1" class="anchored" data-anchor-id="step-1">
<span class="header-section-number">10.1.2.1</span> Step 1</h4>
<p>Let’s now work on Step 1. We estimate <span class="math inline">\(g_0(X)\)</span> using random forest (RF). As described above, this is a four-step process.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>It does not have to be RF. Indeed, you can use any statistical methods in this step.</p>
</div></div><p><strong>Step 1.1</strong>: Estimate <span class="math inline">\(l_0(X)\)</span> by regressing <span class="math inline">\(y\)</span> on <span class="math inline">\(X\)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--------------------------</span></span>
<span><span class="co"># Step 1.1</span></span>
<span><span class="co">#--------------------------</span></span>
<span><span class="va">rf_fitted_l0</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ranger/man/ranger.html">ranger</a></span><span class="op">(</span></span>
<span>    <span class="va">y</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>    data <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">training_data</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"y"</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"x"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    mtry <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    num.trees <span class="op">=</span> <span class="fl">132</span>,</span>
<span>    max.depth <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    min.node.size <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#=== fitted values ===#</span></span>
<span><span class="va">l0_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">rf_fitted_l0</span>, data <span class="op">=</span> <span class="va">training_data</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span></span>
<span></span>
<span><span class="co">#=== create y - l0_hat ===#</span></span>
<span><span class="va">training_data</span><span class="op">[</span>, <span class="va">y_less_l</span> <span class="op">:=</span> <span class="va">y</span> <span class="op">-</span> <span class="va">l0_hat</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Step 1.2</strong>: Estimate <span class="math inline">\(m_0(X)\)</span> by regressing <span class="math inline">\(d\)</span> on <span class="math inline">\(X\)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--------------------------</span></span>
<span><span class="co"># Step 1.2</span></span>
<span><span class="co">#--------------------------</span></span>
<span><span class="va">rf_fitted_m0</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ranger/man/ranger.html">ranger</a></span><span class="op">(</span></span>
<span>    <span class="va">d</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>    data <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">training_data</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"d"</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"x"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    mtry <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    num.trees <span class="op">=</span> <span class="fl">378</span>,</span>
<span>    max.depth <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    min.node.size <span class="op">=</span> <span class="fl">6</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#=== fitted values ===#</span></span>
<span><span class="va">m0_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">rf_fitted_m0</span>, data <span class="op">=</span> <span class="va">training_data</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span></span>
<span></span>
<span><span class="co">#=== create y - m0_hat ===#</span></span>
<span><span class="va">training_data</span><span class="op">[</span>, <span class="va">d_less_m</span> <span class="op">:=</span> <span class="va">d</span> <span class="op">-</span> <span class="va">m0_hat</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>Figure of <code>d</code> (treatment variable) plotted against <code>m0_hat</code> (<span class="math inline">\(\hat{m}_0(X)\)</span>).</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">training_data</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">d</span>, x <span class="op">=</span> <span class="va">m0_hat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_abline</a></span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="C01-dml_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div></div><p><strong>Step 1.3</strong>: Get an initial estimate of <span class="math inline">\(\theta\)</span> using <a href="#eq-partial-out">Equation&nbsp;<span>10.2</span></a>.</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--------------------------</span></span>
<span><span class="co"># Step 1.2</span></span>
<span><span class="co">#--------------------------</span></span>
<span><span class="va">theta_init</span> <span class="op">&lt;-</span> <span class="va">training_data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">d_less_m</span> <span class="op">*</span> <span class="va">y_less_l</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">d_less_m</span> <span class="op">*</span> <span class="va">d_less_m</span><span class="op">)</span> <span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Step 1.4</strong>: Regress <span class="math inline">\(y - \theta_{init}d\)</span> on <span class="math inline">\(X\)</span> to fit <span class="math inline">\(g_0(X)\)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--------------------------</span></span>
<span><span class="co"># Step 1.3</span></span>
<span><span class="co">#--------------------------</span></span>
<span><span class="co">#=== define y - treatment effect ===#</span></span>
<span><span class="va">training_data</span><span class="op">[</span>, <span class="va">y_less_te</span> <span class="op">:=</span> <span class="va">y</span> <span class="op">-</span> <span class="va">theta_init</span> <span class="op">*</span> <span class="va">d</span><span class="op">]</span></span>
<span></span>
<span><span class="co">#=== fit rf ===#</span></span>
<span><span class="va">rf_fitted_g0</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ranger/man/ranger.html">ranger</a></span><span class="op">(</span></span>
<span>    <span class="va">y_less_te</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>    data <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">training_data</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"y_less_te"</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"x"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    mtry <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    num.trees <span class="op">=</span> <span class="fl">132</span>,</span>
<span>    max.depth <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    min.node.size <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#=== fitted values ===#</span></span>
<span><span class="va">g0_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">rf_fitted_g0</span>, data <span class="op">=</span> <span class="va">training_data</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span></span>
<span></span>
<span><span class="co">#=== create y - g0 ===#</span></span>
<span><span class="va">training_data</span><span class="op">[</span>, <span class="va">y_less_g</span> <span class="op">:=</span> <span class="va">y</span> <span class="op">-</span> <span class="va">g0_hat</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-g0-ghat">Figure&nbsp;<span>10.1</span></a> plots true <span class="math inline">\(g_0(X)\)</span> (<code>g</code>) against <span class="math inline">\(\hat{g}_0(X)\)</span> (<code>g0_hat</code>). As you can see, <span class="math inline">\(\hat{g}_0(X)\)</span> is a bit biased.</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">training_data</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">g</span>, x <span class="op">=</span> <span class="va">g0_hat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_abline</a></span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html">coord_equal</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-g0-ghat" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="C01-dml_files/figure-html/fig-g0-ghat-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Figure 10.1: <strong>?(caption)</strong></figcaption><p></p>
</figure>
</div>
</div>
</div>
</section><section id="step-2" class="level4" data-number="10.1.2.2"><h4 data-number="10.1.2.2" class="anchored" data-anchor-id="step-2">
<span class="header-section-number">10.1.2.2</span> Step 2</h4>
<p>Finally, we regress <span class="math inline">\(y - \hat{g}_0(X)\)</span> on <span class="math inline">\(d\)</span> (or equivalently using <a href="#eq-theta-partial">Equation&nbsp;<span>10.3</span></a>).</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">theta_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y_less_g</span> <span class="op">~</span> <span class="va">d</span>, data <span class="op">=</span> <span class="va">training_data</span><span class="op">)</span><span class="op">$</span><span class="va">coefficient</span><span class="op">[</span><span class="st">"d"</span><span class="op">]</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        d 
0.5411723 </code></pre>
</div>
</div>
<p>So, in this instance, we get an estimate of <span class="math inline">\(\theta\)</span> that is a bit lower than the true value of <span class="math inline">\(\theta\)</span>. Let’s repeat this process many times to see how this procedure performs on average.</p>
<div class="cell" data-hash="C01-dml_cache/html/fig-naive_129ccc14135cfc04346125fa35e06c36">
<details><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fit_m0</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">training_data</span>, <span class="va">mtry</span> <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="va">rf_fitted_m0</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ranger/man/ranger.html">ranger</a></span><span class="op">(</span></span>
<span>      <span class="va">d</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>      data <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">training_data</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"d"</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"x"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      <span class="co"># mtry = 5,</span></span>
<span>      mtry <span class="op">=</span> <span class="va">mtry</span>,</span>
<span>      <span class="co"># num.trees = 378,</span></span>
<span>      num.trees <span class="op">=</span> <span class="fl">500</span>,</span>
<span>      max.depth <span class="op">=</span> <span class="fl">3</span>,</span>
<span>      <span class="co"># min.node.size = 6</span></span>
<span>      min.node.size <span class="op">=</span> <span class="fl">10</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">rf_fitted_m0</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">fit_l0</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">training_data</span>, <span class="va">mtry</span> <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="va">rf_fitted_l0</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ranger/man/ranger.html">ranger</a></span><span class="op">(</span></span>
<span>      <span class="va">y</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>      data <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">training_data</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"y"</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"x"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      mtry <span class="op">=</span> <span class="va">mtry</span>,</span>
<span>      <span class="co"># num.trees = 132,</span></span>
<span>      num.trees <span class="op">=</span> <span class="fl">500</span>,</span>
<span>      max.depth <span class="op">=</span> <span class="fl">5</span>,</span>
<span>      <span class="co"># min.node.size = 1</span></span>
<span>      min.node.size <span class="op">=</span> <span class="fl">10</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">rf_fitted_l0</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#===================================</span></span>
<span><span class="co"># Define a function that will get you g0_hat</span></span>
<span><span class="co">#===================================</span></span>
<span><span class="co"># this function will be used later</span></span>
<span></span>
<span><span class="va">fit_g0</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">training_data</span>, <span class="va">rf_fitted_m0</span>, <span class="va">mtry_l</span> <span class="op">=</span> <span class="fl">12</span>, <span class="va">mtry_g</span> <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">#--------------------------</span></span>
<span>  <span class="co"># Step 1.1</span></span>
<span>  <span class="co">#--------------------------</span></span>
<span>  <span class="va">rf_fitted_l0</span> <span class="op">&lt;-</span> <span class="fu">fit_l0</span><span class="op">(</span><span class="va">training_data</span>, <span class="va">mtry_l</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#=== fitted values ===#</span></span>
<span>  <span class="va">l0_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">rf_fitted_l0</span>, data <span class="op">=</span> <span class="va">training_data</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span></span>
<span></span>
<span>  <span class="co">#=== create y - l0_hat ===#</span></span>
<span>  <span class="va">training_data</span><span class="op">[</span>, <span class="va">y_less_l</span> <span class="op">:=</span> <span class="va">y</span> <span class="op">-</span> <span class="va">l0_hat</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co">#--------------------------</span></span>
<span>  <span class="co"># Step 1.2</span></span>
<span>  <span class="co">#--------------------------</span></span>
<span>  <span class="co">#=== fitted values ===#</span></span>
<span>  <span class="va">m0_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">rf_fitted_m0</span>, data <span class="op">=</span> <span class="va">training_data</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span></span>
<span></span>
<span>  <span class="co">#=== create y - m0_hat ===#</span></span>
<span>  <span class="va">training_data</span><span class="op">[</span>, <span class="va">d_less_m</span> <span class="op">:=</span> <span class="va">d</span> <span class="op">-</span> <span class="va">m0_hat</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co">#--------------------------</span></span>
<span>  <span class="co"># Step 1.2</span></span>
<span>  <span class="co">#--------------------------</span></span>
<span>  <span class="va">theta_init</span> <span class="op">&lt;-</span> <span class="va">training_data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">d_less_m</span> <span class="op">*</span> <span class="va">y_less_l</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">d_less_m</span> <span class="op">*</span> <span class="va">d_less_m</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co">#--------------------------</span></span>
<span>  <span class="co"># Step 1.3</span></span>
<span>  <span class="co">#--------------------------</span></span>
<span>  <span class="co">#=== define y - treatment effect ===#</span></span>
<span>  <span class="va">training_data</span><span class="op">[</span>, <span class="va">y_less_te</span> <span class="op">:=</span> <span class="va">y</span> <span class="op">-</span> <span class="va">theta_init</span> <span class="op">*</span> <span class="va">d</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co">#=== fit rf ===#</span></span>
<span>  <span class="va">rf_fitted_g0</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ranger/man/ranger.html">ranger</a></span><span class="op">(</span></span>
<span>      <span class="va">y_less_te</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>      data <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">training_data</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"y_less_te"</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"x"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      mtry <span class="op">=</span> <span class="va">mtry_g</span>,</span>
<span>      <span class="co"># num.trees = 132,</span></span>
<span>      num.trees <span class="op">=</span> <span class="fl">500</span>,</span>
<span>      max.depth <span class="op">=</span> <span class="fl">5</span>,</span>
<span>      <span class="co"># min.node.size = 1</span></span>
<span>      min.node.size <span class="op">=</span> <span class="fl">10</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">rf_fitted_g0</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#===================================</span></span>
<span><span class="co"># Define a function that runs a single simulation and gets you theta_hat</span></span>
<span><span class="co">#===================================</span></span>
<span><span class="va">run_sim_naive</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="co"># training_data &lt;- data[[i]] %&gt;% data.table()</span></span>
<span>  <span class="va">training_data</span> <span class="op">&lt;-</span> <span class="fu">gen_data</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">rf_fitted_m0</span> <span class="op">&lt;-</span> <span class="fu">fit_m0</span><span class="op">(</span><span class="va">training_data</span><span class="op">)</span></span>
<span>  <span class="va">rf_fitted_g0</span> <span class="op">&lt;-</span> <span class="fu">fit_g0</span><span class="op">(</span><span class="va">training_data</span>, <span class="va">rf_fitted_m0</span><span class="op">)</span></span>
<span>  <span class="va">g0_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">rf_fitted_g0</span>, data <span class="op">=</span> <span class="va">training_data</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span></span>
<span></span>
<span>  <span class="co">#=== create y - g0 ===#</span></span>
<span>  <span class="va">training_data</span><span class="op">[</span>, <span class="va">y_less_g</span> <span class="op">:=</span> <span class="va">y</span> <span class="op">-</span> <span class="va">g0_hat</span><span class="op">]</span></span>
<span></span>
<span>  <span class="va">theta_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y_less_g</span> <span class="op">~</span> <span class="va">d</span>, data <span class="op">=</span> <span class="va">training_data</span><span class="op">)</span><span class="op">$</span><span class="va">coefficient</span><span class="op">[</span><span class="st">"d"</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># theta_hat &lt;- training_data[, sum(d * y_less_g) / sum(d * d)]</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">theta_hat</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#===================================</span></span>
<span><span class="co"># Repeat MC simulations 500 times</span></span>
<span><span class="co">#===================================</span></span>
<span><span class="va">theta_hats_apr1</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span></span>
<span>    <span class="fl">1</span><span class="op">:</span><span class="fl">500</span>,</span>
<span>    <span class="va">run_sim_naive</span>,</span>
<span>    mc.cores <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="fl">4</span> <span class="op">*</span> <span class="fl">3</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="va">.</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#===================================</span></span>
<span><span class="co"># Plot the results</span></span>
<span><span class="co">#===================================</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">theta_hats_apr1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">theta</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"grey"</span>, fill <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0.5</span>,color <span class="op">=</span> <span class="st">"True Value"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">theta_hats_apr1</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span><span class="op">]</span>, color <span class="op">=</span> <span class="st">"Mean of the Estimates"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"True Value"</span> <span class="op">=</span> <span class="st">"red"</span>, <span class="st">"Mean of the Estimates"</span> <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span>,</span>
<span>    name <span class="op">=</span> <span class="st">""</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">1</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-naive" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="C01-dml_files/figure-html/fig-naive-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Figure 10.2: Simulation results of the naive procedure</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p><a href="#fig-naive">Figure&nbsp;<span>10.2</span></a> shows the histogram of <span class="math inline">\(\hat{\theta}\)</span> from 500 simulations. You can see that this procedure has led to consistent underestimation of the treatment effect (mean value of <span class="math inline">\(\hat{\theta}\)</span> is 0.467). There are two sources of bias in this approach: regularization and over-fitting bias.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Regularization bias: the bias coming from bias in estimating <span class="math inline">\(g_0(X)\)</span>
</li>
<li>Over-fitting bias: the bias coming from over-fitting <span class="math inline">\(g_0(X)\)</span> and <span class="math inline">\(m_0(X)\)</span> due to the fact that the same sample is used for <span class="math inline">\(g_0(X)\)</span> and <span class="math inline">\(m_0(X)\)</span> estimation and <span class="math inline">\(\theta\)</span> estimation</li>
</ul>
</div>
</div>
<p>Regularization bias is termed so because bias in estimating <span class="math inline">\(g_0(X)\)</span> can occur when some form of regularization is implemented (e.g., lasso).</p>
<!-- However, its name is slightly misleading because $g_0(X)$ cannot be estimated without bias even without any regularization in general. This is because the estimation of initial $\theta$ (in Step 1.3) is biased, which comes from the fact that $m_0(X)$ is correlated with $g_0(X)$ through $X$.  -->
<!-- ::: {.column-margin}
Another (unofficial) implementation of $g_0(X)$ estimation is to just use $\hat{l}_0(X_i)$ as $\hat{g}_0(X_i)$ ([a blog post](https://www.r-bloggers.com/2017/06/cross-fitting-double-machine-learning-estimator/)) and then use the following formula.



$$
\begin{aligned}
  \hat{\theta} = (\frac{1}{n}\sum_{i=1}^N d_i d_i)^{-1}\frac{1}{n}\sum_{i=1}^N d_i (y_i - \hat{l}_0(X_i))
\end{aligned}
$$



$\hat{\theta}$ is biased because $\hat{l}_0(X_i)$ is a biased estimator of $\hat{g}_0(X_i)$ when $m_0(X)$ and $g_0(X)$ are correlated. The point here is that, $g_0(X)$ is hard to estimate without bias irrespective of whether any regularization happens or not.
::: -->
<!-- However, if the treatment is independent, then, $g_0(X)$ can be estimated well and this approach works well except it still suffers from over-fitting bias. @fig-apr1-indep shows that the distribution of $\hat{\theta}$ when $m_0(X)$ is independent of $g_0(X)$ and the RF with the same hyper-parameters are used. While regularization can lead to bias in the estimation of $g_0(X)$, regularization is not the only source of bias.  -->

<!-- ```{r}
#| fig-cap: Performance of approach 1 when the treatment status is independent
#| label: fig-apr1-indep
#| code-fold: true
#| warning: false
#| cache: true 

run_sim_naive <- function(i){

  training_data <- gen_data(m_formula = "independent")

  rf_fitted_m0 <- fit_m0(training_data)
  rf_fitted_g0 <- fit_g0(training_data, rf_fitted_m0)
  # rf_fitted_g0 <- fit_l0(training_data)

  g0_hat <- predict(rf_fitted_g0, data = training_data)$predictions

  #=== create y - g0 ===#
  training_data[, y_less_g := y - g0_hat]

  theta_hat <- lm(y_less_g ~ d, data = training_data)$coefficient["d"]

  # theta_hat <- training_data[, sum(d * y_less_g) / sum(d * d)]

  return(theta_hat)

}

#===================================
# Repeat MC simulations 500 times
#===================================
theta_hats_apr1_indep <-
  mclapply(
    1:500,
    run_sim_naive,
    mc.cores = detectCores() / 4 * 3
  ) %>% 
  unlist() %>% 
  data.table(theta = .)

#===================================
# Plot the results
#===================================
ggplot(theta_hats_apr1_indep) +
  geom_histogram(aes(x = theta), color = "grey", fill = "white") +
  theme_bw() + 
  geom_vline(aes(xintercept = 0.5,color = "True Value")) +
  geom_vline(aes(xintercept = theta_hats_apr1_indep[, mean(theta)], color = "Mean of the Estimates")) +
  scale_color_manual(
    values = c("True Value" = "red", "Mean of the Estimates" = "blue"),
    name = ""
  ) +
  guides(color = guide_legend(nrow = 1, byrow = TRUE)) +
  theme(legend.position = "bottom")
``` -->
</section></section><section id="overcoming-the-regularization-bias" class="level3 page-columns page-full" data-number="10.1.3"><h3 data-number="10.1.3" class="anchored" data-anchor-id="overcoming-the-regularization-bias">
<span class="header-section-number">10.1.3</span> Overcoming the regularization bias</h3>
<p>Regularization bias can be overcome by double-debiasing (orthogonalizing both <span class="math inline">\(d\)</span> and <span class="math inline">\(y\)</span>). Specifically,</p>
<ul>
<li>Step 1: Estimate <span class="math inline">\(g_0(X)\)</span> and then subtract the fitted value of <span class="math inline">\(g_0(X)\)</span> from <span class="math inline">\(y\)</span>
</li>
<li>Step 2: Subtract <span class="math inline">\(\hat{m}_0(X)\)</span> from <span class="math inline">\(d\)</span> (<span class="math inline">\(\tilde{d} = d - \hat{m}_0(x)\)</span>)</li>
<li>Step 3: Calculate <span class="math inline">\(\hat{\theta}\)</span> based on the following formula</li>
</ul>
<p><span class="math display">\[
\begin{aligned}
\hat{\theta} = (\frac{1}{n}\sum_{i=1}^N \tilde{d}_i d_i)^{-1}\frac{1}{n}\sum_{i=1}^N \tilde{d}_i (y_i - \hat{g}_0(X_i))
\end{aligned}
\]</span></p>
<p>The key difference from the previous approach is that this approach uses <strong>IV-like</strong> formula, where <span class="math inline">\(\tilde{d}\)</span> is acting like an instrument.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>For <span class="math inline">\(y = X\beta + \mu\)</span> with instruments <span class="math inline">\(Z\)</span>, the IV estimator is <span class="math display">\[
\begin{aligned}
\hat{\beta} = (Z'X)^{-1}Z'y
\end{aligned}
\]</span></p>
</div></div><p>We have done Steps 1 and 2 already in the previous approach. So,</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#--------------------------</span></span>
<span><span class="co"># Step 3</span></span>
<span><span class="co">#--------------------------</span></span>
<span><span class="op">(</span></span>
<span><span class="va">theta_hat</span> <span class="op">&lt;-</span> <span class="va">training_data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">d_less_m</span> <span class="op">*</span> <span class="va">y_less_g</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">d_less_m</span> <span class="op">*</span> <span class="va">d</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5347399</code></pre>
</div>
</div>
<p>Now, let’s repeat this 500 times.</p>
<div class="cell" data-hash="C01-dml_cache/html/fig-dd_2945fcf559fd312ad8ebcee214a75904">
<details><summary>Code</summary><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">run_sim_dereg</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="va">training_data</span> <span class="op">&lt;-</span> <span class="fu">gen_data</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="co"># training_data &lt;- data[[i]] %&gt;% data.table</span></span>
<span></span>
<span>  <span class="va">rf_fitted_m0</span> <span class="op">&lt;-</span> <span class="fu">fit_m0</span><span class="op">(</span><span class="va">training_data</span><span class="op">)</span></span>
<span>  <span class="va">m0_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">rf_fitted_m0</span>, data <span class="op">=</span> <span class="va">training_data</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span></span>
<span></span>
<span>  <span class="co">#=== create d - m0_hat ===#</span></span>
<span>  <span class="va">training_data</span><span class="op">[</span>, <span class="va">d_less_m</span> <span class="op">:=</span> <span class="va">d</span> <span class="op">-</span> <span class="va">m0_hat</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co">#=== get g0_hat ===#</span></span>
<span>  <span class="va">rf_fitted_g0</span> <span class="op">&lt;-</span> <span class="fu">fit_g0</span><span class="op">(</span><span class="va">training_data</span>, <span class="va">rf_fitted_m0</span><span class="op">)</span></span>
<span>  <span class="va">g0_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">rf_fitted_g0</span>, data <span class="op">=</span> <span class="va">training_data</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span></span>
<span></span>
<span>  <span class="co">#=== create y - g0 ===#</span></span>
<span>  <span class="va">training_data</span><span class="op">[</span>, <span class="va">y_less_g</span> <span class="op">:=</span> <span class="va">y</span> <span class="op">-</span> <span class="va">g0_hat</span><span class="op">]</span></span>
<span></span>
<span>  <span class="va">theta_hat</span> <span class="op">&lt;-</span> <span class="va">training_data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">d_less_m</span> <span class="op">*</span> <span class="va">y_less_g</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">d_less_m</span> <span class="op">*</span> <span class="va">d</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">theta_hat</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">theta_hats_apr2</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span></span>
<span>    <span class="fl">1</span><span class="op">:</span><span class="fl">500</span>,</span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">run_sim_dereg</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>    mc.cores <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="fl">4</span> <span class="op">*</span> <span class="fl">3</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="va">.</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">theta_hats_apr2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">theta</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"grey"</span>, fill <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0.5</span>,color <span class="op">=</span> <span class="st">"True Value"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">theta_hats_apr2</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span><span class="op">]</span>, color <span class="op">=</span> <span class="st">"Mean of the Estimates"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"True Value"</span> <span class="op">=</span> <span class="st">"red"</span>, <span class="st">"Mean of the Estimates"</span> <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span>,</span>
<span>    name <span class="op">=</span> <span class="st">""</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">1</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-dd" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="C01-dml_files/figure-html/fig-dd-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Figure 10.3: Simulation results of double-debiased approach</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p><a href="#fig-dd">Figure&nbsp;<span>10.3</span></a> shows the distribution of <span class="math inline">\(\hat{\theta}\)</span>, which is centered about <span class="math inline">\(0.479\)</span>. The current approach still suffers from the so-called over-fitting bias<span class="citation" data-cites="Chernozhukov2018">(<a href="#ref-Chernozhukov2018" role="doc-biblioref">Chernozhukov et al. 2018</a>)</span>. Let’s look at how we can overcome this bias next.</p>
</section><section id="sec-cf" class="level3 page-columns page-full" data-number="10.1.4"><h3 data-number="10.1.4" class="anchored" data-anchor-id="sec-cf">
<span class="header-section-number">10.1.4</span> Overcoming the over-fitting bias</h3>
<p>Over-fitting bias can be overcome by cross-fitting. First, the training data is split into <span class="math inline">\(K\)</span>-folds just like K-fold cross-validation. Let’s denote them as <span class="math inline">\(I_1, \dots, I_k\)</span>. For example, for <span class="math inline">\(I_1\)</span>, the following steps are taken (<a href="#fig-cross-fitting">Figure&nbsp;<span>10.4</span></a> provides a visual illustration):</p>
<ul>
<li>Step 1: Estimate <span class="math inline">\(\hat{g}_0(x)\)</span> and <span class="math inline">\(\hat{m}_0(x)\)</span> using the data from the other folds (<span class="math inline">\(I_2, \dots, I_K\)</span>).</li>
<li>Step 2: Estimate <span class="math inline">\(\hat{g}_0(x_i)\)</span> and <span class="math inline">\(\hat{m}_0(x_i)\)</span> for each <span class="math inline">\(i \in I_1\)</span> and calculate <span class="math inline">\(\tilde{y}_i = y_i - \hat{g}_0(x_i)\)</span> and <span class="math inline">\(\tilde{d}_i = d_i - \hat{m}_0(x_i)\)</span>.</li>
<li>Step 3: Use the following formula to obtain <span class="math inline">\(\hat{\theta}\)</span>.</li>
</ul>
<p><span id="eq-iv-score"><span class="math display">\[
\begin{aligned}
\hat{\theta} = (\frac{1}{n}\sum_{i=1}^N \tilde{d}_i d_i)^{-1}\frac{1}{n}\sum_{i=1}^N \tilde{d}_i (y_i - \hat{g}_0(X_i))
\end{aligned}
\tag{10.5}\]</span></span></p>
<p>This process is repeated for all the <span class="math inline">\(K\)</span> folds, and then the the final estimate of <span class="math inline">\(\hat{\theta}\)</span> is obtained as the average of <span class="math inline">\(\hat{\theta}\)</span>s.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>You can implement repeated K-fold cross-fitting using the <code>DoublML</code> package, which is not demonstrated here as it is very much similar in concept to repeated K-fold CV explained in <span class="quarto-unresolved-ref">?sec-cross-validation</span>.</p>
</div></div><p><span style="color:blue"> talk about <code>algorithm_2</code> </span></p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">#=== fold 1 ===#</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_rect</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">0</span>, xmax <span class="op">=</span> <span class="fl">10</span>, ymin <span class="op">=</span> <span class="fl">0</span>, ymax <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"grey"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">1.2</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_rect</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">0</span>, xmax <span class="op">=</span> <span class="fl">2.5</span>, ymin <span class="op">=</span> <span class="fl">0</span>, ymax <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"black"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">#=== fold 2 ===#</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_rect</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">0</span>, xmax <span class="op">=</span> <span class="fl">10</span>, ymin <span class="op">=</span> <span class="fl">2.2</span>, ymax <span class="op">=</span> <span class="fl">4.2</span><span class="op">)</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"grey"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">1.2</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_rect</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">2.5</span>, xmax <span class="op">=</span> <span class="fl">5</span>, ymin <span class="op">=</span> <span class="fl">2.2</span>, ymax <span class="op">=</span> <span class="fl">4.2</span><span class="op">)</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"black"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">#=== fold 3 ===#</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_rect</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">0</span>, xmax <span class="op">=</span> <span class="fl">10</span>, ymin <span class="op">=</span> <span class="fl">4.4</span>, ymax <span class="op">=</span> <span class="fl">6.4</span><span class="op">)</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"grey"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">1.2</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_rect</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">5</span>, xmax <span class="op">=</span> <span class="fl">7.5</span>, ymin <span class="op">=</span> <span class="fl">4.4</span>, ymax <span class="op">=</span> <span class="fl">6.4</span><span class="op">)</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"black"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">#=== fold 4 ===#</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_rect</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">0</span>, xmax <span class="op">=</span> <span class="fl">10</span>, ymin <span class="op">=</span> <span class="fl">6.6</span>, ymax <span class="op">=</span> <span class="fl">8.6</span><span class="op">)</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"grey"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">1.2</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_rect</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">7.5</span>, xmax <span class="op">=</span> <span class="fl">10</span>, ymin <span class="op">=</span> <span class="fl">6.6</span>, ymax <span class="op">=</span> <span class="fl">8.6</span><span class="op">)</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"black"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ggbrace/man/geom_brace.html">geom_brace</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7.4</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">8.7</span>, <span class="fl">9.2</span><span class="op">)</span><span class="op">)</span>, inherit.data<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span></span>
<span>    <span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">3.5</span>, y <span class="op">=</span> <span class="fl">9.7</span>, parse <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    label <span class="op">=</span> <span class="st">"'Find ' * hat(g)[0](x) * ' and ' * hat(m)[0](x) * ' from this data.'"</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">6</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_curve</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">2.2</span>, xend <span class="op">=</span> <span class="fl">8.5</span>, y <span class="op">=</span> <span class="fl">10.3</span>, yend <span class="op">=</span> <span class="fl">8.8</span><span class="op">)</span>,</span>
<span>    arrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html">arrow</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.03</span>, <span class="st">"npc"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    curvature <span class="op">=</span> <span class="op">-</span><span class="fl">0.3</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_curve</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">3.4</span>, xend <span class="op">=</span> <span class="fl">8</span>, y <span class="op">=</span> <span class="fl">10.3</span>, yend <span class="op">=</span> <span class="fl">8.8</span><span class="op">)</span>,</span>
<span>    arrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html">arrow</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.03</span>, <span class="st">"npc"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    curvature <span class="op">=</span> <span class="op">-</span><span class="fl">0.3</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">11</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># coord_equal() +</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-cross-fitting" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="C01-dml_files/figure-html/fig-cross-fitting-1.png" class="img-fluid figure-img" width="864"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Figure 10.4: Illustration of cross-fitting</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Let’s code the cross-fitting procedure. We first split the data into 2 folds (<span class="math inline">\(K = 2\)</span>).</p>

<div class="no-row-height column-margin column-container"><div class="">
<p><span class="math inline">\(K\)</span> does not have to be 2.</p>
</div></div><div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">data_folds</span> <span class="op">&lt;-</span> <span class="fu">rsample</span><span class="fu">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/vfold_cv.html">vfold_cv</a></span><span class="op">(</span><span class="va">training_data</span>, v <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#  2-fold cross-validation 
# A tibble: 2 × 2
  splits            id   
  &lt;list&gt;            &lt;chr&gt;
1 &lt;split [250/250]&gt; Fold1
2 &lt;split [250/250]&gt; Fold2</code></pre>
</div>
</div>
<p>Let’s cross-fit for fold 1.</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">split_1</span> <span class="op">&lt;-</span> <span class="va">data_folds</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co">#=== data for estimating g_0  and m_0 ===#</span></span>
<span><span class="va">data_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/as.data.frame.rsplit.html">analysis</a></span><span class="op">(</span><span class="va">split_1</span><span class="op">$</span><span class="va">splits</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> </span>
<span></span>
<span><span class="co">#=== data for which g_0(x_i) and m_0(x_i) are calculated ===#</span></span>
<span><span class="va">data_target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/as.data.frame.rsplit.html">assessment</a></span><span class="op">(</span><span class="va">split_1</span><span class="op">$</span><span class="va">splits</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First, we fit <span class="math inline">\(\hat{g}_0(x)\)</span> and <span class="math inline">\(\hat{m}_0(x)\)</span> using the data from the other folds.</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#=== m0 ===#</span></span>
<span><span class="va">m_rf_fit</span> <span class="op">&lt;-</span> <span class="fu">fit_m0</span><span class="op">(</span><span class="va">data_train</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#=== g0 ===#</span></span>
<span><span class="va">g_rf_fit</span> <span class="op">&lt;-</span> <span class="fu">fit_g0</span><span class="op">(</span><span class="va">data_train</span>, <span class="va">m_rf_fit</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we predict <span class="math inline">\(\hat{g}_0(x_i)\)</span> and <span class="math inline">\(\hat{m}_0(x_i)\)</span> for each <span class="math inline">\(i\)</span> of fold 1 (the target dataset) and calculate <span class="math inline">\(\tilde{y}_i = y_i - \hat{g}_0(x_i)\)</span> and <span class="math inline">\(\tilde{d}_i = d_i - \hat{m}_0(x_i)\)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_orth</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">data_target</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">#=== prediction of g_0(x_i) ===#</span></span>
<span>  <span class="va">.</span><span class="op">[</span>, <span class="va">g_0_hat</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">g_rf_fit</span>, data <span class="op">=</span> <span class="va">.</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">#=== orthogonalize y ===#</span></span>
<span>  <span class="va">.</span><span class="op">[</span>, <span class="va">y_tilde</span> <span class="op">:=</span> <span class="va">y</span> <span class="op">-</span> <span class="va">g_0_hat</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">#=== prediction of m_0(x_i) ===#</span></span>
<span>  <span class="va">.</span><span class="op">[</span>, <span class="va">m_0_hat</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">m_rf_fit</span>, data <span class="op">=</span> <span class="va">.</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">#=== orthogonalize d ===#</span></span>
<span>  <span class="va">.</span><span class="op">[</span>, <span class="va">d_tilde</span> <span class="op">:=</span> <span class="va">d</span> <span class="op">-</span> <span class="va">m_0_hat</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, <span class="math inline">\(\hat{\theta}\)</span> is obtained for this fold using <a href="#eq-iv-score">Equation&nbsp;<span>10.5</span></a>.</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">theta_hat</span> <span class="op">&lt;-</span> <span class="va">data_orth</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">d_tilde</span> <span class="op">*</span> <span class="va">y_tilde</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">d_tilde</span> <span class="op">*</span> <span class="va">d</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5457779</code></pre>
</div>
</div>
<p>We can repeat this for all the folds (<code>cross_fit()</code> which finds <span class="math inline">\(\hat{\theta}\)</span> for a particular fold is defined on the side).</p>

<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cross_fit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">data_folds</span>, <span class="va">mtry_l</span> <span class="op">=</span> <span class="fl">12</span>, <span class="va">mtry_m</span> <span class="op">=</span> <span class="fl">10</span>, <span class="va">mtry_g</span> <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span></span>
<span>  <span class="co">#--------------------------</span></span>
<span>  <span class="co"># Prepare data</span></span>
<span>  <span class="co">#--------------------------</span></span>
<span>  <span class="co">#=== ith split ===#</span></span>
<span>  <span class="va">working_split</span> <span class="op">&lt;-</span> <span class="va">data_folds</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span></span>
<span></span>
<span>  <span class="co">#=== data for estimating g_0  and m_0 ===#</span></span>
<span>  <span class="va">data_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/as.data.frame.rsplit.html">analysis</a></span><span class="op">(</span><span class="va">working_split</span><span class="op">$</span><span class="va">splits</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> </span>
<span></span>
<span>  <span class="co">#=== data for which g_0(x_i) and m_0(x_i) are calculated ===#</span></span>
<span>  <span class="va">data_target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/as.data.frame.rsplit.html">assessment</a></span><span class="op">(</span><span class="va">working_split</span><span class="op">$</span><span class="va">splits</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> </span>
<span></span>
<span>  <span class="co">#--------------------------</span></span>
<span>  <span class="co"># Fit g0 and m0</span></span>
<span>  <span class="co">#--------------------------</span></span>
<span>  <span class="co">#=== m0 ===#</span></span>
<span>  <span class="va">m_rf_fit</span> <span class="op">&lt;-</span> <span class="fu">fit_m0</span><span class="op">(</span><span class="va">data_train</span>, <span class="va">mtry_m</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#=== g0 ===#</span></span>
<span>  <span class="va">g_rf_fit</span> <span class="op">&lt;-</span> <span class="fu">fit_g0</span><span class="op">(</span><span class="va">data_train</span>, <span class="va">m_rf_fit</span>, <span class="va">mtry_l</span>, <span class="va">mtry_g</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#--------------------------</span></span>
<span>  <span class="co"># Get y_tilde and d_tilde</span></span>
<span>  <span class="co">#--------------------------</span></span>
<span>  <span class="va">data_orth</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">data_target</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">#=== prediction of g_0(x_i) ===#</span></span>
<span>    <span class="va">.</span><span class="op">[</span>, <span class="va">g_0_hat</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">g_rf_fit</span>, data <span class="op">=</span> <span class="va">.</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">#=== orthogonalize y ===#</span></span>
<span>    <span class="va">.</span><span class="op">[</span>, <span class="va">y_tilde</span> <span class="op">:=</span> <span class="va">y</span> <span class="op">-</span> <span class="va">g_0_hat</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">#=== prediction of m_0(x_i) ===#</span></span>
<span>    <span class="va">.</span><span class="op">[</span>, <span class="va">m_0_hat</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">m_rf_fit</span>, data <span class="op">=</span> <span class="va">.</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">#=== orthogonalize d ===#</span></span>
<span>    <span class="va">.</span><span class="op">[</span>, <span class="va">d_tilde</span> <span class="op">:=</span> <span class="va">d</span> <span class="op">-</span> <span class="va">m_0_hat</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="va">.</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">y_tilde</span>, <span class="va">d_tilde</span>, <span class="va">d</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>  <span class="va">theta_cf</span> <span class="op">&lt;-</span> <span class="va">data_orth</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">d_tilde</span> <span class="op">*</span> <span class="va">y_tilde</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">d_tilde</span> <span class="op">*</span> <span class="va">d</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">theta_cf</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div></div><div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">theta_hat</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_folds</span><span class="op">)</span><span class="op">)</span>, <span class="co"># loop over folds</span></span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">cross_fit</span><span class="op">(</span><span class="va">x</span>, <span class="va">data_folds</span><span class="op">)</span> <span class="co"># get theta_hat</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># average them</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5303571</code></pre>
</div>
</div>
<p>Okay, now that we understand the steps of this approach, let’s repeat this many times (<code>get_theta_cf()</code> that finds <span class="math inline">\(\hat{\theta}\)</span> by cross-fitting is defined on the side).</p>

<div class="no-row-height column-margin column-container"><div class="">
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">get_theta_cf</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data_folds</span>, <span class="va">mtry_l</span> <span class="op">=</span> <span class="fl">12</span>, <span class="va">mtry_m</span> <span class="op">=</span> <span class="fl">10</span>, <span class="va">mtry_g</span> <span class="op">=</span> <span class="fl">12</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="va">theta_hat</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_folds</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">cross_fit</span><span class="op">(</span><span class="va">x</span>, <span class="va">data_folds</span>, <span class="va">mtry_l</span>, <span class="va">mtry_m</span>, <span class="va">mtry_g</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">theta_hat</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div></div><div class="cell" data-hash="C01-dml_cache/html/fig-cf-debiased_80e2bdd7dd7f0848047825d099f877ad">
<details><summary>Code</summary><div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">theta_hats_cf</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span></span>
<span>    <span class="fl">1</span><span class="op">:</span><span class="fl">500</span>,</span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>      <span class="va">training_data</span> <span class="op">&lt;-</span> <span class="fu">gen_data</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">data_folds</span> <span class="op">&lt;-</span> <span class="fu">rsample</span><span class="fu">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/vfold_cv.html">vfold_cv</a></span><span class="op">(</span><span class="va">training_data</span>, v <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>      <span class="va">theta_hat</span> <span class="op">&lt;-</span>  <span class="fu">get_theta_cf</span><span class="op">(</span><span class="va">data_folds</span><span class="op">)</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">theta_hat</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    mc.cores <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">*</span> <span class="fl">3</span> <span class="op">/</span> <span class="fl">4</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#=== visualize the results ===#</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">theta_hats_cf</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"grey"</span>, fill <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0.5</span>,color <span class="op">=</span> <span class="st">"True Value"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">theta_hats_cf</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"Mean of the Estimates"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"True Value"</span> <span class="op">=</span> <span class="st">"red"</span>, <span class="st">"Mean of the Estimates"</span> <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span>,</span>
<span>    name <span class="op">=</span> <span class="st">""</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">1</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-cf-debiased" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="C01-dml_files/figure-html/fig-cf-debiased-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Figure 10.5: The distribution of treatment effect estimated by the double-debiased approach with cross-fitting</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p><a href="#fig-cf-debiased">Figure&nbsp;<span>10.5</span></a> shows the distribution of <span class="math inline">\(\hat{\theta}\)</span> with double-debiasing and cross-fitting. It is slightly biased in this instance (mean is 0.501), but the average <span class="math inline">\(\hat{\theta}\)</span> is very close to the true parameter.</p>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>Double/debiased (double orthogonalization) can help overcome the bias in <span class="math inline">\(\hat{\theta}\)</span> that comes from the bias in estimating <span class="math inline">\(g_0(X)\)</span>.</p></li>
<li><p>Cross-fitting can help overcome the bias from estimating <span class="math inline">\(g_0(X)\)</span>, <span class="math inline">\(m_0(X)\)</span>, and <span class="math inline">\(\theta\)</span> using the same data.</p></li>
</ul>
</div>
</div>
</section></section><section id="models-and-implementation-by-doubleml" class="level2 page-columns page-full" data-number="10.2"><h2 data-number="10.2" class="anchored" data-anchor-id="models-and-implementation-by-doubleml">
<span class="header-section-number">10.2</span> Models and implementation by <code>DoubleML</code>
</h2>
<p>In R, <code>DoubleML</code> is built on top of <code>mlr3</code>, which uses <code>R6</code> classes provided by the <code>R6</code> package. Since <code>R6</code> implements encapsulated object-oriented programming like Python, <code>DoubleML</code> in R and Python work in a very similar manner. Here, we will use R for demonstrations.</p>
<section id="partially-linear-model" class="level3 page-columns page-full" data-number="10.2.1"><h3 data-number="10.2.1" class="anchored" data-anchor-id="partially-linear-model">
<span class="header-section-number">10.2.1</span> Partially linear model</h3>
<p><span id="eq-plr"><span class="math display">\[
\begin{aligned}
y = \theta d + g_0(X) + \mu \\
d = m_0(X) + \eta
\end{aligned}
\tag{10.6}\]</span></span></p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Assumptions on the error terms</strong></p>
<ul>
<li><span class="math inline">\(E[\mu|D,X] = 0\)</span></li>
<li><span class="math inline">\(E[\eta|X] = 0\)</span></li>
<li><span class="math inline">\(E[\eta\cdot \mu|D, X] = 0\)</span></li>
</ul>
</div>
</div>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">DiagrammeR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DiagrammeR/man/grViz.html">grViz</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span></span>
<span>  <span class="st">"</span></span>
<span><span class="st">  digraph {</span></span>
<span><span class="st">    graph [layout = circo, ranksep = 0.5]</span></span>
<span><span class="st"></span></span>
<span><span class="st">    node [shape = box]</span></span>
<span><span class="st">      Y [label = 'Y']</span></span>
<span><span class="st">      u [label = '\U03BC']</span></span>
<span><span class="st"></span></span>
<span><span class="st">    node [shape = box]</span></span>
<span><span class="st">      X [label = 'X']</span></span>
<span><span class="st">      T [label = 'T']</span></span>
<span><span class="st">      v [label = '\U03B7']</span></span>
<span><span class="st"></span></span>
<span><span class="st">    edge [minlen = 2]</span></span>
<span><span class="st">      {v, X}-&gt;T</span></span>
<span><span class="st">      {X, T}-&gt;Y</span></span>
<span><span class="st">      u-&gt;Y</span></span>
<span><span class="st">  }</span></span>
<span><span class="st">  "</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="htmlwidget-6513000584a4d02624c3" style="width:100%;height:464px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-6513000584a4d02624c3">{"x":{"diagram":"\n  digraph {\n    graph [layout = circo, ranksep = 0.5]\n\n    node [shape = box]\n      Y [label = \"Y\"]\n      u [label = \"μ\"]\n\n    node [shape = box]\n      X [label = \"X\"]\n      T [label = \"T\"]\n      v [label = \"η\"]\n\n    edge [minlen = 2]\n      {v, X}->T\n      {X, T}->Y\n      u->Y\n  }\n  ","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>There are two ways to estimate <span class="math inline">\(\theta\)</span> using <code>DoublMLPLR()</code>. They differ in how their score functions are defined. You pick either one of the two:</p>
<ul>
<li>
<code>partialling-out</code>: <span class="math inline">\([Y - l(X) - \theta(D-m(X))][D-m(X)]\)</span>
</li>
<li>
<code>IV-type</code>: <span class="math inline">\([Y - \theta D - g(X)][D-m(X)]\)</span>
</li>
</ul>
<p>Since <span class="math inline">\(g(X)\)</span> and <span class="math inline">\(m(X)\)</span> themselves appear in the data generating process (<a href="#eq-plr">Equation&nbsp;<span>10.7</span></a>), it is clear what they are. However, it is not immediately clear what <span class="math inline">\(l(X)\)</span> represents. <span class="math inline">\(l(X)\)</span> refers to <span class="math inline">\(E[Y|X]\)</span>.</p>
<p><span class="math display">\[
\begin{aligned}
l(X) = E[Y|X] &amp; = E[\theta d + g_0(X) + \mu] \\
              &amp; = \theta E[d|X] + E[g_0(X)] + E[\mu|X] \\
              &amp; = \theta m_0(X) + g_0(X) \;\; \mbox{(by the assumptions on the error terms)}\\
\end{aligned}
\]</span></p>
<p>Given this, the scores functions can be rewritten as:</p>
<ul>
<li>
<code>partialling-out</code>: <span class="math inline">\(\mu\cdot \eta\)</span>
</li>
<li>
<code>IV-type</code>: <span class="math inline">\(\mu\cdot \eta\)</span>
</li>
</ul>
<p>Therefore, the two score functions are actually identical in meaning, but represented by different terms, which result in different equations to calculate <span class="math inline">\(\hat{\theta}\)</span>. Here are how <span class="math inline">\(\theta\)</span> is identified for the two scores functions:</p>
<p><strong><code>partialling-out</code></strong></p>
<p><span class="math display">\[
\begin{aligned}
E\large(\normalsize[Y - l(X) - \theta(D-m(X))][D-m(X)]\large)\normalsize = 0 \\
\theta = \frac{E[(Y - l(X))(D-m(X))]}{E[(D-m(X))(D-m(X))]}
\end{aligned}
\]</span></p>
<p>The empirical analog of this moment condition is</p>
<p><span class="math display">\[
\begin{aligned}
\hat{\theta} = \frac{\sum_{i=1}^N (Y_i - l(X_i))(D_i-m(X_i))}{\sum_{i=1}^N (D_i-m(X_i))(D_i-m(X_i))}
\end{aligned}
\]</span></p>
<p><strong><code>IV-type</code></strong></p>
<p><span class="math display">\[
\begin{aligned}
\hat{\theta} = \frac{\sum_{i=1}^N (Y_i - g(X_i))(D_i-m(X_i))}{\sum_{i=1}^N D_i(D_i-m(X_i))}
\end{aligned}
\]</span></p>

<div class="no-row-height column-margin column-container"><div class="">
<p><span class="math inline">\(D_i-m(X_i)\)</span> is acting like an instrument.</p>
</div></div><p>The choice of the score function results in different steps to estimate <span class="math inline">\(\theta\)</span> and what you need to supply to <code>DoublMLPLR()</code>. <span class="math inline">\(g_0(X)\)</span> is estimated in several steps (see <a href="#sec-dml-naive"><span>Section&nbsp;10.1.2</span></a>) as it needs to remove the effect of <span class="math inline">\(\theta D\)</span> before estimating only <span class="math inline">\(g_0(X)\)</span>. <span class="math inline">\(l_0(X)\)</span>, however, is estimated by simply regressing <span class="math inline">\(Y\)</span> on <span class="math inline">\(X\)</span>. In running <code>DoublMLPLR()</code>, there are three key options:</p>
<ul>
<li>
<code>ml_l</code>: ML method to use to estimate <span class="math inline">\(l(X)\)</span>
</li>
<li>
<code>ml_m</code>: ML method to use to estimate <span class="math inline">\(m(X)\)</span>
</li>
<li>
<code>ml_g</code>: ML method to use to estimate <span class="math inline">\(g(X)\)</span>
</li>
</ul>
<p>When <code>partialling-out</code> is selected, you need to specify <code>ml_l</code> and <code>ml_m</code>. However, you do not need to specify the <code>ml_g</code>. When <code>IV-type</code> is used you need to specify all three. This is because estimating <code>g(X)</code> involves first estimating <code>l(X)</code> (see <a href="#sec-dml-naive"><span>Section&nbsp;10.1.2</span></a>). So, the <code>partialling-out</code> option requires a smaller number of steps and easier to specify for the user.</p>
<p>Let’s implement <code>DoublMLPLR()</code> using a synthetic dataset that follows the DGP represented by <a href="#eq-simple-synthetic">Equation&nbsp;<span>10.4</span></a>. We can use <code><a href="https://rdrr.io/pkg/DoubleML/man/make_plr_CCDDHNR2018.html">make_plr_CCDDHNR2018()</a></code> to create such a dataset.</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/DoubleML/man/make_plr_CCDDHNR2018.html">make_plr_CCDDHNR2018</a></span><span class="op">(</span></span>
<span>    alpha <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>    n_obs <span class="op">=</span> <span class="fl">500</span>, </span>
<span>    dim_x <span class="op">=</span> <span class="fl">20</span>, </span>
<span>    return_type <span class="op">=</span> <span class="st">'data.table'</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             X1          X2          X3         X4           X5         X6
  1:  1.2440476  1.64639297  0.71131792  0.4783044  0.008239645  0.4533324
  2:  0.9023502  0.15267901  0.01064853  0.2088653 -0.305263506  0.7158397
  3: -1.9637574 -1.87906651 -0.67356583 -0.5550050  0.029957814  0.5359109
  4: -1.9718906 -0.82930335 -1.11817257 -1.6561757 -1.853304959 -0.5511951
  5: -1.0273249 -0.69520796 -1.62652575 -0.8325634 -0.769455086  0.7121183
 ---                                                                      
496: -0.5828880  0.03691634 -0.09796938 -0.2660888  0.256374614  0.8409559
497:  0.1310249 -0.04537018 -0.63309501 -1.9887410 -0.511560500 -0.6410372
498:  0.6988148  1.18801352  1.40573962  1.7227378  0.135727751 -0.9089638
499:  0.9334815  0.53835718  0.63176578  0.6217877  0.949987407  1.3972804
500: -1.8301636 -0.48985250  0.28928829  0.2081408  0.289517934  0.1162203
             X7          X8         X9         X10        X11        X12
  1:  0.2998599  0.08169994 -0.3034012 -0.41817280 -0.1684357 -0.5818317
  2:  0.4535326  0.39097316 -0.1131795 -0.32836997 -0.4328069  0.3964901
  3:  1.9876844  0.32706905 -0.3247179 -0.95800870 -0.6582622 -0.8564451
  4: -1.1271986  0.01316699 -0.6730823 -0.27714289 -0.4080058  0.2292704
  5:  0.9164861  0.25645093  0.8497441  1.43501126  1.0167186 -0.1490919
 ---                                                                    
496:  1.9224220 -0.36454764  0.5100894  0.56865912  1.2143600  1.4910141
497: -0.3887281  0.19720732 -0.2633226 -0.36455774 -0.6915640  0.1428711
498: -0.4677247  0.09132417  1.3396831  0.12893152  0.5207629  0.3854993
499:  1.4887376  1.83162991  1.0472136  1.52179830  1.8261050  2.2777564
500:  1.2296010  0.99825727  1.2843710 -0.08255473 -0.2282313 -0.4273543
            X13        X14        X15        X16        X17        X18
  1:  0.6359233  0.6519038  0.8225963  1.4501328  1.3638703  2.3590094
  2:  0.4119444  0.8873855  0.4601086  0.8426136  1.1745062  1.0474801
  3: -1.7953205 -2.7288900 -1.8070682 -2.3540323 -1.0996324 -0.4669641
  4:  0.6332562 -1.5151797 -0.5069169 -0.3316435 -0.5820351 -1.1698090
  5:  0.3762819  0.2109936  1.5015694  0.7507966  0.4815073  0.4143088
 ---                                                                  
496:  0.7537537  0.5242330  1.0652588  2.2025996  1.3431624  0.4493184
497: -0.5253672  0.1851662  0.1890410 -1.1936561 -2.0104705 -1.6484655
498:  0.3943351 -1.0036494  0.2384225 -0.1725888  0.8901573  0.3837909
499:  3.3185716  1.9115865  1.6692008  0.3438597 -0.1976231  0.3944083
500:  0.5623116  0.8880912  1.5738437  1.2236440  1.8337886  2.8762545
             X19        X20          y          d
  1:  2.15034400  1.9143797  1.8599237  1.2501768
  2:  0.94456253 -0.4795718  2.3923080  2.1841305
  3: -0.06033539  0.5126436 -0.9123374 -1.4574737
  4: -1.12264600 -0.3507258 -1.7675132 -2.9801900
  5:  0.08113000 -1.6986236 -1.7201920 -0.8987789
 ---                                             
496: -0.17389979  0.7992646  0.2055072 -1.3320553
497: -2.00535182 -0.9286602 -0.2724589 -1.6061591
498:  1.25943944  0.5382165  0.4598890  0.4722447
499: -0.67025460 -0.4495312  0.4208797  0.4633706
500:  1.44951329  0.3391455 -1.7206897 -3.5137542</code></pre>
</div>
</div>
<p>Note that the treatment variable is continuous in this dataset.</p>
<p>We first need to create a <code>DoubleMLData</code> object from the train data using <code>DoubleMLData$new()</code>. Specify the dependent variable using the <code>y_col</code> option and the treatment variable(s) by <code>d_cols</code>. The rest of the variables in the dataset provided will be regarded as covariates.</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">obj_dml_data</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va"><a href="https://rdrr.io/pkg/DoubleML/man/DoubleMLData.html">DoubleMLData</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    <span class="va">data</span>, </span>
<span>    y_col <span class="op">=</span> <span class="st">"y"</span>, </span>
<span>    d_cols <span class="op">=</span> <span class="st">"d"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>================= DoubleMLData Object ==================


------------------ Data summary      ------------------
Outcome variable: y
Treatment variable(s): d
Covariates: X1, X2, X3, X4, X5, X6, X7, X8, X9, X10, X11, X12, X13, X14, X15, X16, X17, X18, X19, X20
Instrument(s): 
No. Observations: 500</code></pre>
</div>
</div>
<p>Now, let’s specify <code>ml_l</code>, <code>ml_m</code>, and <code>ml_g</code>. The <code>DoubleML</code> follows <code>mlr3</code> (see <span class="quarto-unresolved-ref">?sec-mlr3</span> for how to use <code>mlr3</code>).</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span></span>
<span><span class="va">ml_l</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span></span>
<span>    <span class="st">"regr.ranger"</span>,</span>
<span>    num.trees <span class="op">=</span> <span class="fl">500</span>, </span>
<span>    mtry <span class="op">=</span> <span class="fl">15</span>, </span>
<span>    min.node.size <span class="op">=</span> <span class="fl">5</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;LearnerRegrRanger:regr.ranger&gt;
* Model: -
* Parameters: num.threads=1, num.trees=500, mtry=15, min.node.size=5
* Packages: mlr3, mlr3learners, ranger
* Predict Types:  [response], se
* Feature Types: logical, integer, numeric, character, factor, ordered
* Properties: hotstart_backward, importance, oob_error, weights</code></pre>
</div>
</div>
<p>Let’s use the same ML method for <code>ml_m</code> and <code>ml_g</code> (you can use any appropriate ML methods). We can simply use the <code>clone()</code> method to replicate <code>ml_l</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ml_m</span> <span class="op">&lt;-</span> <span class="va">ml_l</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ml_g</span> <span class="op">&lt;-</span> <span class="va">ml_l</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We now set up the <code>DoubleMLPLR</code> estimator by providing a <code>DoubleMLData</code> and ML methods. By default, <code>score</code> is set to <code>"partialling out"</code>, so we do not need to provide <code>ml_g</code>. The <code>apply_cross_fitting</code> option is set to <code>TRUE</code> by default.</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">dml_plr_obj</span> <span class="op">&lt;-</span> <span class="va"><a href="https://rdrr.io/pkg/DoubleML/man/DoubleMLPLR.html">DoubleMLPLR</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">obj_dml_data</span>, <span class="va">ml_l</span>, <span class="va">ml_m</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can fit the model by invoking <code>fit()</code> on <code>dml_plr_obj</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">dml_plr_obj</span><span class="op">$</span><span class="fu">fit</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>INFO  [21:45:10.036] [mlr3] Applying learner 'regr.ranger' on task 'nuis_l' (iter 1/5) 
INFO  [21:45:11.375] [mlr3] Applying learner 'regr.ranger' on task 'nuis_l' (iter 2/5) 
INFO  [21:45:12.538] [mlr3] Applying learner 'regr.ranger' on task 'nuis_l' (iter 3/5) 
INFO  [21:45:13.584] [mlr3] Applying learner 'regr.ranger' on task 'nuis_l' (iter 4/5) 
INFO  [21:45:14.689] [mlr3] Applying learner 'regr.ranger' on task 'nuis_l' (iter 5/5) 
INFO  [21:45:16.272] [mlr3] Applying learner 'regr.ranger' on task 'nuis_m' (iter 1/5) 
INFO  [21:45:17.194] [mlr3] Applying learner 'regr.ranger' on task 'nuis_m' (iter 2/5) 
INFO  [21:45:18.091] [mlr3] Applying learner 'regr.ranger' on task 'nuis_m' (iter 3/5) 
INFO  [21:45:18.964] [mlr3] Applying learner 'regr.ranger' on task 'nuis_m' (iter 4/5) 
INFO  [21:45:19.838] [mlr3] Applying learner 'regr.ranger' on task 'nuis_m' (iter 5/5) </code></pre>
</div>
</div>
<p>See the results with <code><a href="https://rdrr.io/r/base/print.html">print()</a></code>. You can see <span class="math inline">\(\hat{\theta}\)</span> at the bottom.</p>
<div class="cell">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">dml_plr_obj</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>================= DoubleMLPLR Object ==================


------------------ Data summary      ------------------
Outcome variable: y
Treatment variable(s): d
Covariates: X1, X2, X3, X4, X5, X6, X7, X8, X9, X10, X11, X12, X13, X14, X15, X16, X17, X18, X19, X20
Instrument(s): 
No. Observations: 500

------------------ Score &amp; algorithm ------------------
Score function: partialling out
DML algorithm: dml2

------------------ Machine learner   ------------------
ml_l: regr.ranger
ml_m: regr.ranger

------------------ Resampling        ------------------
No. folds: 5
No. repeated sample splits: 1
Apply cross-fitting: TRUE

------------------ Fit summary       ------------------
 Estimates and significance testing of the effect of target variables
  Estimate. Std. Error t value Pr(&gt;|t|)    
d    0.5234     0.0454   11.53   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>If you are using <code>IV-type</code>, then you need to provide <code>ml_g</code> as well like below.</p>
<div class="cell">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#=== set up ===#</span></span>
<span><span class="va">dml_plr_obj_iv</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va"><a href="https://rdrr.io/pkg/DoubleML/man/DoubleMLPLR.html">DoubleMLPLR</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    <span class="va">obj_dml_data</span>, </span>
<span>    <span class="va">ml_l</span>, </span>
<span>    <span class="va">ml_m</span>, </span>
<span>    <span class="va">ml_g</span>,</span>
<span>    score <span class="op">=</span> <span class="st">"IV-type"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#=== fit ===#</span></span>
<span><span class="va">dml_plr_obj_iv</span><span class="op">$</span><span class="fu">fit</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>INFO  [21:45:21.081] [mlr3] Applying learner 'regr.ranger' on task 'nuis_l' (iter 1/5) 
INFO  [21:45:21.928] [mlr3] Applying learner 'regr.ranger' on task 'nuis_l' (iter 2/5) 
INFO  [21:45:22.776] [mlr3] Applying learner 'regr.ranger' on task 'nuis_l' (iter 3/5) 
INFO  [21:45:23.630] [mlr3] Applying learner 'regr.ranger' on task 'nuis_l' (iter 4/5) 
INFO  [21:45:24.488] [mlr3] Applying learner 'regr.ranger' on task 'nuis_l' (iter 5/5) 
INFO  [21:45:25.698] [mlr3] Applying learner 'regr.ranger' on task 'nuis_m' (iter 1/5) 
INFO  [21:45:26.533] [mlr3] Applying learner 'regr.ranger' on task 'nuis_m' (iter 2/5) 
INFO  [21:45:27.371] [mlr3] Applying learner 'regr.ranger' on task 'nuis_m' (iter 3/5) 
INFO  [21:45:28.214] [mlr3] Applying learner 'regr.ranger' on task 'nuis_m' (iter 4/5) 
INFO  [21:45:29.038] [mlr3] Applying learner 'regr.ranger' on task 'nuis_m' (iter 5/5) 
INFO  [21:45:29.971] [mlr3] Applying learner 'regr.ranger' on task 'nuis_g' (iter 1/5) 
INFO  [21:45:31.071] [mlr3] Applying learner 'regr.ranger' on task 'nuis_g' (iter 2/5) 
INFO  [21:45:31.912] [mlr3] Applying learner 'regr.ranger' on task 'nuis_g' (iter 3/5) 
INFO  [21:45:32.783] [mlr3] Applying learner 'regr.ranger' on task 'nuis_g' (iter 4/5) 
INFO  [21:45:33.731] [mlr3] Applying learner 'regr.ranger' on task 'nuis_g' (iter 5/5) </code></pre>
</div>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#=== print the results ===#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">dml_plr_obj_iv</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>================= DoubleMLPLR Object ==================


------------------ Data summary      ------------------
Outcome variable: y
Treatment variable(s): d
Covariates: X1, X2, X3, X4, X5, X6, X7, X8, X9, X10, X11, X12, X13, X14, X15, X16, X17, X18, X19, X20
Instrument(s): 
No. Observations: 500

------------------ Score &amp; algorithm ------------------
Score function: IV-type
DML algorithm: dml2

------------------ Machine learner   ------------------
ml_l: regr.ranger
ml_m: regr.ranger
ml_g: regr.ranger

------------------ Resampling        ------------------
No. folds: 5
No. repeated sample splits: 1
Apply cross-fitting: TRUE

------------------ Fit summary       ------------------
 Estimates and significance testing of the effect of target variables
  Estimate. Std. Error t value Pr(&gt;|t|)    
d   0.55102    0.04558   12.09   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
</section><section id="partially-linear-iv-model" class="level3" data-number="10.2.2"><h3 data-number="10.2.2" class="anchored" data-anchor-id="partially-linear-iv-model">
<span class="header-section-number">10.2.2</span> Partially linear IV model</h3>
<p>When using observational data, it is rarely the case that conditional unconfoundedness of the treatment is satisfied. In such a case, you may want to consider a DML-IV approach implemented by <code><a href="https://rdrr.io/pkg/DoubleML/man/DoubleMLPLIV.html">DoubleMLPLIV()</a></code>. Just like IV for linear models, finding the right instrument is critical for the DML-IV approach to be consistent.</p>
<p><span id="eq-plr"><span class="math display">\[
\begin{aligned}
y = \theta d + g_0(X) + \mu \\
Z = m_0(X) + \varepsilon \\
d = r_0(X) + \eta
\end{aligned}
\tag{10.7}\]</span></span></p>
<p>When <span class="math inline">\(\varspsilon\)</span> and <span class="math inline">\(\mu\)</span> are correlated, <code><a href="https://rdrr.io/pkg/DoubleML/man/DoubleMLPLR.html">DoubleMLPLR()</a></code> is inconsistent. However, as long as the following assumptions are satisfied, <code><a href="https://rdrr.io/pkg/DoubleML/man/DoubleMLPLIV.html">DoubleMLPLIV()</a></code> is consistent.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Assumptions on the error terms</strong></p>
<ul>
<li><span class="math inline">\(E[\mu|Z,X] = 0\)</span></li>
<li><span class="math inline">\(E[\varepsilon|X] = 0\)</span></li>
<li><span class="math inline">\(E[\varepsilon\cdot \mu|Z, X] = 0\)</span></li>
</ul>
</div>
</div>
<p>Here is the causal diagram for the partially linear model of interest. As you can see, the treatment variable <span class="math inline">\(T\)</span> is confounded as <span class="math inline">\(\mu\)</span> affects both <span class="math inline">\(Y\)</span> and <span class="math inline">\(T\)</span> (through <span class="math inline">\(\eta\)</span>).</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">DiagrammeR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DiagrammeR/man/grViz.html">grViz</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span></span>
<span>  <span class="st">"</span></span>
<span><span class="st">  digraph {</span></span>
<span><span class="st">    graph [ranksep = 0.6]</span></span>
<span><span class="st">    node [shape = box]</span></span>
<span><span class="st">      Y [label = 'Y']</span></span>
<span><span class="st">      X [label = 'X']</span></span>
<span><span class="st">      T [label = 'T']</span></span>
<span><span class="st">      Z [label = 'Z']</span></span>
<span><span class="st">      varep [label = '\U03B5']</span></span>
<span><span class="st">      mu [label = '\U03BC']</span></span>
<span><span class="st">      eta [label = '\U03B7']</span></span>
<span><span class="st">    edge [minlen = 2]</span></span>
<span><span class="st">      X-&gt;Y</span></span>
<span><span class="st">      T-&gt;Y</span></span>
<span><span class="st">      Z-&gt;T</span></span>
<span><span class="st">      X-&gt;T</span></span>
<span><span class="st">      X-&gt;Z</span></span>
<span><span class="st">      varep-&gt;Z</span></span>
<span><span class="st">      mu-&gt;{Y, eta}</span></span>
<span><span class="st">      eta-&gt;{T, mu}</span></span>
<span><span class="st">    { rank = same; Y; Z; varep}</span></span>
<span><span class="st">    { rank = same; X; T; mu}</span></span>
<span><span class="st">  }</span></span>
<span><span class="st">  "</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="htmlwidget-1c291c2394a95241a846" style="width:100%;height:464px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-1c291c2394a95241a846">{"x":{"diagram":"\n  digraph {\n    graph [ranksep = 0.6]\n    node [shape = box]\n      Y [label = \"Y\"]\n      X [label = \"X\"]\n      T [label = \"T\"]\n      Z [label = \"Z\"]\n      varep [label = \"ε\"]\n      mu [label = \"μ\"]\n      eta [label = \"η\"]\n    edge [minlen = 2]\n      X->Y\n      T->Y\n      Z->T\n      X->T\n      X->Z\n      varep->Z\n      mu->{Y, eta}\n      eta->{T, mu}\n    { rank = same; Y; Z; varep}\n    { rank = same; X; T; mu}\n  }\n  ","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Just like <code>DoublMLPLR()</code>, there are two ways to estimate <span class="math inline">\(\theta\)</span> using <code>DoublMLPLIV()</code>. The two score functions are:</p>
<ul>
<li>
<code>partialling-out</code>: <span class="math inline">\([Y - l(X) - \theta(D-r(X))][Z-m(X)]\)</span>
</li>
<li>
<code>IV-type</code>: <span class="math inline">\([Y - \theta D - g(X)][Z-m(X)]\)</span>
</li>
</ul>
<p>, where <span class="math inline">\(r(X) = E[D|X]\)</span>. So, <span class="math inline">\(r(X)\)</span> is the same as <span class="math inline">\(m(X)\)</span> in the partially line model case. <span class="math inline">\(m(X)\)</span> represents <span class="math inline">\(E[Z|X]\)</span> in the IV model.</p>
<p>Let <span class="math inline">\(\tilde{Z}\)</span>, <span class="math inline">\(\tilde{D}\)</span>, <span class="math inline">\(\tilde{Y}_l\)</span>, and <span class="math inline">\(\tilde{Y}_g\)</span> denote <span class="math inline">\(Z-m(X)\)</span>, <span class="math inline">\(D-r(X)\)</span>, <span class="math inline">\(Y-l(X)\)</span>, and <span class="math inline">\(Y-g(X)\)</span>, respectively.</p>
<ul>
<li><p><code>partialling-out</code>: <span class="math inline">\(\theta = (\tilde{Z}'\tilde{D})^{-1}\tilde{Z}\tilde{Y}_l\)</span></p></li>
<li><p><code>IV-type</code>: <span class="math inline">\(\theta = (\tilde{Z}'D)^{-1}\tilde{Z}\tilde{Y}_g\)</span></p></li>
</ul></section></section><section id="suggested-exercises" class="level2" data-number="10.3"><h2 data-number="10.3" class="anchored" data-anchor-id="suggested-exercises">
<span class="header-section-number">10.3</span> Suggested Exercises</h2>
</section><section id="references" class="level2 unnumbered"><h2 class="unnumbered anchored" data-anchor-id="references">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-DoubleML2021R" class="csl-entry" role="doc-biblioentry">
Bach, P., V. Chernozhukov, M. S. Kurz, and M. Spindler. 2021. <span>“<span>DoubleML</span> – <span>A</span>n Object-Oriented Implementation of Double Machine Learning in <span>R</span>.”</span> <a href="https://arxiv.org/abs/2103.09603">https://arxiv.org/abs/2103.09603</a>.
</div>
<div id="ref-DoubleML2022Python" class="csl-entry" role="doc-biblioentry">
Bach, Philipp, Victor Chernozhukov, Malte S. Kurz, and Martin Spindler. 2022. <span>“<span>DoubleML</span> – <span>A</span>n Object-Oriented Implementation of Double Machine Learning in <span>P</span>ython.”</span> <em>Journal of Machine Learning Research</em> 23 (53): 1–6. <a href="http://jmlr.org/papers/v23/21-0862.html">http://jmlr.org/papers/v23/21-0862.html</a>.
</div>
<div id="ref-Chernozhukov2018" class="csl-entry" role="doc-biblioentry">
Chernozhukov, Victor, Denis Chetverikov, Mert Demirer, Esther Duflo, Christian Hansen, Whitney Newey, and James Robins. 2018. <span>“<span class="nocase">Double/debiased machine learning for treatment and structural parameters</span>.”</span> <em>The Econometrics Journal</em> 21 (1): C1–68. <a href="https://doi.org/10.1111/ectj.12097">https://doi.org/10.1111/ectj.12097</a>.
</div>
</div>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./C00-why-not-this.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Why can’t we just do this?</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./C02-r-learner.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">R-learner</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>