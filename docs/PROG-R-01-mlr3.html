<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.629">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Introduction to Machine Learning for Economists (Under Construction) - 18&nbsp; Machine Learning with mlr3</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./PROG-R-02-reticulate.html" rel="next">
<link href="./E02-grf.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<link href="style.css" rel="stylesheet" type="text/css">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-45VKT2HZSL"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'G-45VKT2HZSL');
</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Machine Learning with <code>mlr3</code></span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Introduction to Machine Learning for Economists (Under Construction)</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/tmieno2/ML-Economist" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="" title="Share" id="sidebar-tool-dropdown-0" class="sidebar-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-share"></i></a>
    <ul class="dropdown-menu" aria-labelledby="sidebar-tool-dropdown-0">
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
            <i class="bi bi-bi-twitter pe-1"></i>
          Twitter
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
            <i class="bi bi-bi-facebook pe-1"></i>
          Facebook
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
            <i class="bi bi-bi-linkedin pe-1"></i>
          LinkedIn
          </a>
        </li>
    </ul>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Welcome</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./H00-preface.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Basics</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B01-nonlinear.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Non-linear function estimation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B02-bias-variance-tradeoff.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Bias-variance Trade-off</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B03-cross-validation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Cross-validation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B04-regularization.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Regression Shrinkage Methods</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B05-bootstrap.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Bootstrap</span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Prediction ML</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P01-random-forest.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Random Forest</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P02-boosted-regression-forest.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Boosted Regression Forest</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P03-xgb.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Extreme Gradient Boosting</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P04-local-linear-forest.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Local Linear Forest</span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./C0P-causal-ml.html" class="sidebar-item-text sidebar-link">Causal Machine Learning (CML) Methods</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C00-why-not-this.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Why can’t we just do this?</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C01-dml.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Double Machine Learning</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C02-xstr-learner.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">S-, X-, T-, and R-learner</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C03-cf-orf.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Forest-based CATE Estimators</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C04-cf-extension.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Extensions of Causal Forest</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C05-causal-model-selection.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Causal Model Selection</span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./E0P-extensions.html" class="sidebar-item-text sidebar-link">Extensions</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./E01-spatial-cv.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Spatial Cross-validation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./E02-grf.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Generalized Random Forest</span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">Programming: R</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PROG-R-01-mlr3.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Machine Learning with <code>mlr3</code></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PROG-R-02-reticulate.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Running Python from R</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PROG-R-03-model-selection-prediction.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Model Selection (Prediction)</span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">Programming: Python</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PROG-P-01-scikitlearn.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Prediction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PROG-P-02-CATE-econml.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Treatment Effect Estimation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PROG-P-03-model-selection.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Model selection</span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">Appendices</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A01-mc-simulation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Monte Carlo (MC) Simulation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A02-method-of-moment.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Primer on method of moment</span></a>
  </div>
</li>
    </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#tasks" id="toc-tasks" class="nav-link active" data-scroll-target="#tasks"> <span class="header-section-number">18.1</span> Tasks</a></li>
  <li><a href="#learners" id="toc-learners" class="nav-link" data-scroll-target="#learners"> <span class="header-section-number">18.2</span> Learners</a></li>
  <li><a href="#train-predict-assessment" id="toc-train-predict-assessment" class="nav-link" data-scroll-target="#train-predict-assessment"> <span class="header-section-number">18.3</span> Train, predict, assessment</a>
  <ul class="collapse">
  <li><a href="#train" id="toc-train" class="nav-link" data-scroll-target="#train"> <span class="header-section-number">18.3.1</span> Train</a></li>
  <li><a href="#prediction" id="toc-prediction" class="nav-link" data-scroll-target="#prediction"> <span class="header-section-number">18.3.2</span> Prediction</a></li>
  <li><a href="#performance-assessment" id="toc-performance-assessment" class="nav-link" data-scroll-target="#performance-assessment"> <span class="header-section-number">18.3.3</span> Performance assessment</a></li>
  </ul></li>
  <li><a href="#resampling-cross-validation-and-cross-fitting" id="toc-resampling-cross-validation-and-cross-fitting" class="nav-link" data-scroll-target="#resampling-cross-validation-and-cross-fitting"> <span class="header-section-number">18.4</span> Resampling, cross-validation, and cross-fitting</a>
  <ul class="collapse">
  <li><a href="#resampling" id="toc-resampling" class="nav-link" data-scroll-target="#resampling"> <span class="header-section-number">18.4.1</span> Resampling</a></li>
  <li><a href="#cross-validation-and-cross-fitting" id="toc-cross-validation-and-cross-fitting" class="nav-link" data-scroll-target="#cross-validation-and-cross-fitting"> <span class="header-section-number">18.4.2</span> Cross-validation and cross-fitting</a></li>
  </ul></li>
  <li><a href="#hyper-parameter-tuning" id="toc-hyper-parameter-tuning" class="nav-link" data-scroll-target="#hyper-parameter-tuning"> <span class="header-section-number">18.5</span> Hyper-parameter tuning</a>
  <ul class="collapse">
  <li><a href="#tuninginstance" id="toc-tuninginstance" class="nav-link" data-scroll-target="#tuninginstance"> <span class="header-section-number">18.5.1</span> TuningInstance</a></li>
  <li><a href="#tuner" id="toc-tuner" class="nav-link" data-scroll-target="#tuner"> <span class="header-section-number">18.5.2</span> Tuner</a></li>
  <li><a href="#tuning" id="toc-tuning" class="nav-link" data-scroll-target="#tuning"> <span class="header-section-number">18.5.3</span> Tuning</a></li>
  <li><a href="#autotuner" id="toc-autotuner" class="nav-link" data-scroll-target="#autotuner"> <span class="header-section-number">18.5.4</span> AutoTuner</a></li>
  </ul></li>
  <li><a href="#sec-mlr3-in-action" id="toc-sec-mlr3-in-action" class="nav-link" data-scroll-target="#sec-mlr3-in-action"> <span class="header-section-number">18.6</span> <code>mlr3</code> in action</a>
  <ul class="collapse">
  <li><a href="#first-stage" id="toc-first-stage" class="nav-link" data-scroll-target="#first-stage"> <span class="header-section-number">18.6.1</span> First stage</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/tmieno2/ML-Economist/edit/master/PROG-R-01-mlr3.qmd" class="toc-action">Edit this page</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-mlr3" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Machine Learning with <code>mlr3</code></span></span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<p>The <code>mlr3</code> package is an R package that makes it easy for you to implement standard machine learning procedures (e.g., training, prediction, cross-validation) in a unified framework. It is similar to the Python scikit-learn package. In this section, we cover the basic use cases of the <code>mlr3</code> package accompanied by an real-world example at the end. The authors of the package is currently writing a <a href="https://mlr3book.mlr-org.com/02-basics-learners.html">book</a> on how to use it. Materials covered in this section is basically a condensed (and far less comprehensive) version of the book. Yet, they should still be sufficient for the majority of ML tasks you typically implement in practice.</p>
<p>To start working with <code>mlr3</code>, it is convenient to load the <code>mlr3verse</code> package, which is a collection of packages that provide useful extensions (e.g., quick visualization (<code>mlr3viz</code>), machine learning methods (<code>mlr3leaners</code>), etc). It is like the <code>tidyverse</code> package.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>See <a href="https://github.com/mlr-org/mlr3verse">here</a> for the list of included packages.</p>
</div></div><div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>An alternative ML utility package in R is the <code>tidymodels</code> package. In this book, we do not cover how to use the package. Interested readers can read an excellent free on-line book <a href="https://www.tmwr.org/">here</a>.</p>
</div>
</div>
<p>For those who have been using solely R for their programming needs are not likely to be familiar with the way <code>mlr3</code> works. It uses R6 classes provided the <code>R6</code> package. The package provides an implementation of encapsulated object-oriented programing, which how Python works. So, if you are familiar with Python, then <code>mlr3</code> should come quite natural to you. Fortunately, understanding how <code>R6</code> works is not too hard (especially for us who are just using it). Reading the introduction of the <code>R6</code> provided <a href="https://r6.r-lib.org/articles/Introduction.html">here</a> should suffice.</p>
<p>To implement ML tasks, we need two core components at least: task, and learner. Roughly speaking, here are what they are.</p>
<ul>
<li>Task: data</li>
<li>Learner: model</li>
</ul>
<p>We will take a deeper look at these two components first, and then training, prediction, and other ML tasks.</p>
<section id="tasks" class="level2 page-columns page-full" data-number="18.1">
<h2 data-number="18.1" class="anchored" data-anchor-id="tasks"><span class="header-section-number">18.1</span> Tasks</h2>

<div class="no-row-height column-margin column-container"><div class="">
<p><strong>Packages to load for replication</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DoubleML)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mltools)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div></div><p>A task in the <code>mlr3</code> parlance is basically a dataset (called <code>backend</code>) with information on which variable is the dependent variable (called <code>target</code>) and which variables are explanatory variables (called <code>features</code>).</p>
<p>Here, we will use <code>mtcars</code> data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== load mtcars ===#</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"mtcars"</span>, <span class="at">package =</span> <span class="st">"datasets"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== see the first 6 rows ===#</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mtcars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   mpg cyl disp  hp drat    wt  qsec vs am gear carb
Mazda RX4         21.0   6  160 110 3.90 2.620 16.46  0  1    4    4
Mazda RX4 Wag     21.0   6  160 110 3.90 2.875 17.02  0  1    4    4
Datsun 710        22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
Hornet 4 Drive    21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2
Valiant           18.1   6  225 105 2.76 3.460 20.22  1  0    3    1</code></pre>
</div>
</div>
<p>When you create a task, you need to recognize what type of analysis you will be doing and use an appropriate class. Here, we will be running regression, so we use the <code>TaskRegr</code> class (see <a href="https://mlr3book.mlr-org.com/02-basics-tasks.html#tasks-types">here</a> for other task types).</p>
<p>Now, let’s create a task using the <code>TaskRegr</code> class with</p>
<ul>
<li><code>mtcars</code> as <code>backend</code> (data)</li>
<li><code>mpg</code> as <code>target</code> (dependent variable)</li>
<li><code>example</code> as <code>id</code> (this is the id for the task, you can give any name)</li>
</ul>
<p>You can instantiate a new <code>TaskRegr</code> instance using the <code>new()</code> methods on the <code>TaskRegr</code> class.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>reg_task <span class="ot">&lt;-</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  TaskRegr<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="st">"example"</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">backend =</span> mtcars,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">target =</span> <span class="st">"mpg"</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TaskRegr:example&gt; (32 x 11)
* Target: mpg
* Properties: -
* Features (10):
  - dbl (10): am, carb, cyl, disp, drat, gear, hp, qsec, vs, wt</code></pre>
</div>
</div>
<p>As you can see, <code>mpg</code> is the <code>Target</code> and the rest was automatically set to <code>Features</code>.</p>
<p>You can use the <code>cole_roles()</code> method to return the roles of the variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>reg_task<span class="sc">$</span>col_roles </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$feature
 [1] "am"   "carb" "cyl"  "disp" "drat" "gear" "hp"   "qsec" "vs"   "wt"  

$target
[1] "mpg"

$name
character(0)

$order
character(0)

$stratum
character(0)

$group
character(0)

$weight
character(0)</code></pre>
</div>
</div>
<p>You can extract information from the task using various methods:</p>
<ul>
<li>$nrow: returns the number of rows</li>
<li>$ncol: returns the number of columns</li>
<li>$feature_names: returns the name of the feature variables</li>
<li>$target_names: returns the name of the target variable(s)</li>
<li>$row_ids: return row ids (integers starting from 1 to the number of rows)</li>
<li>$data(): returns the backend (data) as a <code>data.table</code></li>
</ul>
<p>Let’s see some of these.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== row ids ===#</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>reg_task<span class="sc">$</span>row_ids</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25
[26] 26 27 28 29 30 31 32</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== data ===#</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>reg_task<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     mpg am carb cyl  disp drat gear  hp  qsec vs    wt
 1: 21.0  1    4   6 160.0 3.90    4 110 16.46  0 2.620
 2: 21.0  1    4   6 160.0 3.90    4 110 17.02  0 2.875
 3: 22.8  1    1   4 108.0 3.85    4  93 18.61  1 2.320
 4: 21.4  0    1   6 258.0 3.08    3 110 19.44  1 3.215
 5: 18.7  0    2   8 360.0 3.15    3 175 17.02  0 3.440
 6: 18.1  0    1   6 225.0 2.76    3 105 20.22  1 3.460
 7: 14.3  0    4   8 360.0 3.21    3 245 15.84  0 3.570
 8: 24.4  0    2   4 146.7 3.69    4  62 20.00  1 3.190
 9: 22.8  0    2   4 140.8 3.92    4  95 22.90  1 3.150
10: 19.2  0    4   6 167.6 3.92    4 123 18.30  1 3.440
11: 17.8  0    4   6 167.6 3.92    4 123 18.90  1 3.440
12: 16.4  0    3   8 275.8 3.07    3 180 17.40  0 4.070
13: 17.3  0    3   8 275.8 3.07    3 180 17.60  0 3.730
14: 15.2  0    3   8 275.8 3.07    3 180 18.00  0 3.780
15: 10.4  0    4   8 472.0 2.93    3 205 17.98  0 5.250
16: 10.4  0    4   8 460.0 3.00    3 215 17.82  0 5.424
17: 14.7  0    4   8 440.0 3.23    3 230 17.42  0 5.345
18: 32.4  1    1   4  78.7 4.08    4  66 19.47  1 2.200
19: 30.4  1    2   4  75.7 4.93    4  52 18.52  1 1.615
20: 33.9  1    1   4  71.1 4.22    4  65 19.90  1 1.835
21: 21.5  0    1   4 120.1 3.70    3  97 20.01  1 2.465
22: 15.5  0    2   8 318.0 2.76    3 150 16.87  0 3.520
23: 15.2  0    2   8 304.0 3.15    3 150 17.30  0 3.435
24: 13.3  0    4   8 350.0 3.73    3 245 15.41  0 3.840
25: 19.2  0    2   8 400.0 3.08    3 175 17.05  0 3.845
26: 27.3  1    1   4  79.0 4.08    4  66 18.90  1 1.935
27: 26.0  1    2   4 120.3 4.43    5  91 16.70  0 2.140
28: 30.4  1    2   4  95.1 3.77    5 113 16.90  1 1.513
29: 15.8  1    4   8 351.0 4.22    5 264 14.50  0 3.170
30: 19.7  1    6   6 145.0 3.62    5 175 15.50  0 2.770
31: 15.0  1    8   8 301.0 3.54    5 335 14.60  0 3.570
32: 21.4  1    2   4 121.0 4.11    4 109 18.60  1 2.780
     mpg am carb cyl  disp drat gear  hp  qsec vs    wt</code></pre>
</div>
</div>
<p>It is possible to retrieve only a portion of the data using <code>rows</code> and <code>cols</code> options inside <code>data()</code> as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>reg_task<span class="sc">$</span><span class="fu">data</span>(<span class="at">rows =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"mpg"</span>, <span class="st">'wt'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     mpg    wt
 1: 21.0 2.620
 2: 21.0 2.875
 3: 22.8 2.320
 4: 21.4 3.215
 5: 18.7 3.440
 6: 18.1 3.460
 7: 14.3 3.570
 8: 24.4 3.190
 9: 22.8 3.150
10: 19.2 3.440</code></pre>
</div>
</div>
<p>To retrieve the complete data from the task, you can apply <code>as.data.table()</code> to the task.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>data_extracted <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(reg_task)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     mpg am carb cyl  disp drat gear  hp  qsec vs    wt
 1: 21.0  1    4   6 160.0 3.90    4 110 16.46  0 2.620
 2: 21.0  1    4   6 160.0 3.90    4 110 17.02  0 2.875
 3: 22.8  1    1   4 108.0 3.85    4  93 18.61  1 2.320
 4: 21.4  0    1   6 258.0 3.08    3 110 19.44  1 3.215
 5: 18.7  0    2   8 360.0 3.15    3 175 17.02  0 3.440
 6: 18.1  0    1   6 225.0 2.76    3 105 20.22  1 3.460
 7: 14.3  0    4   8 360.0 3.21    3 245 15.84  0 3.570
 8: 24.4  0    2   4 146.7 3.69    4  62 20.00  1 3.190
 9: 22.8  0    2   4 140.8 3.92    4  95 22.90  1 3.150
10: 19.2  0    4   6 167.6 3.92    4 123 18.30  1 3.440
11: 17.8  0    4   6 167.6 3.92    4 123 18.90  1 3.440
12: 16.4  0    3   8 275.8 3.07    3 180 17.40  0 4.070
13: 17.3  0    3   8 275.8 3.07    3 180 17.60  0 3.730
14: 15.2  0    3   8 275.8 3.07    3 180 18.00  0 3.780
15: 10.4  0    4   8 472.0 2.93    3 205 17.98  0 5.250
16: 10.4  0    4   8 460.0 3.00    3 215 17.82  0 5.424
17: 14.7  0    4   8 440.0 3.23    3 230 17.42  0 5.345
18: 32.4  1    1   4  78.7 4.08    4  66 19.47  1 2.200
19: 30.4  1    2   4  75.7 4.93    4  52 18.52  1 1.615
20: 33.9  1    1   4  71.1 4.22    4  65 19.90  1 1.835
21: 21.5  0    1   4 120.1 3.70    3  97 20.01  1 2.465
22: 15.5  0    2   8 318.0 2.76    3 150 16.87  0 3.520
23: 15.2  0    2   8 304.0 3.15    3 150 17.30  0 3.435
24: 13.3  0    4   8 350.0 3.73    3 245 15.41  0 3.840
25: 19.2  0    2   8 400.0 3.08    3 175 17.05  0 3.845
26: 27.3  1    1   4  79.0 4.08    4  66 18.90  1 1.935
27: 26.0  1    2   4 120.3 4.43    5  91 16.70  0 2.140
28: 30.4  1    2   4  95.1 3.77    5 113 16.90  1 1.513
29: 15.8  1    4   8 351.0 4.22    5 264 14.50  0 3.170
30: 19.7  1    6   6 145.0 3.62    5 175 15.50  0 2.770
31: 15.0  1    8   8 301.0 3.54    5 335 14.60  0 3.570
32: 21.4  1    2   4 121.0 4.11    4 109 18.60  1 2.780
     mpg am carb cyl  disp drat gear  hp  qsec vs    wt</code></pre>
</div>
</div>
<p>You can mutate tasks using the <code>select()</code> and <code>filter()</code> methods. It is important to remember here that the instance at which these mutations are implemented is indeed mutated. Let’s see what I mean by this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== first select few variables ===#</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>reg_task<span class="sc">$</span><span class="fu">select</span>(<span class="fu">c</span>(<span class="st">"am"</span>, <span class="st">"carb"</span>, <span class="st">"cyl"</span>))</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== see the backend now ===#</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>reg_task<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     mpg am carb cyl
 1: 21.0  1    4   6
 2: 21.0  1    4   6
 3: 22.8  1    1   4
 4: 21.4  0    1   6
 5: 18.7  0    2   8
 6: 18.1  0    1   6
 7: 14.3  0    4   8
 8: 24.4  0    2   4
 9: 22.8  0    2   4
10: 19.2  0    4   6
11: 17.8  0    4   6
12: 16.4  0    3   8
13: 17.3  0    3   8
14: 15.2  0    3   8
15: 10.4  0    4   8
16: 10.4  0    4   8
17: 14.7  0    4   8
18: 32.4  1    1   4
19: 30.4  1    2   4
20: 33.9  1    1   4
21: 21.5  0    1   4
22: 15.5  0    2   8
23: 15.2  0    2   8
24: 13.3  0    4   8
25: 19.2  0    2   8
26: 27.3  1    1   4
27: 26.0  1    2   4
28: 30.4  1    2   4
29: 15.8  1    4   8
30: 19.7  1    6   6
31: 15.0  1    8   8
32: 21.4  1    2   4
     mpg am carb cyl</code></pre>
</div>
</div>
<p>As you can see, <code>reg_task</code> now holds only the variables that were selected (plus the target variable <code>mpg</code>). This behavior is similar to how <code>data.table</code> works when you create a new variable using <code>data[, := ]</code> syntax. And, this is different from how <code>dplyr::select</code> works.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== create a dataset ===#</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>data_temp <span class="ot">&lt;-</span> reg_task<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== select mpg, carb ===#</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">select</span>(data_temp, mpg, carb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     mpg carb
 1: 21.0    4
 2: 21.0    4
 3: 22.8    1
 4: 21.4    1
 5: 18.7    2
 6: 18.1    1
 7: 14.3    4
 8: 24.4    2
 9: 22.8    2
10: 19.2    4
11: 17.8    4
12: 16.4    3
13: 17.3    3
14: 15.2    3
15: 10.4    4
16: 10.4    4
17: 14.7    4
18: 32.4    1
19: 30.4    2
20: 33.9    1
21: 21.5    1
22: 15.5    2
23: 15.2    2
24: 13.3    4
25: 19.2    2
26: 27.3    1
27: 26.0    2
28: 30.4    2
29: 15.8    4
30: 19.7    6
31: 15.0    8
32: 21.4    2
     mpg carb</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== look at data_temp ===#</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>data_temp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     mpg am carb cyl
 1: 21.0  1    4   6
 2: 21.0  1    4   6
 3: 22.8  1    1   4
 4: 21.4  0    1   6
 5: 18.7  0    2   8
 6: 18.1  0    1   6
 7: 14.3  0    4   8
 8: 24.4  0    2   4
 9: 22.8  0    2   4
10: 19.2  0    4   6
11: 17.8  0    4   6
12: 16.4  0    3   8
13: 17.3  0    3   8
14: 15.2  0    3   8
15: 10.4  0    4   8
16: 10.4  0    4   8
17: 14.7  0    4   8
18: 32.4  1    1   4
19: 30.4  1    2   4
20: 33.9  1    1   4
21: 21.5  0    1   4
22: 15.5  0    2   8
23: 15.2  0    2   8
24: 13.3  0    4   8
25: 19.2  0    2   8
26: 27.3  1    1   4
27: 26.0  1    2   4
28: 30.4  1    2   4
29: 15.8  1    4   8
30: 19.7  1    6   6
31: 15.0  1    8   8
32: 21.4  1    2   4
     mpg am carb cyl</code></pre>
</div>
</div>
<p>As you can see, <code>data_temp</code> is not mutated after <code>select()</code>. To save the the result of <code>dplyr::select()</code>, you need to explicitly assign it to another R object.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>The target variable cannot be selected in <code>select()</code>. It is automatically selected.</p>
</div></div><p>If you would like to keep the original task, you can use the <code>clone()</code> method to create a distinct instance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== create a clone ===#</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>reg_task_independent <span class="ot">&lt;-</span> reg_task<span class="sc">$</span><span class="fu">clone</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s filter the data using the <code>filter()</code> method.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== filter ===#</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>reg_task<span class="sc">$</span><span class="fu">filter</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== see the backend ===#</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>reg_task<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     mpg am carb cyl
 1: 21.0  1    4   6
 2: 21.0  1    4   6
 3: 22.8  1    1   4
 4: 21.4  0    1   6
 5: 18.7  0    2   8
 6: 18.1  0    1   6
 7: 14.3  0    4   8
 8: 24.4  0    2   4
 9: 22.8  0    2   4
10: 19.2  0    4   6</code></pre>
</div>
</div>
<p>However, <code>reg_task_independent</code> is not affected.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>reg_task_independent<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     mpg am carb cyl
 1: 21.0  1    4   6
 2: 21.0  1    4   6
 3: 22.8  1    1   4
 4: 21.4  0    1   6
 5: 18.7  0    2   8
 6: 18.1  0    1   6
 7: 14.3  0    4   8
 8: 24.4  0    2   4
 9: 22.8  0    2   4
10: 19.2  0    4   6
11: 17.8  0    4   6
12: 16.4  0    3   8
13: 17.3  0    3   8
14: 15.2  0    3   8
15: 10.4  0    4   8
16: 10.4  0    4   8
17: 14.7  0    4   8
18: 32.4  1    1   4
19: 30.4  1    2   4
20: 33.9  1    1   4
21: 21.5  0    1   4
22: 15.5  0    2   8
23: 15.2  0    2   8
24: 13.3  0    4   8
25: 19.2  0    2   8
26: 27.3  1    1   4
27: 26.0  1    2   4
28: 30.4  1    2   4
29: 15.8  1    4   8
30: 19.7  1    6   6
31: 15.0  1    8   8
32: 21.4  1    2   4
     mpg am carb cyl</code></pre>
</div>
</div>
<p>You can use the <code>rbind()</code> and <code>cbind()</code> methods to append data vertically and horizontally, respectively.</p>
<p>Here is an example use of <code>rbind()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>reg_task<span class="sc">$</span><span class="fu">rbind</span>(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(<span class="at">mpg =</span> <span class="dv">20</span>, <span class="at">am =</span> <span class="dv">1</span>, <span class="at">carb =</span> <span class="dv">3</span>, <span class="at">cyl =</span> <span class="dv">99</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co">#=== see the change ===#</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>reg_task<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     mpg am carb cyl
 1: 21.0  1    4   6
 2: 21.0  1    4   6
 3: 22.8  1    1   4
 4: 21.4  0    1   6
 5: 18.7  0    2   8
 6: 18.1  0    1   6
 7: 14.3  0    4   8
 8: 24.4  0    2   4
 9: 22.8  0    2   4
10: 19.2  0    4   6
11: 20.0  1    3  99</code></pre>
</div>
</div>
</section>
<section id="learners" class="level2 page-columns page-full" data-number="18.2">
<h2 data-number="18.2" class="anchored" data-anchor-id="learners"><span class="header-section-number">18.2</span> Learners</h2>
<p>In Python, the majority of ML packages are written to be compatible with <code>scikit-learn</code> framework. However, in R, there is no single framework that is equivalent to <code>scikit-learn</code> to which all the developers of ML packages conform to. Fortunately, the author of the <code>mlr3</code> package picked popular ML packages (e.g., <code>ranger</code>, <code>xgboost</code>) and made it easier for us to use those packages under the unified framework.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p><code>tidymodels</code> have their own collection of packages, which is very similar to what <code>mlr3</code> has.</p>
</div></div><p>Here is the list of learners that is available after loading the <code>mlr3verse</code> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>mlr_learners</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;DictionaryLearner&gt; with 129 stored values
Keys: classif.AdaBoostM1, classif.bart, classif.C50, classif.catboost,
  classif.cforest, classif.ctree, classif.cv_glmnet, classif.debug,
  classif.earth, classif.featureless, classif.fnn, classif.gam,
  classif.gamboost, classif.gausspr, classif.gbm, classif.glmboost,
  classif.glmnet, classif.IBk, classif.J48, classif.JRip, classif.kknn,
  classif.ksvm, classif.lda, classif.liblinear, classif.lightgbm,
  classif.LMT, classif.log_reg, classif.lssvm, classif.mob,
  classif.multinom, classif.naive_bayes, classif.nnet, classif.OneR,
  classif.PART, classif.qda, classif.randomForest, classif.ranger,
  classif.rfsrc, classif.rpart, classif.svm, classif.xgboost,
  clust.agnes, clust.ap, clust.cmeans, clust.cobweb, clust.dbscan,
  clust.diana, clust.em, clust.fanny, clust.featureless, clust.ff,
  clust.hclust, clust.kkmeans, clust.kmeans, clust.MBatchKMeans,
  clust.meanshift, clust.pam, clust.SimpleKMeans, clust.xmeans,
  dens.kde_ks, dens.locfit, dens.logspline, dens.mixed, dens.nonpar,
  dens.pen, dens.plug, dens.spline, regr.bart, regr.catboost,
  regr.cforest, regr.ctree, regr.cubist, regr.cv_glmnet, regr.debug,
  regr.earth, regr.featureless, regr.fnn, regr.gam, regr.gamboost,
  regr.gausspr, regr.gbm, regr.glm, regr.glmboost, regr.glmnet,
  regr.IBk, regr.kknn, regr.km, regr.ksvm, regr.liblinear,
  regr.lightgbm, regr.lm, regr.lmer, regr.M5Rules, regr.mars, regr.mob,
  regr.randomForest, regr.ranger, regr.rfsrc, regr.rpart, regr.rvm,
  regr.svm, regr.xgboost, surv.akritas, surv.blackboost, surv.cforest,
  surv.coxboost, surv.coxtime, surv.ctree, surv.cv_coxboost,
  surv.cv_glmnet, surv.deephit, surv.deepsurv, surv.dnnsurv,
  surv.flexible, surv.gamboost, surv.gbm, surv.glmboost, surv.glmnet,
  surv.loghaz, surv.mboost, surv.nelson, surv.obliqueRSF,
  surv.parametric, surv.pchazard, surv.penalized, surv.ranger,
  surv.rfsrc, surv.svm, surv.xgboost</code></pre>
</div>
</div>
<p>As you can see, packages that we have seen earlier (e.g., <code>glmnet</code>, <code>ranger</code>, <code>xgboost</code>, <code>gam</code>) are available. the <code>mlr3extralearners</code> package provides you with additional but less-supported learners. You can check the complete list of learners <a href="https://mlr3extralearners.mlr-org.com/articles/learners/list_learners.html">here</a>.</p>
<p>You set up a learner by giving the name of the learner you would like to implement from the list to <code>lrn()</code> like below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">&lt;-</span> <span class="fu">lrn</span>(<span class="st">"regr.ranger"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that you need to pick the one with the appropriate prediction type prefix (the prefixes are self-explanatory). Here, since we are interested in regression, we picked <code>"regr.ranger"</code>.</p>
<p>Once you set up a learner, you can see the set of the learner’s hyper-parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>param_set</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ParamSet&gt;
                              id    class lower upper nlevels        default
 1:                        alpha ParamDbl  -Inf   Inf     Inf            0.5
 2:       always.split.variables ParamUty    NA    NA     Inf &lt;NoDefault[3]&gt;
 3:                      holdout ParamLgl    NA    NA       2          FALSE
 4:                   importance ParamFct    NA    NA       4 &lt;NoDefault[3]&gt;
 5:                   keep.inbag ParamLgl    NA    NA       2          FALSE
 6:                    max.depth ParamInt     0   Inf     Inf               
 7:                min.node.size ParamInt     1   Inf     Inf              5
 8:                     min.prop ParamDbl  -Inf   Inf     Inf            0.1
 9:                      minprop ParamDbl  -Inf   Inf     Inf            0.1
10:                         mtry ParamInt     1   Inf     Inf &lt;NoDefault[3]&gt;
11:                   mtry.ratio ParamDbl     0     1     Inf &lt;NoDefault[3]&gt;
12:            num.random.splits ParamInt     1   Inf     Inf              1
13:                  num.threads ParamInt     1   Inf     Inf              1
14:                    num.trees ParamInt     1   Inf     Inf            500
15:                    oob.error ParamLgl    NA    NA       2           TRUE
16:                     quantreg ParamLgl    NA    NA       2          FALSE
17:        regularization.factor ParamUty    NA    NA     Inf              1
18:      regularization.usedepth ParamLgl    NA    NA       2          FALSE
19:                      replace ParamLgl    NA    NA       2           TRUE
20:    respect.unordered.factors ParamFct    NA    NA       3         ignore
21:              sample.fraction ParamDbl     0     1     Inf &lt;NoDefault[3]&gt;
22:                  save.memory ParamLgl    NA    NA       2          FALSE
23: scale.permutation.importance ParamLgl    NA    NA       2          FALSE
24:                    se.method ParamFct    NA    NA       2        infjack
25:                         seed ParamInt  -Inf   Inf     Inf               
26:         split.select.weights ParamUty    NA    NA     Inf               
27:                    splitrule ParamFct    NA    NA       3       variance
28:                      verbose ParamLgl    NA    NA       2           TRUE
29:                 write.forest ParamLgl    NA    NA       2           TRUE
                              id    class lower upper nlevels        default
       parents value
 1:  splitrule      
 2:                 
 3:                 
 4:                 
 5:                 
 6:                 
 7:                 
 8:                 
 9:  splitrule      
10:                 
11:                 
12:  splitrule      
13:                1
14:                 
15:                 
16:                 
17:                 
18:                 
19:                 
20:                 
21:                 
22:                 
23: importance      
24:                 
25:                 
26:                 
27:                 
28:                 
29:                 
       parents value</code></pre>
</div>
</div>
<p>Right now, only <code>num.threads</code> is set explicitly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>param_set<span class="sc">$</span>values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$num.threads
[1] 1</code></pre>
</div>
</div>
<p>You can update or assign the value of a parameter like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== set max.depth to 5 ===#</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>max.depth <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== see the values ===#</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>param_set<span class="sc">$</span>values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$num.threads
[1] 1

$max.depth
[1] 5</code></pre>
</div>
</div>
<p>When you would like to set values for multiple hyper-parameters at the same time, you can provide a named list to <code>$param_set$values</code>. Here is an example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== create a named vector ===#</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>parameter_values <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">"min.node.size"</span> <span class="ot">=</span> <span class="dv">10</span>, <span class="st">"mtry"</span> <span class="ot">=</span> <span class="dv">5</span>, <span class="st">"num.trees"</span> <span class="ot">=</span> <span class="dv">500</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== assign them ===#</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>param_set<span class="sc">$</span>values <span class="ot">&lt;-</span> parameter_values</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="co">#=== see the values ===#</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>param_set<span class="sc">$</span>values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$min.node.size
[1] 10

$mtry
[1] 5

$num.trees
[1] 500</code></pre>
</div>
</div>
<p>But, notice that the values we set previously for <code>max.depth</code> and <code>num.threads</code> are gone.</p>
</section>
<section id="train-predict-assessment" class="level2" data-number="18.3">
<h2 data-number="18.3" class="anchored" data-anchor-id="train-predict-assessment"><span class="header-section-number">18.3</span> Train, predict, assessment</h2>
<section id="train" class="level3" data-number="18.3.1">
<h3 data-number="18.3.1" class="anchored" data-anchor-id="train"><span class="header-section-number">18.3.1</span> Train</h3>
<p>Training a model can be done using the <code>$train()</code> method on a leaner by supplying a task to it. Let’s first set up a task and learner.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== define a task ===#</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>reg_task <span class="ot">&lt;-</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  TaskRegr<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="st">"example"</span>,</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">backend =</span> mtcars,</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">target =</span> <span class="st">"mpg"</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="co">#=== set up a learner ===#</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">&lt;-</span> <span class="fu">lrn</span>(<span class="st">"regr.ranger"</span>)</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>param_set<span class="sc">$</span>values <span class="ot">&lt;-</span> </span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"min.node.size"</span> <span class="ot">=</span> <span class="dv">10</span>, </span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mtry"</span> <span class="ot">=</span> <span class="dv">5</span>, </span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"num.trees"</span> <span class="ot">=</span> <span class="dv">500</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice that the <code>model</code> attribute of the learner is empty at this point.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NULL</code></pre>
</div>
</div>
<p>Now, let’s train.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span><span class="fu">train</span>(reg_task)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We now how information about the trained model in the <code>model</code> attribute.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Ranger result

Call:
 ranger::ranger(dependent.variable.name = task$target_names, data = task$data(),      case.weights = task$weights$weight, min.node.size = 10L,      mtry = 5L, num.trees = 500L) 

Type:                             Regression 
Number of trees:                  500 
Sample size:                      32 
Number of independent variables:  10 
Mtry:                             5 
Target node size:                 10 
Variable importance mode:         none 
Splitrule:                        variance 
OOB prediction error (MSE):       5.974535 
R squared (OOB):                  0.8355215 </code></pre>
</div>
</div>
<p>Notice that this is exactly what you would get if you use <code>ranger()</code> to train your model.</p>
<p>The <code>train()</code> function has the <code>row_ids()</code> option, where you can specify which rows of the data backend in the task are used for training.</p>
<p>Let’s split extract the <code>row_ids</code> attribute and then split it for train and test purposes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== extract row ids ===#</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>row_ids <span class="ot">&lt;-</span> reg_task<span class="sc">$</span>row_ids</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== train ===#</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>train_ids <span class="ot">&lt;-</span> row_ids[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(row_ids) <span class="sc">/</span> <span class="dv">2</span>)]</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="co">#=== test ===#</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>test_ids <span class="ot">&lt;-</span> row_ids[<span class="sc">!</span>(row_ids <span class="sc">%in%</span> train_ids)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>He, we are doing the split manually. But, you should use resampling methods, which we will look at later.</p>
</div>
</div>
<p>Now train using the train data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== train ===#</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span><span class="fu">train</span>(reg_task, <span class="at">row_ids =</span> train_ids)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== seed the trained model ===#</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Ranger result

Call:
 ranger::ranger(dependent.variable.name = task$target_names, data = task$data(),      case.weights = task$weights$weight, min.node.size = 10L,      mtry = 5L, num.trees = 500L) 

Type:                             Regression 
Number of trees:                  500 
Sample size:                      16 
Number of independent variables:  10 
Mtry:                             5 
Target node size:                 10 
Variable importance mode:         none 
Splitrule:                        variance 
OOB prediction error (MSE):       5.488785 
R squared (OOB):                  0.6809341 </code></pre>
</div>
</div>
</section>
<section id="prediction" class="level3" data-number="18.3.2">
<h3 data-number="18.3.2" class="anchored" data-anchor-id="prediction"><span class="header-section-number">18.3.2</span> Prediction</h3>
<p>We can use the <code>predict()</code> method to make predictions by supplying a task to it. Just like the <code>train()</code> method, we can use the <code>row_ids</code> option inside <code>predict_newdata()</code> to apply prediction only on a portion of the data. Let’s use <code>test_ids</code> we created above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>prediction <span class="ot">&lt;-</span> learner<span class="sc">$</span><span class="fu">predict</span>(reg_task, <span class="at">row_ids =</span> test_ids)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>prediction</code> is of a class called <code>Prediction</code>. You can make the prediction available as a <code>data.table</code> by using <code>as.data.table()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(prediction)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    row_ids truth response
 1:      17  14.7 13.76909
 2:      18  32.4 21.70952
 3:      19  30.4 21.69724
 4:      20  33.9 21.70952
 5:      21  21.5 21.56469
 6:      22  15.5 16.50304
 7:      23  15.2 17.73533
 8:      24  13.3 14.75347
 9:      25  19.2 16.18023
10:      26  27.3 21.69724
11:      27  26.0 21.62519
12:      28  30.4 21.51458
13:      29  15.8 17.18676
14:      30  19.7 20.75792
15:      31  15.0 15.36191
16:      32  21.4 21.56894</code></pre>
</div>
</div>
<p>You can predict on a new dataset by supplying a new dataset as a <code>data.frame</code>/<code>data.table</code> to the <code>predict_newdata()</code> method. Here, we just use parts of <code>mtcars</code> (just pretend this is a newdataset).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>prediction <span class="ot">&lt;-</span> learner<span class="sc">$</span><span class="fu">predict_newdata</span>(mtcars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="performance-assessment" class="level3" data-number="18.3.3">
<h3 data-number="18.3.3" class="anchored" data-anchor-id="performance-assessment"><span class="header-section-number">18.3.3</span> Performance assessment</h3>
<p>There are many measure of performance we can use under <code>mlr3</code>. Here is the list:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>mlr_measures</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;DictionaryMeasure&gt; with 63 stored values
Keys: aic, bic, classif.acc, classif.auc, classif.bacc, classif.bbrier,
  classif.ce, classif.costs, classif.dor, classif.fbeta, classif.fdr,
  classif.fn, classif.fnr, classif.fomr, classif.fp, classif.fpr,
  classif.logloss, classif.mbrier, classif.mcc, classif.npv,
  classif.ppv, classif.prauc, classif.precision, classif.recall,
  classif.sensitivity, classif.specificity, classif.tn, classif.tnr,
  classif.tp, classif.tpr, clust.ch, clust.db, clust.dunn,
  clust.silhouette, clust.wss, debug, oob_error, regr.bias, regr.ktau,
  regr.mae, regr.mape, regr.maxae, regr.medae, regr.medse, regr.mse,
  regr.msle, regr.pbias, regr.rae, regr.rmse, regr.rmsle, regr.rrse,
  regr.rse, regr.rsq, regr.sae, regr.smape, regr.srho, regr.sse,
  selected_features, sim.jaccard, sim.phi, time_both, time_predict,
  time_train</code></pre>
</div>
</div>
<p>We can access a measure using the <code>msr()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== get a measure ===#</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>measure <span class="ot">&lt;-</span> <span class="fu">msr</span>(<span class="st">"regr.mse"</span>)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== check the class ===#</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(measure)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "MeasureRegrSimple" "MeasureRegr"       "Measure"          
[4] "R6"               </code></pre>
</div>
</div>
<p>We can do performance evaluation using the <code>$score()</code> method on a <code>Prediction</code> object by supplying a <code>Measure</code> object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">score</span>(measure)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>regr.mse 
16.50768 </code></pre>
</div>
</div>
</section>
</section>
<section id="resampling-cross-validation-and-cross-fitting" class="level2" data-number="18.4">
<h2 data-number="18.4" class="anchored" data-anchor-id="resampling-cross-validation-and-cross-fitting"><span class="header-section-number">18.4</span> Resampling, cross-validation, and cross-fitting</h2>
<section id="resampling" class="level3" data-number="18.4.1">
<h3 data-number="18.4.1" class="anchored" data-anchor-id="resampling"><span class="header-section-number">18.4.1</span> Resampling</h3>
<p><code>mlr3</code> offers the following resampling methods:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(mlr_resamplings)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           key                         label        params iters
1:   bootstrap                     Bootstrap ratio,repeats    30
2:      custom                 Custom Splits                  NA
3:   custom_cv Custom Split Cross-Validation                  NA
4:          cv              Cross-Validation         folds    10
5:     holdout                       Holdout         ratio     1
6:    insample           Insample Resampling                   1
7:         loo                 Leave-One-Out                  NA
8: repeated_cv     Repeated Cross-Validation folds,repeats   100
9: subsampling                   Subsampling ratio,repeats    30</code></pre>
</div>
</div>
<p>You can access a resampling method using the <code>rsmp()</code> function. You can specify parameters at the same time.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>resampling <span class="ot">&lt;-</span> <span class="fu">rsmp</span>(<span class="st">"repeated_cv"</span>, <span class="at">repeats =</span> <span class="dv">2</span>, <span class="at">folds =</span> <span class="dv">3</span>)</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ResamplingRepeatedCV&gt;: Repeated Cross-Validation
* Iterations: 6
* Instantiated: FALSE
* Parameters: repeats=2, folds=3</code></pre>
</div>
</div>
<p>You can check the number of iterations (number of train-test datasets combinations) by accessing the <code>iters</code> attribute.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>resampling<span class="sc">$</span>iters</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6</code></pre>
</div>
</div>
<p>You can override parameters just like you did for a leaner.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== update ===#</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>resampling<span class="sc">$</span>param_set<span class="sc">$</span>values <span class="ot">=</span> <span class="fu">list</span>(<span class="at">repeats =</span> <span class="dv">3</span>, <span class="at">folds =</span> <span class="dv">4</span>)</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== see the updates ===#</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>resampling</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ResamplingRepeatedCV&gt;: Repeated Cross-Validation
* Iterations: 12
* Instantiated: FALSE
* Parameters: repeats=3, folds=4</code></pre>
</div>
</div>
<p>We can use the <code>instantiate()</code> method to implement the specified resampling method:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>resampling<span class="sc">$</span><span class="fu">instantiate</span>(reg_task)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can access the train and test datasets using the <code>train_set()</code> and <code>test_set()</code> method. respectively. Since <code>repeats = 3</code> and <code>folds = 4</code>, we have 12 sets of train and test datasets. You indicate which set you want inside <code>train_set()</code> and <code>test_set()</code>.</p>
<p>First pair:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>resampling<span class="sc">$</span><span class="fu">train_set</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  1  8 10 11 21 22 29 30  2  4  5  6  9 14 16 25 13 18 19 23 24 28 31 32</code></pre>
</div>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>resampling<span class="sc">$</span><span class="fu">test_set</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  3  7 12 15 17 20 26 27</code></pre>
</div>
</div>
<p>Last pair:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>resampling<span class="sc">$</span><span class="fu">train_set</span>(<span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  7 10 11 19 21 22 30 32  3  5 12 13 15 18 23 24  2  4  6  9 14 16 17 31</code></pre>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>resampling<span class="sc">$</span><span class="fu">test_set</span>(<span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  1  8 20 25 26 27 28 29</code></pre>
</div>
</div>
</section>
<section id="cross-validation-and-cross-fitting" class="level3" data-number="18.4.2">
<h3 data-number="18.4.2" class="anchored" data-anchor-id="cross-validation-and-cross-fitting"><span class="header-section-number">18.4.2</span> Cross-validation and cross-fitting</h3>
<p>Now that data splits are determined (along with a task and leaner), we can conduct a cross-validation using the <code>resample()</code> function like below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>cv_results <span class="ot">&lt;-</span> <span class="fu">resample</span>(reg_task, learner, resampling)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>INFO  [13:50:06.767] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 9/12) 
INFO  [13:50:06.788] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 12/12) 
INFO  [13:50:06.801] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 7/12) 
INFO  [13:50:06.811] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 5/12) 
INFO  [13:50:06.820] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 10/12) 
INFO  [13:50:06.830] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 11/12) 
INFO  [13:50:06.839] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 3/12) 
INFO  [13:50:06.849] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 8/12) 
INFO  [13:50:06.858] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 4/12) 
INFO  [13:50:06.868] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 2/12) 
INFO  [13:50:06.877] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 1/12) 
INFO  [13:50:06.887] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 6/12) </code></pre>
</div>
</div>
<p>This code applies the method specified in <code>leaner</code> to each of the 12 train datasets, and evaluate the trained model on each of the 12 test datasets.</p>
<p>You can look at the prediction results using the <code>predictions()</code> method.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>cv_results<span class="sc">$</span><span class="fu">predictions</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
&lt;PredictionRegr&gt; for 8 observations:
    row_ids truth response
          3  22.8 25.39502
          7  14.3 15.39947
         12  16.4 16.02514
---                       
         20  33.9 28.74930
         26  27.3 28.74483
         27  26.0 24.39131

[[2]]
&lt;PredictionRegr&gt; for 8 observations:
    row_ids truth response
          1  21.0 21.41924
          8  24.4 23.27658
         10  19.2 19.68260
---                       
         22  15.5 16.67194
         29  15.8 17.70115
         30  19.7 20.37609

[[3]]
&lt;PredictionRegr&gt; for 8 observations:
    row_ids truth response
          2  21.0 20.76317
          4  21.4 19.63301
          5  18.7 15.47984
---                       
         14  15.2 15.77880
         16  10.4 13.82268
         25  19.2 15.39866

[[4]]
&lt;PredictionRegr&gt; for 8 observations:
    row_ids truth response
         13  17.3 15.60214
         18  32.4 26.53394
         19  30.4 27.30051
---                       
         28  30.4 24.33593
         31  15.0 15.18679
         32  21.4 22.89823

[[5]]
&lt;PredictionRegr&gt; for 8 observations:
    row_ids truth response
          1  21.0 21.31404
          3  22.8 25.77647
          5  18.7 16.31637
---                       
         11  17.8 20.68864
         19  30.4 28.26674
         28  30.4 25.76290

[[6]]
&lt;PredictionRegr&gt; for 8 observations:
    row_ids truth response
          4  21.4 19.48482
         13  17.3 15.49989
         17  14.7 13.02996
---                       
         27  26.0 26.24806
         29  15.8 16.88705
         32  21.4 24.17115

[[7]]
&lt;PredictionRegr&gt; for 8 observations:
    row_ids truth response
         10  19.2 18.84035
         12  16.4 15.86855
         16  10.4 13.73661
---                       
         24  13.3 15.45955
         25  19.2 15.95369
         30  19.7 20.40310

[[8]]
&lt;PredictionRegr&gt; for 8 observations:
    row_ids truth response
          2  21.0 20.45831
          8  24.4 22.54212
          9  22.8 21.69796
---                       
         23  15.2 17.88105
         26  27.3 29.80750
         31  15.0 14.98620

[[9]]
&lt;PredictionRegr&gt; for 8 observations:
    row_ids truth response
          7  14.3 15.05229
         10  19.2 20.43256
         11  17.8 20.46911
---                       
         22  15.5 16.70938
         30  19.7 21.31929
         32  21.4 24.54774

[[10]]
&lt;PredictionRegr&gt; for 8 observations:
    row_ids truth response
          3  22.8 24.86341
          5  18.7 16.61881
         12  16.4 15.86632
---                       
         18  32.4 28.24179
         23  15.2 16.65168
         24  13.3 15.38927

[[11]]
&lt;PredictionRegr&gt; for 8 observations:
    row_ids truth response
          2  21.0 20.73798
          4  21.4 19.29284
          6  18.1 19.07741
---                       
         16  10.4 14.16262
         17  14.7 14.41479
         31  15.0 15.15979

[[12]]
&lt;PredictionRegr&gt; for 8 observations:
    row_ids truth response
          1  21.0 21.04171
          8  24.4 23.06457
         20  33.9 27.33506
---                       
         27  26.0 23.78660
         28  30.4 24.38675
         29  15.8 17.11395</code></pre>
</div>
</div>
<p>You can get the all predictions combined using the <code>prediction()</code> method.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== all combined ===#</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>all_predictions <span class="ot">&lt;-</span> cv_results<span class="sc">$</span><span class="fu">prediction</span>()</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== check the class ===#</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(all_predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "PredictionRegr" "Prediction"     "R6"            </code></pre>
</div>
</div>
<p>Since it is a <code>Prediciton</code> object, we can apply the <code>score()</code> method like this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>all_predictions<span class="sc">$</span><span class="fu">score</span>(<span class="fu">msr</span>(<span class="st">"regr.mse"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>regr.mse 
6.842244 </code></pre>
</div>
</div>
<p>Of course, you are also cross-fitting when you are doing cross-validation. You can just take the prediction results and use them if you are implementing DML for example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>cross_fitted_yhat <span class="ot">&lt;-</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.table</span>(all_predictions) <span class="sc">%&gt;%</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>  .[, .(<span class="at">y_hat_cf =</span> <span class="fu">mean</span>(response)), <span class="at">by =</span> row_ids]</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    row_ids y_hat_cf
 1:       3 25.34497
 2:       7 15.10717
 3:      12 15.92000
 4:      15 14.48389
 5:      17 13.97880
 6:      20 27.59434
 7:      26 28.61634
 8:      27 24.80866
 9:       1 21.25833
10:       8 22.96109
11:      10 19.65184
12:      11 20.29878
13:      21 24.30397
14:      22 16.65521
15:      29 17.23405
16:      30 20.69949
17:       2 20.65315
18:       4 19.47022
19:       5 16.13834
20:       6 19.70304
21:       9 22.43349
22:      14 16.28460
23:      16 13.90730
24:      25 15.67836
25:      13 15.65128
26:      18 26.95828
27:      19 28.08307
28:      23 17.29707
29:      24 15.33268
30:      28 24.82853
31:      31 15.11093
32:      32 23.87237
    row_ids y_hat_cf</code></pre>
</div>
</div>
</section>
</section>
<section id="hyper-parameter-tuning" class="level2" data-number="18.5">
<h2 data-number="18.5" class="anchored" data-anchor-id="hyper-parameter-tuning"><span class="header-section-number">18.5</span> Hyper-parameter tuning</h2>
<p>In conducting hyper-parameter tuning under the <code>mlr3</code> framework, you define <code>TuningInstance*</code> class, select the tuning method, and then trigger it.</p>
<section id="tuninginstance" class="level3" data-number="18.5.1">
<h3 data-number="18.5.1" class="anchored" data-anchor-id="tuninginstance"><span class="header-section-number">18.5.1</span> TuningInstance</h3>
<p>There are two tuning instance classes.</p>
<ul>
<li>TuningInstanceSingleCrit</li>
<li>TuningInstanceMultiCrit</li>
</ul>
<p>The difference should be clear by looking at the name of the classes. We focus on the <code>TuningInstanceSingleCrit</code> class here.</p>
<p>Tuning instance consists of six elements:</p>
<ul>
<li><code>task</code></li>
<li><code>learner</code></li>
<li><code>resampling</code></li>
<li><code>measure</code></li>
<li><code>search_space</code></li>
<li><code>terminator</code></li>
</ul>
<p>We have covered all except <code>search_space</code> and <code>terminator</code>. Let’s look at these two.</p>
<p>Let’s quickly create the first four elements.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== task ===#</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>reg_task <span class="ot">&lt;-</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>  TaskRegr<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="st">"example"</span>,</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">backend =</span> mtcars,</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">target =</span> <span class="st">"mpg"</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a><span class="co">#=== learner ===#</span></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">&lt;-</span> <span class="fu">lrn</span>(<span class="st">"regr.ranger"</span>)</span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>max.depth <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a><span class="co">#=== resampling ===#</span></span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>resampling <span class="ot">&lt;-</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>) <span class="co"># k-fold cv</span></span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a><span class="co">#=== measure ===#</span></span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a>measure <span class="ot">&lt;-</span> <span class="fu">msr</span>(<span class="st">"regr.mse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>search_space</code> defines which hyper-parameters to tune and their ranges. You can use <code>ps()</code> to create a search space. Before doing so, let’s look at the parameters of the learner.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>param_set</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ParamSet&gt;
                              id    class lower upper nlevels        default
 1:                        alpha ParamDbl  -Inf   Inf     Inf            0.5
 2:       always.split.variables ParamUty    NA    NA     Inf &lt;NoDefault[3]&gt;
 3:                      holdout ParamLgl    NA    NA       2          FALSE
 4:                   importance ParamFct    NA    NA       4 &lt;NoDefault[3]&gt;
 5:                   keep.inbag ParamLgl    NA    NA       2          FALSE
 6:                    max.depth ParamInt     0   Inf     Inf               
 7:                min.node.size ParamInt     1   Inf     Inf              5
 8:                     min.prop ParamDbl  -Inf   Inf     Inf            0.1
 9:                      minprop ParamDbl  -Inf   Inf     Inf            0.1
10:                         mtry ParamInt     1   Inf     Inf &lt;NoDefault[3]&gt;
11:                   mtry.ratio ParamDbl     0     1     Inf &lt;NoDefault[3]&gt;
12:            num.random.splits ParamInt     1   Inf     Inf              1
13:                  num.threads ParamInt     1   Inf     Inf              1
14:                    num.trees ParamInt     1   Inf     Inf            500
15:                    oob.error ParamLgl    NA    NA       2           TRUE
16:                     quantreg ParamLgl    NA    NA       2          FALSE
17:        regularization.factor ParamUty    NA    NA     Inf              1
18:      regularization.usedepth ParamLgl    NA    NA       2          FALSE
19:                      replace ParamLgl    NA    NA       2           TRUE
20:    respect.unordered.factors ParamFct    NA    NA       3         ignore
21:              sample.fraction ParamDbl     0     1     Inf &lt;NoDefault[3]&gt;
22:                  save.memory ParamLgl    NA    NA       2          FALSE
23: scale.permutation.importance ParamLgl    NA    NA       2          FALSE
24:                    se.method ParamFct    NA    NA       2        infjack
25:                         seed ParamInt  -Inf   Inf     Inf               
26:         split.select.weights ParamUty    NA    NA     Inf               
27:                    splitrule ParamFct    NA    NA       3       variance
28:                      verbose ParamLgl    NA    NA       2           TRUE
29:                 write.forest ParamLgl    NA    NA       2           TRUE
                              id    class lower upper nlevels        default
       parents value
 1:  splitrule      
 2:                 
 3:                 
 4:                 
 5:                 
 6:               10
 7:                 
 8:                 
 9:  splitrule      
10:                 
11:                 
12:  splitrule      
13:                1
14:                 
15:                 
16:                 
17:                 
18:                 
19:                 
20:                 
21:                 
22:                 
23: importance      
24:                 
25:                 
26:                 
27:                 
28:                 
29:                 
       parents value</code></pre>
</div>
</div>
<p>Let’s tune three parameters here: <code>mtry.ratio</code>, <code>min.node.size</code>, and <code>num.trees</code>. For each parameter to tune, we need to use an appropriate function to define the range. You can see what functions to use from <code>class</code> variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>param_set <span class="sc">%&gt;%</span> </span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.table</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>  .[id <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"mtry.ratio"</span>, <span class="st">"min.node.size"</span>), .(id, class, lower, upper)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              id    class lower upper
1: min.node.size ParamInt     1   Inf
2:    mtry.ratio ParamDbl     0     1</code></pre>
</div>
</div>
<p>In this case, we use <code>p_int()</code> for “min.node.size” as its class is <code>ParamInt</code> and use <code>p_dbl()</code> for “mtry.ratio” as its class is <code>ParamDbl</code>. You cannot specify the range that go beyond the <code>lower</code> and <code>upper</code> for each parameter.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>search_space <span class="ot">&lt;-</span> </span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ps</span>(</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">mtry.ratio =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="fl">0.5</span>, <span class="at">upper =</span> <span class="fl">0.9</span>),</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">min.node.size =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> <span class="dv">1</span>, <span class="at">upper =</span> <span class="dv">20</span>)</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s define a <code>terminator</code> now. <code>mlr3</code> offers five different options. We will just look at the most common one here, which is <code>TerminatorEvals</code>. <code>TerminatorEvals</code> terminates tuning after a given number of iterations specified by the user (see <a href="https://mlr3book.mlr-org.com/04-optimization-tuning.html#tuning-optimization">here</a> for other terminator options).</p>
<p>You can use the <code>trm()</code> function to define a Terminator object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>terminator <span class="ot">&lt;-</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">100</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Inside <code>trm()</code>, “evals” indicates that we would like to use the <code>TerminatorEvals</code> option.</p>
<p>Now that we have all the components specified, we can instantiate (generate) a TuningInstanceSingleCrit class.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>tuning_instance <span class="ot">&lt;-</span> </span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>  TuningInstanceSingleCrit<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">task =</span> reg_task,</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">learner =</span> learner,</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">resampling =</span> resampling,</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">measure =</span> measure,</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">search_space =</span> search_space,</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">terminator =</span> terminator</span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TuningInstanceSingleCrit&gt;
* State:  Not optimized
* Objective: &lt;ObjectiveTuning:regr.ranger_on_example&gt;
* Search Space:
              id    class lower upper nlevels
1:    mtry.ratio ParamDbl   0.5   0.9     Inf
2: min.node.size ParamInt   1.0  20.0      20
* Terminator: &lt;TerminatorEvals&gt;</code></pre>
</div>
</div>
</section>
<section id="tuner" class="level3" data-number="18.5.2">
<h3 data-number="18.5.2" class="anchored" data-anchor-id="tuner"><span class="header-section-number">18.5.2</span> Tuner</h3>
<p>Let’s now define the method of tuning. <code>mlr3</code> offers four options:</p>
<ul>
<li>Grid Search (<code>TunerGridSearch</code>)</li>
<li>Random Search (<code>TunerRandomSearch</code>)</li>
<li>Generalized Simulated Annealing (<code>TunerGenSA</code>)</li>
<li>Non-Linear Optimization (<code>TunerNLoptr</code>)</li>
</ul>
<p>Here we use <code>TunerGridSearch</code>. We can set up a tuner using the <code>tnr()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>tuner <span class="ot">&lt;-</span> <span class="fu">tnr</span>(<span class="st">"grid_search"</span>, <span class="at">resolution =</span> <span class="dv">4</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>resolution = 4</code> means that each parameter takes four values where the values are equidistant between the upper and lower bounds specified in <code>search_space</code>. So, this tuning will look at <span class="math inline">\(4^2 = 16\)</span> parameter configurations. Notice that we set the number of evaluations to 100 above. So, all <span class="math inline">\(16\)</span> cases will be evaluated. However, if you set <code>n_evals</code> lower than <span class="math inline">\(16\)</span>, then the tuning will not look at all the cases.</p>
</section>
<section id="tuning" class="level3" data-number="18.5.3">
<h3 data-number="18.5.3" class="anchored" data-anchor-id="tuning"><span class="header-section-number">18.5.3</span> Tuning</h3>
<p>You can trigger tuning by supplying a tuning instance to the <code>optimizer()</code> method on <code>tuner</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>tuner<span class="sc">$</span><span class="fu">optimize</span>(tuning_instance)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Since the execution of this tuning prints so many lines of results, it is not presented here.</p>
<p>One the tuning is done, you can get the optimized parameters by accessing the <code>result_learner_param_values</code> attribute of the tuning instance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>tuning_instance<span class="sc">$</span>result_learner_param_vals</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$num.threads
[1] 1

$max.depth
[1] 10

$mtry.ratio
[1] 0.6333333

$min.node.size
[1] 1</code></pre>
</div>
</div>
<p>You can look at the evaluation results of other parameter configurations by accessing the <code>archive</code> attribute of the tuning instance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(tuning_instance<span class="sc">$</span>archive) <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   mtry.ratio min.node.size  regr.mse x_domain_mtry.ratio
1:  0.7666667            14  8.474011           0.7666667
2:  0.7666667            20 10.603670           0.7666667
3:  0.9000000            14  8.651439           0.9000000
4:  0.5000000            20 10.785482           0.5000000
5:  0.6333333            14  8.534432           0.6333333
6:  0.7666667             7  6.485146           0.7666667
   x_domain_min.node.size runtime_learners           timestamp batch_nr
1:                     14            0.023 2022-08-14 13:50:07        1
2:                     20            0.018 2022-08-14 13:50:07        2
3:                     14            0.021 2022-08-14 13:50:07        3
4:                     20            0.017 2022-08-14 13:50:07        4
5:                     14            0.020 2022-08-14 13:50:07        5
6:                      7            0.022 2022-08-14 13:50:07        6
   warnings errors      resample_result
1:        0      0 &lt;ResampleResult[22]&gt;
2:        0      0 &lt;ResampleResult[22]&gt;
3:        0      0 &lt;ResampleResult[22]&gt;
4:        0      0 &lt;ResampleResult[22]&gt;
5:        0      0 &lt;ResampleResult[22]&gt;
6:        0      0 &lt;ResampleResult[22]&gt;</code></pre>
</div>
</div>
</section>
<section id="autotuner" class="level3" data-number="18.5.4">
<h3 data-number="18.5.4" class="anchored" data-anchor-id="autotuner"><span class="header-section-number">18.5.4</span> AutoTuner</h3>
<p><code>AutoTuner</code> sounds like it is a tuner, but it is really learner where tuning is automatically implemented when training is triggered with a task. An <code>AutoTuner</code> class can be instantiated using the <code>new()</code> method on <code>AutoTuner</code> class like below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>auto_tunning_learner <span class="ot">&lt;-</span> </span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>  AutoTuner<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">learner =</span> learner,</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">resampling =</span> resampling,</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">measure =</span> measure,</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">search_space =</span> search_space,</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">terminator =</span> terminator,</span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">tuner =</span> tuner</span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;AutoTuner:regr.ranger.tuned&gt;
* Model: -
* Search Space:
&lt;ParamSet&gt;
              id    class lower upper nlevels        default value
1:    mtry.ratio ParamDbl   0.5   0.9     Inf &lt;NoDefault[3]&gt;      
2: min.node.size ParamInt   1.0  20.0      20 &lt;NoDefault[3]&gt;      
* Packages: mlr3, mlr3tuning, mlr3learners, ranger
* Predict Type: response
* Feature Types: logical, integer, numeric, character, factor, ordered
* Properties: hotstart_backward, importance, oob_error, weights</code></pre>
</div>
</div>
<p>Note that unlike TuningInstance, <code>AutoTuner</code> does not take a task as its element and takes a <code>Tuner</code> instead. Once an <code>AutoTuner</code> is instantiated, you can use it like a learner and invoke the <code>train()</code> method with a task to train a model. The difference from a regular leaner is that it automatically tune the parameters internally and use the optimized parameter values to train.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>auto_tunning_learner<span class="sc">$</span><span class="fu">train</span>(reg_task)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>INFO  [13:50:08.091] [bbotk] Starting to optimize 2 parameter(s) with '&lt;TunerGridSearch&gt;' and '&lt;TerminatorEvals&gt; [n_evals=100, k=0]' 
INFO  [13:50:08.092] [bbotk] Evaluating 1 configuration(s) 
INFO  [13:50:08.102] [mlr3] Running benchmark with 3 resampling iterations 
INFO  [13:50:08.104] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 2/3) 
INFO  [13:50:08.115] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 3/3) 
INFO  [13:50:08.126] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 1/3) 
INFO  [13:50:08.139] [mlr3] Finished benchmark 
INFO  [13:50:08.150] [bbotk] Result of batch 1: 
INFO  [13:50:08.151] [bbotk]  mtry.ratio min.node.size regr.mse warnings errors runtime_learners 
INFO  [13:50:08.151] [bbotk]   0.6333333             7 6.881547        0      0            0.023 
INFO  [13:50:08.151] [bbotk]                                 uhash 
INFO  [13:50:08.151] [bbotk]  0d0781c6-6cd0-4112-9146-959abb559ce1 
INFO  [13:50:08.151] [bbotk] Evaluating 1 configuration(s) 
INFO  [13:50:08.160] [mlr3] Running benchmark with 3 resampling iterations 
INFO  [13:50:08.163] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 2/3) 
INFO  [13:50:08.171] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 3/3) 
INFO  [13:50:08.180] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 1/3) 
INFO  [13:50:08.189] [mlr3] Finished benchmark 
INFO  [13:50:08.206] [bbotk] Result of batch 2: 
INFO  [13:50:08.206] [bbotk]  mtry.ratio min.node.size regr.mse warnings errors runtime_learners 
INFO  [13:50:08.206] [bbotk]         0.5            14 8.146189        0      0            0.016 
INFO  [13:50:08.206] [bbotk]                                 uhash 
INFO  [13:50:08.206] [bbotk]  74d0f355-a341-4bc5-97f0-3d522fb8fb73 
INFO  [13:50:08.207] [bbotk] Evaluating 1 configuration(s) 
INFO  [13:50:08.216] [mlr3] Running benchmark with 3 resampling iterations 
INFO  [13:50:08.218] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 3/3) 
INFO  [13:50:08.226] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 1/3) 
INFO  [13:50:08.235] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 2/3) 
INFO  [13:50:08.244] [mlr3] Finished benchmark 
INFO  [13:50:08.254] [bbotk] Result of batch 3: 
INFO  [13:50:08.255] [bbotk]  mtry.ratio min.node.size regr.mse warnings errors runtime_learners 
INFO  [13:50:08.255] [bbotk]         0.5            20 10.06284        0      0            0.015 
INFO  [13:50:08.255] [bbotk]                                 uhash 
INFO  [13:50:08.255] [bbotk]  a41ebccf-e6a5-42c1-984d-48bac53a4d5c 
INFO  [13:50:08.255] [bbotk] Evaluating 1 configuration(s) 
INFO  [13:50:08.264] [mlr3] Running benchmark with 3 resampling iterations 
INFO  [13:50:08.267] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 1/3) 
INFO  [13:50:08.276] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 3/3) 
INFO  [13:50:08.284] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 2/3) 
INFO  [13:50:08.299] [mlr3] Finished benchmark 
INFO  [13:50:08.311] [bbotk] Result of batch 4: 
INFO  [13:50:08.312] [bbotk]  mtry.ratio min.node.size regr.mse warnings errors runtime_learners 
INFO  [13:50:08.312] [bbotk]         0.9            20 10.73784        0      0            0.018 
INFO  [13:50:08.312] [bbotk]                                 uhash 
INFO  [13:50:08.312] [bbotk]  8fa39426-d8e4-420c-9f9a-ce8f2e01651e 
INFO  [13:50:08.312] [bbotk] Evaluating 1 configuration(s) 
INFO  [13:50:08.321] [mlr3] Running benchmark with 3 resampling iterations 
INFO  [13:50:08.324] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 3/3) 
INFO  [13:50:08.335] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 1/3) 
INFO  [13:50:08.345] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 2/3) 
INFO  [13:50:08.355] [mlr3] Finished benchmark 
INFO  [13:50:08.366] [bbotk] Result of batch 5: 
INFO  [13:50:08.367] [bbotk]  mtry.ratio min.node.size regr.mse warnings errors runtime_learners 
INFO  [13:50:08.367] [bbotk]         0.9             7 6.976098        0      0            0.022 
INFO  [13:50:08.367] [bbotk]                                 uhash 
INFO  [13:50:08.367] [bbotk]  c37cd7b2-edb3-4e4e-aa9a-dbfd5c030e59 
INFO  [13:50:08.367] [bbotk] Evaluating 1 configuration(s) 
INFO  [13:50:08.376] [mlr3] Running benchmark with 3 resampling iterations 
INFO  [13:50:08.379] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 1/3) 
INFO  [13:50:08.387] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 2/3) 
INFO  [13:50:08.401] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 3/3) 
INFO  [13:50:08.411] [mlr3] Finished benchmark 
INFO  [13:50:08.422] [bbotk] Result of batch 6: 
INFO  [13:50:08.422] [bbotk]  mtry.ratio min.node.size regr.mse warnings errors runtime_learners 
INFO  [13:50:08.422] [bbotk]   0.7666667            14 7.986156        0      0            0.018 
INFO  [13:50:08.422] [bbotk]                                 uhash 
INFO  [13:50:08.422] [bbotk]  79f4598d-7f8f-43f0-a52e-742fcd041e21 
INFO  [13:50:08.423] [bbotk] Evaluating 1 configuration(s) 
INFO  [13:50:08.432] [mlr3] Running benchmark with 3 resampling iterations 
INFO  [13:50:08.434] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 1/3) 
INFO  [13:50:08.442] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 2/3) 
INFO  [13:50:08.451] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 3/3) 
INFO  [13:50:08.459] [mlr3] Finished benchmark 
INFO  [13:50:08.470] [bbotk] Result of batch 7: 
INFO  [13:50:08.471] [bbotk]  mtry.ratio min.node.size regr.mse warnings errors runtime_learners 
INFO  [13:50:08.471] [bbotk]   0.6333333            20   10.489        0      0            0.017 
INFO  [13:50:08.471] [bbotk]                                 uhash 
INFO  [13:50:08.471] [bbotk]  d293c8ce-e448-4b1b-841a-b0b9d75f290e 
INFO  [13:50:08.471] [bbotk] Evaluating 1 configuration(s) 
INFO  [13:50:08.480] [mlr3] Running benchmark with 3 resampling iterations 
INFO  [13:50:08.482] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 1/3) 
INFO  [13:50:08.502] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 2/3) 
INFO  [13:50:08.515] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 3/3) 
INFO  [13:50:08.528] [mlr3] Finished benchmark 
INFO  [13:50:08.539] [bbotk] Result of batch 8: 
INFO  [13:50:08.540] [bbotk]  mtry.ratio min.node.size regr.mse warnings errors runtime_learners 
INFO  [13:50:08.540] [bbotk]         0.5             1 6.445074        0      0            0.029 
INFO  [13:50:08.540] [bbotk]                                 uhash 
INFO  [13:50:08.540] [bbotk]  441a0277-95aa-4703-86bf-5c5c6f454448 
INFO  [13:50:08.540] [bbotk] Evaluating 1 configuration(s) 
INFO  [13:50:08.549] [mlr3] Running benchmark with 3 resampling iterations 
INFO  [13:50:08.552] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 2/3) 
INFO  [13:50:08.565] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 1/3) 
INFO  [13:50:08.579] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 3/3) 
INFO  [13:50:08.594] [mlr3] Finished benchmark 
INFO  [13:50:08.604] [bbotk] Result of batch 9: 
INFO  [13:50:08.605] [bbotk]  mtry.ratio min.node.size regr.mse warnings errors runtime_learners 
INFO  [13:50:08.605] [bbotk]         0.9             1 6.529823        0      0            0.033 
INFO  [13:50:08.605] [bbotk]                                 uhash 
INFO  [13:50:08.605] [bbotk]  6b372fac-bf83-4338-b969-9c57df8f2aa5 
INFO  [13:50:08.606] [bbotk] Evaluating 1 configuration(s) 
INFO  [13:50:08.619] [mlr3] Running benchmark with 3 resampling iterations 
INFO  [13:50:08.622] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 2/3) 
INFO  [13:50:08.633] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 1/3) 
INFO  [13:50:08.645] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 3/3) 
INFO  [13:50:08.657] [mlr3] Finished benchmark 
INFO  [13:50:08.668] [bbotk] Result of batch 10: 
INFO  [13:50:08.669] [bbotk]  mtry.ratio min.node.size regr.mse warnings errors runtime_learners 
INFO  [13:50:08.669] [bbotk]   0.7666667             7 6.735557        0      0            0.023 
INFO  [13:50:08.669] [bbotk]                                 uhash 
INFO  [13:50:08.669] [bbotk]  07ad7b65-6a03-4009-8b0a-3f3f4add0da3 
INFO  [13:50:08.669] [bbotk] Evaluating 1 configuration(s) 
INFO  [13:50:08.679] [mlr3] Running benchmark with 3 resampling iterations 
INFO  [13:50:08.682] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 1/3) 
INFO  [13:50:08.692] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 3/3) 
INFO  [13:50:08.702] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 2/3) 
INFO  [13:50:08.711] [mlr3] Finished benchmark 
INFO  [13:50:08.723] [bbotk] Result of batch 11: 
INFO  [13:50:08.723] [bbotk]  mtry.ratio min.node.size regr.mse warnings errors runtime_learners 
INFO  [13:50:08.723] [bbotk]         0.9            14 8.404492        0      0            0.018 
INFO  [13:50:08.723] [bbotk]                                 uhash 
INFO  [13:50:08.723] [bbotk]  7fd9083f-4231-46de-97cf-fffbb15ae945 
INFO  [13:50:08.724] [bbotk] Evaluating 1 configuration(s) 
INFO  [13:50:08.741] [mlr3] Running benchmark with 3 resampling iterations 
INFO  [13:50:08.744] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 2/3) 
INFO  [13:50:08.758] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 3/3) 
INFO  [13:50:08.772] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 1/3) 
INFO  [13:50:08.786] [mlr3] Finished benchmark 
INFO  [13:50:08.798] [bbotk] Result of batch 12: 
INFO  [13:50:08.799] [bbotk]  mtry.ratio min.node.size regr.mse warnings errors runtime_learners 
INFO  [13:50:08.799] [bbotk]   0.6333333             1  6.49944        0      0             0.03 
INFO  [13:50:08.799] [bbotk]                                 uhash 
INFO  [13:50:08.799] [bbotk]  675cebf9-d4c7-4f71-aaea-1b372a16062c 
INFO  [13:50:08.799] [bbotk] Evaluating 1 configuration(s) 
INFO  [13:50:08.808] [mlr3] Running benchmark with 3 resampling iterations 
INFO  [13:50:08.811] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 3/3) 
INFO  [13:50:08.820] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 2/3) 
INFO  [13:50:08.829] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 1/3) 
INFO  [13:50:08.839] [mlr3] Finished benchmark 
INFO  [13:50:08.850] [bbotk] Result of batch 13: 
INFO  [13:50:08.851] [bbotk]  mtry.ratio min.node.size regr.mse warnings errors runtime_learners 
INFO  [13:50:08.851] [bbotk]   0.7666667            20 10.31122        0      0            0.016 
INFO  [13:50:08.851] [bbotk]                                 uhash 
INFO  [13:50:08.851] [bbotk]  9a97308e-5329-4190-adbc-24544d4c2456 
INFO  [13:50:08.852] [bbotk] Evaluating 1 configuration(s) 
INFO  [13:50:08.870] [mlr3] Running benchmark with 3 resampling iterations 
INFO  [13:50:08.872] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 2/3) 
INFO  [13:50:08.883] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 1/3) 
INFO  [13:50:08.891] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 3/3) 
INFO  [13:50:08.902] [mlr3] Finished benchmark 
INFO  [13:50:08.913] [bbotk] Result of batch 14: 
INFO  [13:50:08.913] [bbotk]  mtry.ratio min.node.size regr.mse warnings errors runtime_learners 
INFO  [13:50:08.913] [bbotk]   0.6333333            14 8.388858        0      0            0.018 
INFO  [13:50:08.913] [bbotk]                                 uhash 
INFO  [13:50:08.913] [bbotk]  44331072-6217-44f9-8e9a-e48b7d4f2875 
INFO  [13:50:08.914] [bbotk] Evaluating 1 configuration(s) 
INFO  [13:50:08.923] [mlr3] Running benchmark with 3 resampling iterations 
INFO  [13:50:08.926] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 1/3) 
INFO  [13:50:08.940] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 2/3) 
INFO  [13:50:08.953] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 3/3) 
INFO  [13:50:08.968] [mlr3] Finished benchmark 
INFO  [13:50:08.984] [bbotk] Result of batch 15: 
INFO  [13:50:08.985] [bbotk]  mtry.ratio min.node.size regr.mse warnings errors runtime_learners 
INFO  [13:50:08.985] [bbotk]   0.7666667             1 6.647228        0      0            0.033 
INFO  [13:50:08.985] [bbotk]                                 uhash 
INFO  [13:50:08.985] [bbotk]  98d8b35f-b566-44de-ad3f-55f224796284 
INFO  [13:50:08.985] [bbotk] Evaluating 1 configuration(s) 
INFO  [13:50:08.995] [mlr3] Running benchmark with 3 resampling iterations 
INFO  [13:50:08.998] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 1/3) 
INFO  [13:50:09.007] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 2/3) 
INFO  [13:50:09.017] [mlr3] Applying learner 'regr.ranger' on task 'example' (iter 3/3) 
INFO  [13:50:09.027] [mlr3] Finished benchmark 
INFO  [13:50:09.038] [bbotk] Result of batch 16: 
INFO  [13:50:09.039] [bbotk]  mtry.ratio min.node.size regr.mse warnings errors runtime_learners 
INFO  [13:50:09.039] [bbotk]         0.5             7 6.776204        0      0            0.019 
INFO  [13:50:09.039] [bbotk]                                 uhash 
INFO  [13:50:09.039] [bbotk]  c73968b7-0727-48c2-bb69-0531d8b4ec38 
INFO  [13:50:09.041] [bbotk] Finished optimizing after 16 evaluation(s) 
INFO  [13:50:09.041] [bbotk] Result: 
INFO  [13:50:09.041] [bbotk]  mtry.ratio min.node.size learner_param_vals  x_domain regr.mse 
INFO  [13:50:09.041] [bbotk]         0.5             1          &lt;list[4]&gt; &lt;list[2]&gt; 6.445074 </code></pre>
</div>
</div>
<p>You can access the optimized learner by accessing the <code>model$learner</code> attribute.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>auto_tunning_learner<span class="sc">$</span>model<span class="sc">$</span>learner</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;LearnerRegrRanger:regr.ranger&gt;
* Model: ranger
* Parameters: num.threads=1, max.depth=10, mtry.ratio=0.5,
  min.node.size=1
* Packages: mlr3, mlr3learners, ranger
* Predict Type: response
* Feature types: logical, integer, numeric, character, factor, ordered
* Properties: hotstart_backward, importance, oob_error, weights</code></pre>
</div>
</div>
<p>You can look at the history of tuning process like below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>auto_tunning_learner<span class="sc">$</span>model<span class="sc">$</span>tuning_instance</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TuningInstanceSingleCrit&gt;
* State:  Optimized
* Objective: &lt;ObjectiveTuning:regr.ranger_on_example&gt;
* Search Space:
              id    class lower upper nlevels
1:    mtry.ratio ParamDbl   0.5   0.9     Inf
2: min.node.size ParamInt   1.0  20.0      20
* Terminator: &lt;TerminatorEvals&gt;
* Result:
   mtry.ratio min.node.size regr.mse
1:        0.5             1 6.445074
* Archive:
    mtry.ratio min.node.size  regr.mse
 1:  0.6333333             7  6.881547
 2:  0.5000000            14  8.146189
 3:  0.5000000            20 10.062836
 4:  0.9000000            20 10.737842
 5:  0.9000000             7  6.976098
 6:  0.7666667            14  7.986156
 7:  0.6333333            20 10.489003
 8:  0.5000000             1  6.445074
 9:  0.9000000             1  6.529823
10:  0.7666667             7  6.735557
11:  0.9000000            14  8.404492
12:  0.6333333             1  6.499440
13:  0.7666667            20 10.311222
14:  0.6333333            14  8.388858
15:  0.7666667             1  6.647228
16:  0.5000000             7  6.776204</code></pre>
</div>
</div>
<p>You can of course use the <code>predict()</code> method as well.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>auto_tunning_learner<span class="sc">$</span><span class="fu">predict</span>(reg_task)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;PredictionRegr&gt; for 32 observations:
    row_ids truth response
          1  21.0 20.88403
          2  21.0 20.84543
          3  22.8 23.97760
---                       
         30  19.7 19.89333
         31  15.0 15.03820
         32  21.4 22.01467</code></pre>
</div>
</div>
</section>
</section>
<section id="sec-mlr3-in-action" class="level2 page-columns page-full" data-number="18.6">
<h2 data-number="18.6" class="anchored" data-anchor-id="sec-mlr3-in-action"><span class="header-section-number">18.6</span> <code>mlr3</code> in action</h2>
<p>Here, an example usage of the <code>mlr3</code> framework as a part of a research process is presented. Suppose our goal is to estimate the heterogeneous treatment effect using causal forest using the R <code>grf</code> package. The <code>grf::causal_forest()</code> function implements causal forest as an R-learner and it uses random forest for its first-stage estimations by default. However, the function allows the users to provide their own estimated values of <span class="math inline">\(y\)</span> (dependent variable) and <span class="math inline">\(T\)</span> (treatment). We will code the process of conducting the first stage using <code>mlr3</code> and then use <code>grf::causal_forest()</code> to estimate heterogeneous treatment effects.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== load the Treatment dataset ===#</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"Treatment"</span>, <span class="at">package =</span> <span class="st">"Ecdat"</span>)</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== convert to a data.table ===#</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> </span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(Treatment)</span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      treat age educ     ethn married    re74    re75     re78   u74   u75
   1:  TRUE  37   11    black    TRUE     0.0     0.0  9930.05  TRUE  TRUE
   2:  TRUE  30   12    black   FALSE     0.0     0.0 24909.50  TRUE  TRUE
   3:  TRUE  27   11    black   FALSE     0.0     0.0  7506.15  TRUE  TRUE
   4:  TRUE  33    8    black   FALSE     0.0     0.0   289.79  TRUE  TRUE
   5:  TRUE  22    9    black   FALSE     0.0     0.0  4056.49  TRUE  TRUE
  ---                                                                     
2671: FALSE  47    8    other    TRUE 44667.4 33837.1 38568.70 FALSE FALSE
2672: FALSE  32    8    other    TRUE 47022.4 67137.1 59109.10 FALSE FALSE
2673: FALSE  47   10    other    TRUE 48198.0 47968.1 55710.30 FALSE FALSE
2674: FALSE  54    0 hispanic    TRUE 49228.5 44221.0 20540.40 FALSE FALSE
2675: FALSE  40    8    other    TRUE 50940.9 55500.0 53198.20 FALSE FALSE</code></pre>
</div>
</div>
<p>The dependent variable is <code>re78</code> (<span class="math inline">\(Y\)</span>), which is real annual earnings in 1978 (after treatment). The treatment variable of interest is <code>treat</code> (<span class="math inline">\(T\)</span>), which is <code>TRUE</code> if a person had gone through a training, <code>FALSE</code> otherwise. The features that are included as potential drivers of the heterogeneity in the impact of <code>treat</code> on <code>re78</code> is <code>age</code>, <code>educ</code>, <code>ethn</code>, and <code>married</code> (<span class="math inline">\(X\)</span>). Note that the focus of this section is just showcasing the use of <code>mlr3</code> and no attention is paid to potential endogeneity problems.</p>
<section id="first-stage" class="level3 page-columns page-full" data-number="18.6.1">
<h3 data-number="18.6.1" class="anchored" data-anchor-id="first-stage"><span class="header-section-number">18.6.1</span> First stage</h3>
<p>We will use <code>ranger()</code> and <code>xgboost()</code> as learners. While <code>ranger()</code> accepts factor variables, <code>xgboost()</code> does not. So, we will one-hot-encode the data using <code>mltools::one_hot()</code> so that we can just create a single <code>Task</code> and use it for both. We also turn <code>treat</code> to a factor so it is amenable with classification jobs by the two learner functions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>data_trt <span class="ot">&lt;-</span> </span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>  mltools<span class="sc">::</span><span class="fu">one_hot</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>  .[, <span class="at">treat :=</span> <span class="fu">factor</span>(treat)]</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that we need separate procedures for estimating <span class="math inline">\(E[Y|X]\)</span> and <span class="math inline">\(E[T|X]\)</span>. The former is a regression and the latter is a classification task.</p>
<p>Let’s first work on estimating <span class="math inline">\(E[Y|X]\)</span>. First, we set up a task.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>y_est_task <span class="ot">&lt;-</span> </span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>  TaskRegr<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="st">"estimate_y_on_x"</span>,</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">backend =</span> data_trt[, .(</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>      re78, age, educ, married, </span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>      ethn_other, ethn_black, ethn_hispanic </span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>    )],</span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">target =</span> <span class="st">"re78"</span></span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We consider two modeling approaches: random forest by <code>ranger</code> and gradient boosted forest by <code>xgboost</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>y_learner_ranger <span class="ot">&lt;-</span> <span class="fu">lrn</span>(<span class="st">"regr.ranger"</span>)</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>y_learner_xgboost <span class="ot">&lt;-</span> <span class="fu">lrn</span>(<span class="st">"regr.xgboost"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will implement a K-fold cross-validation to select the better model with optimized hyper-parameter values. We do this by applying triggering <code>Tuner</code> classed defined separately for the two learners.</p>
<p>Let’s define the resampling method, measure, terminator, and tuner that will be shared by the two approaches.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>resampling_y <span class="ot">&lt;-</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">4</span>)</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>measure_y <span class="ot">&lt;-</span> <span class="fu">msr</span>(<span class="st">"regr.mse"</span>)</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>terminator <span class="ot">&lt;-</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">100</span>)</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>tuner <span class="ot">&lt;-</span> <span class="fu">tnr</span>(<span class="st">"grid_search"</span>, <span class="at">resolution =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, when we compare multiple models, we should use the same CV splits to have a fair comparison their model performance. To ensure this, we need to use an instantiated <code>Resampling</code> object.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>If you provide an un-instantiated <code>Resampling</code> object to an <code>AutoTuner</code>, it will instantiate the <code>Resampling</code> object internally and two separate <code>AutoTuner</code>s can result in two distinct splits.</p>
</div></div><div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== instantiate ===#</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>resampling_y<span class="sc">$</span><span class="fu">instantiate</span>(y_est_task)</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== confirm it is indeed instantiated ===#</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>resampling_y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ResamplingCV&gt;: Cross-Validation
* Iterations: 4
* Instantiated: TRUE
* Parameters: folds=4</code></pre>
</div>
</div>
<p>Let’s define search space for each of the learners.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>search_space_ranger <span class="ot">&lt;-</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ps</span>(</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">mtry =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> <span class="dv">1</span>, <span class="at">upper =</span> <span class="fu">length</span>(y_est_task<span class="sc">$</span>feature_names)),</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">min.node.size =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> <span class="dv">1</span>, <span class="at">upper =</span> <span class="dv">20</span>)</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>search_space_xgboost <span class="ot">&lt;-</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ps</span>(</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrounds =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> <span class="dv">100</span>, <span class="at">upper =</span> <span class="dv">400</span>),</span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">eta =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="fl">0.01</span>, <span class="at">upper =</span> <span class="dv">1</span>)</span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We have all the ingredients to set up <code>TuningInstance</code>s for the learners.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>tuning_instance_ranger <span class="ot">&lt;-</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>  TuningInstanceSingleCrit<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">task =</span> y_est_task,</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">learner =</span> y_learner_ranger,</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">resampling =</span> resampling_y,</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">measure =</span> measure_y,</span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">search_space =</span> search_space_ranger,</span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">terminator =</span> terminator</span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>tuning_instance_xgboost <span class="ot">&lt;-</span></span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>  TuningInstanceSingleCrit<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">task =</span> y_est_task,</span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">learner =</span> y_learner_xgboost,</span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">resampling =</span> resampling_y,</span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">measure =</span> measure_y,</span>
<span id="cb121-17"><a href="#cb121-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">search_space =</span> search_space_xgboost,</span>
<span id="cb121-18"><a href="#cb121-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">terminator =</span> terminator</span>
<span id="cb121-19"><a href="#cb121-19" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s tune them now (this can take a while).</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>We use using the same tuner here, but you can use different tuning processes for the learners. For example, you can have <code>resolution = 5</code> for tuning <code>regr.xgboost</code>.</p>
</div></div><div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== tune ranger ===#</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>tuner<span class="sc">$</span><span class="fu">optimize</span>(tuning_instance_ranger)</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== tune xgboost ===#</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>tuner<span class="sc">$</span><span class="fu">optimize</span>(tuning_instance_xgboost)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here are the MSEs from the two individually tuned learners.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>tuning_instance_ranger<span class="sc">$</span>result_y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> regr.mse 
193848265 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>tuning_instance_xgboost<span class="sc">$</span>result_y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> regr.mse 
198858370 </code></pre>
</div>
</div>
<p>So, in this example, we go with <code>regr.ranger</code> with its optimized hyper-parameter values. Let’s update our learner with the optimized hyper-parameter values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>y_learner_ranger<span class="sc">$</span>param_set<span class="sc">$</span>values <span class="ot">&lt;-</span> tuning_instance_ranger<span class="sc">$</span>result_learner_param_vals</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$num.threads
[1] 1

$mtry
[1] 2

$min.node.size
[1] 7</code></pre>
</div>
</div>
<p>Now that we have decided on the model to use for predicting <span class="math inline">\(E[y|X]\)</span>, let’s implement cross-fitting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>cv_results_y <span class="ot">&lt;-</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resample</span>(</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>    y_est_task, </span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>    y_learner_ranger, </span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rsmp</span>(<span class="st">"repeated_cv"</span>, <span class="at">repeats =</span> <span class="dv">4</span>, <span class="at">folds =</span> <span class="dv">3</span>) </span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>INFO  [13:50:36.524] [mlr3] Applying learner 'regr.ranger' on task 'estimate_y_on_x' (iter 9/12) 
INFO  [13:50:36.656] [mlr3] Applying learner 'regr.ranger' on task 'estimate_y_on_x' (iter 7/12) 
INFO  [13:50:36.786] [mlr3] Applying learner 'regr.ranger' on task 'estimate_y_on_x' (iter 4/12) 
INFO  [13:50:36.914] [mlr3] Applying learner 'regr.ranger' on task 'estimate_y_on_x' (iter 11/12) 
INFO  [13:50:37.043] [mlr3] Applying learner 'regr.ranger' on task 'estimate_y_on_x' (iter 6/12) 
INFO  [13:50:37.178] [mlr3] Applying learner 'regr.ranger' on task 'estimate_y_on_x' (iter 10/12) 
INFO  [13:50:37.313] [mlr3] Applying learner 'regr.ranger' on task 'estimate_y_on_x' (iter 5/12) 
INFO  [13:50:37.444] [mlr3] Applying learner 'regr.ranger' on task 'estimate_y_on_x' (iter 2/12) 
INFO  [13:50:37.573] [mlr3] Applying learner 'regr.ranger' on task 'estimate_y_on_x' (iter 1/12) 
INFO  [13:50:37.701] [mlr3] Applying learner 'regr.ranger' on task 'estimate_y_on_x' (iter 8/12) 
INFO  [13:50:37.829] [mlr3] Applying learner 'regr.ranger' on task 'estimate_y_on_x' (iter 3/12) 
INFO  [13:50:37.956] [mlr3] Applying learner 'regr.ranger' on task 'estimate_y_on_x' (iter 12/12) </code></pre>
</div>
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== all combined ===#</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>all_predictions_y <span class="ot">&lt;-</span> </span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>  cv_results_y<span class="sc">$</span><span class="fu">prediction</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.table</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>  .[, .(<span class="at">y_hat =</span> <span class="fu">mean</span>(response)), by <span class="ot">=</span> row_ids] <span class="sc">%&gt;%</span></span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>  .[<span class="fu">order</span>(row_ids), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We basically follow the same process for estimating <span class="math inline">\(E[T|X]\)</span>. Let’s set up tuning processes for the learners.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>t_est_task <span class="ot">&lt;-</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>  TaskClassif<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="st">"estimate_t_on_x"</span>,</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">backend =</span> </span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>      data_trt[, .(</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>        treat, age, educ, married, </span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>        ethn_other, ethn_black, ethn_hispanic </span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>      )],</span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">target =</span> <span class="st">"treat"</span></span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a>t_learner_ranger <span class="ot">&lt;-</span> <span class="fu">lrn</span>(<span class="st">"classif.ranger"</span>)</span>
<span id="cb132-13"><a href="#cb132-13" aria-hidden="true" tabindex="-1"></a>t_learner_xgboost <span class="ot">&lt;-</span> <span class="fu">lrn</span>(<span class="st">"classif.xgboost"</span>)</span>
<span id="cb132-14"><a href="#cb132-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-15"><a href="#cb132-15" aria-hidden="true" tabindex="-1"></a>resampling_t <span class="ot">&lt;-</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">4</span>)</span>
<span id="cb132-16"><a href="#cb132-16" aria-hidden="true" tabindex="-1"></a>resampling_y<span class="sc">$</span><span class="fu">instantiate</span>(t_est_task)</span>
<span id="cb132-17"><a href="#cb132-17" aria-hidden="true" tabindex="-1"></a>measure_t <span class="ot">&lt;-</span> <span class="fu">msr</span>(<span class="st">"classif.ce"</span>)</span>
<span id="cb132-18"><a href="#cb132-18" aria-hidden="true" tabindex="-1"></a>terminator <span class="ot">&lt;-</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">100</span>)</span>
<span id="cb132-19"><a href="#cb132-19" aria-hidden="true" tabindex="-1"></a>tuner <span class="ot">&lt;-</span> <span class="fu">tnr</span>(<span class="st">"grid_search"</span>, <span class="at">resolution =</span> <span class="dv">4</span>)</span>
<span id="cb132-20"><a href="#cb132-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-21"><a href="#cb132-21" aria-hidden="true" tabindex="-1"></a>tuning_instance_ranger <span class="ot">&lt;-</span></span>
<span id="cb132-22"><a href="#cb132-22" aria-hidden="true" tabindex="-1"></a>  TuningInstanceSingleCrit<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb132-23"><a href="#cb132-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">task =</span> t_est_task,</span>
<span id="cb132-24"><a href="#cb132-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">learner =</span> t_learner_ranger,</span>
<span id="cb132-25"><a href="#cb132-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">resampling =</span> resampling_y,</span>
<span id="cb132-26"><a href="#cb132-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">measure =</span> measure_t,</span>
<span id="cb132-27"><a href="#cb132-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">search_space =</span> search_space_ranger,</span>
<span id="cb132-28"><a href="#cb132-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">terminator =</span> terminator</span>
<span id="cb132-29"><a href="#cb132-29" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb132-30"><a href="#cb132-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-31"><a href="#cb132-31" aria-hidden="true" tabindex="-1"></a>tuning_instance_xgboost <span class="ot">&lt;-</span></span>
<span id="cb132-32"><a href="#cb132-32" aria-hidden="true" tabindex="-1"></a>  TuningInstanceSingleCrit<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb132-33"><a href="#cb132-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">task =</span> t_est_task,</span>
<span id="cb132-34"><a href="#cb132-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">learner =</span> t_learner_xgboost,</span>
<span id="cb132-35"><a href="#cb132-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">resampling =</span> resampling_y,</span>
<span id="cb132-36"><a href="#cb132-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">measure =</span> measure_t,</span>
<span id="cb132-37"><a href="#cb132-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">search_space =</span> search_space_xgboost,</span>
<span id="cb132-38"><a href="#cb132-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">terminator =</span> terminator</span>
<span id="cb132-39"><a href="#cb132-39" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here are the classification error from the two individually tuned learners.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== tune ranger ===#</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>tuner<span class="sc">$</span><span class="fu">optimize</span>(tuning_instance_ranger)</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>tuning_instance_ranger<span class="sc">$</span>result_y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== tune xgboost ===#</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>tuner<span class="sc">$</span><span class="fu">optimize</span>(tuning_instance_xgboost)</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>tuning_instance_xgboost<span class="sc">$</span>result_y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So, we are picking the <code>classif.ranger</code> option here as well as it has a lower classification error.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>t_learner_ranger<span class="sc">$</span>param_set<span class="sc">$</span>values <span class="ot">&lt;-</span> tuning_instance_ranger<span class="sc">$</span>result_learner_param_vals</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we have decided on the model to use for predicting <span class="math inline">\(E[T|X]\)</span>, let’s implement cross-fitting. Before cross-fitting, we need to tell <code>t_learner_ranger</code> to predict probability instead of classification (either 0 or 1).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>t_learner_ranger<span class="sc">$</span>predict_type <span class="ot">&lt;-</span> <span class="st">"prob"</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>cv_results_t <span class="ot">&lt;-</span></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resample</span>(</span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>    t_est_task, </span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>    t_learner_ranger, </span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rsmp</span>(<span class="st">"repeated_cv"</span>, <span class="at">repeats =</span> <span class="dv">4</span>, <span class="at">folds =</span> <span class="dv">3</span>) </span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>INFO  [13:50:57.700] [mlr3] Applying learner 'classif.ranger' on task 'estimate_t_on_x' (iter 6/12) 
INFO  [13:50:57.871] [mlr3] Applying learner 'classif.ranger' on task 'estimate_t_on_x' (iter 7/12) 
INFO  [13:50:58.041] [mlr3] Applying learner 'classif.ranger' on task 'estimate_t_on_x' (iter 8/12) 
INFO  [13:50:58.215] [mlr3] Applying learner 'classif.ranger' on task 'estimate_t_on_x' (iter 3/12) 
INFO  [13:50:58.396] [mlr3] Applying learner 'classif.ranger' on task 'estimate_t_on_x' (iter 9/12) 
INFO  [13:50:58.562] [mlr3] Applying learner 'classif.ranger' on task 'estimate_t_on_x' (iter 1/12) 
INFO  [13:50:58.725] [mlr3] Applying learner 'classif.ranger' on task 'estimate_t_on_x' (iter 12/12) 
INFO  [13:50:58.889] [mlr3] Applying learner 'classif.ranger' on task 'estimate_t_on_x' (iter 2/12) 
INFO  [13:50:59.054] [mlr3] Applying learner 'classif.ranger' on task 'estimate_t_on_x' (iter 10/12) 
INFO  [13:50:59.225] [mlr3] Applying learner 'classif.ranger' on task 'estimate_t_on_x' (iter 4/12) 
INFO  [13:50:59.389] [mlr3] Applying learner 'classif.ranger' on task 'estimate_t_on_x' (iter 5/12) 
INFO  [13:50:59.561] [mlr3] Applying learner 'classif.ranger' on task 'estimate_t_on_x' (iter 11/12) </code></pre>
</div>
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== all combined ===#</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>all_predictions_t <span class="ot">&lt;-</span> </span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>  cv_results_t<span class="sc">$</span><span class="fu">prediction</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.table</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>  .[, .(<span class="at">t_hat =</span> <span class="fu">mean</span>(prob.TRUE)), by <span class="ot">=</span> row_ids] <span class="sc">%&gt;%</span> </span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>  .[<span class="fu">order</span>(row_ids), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We now use <code>all_predictions_y</code> and <code>all_predictions_t</code> for <code>Y.hat</code> and <code>W.hat</code> in <code>grf::causal_forest()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>grf<span class="sc">::</span><span class="fu">causal_forest</span>(</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> data_trt[, .(age, educ, married, ethn_other, ethn_black, ethn_hispanic)] <span class="sc">%&gt;%</span> <span class="fu">as.matrix</span>(),</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> data_trt[, re78],</span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">W =</span> data_trt[, <span class="fu">fifelse</span>(treat <span class="sc">==</span> <span class="cn">TRUE</span>, <span class="dv">1</span>, <span class="dv">0</span>)],</span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y.hat =</span> all_predictions_y[, y_hat],</span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">W.hat =</span> all_predictions_t[, t_hat]</span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>GRF forest object of type causal_forest 
Number of trees: 2000 
Number of training samples: 2675 
Variable importance: 
    1     2     3     4     5     6 
0.491 0.295 0.124 0.021 0.057 0.012 </code></pre>
</div>
</div>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./E02-grf.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Generalized Random Forest</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./PROG-R-02-reticulate.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Running Python from R</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb141" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Machine Learning with `mlr3` {#sec-mlr3}</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>The <span class="in">`mlr3`</span> package is an R package that makes it easy for you to implement standard machine learning procedures (e.g., training, prediction, cross-validation) in a unified framework. It is similar to the Python scikit-learn package. In this section, we cover the basic use cases of the <span class="in">`mlr3`</span> package accompanied by an real-world example at the end. The authors of the package is currently writing a <span class="co">[</span><span class="ot">book</span><span class="co">](https://mlr3book.mlr-org.com/02-basics-learners.html)</span> on how to use it. Materials covered in this section is basically a condensed (and far less comprehensive) version of the book. Yet, they should still be sufficient for the majority of ML tasks you typically implement in practice.</span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>To start working with <span class="in">`mlr3`</span>, it is convenient to load the <span class="in">`mlr3verse`</span> package, which is a collection of packages that provide useful extensions (e.g., quick visualization (<span class="in">` mlr3viz`</span>), machine learning methods (<span class="in">`mlr3leaners`</span>), etc). It is like the <span class="in">`tidyverse`</span> package.</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>See <span class="co">[</span><span class="ot">here</span><span class="co">](https://github.com/mlr-org/mlr3verse)</span> for the list of included packages.</span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-13"><a href="#cb141-13" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-14"><a href="#cb141-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)</span>
<span id="cb141-15"><a href="#cb141-15" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-16"><a href="#cb141-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-17"><a href="#cb141-17" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb141-18"><a href="#cb141-18" aria-hidden="true" tabindex="-1"></a>An alternative ML utility package in R is the <span class="in">`tidymodels`</span> package. In this book, we do not cover how to use the package. Interested readers can read an excellent free on-line book <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.tmwr.org/)</span>.</span>
<span id="cb141-19"><a href="#cb141-19" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb141-20"><a href="#cb141-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-21"><a href="#cb141-21" aria-hidden="true" tabindex="-1"></a>For those who have been using solely R for their programming needs are not likely to be familiar with the way <span class="in">`mlr3`</span> works. It uses R6 classes provided the <span class="in">`R6`</span> package. The package provides an implementation of encapsulated object-oriented programing, which how Python works. So, if you are familiar with Python, then <span class="in">`mlr3`</span> should come quite natural to you. Fortunately, understanding how <span class="in">`R6`</span> works is not too hard (especially for us who are just using it). Reading the introduction of the <span class="in">`R6`</span> provided <span class="co">[</span><span class="ot">here</span><span class="co">](https://r6.r-lib.org/articles/Introduction.html)</span> should suffice. </span>
<span id="cb141-22"><a href="#cb141-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-23"><a href="#cb141-23" aria-hidden="true" tabindex="-1"></a>To implement ML tasks, we need two core components at least: task, and learner. Roughly speaking, here are what they are.</span>
<span id="cb141-24"><a href="#cb141-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-25"><a href="#cb141-25" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Task: data</span>
<span id="cb141-26"><a href="#cb141-26" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Learner: model</span>
<span id="cb141-27"><a href="#cb141-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-28"><a href="#cb141-28" aria-hidden="true" tabindex="-1"></a>We will take a deeper look at these two components first, and then training, prediction, and other ML tasks.</span>
<span id="cb141-29"><a href="#cb141-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-30"><a href="#cb141-30" aria-hidden="true" tabindex="-1"></a><span class="fu">## Tasks</span></span>
<span id="cb141-31"><a href="#cb141-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-32"><a href="#cb141-32" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb141-33"><a href="#cb141-33" aria-hidden="true" tabindex="-1"></a>**Packages to load for replication**</span>
<span id="cb141-34"><a href="#cb141-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-37"><a href="#cb141-37" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-38"><a href="#cb141-38" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb141-39"><a href="#cb141-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-40"><a href="#cb141-40" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb141-41"><a href="#cb141-41" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DoubleML)</span>
<span id="cb141-42"><a href="#cb141-42" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)</span>
<span id="cb141-43"><a href="#cb141-43" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb141-44"><a href="#cb141-44" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mltools)</span>
<span id="cb141-45"><a href="#cb141-45" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb141-46"><a href="#cb141-46" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-47"><a href="#cb141-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-50"><a href="#cb141-50" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-51"><a href="#cb141-51" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb141-52"><a href="#cb141-52" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb141-53"><a href="#cb141-53" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DoubleML)</span>
<span id="cb141-54"><a href="#cb141-54" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)</span>
<span id="cb141-55"><a href="#cb141-55" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb141-56"><a href="#cb141-56" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mltools)</span>
<span id="cb141-57"><a href="#cb141-57" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb141-58"><a href="#cb141-58" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-59"><a href="#cb141-59" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb141-60"><a href="#cb141-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-61"><a href="#cb141-61" aria-hidden="true" tabindex="-1"></a>A task in the <span class="in">`mlr3`</span> parlance is basically a dataset (called <span class="in">`backend`</span>) with information on which variable is the dependent variable (called <span class="in">`target`</span>) and which variables are explanatory variables (called <span class="in">`features`</span>). </span>
<span id="cb141-62"><a href="#cb141-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-63"><a href="#cb141-63" aria-hidden="true" tabindex="-1"></a>Here, we will use <span class="in">`mtcars`</span> data. </span>
<span id="cb141-64"><a href="#cb141-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-67"><a href="#cb141-67" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-68"><a href="#cb141-68" aria-hidden="true" tabindex="-1"></a><span class="co">#=== load mtcars ===#</span></span>
<span id="cb141-69"><a href="#cb141-69" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"mtcars"</span>, <span class="at">package =</span> <span class="st">"datasets"</span>)</span>
<span id="cb141-70"><a href="#cb141-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-71"><a href="#cb141-71" aria-hidden="true" tabindex="-1"></a><span class="co">#=== see the first 6 rows ===#</span></span>
<span id="cb141-72"><a href="#cb141-72" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mtcars)</span>
<span id="cb141-73"><a href="#cb141-73" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-74"><a href="#cb141-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-75"><a href="#cb141-75" aria-hidden="true" tabindex="-1"></a>When you create a task, you need to recognize what type of analysis you will be doing and use an appropriate class. Here, we will be running regression, so we use the <span class="in">`TaskRegr`</span> class (see <span class="co">[</span><span class="ot">here</span><span class="co">](https://mlr3book.mlr-org.com/02-basics-tasks.html#tasks-types)</span> for other task types). </span>
<span id="cb141-76"><a href="#cb141-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-77"><a href="#cb141-77" aria-hidden="true" tabindex="-1"></a>Now, let's create a task using the <span class="in">`TaskRegr`</span> class with </span>
<span id="cb141-78"><a href="#cb141-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-79"><a href="#cb141-79" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`mtcars`</span> as <span class="in">`backend`</span> (data)</span>
<span id="cb141-80"><a href="#cb141-80" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`mpg`</span> as <span class="in">`target`</span> (dependent variable)</span>
<span id="cb141-81"><a href="#cb141-81" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`example`</span> as <span class="in">`id`</span> (this is the id for the task, you can give any name)</span>
<span id="cb141-82"><a href="#cb141-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-83"><a href="#cb141-83" aria-hidden="true" tabindex="-1"></a>You can instantiate a new <span class="in">`TaskRegr`</span> instance using the <span class="in">`new()`</span> methods on the <span class="in">`TaskRegr`</span> class.</span>
<span id="cb141-84"><a href="#cb141-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-87"><a href="#cb141-87" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-88"><a href="#cb141-88" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb141-89"><a href="#cb141-89" aria-hidden="true" tabindex="-1"></a>reg_task <span class="ot">&lt;-</span></span>
<span id="cb141-90"><a href="#cb141-90" aria-hidden="true" tabindex="-1"></a>  TaskRegr<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb141-91"><a href="#cb141-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="st">"example"</span>,</span>
<span id="cb141-92"><a href="#cb141-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">backend =</span> mtcars,</span>
<span id="cb141-93"><a href="#cb141-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">target =</span> <span class="st">"mpg"</span></span>
<span id="cb141-94"><a href="#cb141-94" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb141-95"><a href="#cb141-95" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb141-96"><a href="#cb141-96" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-97"><a href="#cb141-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-98"><a href="#cb141-98" aria-hidden="true" tabindex="-1"></a>As you can see, <span class="in">`mpg`</span> is the <span class="in">`Target`</span> and the rest was automatically set to <span class="in">`Features`</span>.</span>
<span id="cb141-99"><a href="#cb141-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-100"><a href="#cb141-100" aria-hidden="true" tabindex="-1"></a>You can use the <span class="in">`cole_roles()`</span> method to return the roles of the variables.</span>
<span id="cb141-101"><a href="#cb141-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-104"><a href="#cb141-104" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-105"><a href="#cb141-105" aria-hidden="true" tabindex="-1"></a>reg_task<span class="sc">$</span>col_roles </span>
<span id="cb141-106"><a href="#cb141-106" aria-hidden="true" tabindex="-1"></a><span class="in">```</span> </span>
<span id="cb141-107"><a href="#cb141-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-108"><a href="#cb141-108" aria-hidden="true" tabindex="-1"></a>You can extract information from the task using various methods:</span>
<span id="cb141-109"><a href="#cb141-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-110"><a href="#cb141-110" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>$nrow: returns the number of rows</span>
<span id="cb141-111"><a href="#cb141-111" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>$ncol: returns the number of columns</span>
<span id="cb141-112"><a href="#cb141-112" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>$feature_names: returns the name of the feature variables</span>
<span id="cb141-113"><a href="#cb141-113" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>$target_names: returns the name of the target variable(s)</span>
<span id="cb141-114"><a href="#cb141-114" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>$row_ids: return row ids (integers starting from 1 to the number of rows)</span>
<span id="cb141-115"><a href="#cb141-115" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>$data(): returns the backend (data) as a <span class="in">`data.table`</span></span>
<span id="cb141-116"><a href="#cb141-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-117"><a href="#cb141-117" aria-hidden="true" tabindex="-1"></a>Let's see some of these.</span>
<span id="cb141-118"><a href="#cb141-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-121"><a href="#cb141-121" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-122"><a href="#cb141-122" aria-hidden="true" tabindex="-1"></a><span class="co">#=== row ids ===#</span></span>
<span id="cb141-123"><a href="#cb141-123" aria-hidden="true" tabindex="-1"></a>reg_task<span class="sc">$</span>row_ids</span>
<span id="cb141-124"><a href="#cb141-124" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-125"><a href="#cb141-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-128"><a href="#cb141-128" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-129"><a href="#cb141-129" aria-hidden="true" tabindex="-1"></a><span class="co">#=== data ===#</span></span>
<span id="cb141-130"><a href="#cb141-130" aria-hidden="true" tabindex="-1"></a>reg_task<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb141-131"><a href="#cb141-131" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-132"><a href="#cb141-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-133"><a href="#cb141-133" aria-hidden="true" tabindex="-1"></a>It is possible to retrieve only a portion of the data using <span class="in">`rows`</span> and <span class="in">`cols`</span> options inside <span class="in">`data()`</span> as follows:</span>
<span id="cb141-134"><a href="#cb141-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-137"><a href="#cb141-137" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-138"><a href="#cb141-138" aria-hidden="true" tabindex="-1"></a>reg_task<span class="sc">$</span><span class="fu">data</span>(<span class="at">rows =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"mpg"</span>, <span class="st">'wt'</span>))</span>
<span id="cb141-139"><a href="#cb141-139" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-140"><a href="#cb141-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-141"><a href="#cb141-141" aria-hidden="true" tabindex="-1"></a>To retrieve the complete data from the task, you can apply <span class="in">`as.data.table()`</span> to the task.</span>
<span id="cb141-142"><a href="#cb141-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-145"><a href="#cb141-145" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-146"><a href="#cb141-146" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb141-147"><a href="#cb141-147" aria-hidden="true" tabindex="-1"></a>data_extracted <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(reg_task)</span>
<span id="cb141-148"><a href="#cb141-148" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb141-149"><a href="#cb141-149" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-150"><a href="#cb141-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-151"><a href="#cb141-151" aria-hidden="true" tabindex="-1"></a>You can mutate tasks using the <span class="in">`select()`</span> and <span class="in">`filter()`</span> methods. It is important to remember here that the instance at which these mutations are implemented is indeed mutated. Let's see what I mean by this. </span>
<span id="cb141-152"><a href="#cb141-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-153"><a href="#cb141-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-156"><a href="#cb141-156" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-157"><a href="#cb141-157" aria-hidden="true" tabindex="-1"></a><span class="co">#=== first select few variables ===#</span></span>
<span id="cb141-158"><a href="#cb141-158" aria-hidden="true" tabindex="-1"></a>reg_task<span class="sc">$</span><span class="fu">select</span>(<span class="fu">c</span>(<span class="st">"am"</span>, <span class="st">"carb"</span>, <span class="st">"cyl"</span>))</span>
<span id="cb141-159"><a href="#cb141-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-160"><a href="#cb141-160" aria-hidden="true" tabindex="-1"></a><span class="co">#=== see the backend now ===#</span></span>
<span id="cb141-161"><a href="#cb141-161" aria-hidden="true" tabindex="-1"></a>reg_task<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb141-162"><a href="#cb141-162" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-163"><a href="#cb141-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-164"><a href="#cb141-164" aria-hidden="true" tabindex="-1"></a>As you can see, <span class="in">`reg_task`</span> now holds only the variables that were selected (plus the target variable <span class="in">`mpg`</span>). This behavior is similar to how <span class="in">`data.table`</span> works when you create a new variable using <span class="in">`data[, := ]`</span> syntax. And, this is different from how <span class="in">`dplyr::select`</span> works. </span>
<span id="cb141-165"><a href="#cb141-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-168"><a href="#cb141-168" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-169"><a href="#cb141-169" aria-hidden="true" tabindex="-1"></a><span class="co">#=== create a dataset ===#</span></span>
<span id="cb141-170"><a href="#cb141-170" aria-hidden="true" tabindex="-1"></a>data_temp <span class="ot">&lt;-</span> reg_task<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb141-171"><a href="#cb141-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-172"><a href="#cb141-172" aria-hidden="true" tabindex="-1"></a><span class="co">#=== select mpg, carb ===#</span></span>
<span id="cb141-173"><a href="#cb141-173" aria-hidden="true" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">select</span>(data_temp, mpg, carb)</span>
<span id="cb141-174"><a href="#cb141-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-175"><a href="#cb141-175" aria-hidden="true" tabindex="-1"></a><span class="co">#=== look at data_temp ===#</span></span>
<span id="cb141-176"><a href="#cb141-176" aria-hidden="true" tabindex="-1"></a>data_temp</span>
<span id="cb141-177"><a href="#cb141-177" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-178"><a href="#cb141-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-179"><a href="#cb141-179" aria-hidden="true" tabindex="-1"></a>As you can see, <span class="in">`data_temp`</span> is not mutated after <span class="in">`select()`</span>. To save the the result of <span class="in">`dplyr::select()`</span>, you need to explicitly assign it to another R object.</span>
<span id="cb141-180"><a href="#cb141-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-181"><a href="#cb141-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-182"><a href="#cb141-182" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb141-183"><a href="#cb141-183" aria-hidden="true" tabindex="-1"></a>The target variable cannot be selected in <span class="in">`select()`</span>. It is automatically selected.</span>
<span id="cb141-184"><a href="#cb141-184" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb141-185"><a href="#cb141-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-186"><a href="#cb141-186" aria-hidden="true" tabindex="-1"></a>If you would like to keep the original task, you can use the <span class="in">`clone()`</span> method to create a distinct instance.</span>
<span id="cb141-187"><a href="#cb141-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-190"><a href="#cb141-190" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-191"><a href="#cb141-191" aria-hidden="true" tabindex="-1"></a><span class="co">#=== create a clone ===#</span></span>
<span id="cb141-192"><a href="#cb141-192" aria-hidden="true" tabindex="-1"></a>reg_task_independent <span class="ot">&lt;-</span> reg_task<span class="sc">$</span><span class="fu">clone</span>()</span>
<span id="cb141-193"><a href="#cb141-193" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-194"><a href="#cb141-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-195"><a href="#cb141-195" aria-hidden="true" tabindex="-1"></a>Let's filter the data using the <span class="in">`filter()`</span> method.</span>
<span id="cb141-196"><a href="#cb141-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-199"><a href="#cb141-199" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-200"><a href="#cb141-200" aria-hidden="true" tabindex="-1"></a><span class="co">#=== filter ===#</span></span>
<span id="cb141-201"><a href="#cb141-201" aria-hidden="true" tabindex="-1"></a>reg_task<span class="sc">$</span><span class="fu">filter</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb141-202"><a href="#cb141-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-203"><a href="#cb141-203" aria-hidden="true" tabindex="-1"></a><span class="co">#=== see the backend ===#</span></span>
<span id="cb141-204"><a href="#cb141-204" aria-hidden="true" tabindex="-1"></a>reg_task<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb141-205"><a href="#cb141-205" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-206"><a href="#cb141-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-207"><a href="#cb141-207" aria-hidden="true" tabindex="-1"></a>However, <span class="in">`reg_task_independent`</span> is not affected.</span>
<span id="cb141-208"><a href="#cb141-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-211"><a href="#cb141-211" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-212"><a href="#cb141-212" aria-hidden="true" tabindex="-1"></a>reg_task_independent<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb141-213"><a href="#cb141-213" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-214"><a href="#cb141-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-215"><a href="#cb141-215" aria-hidden="true" tabindex="-1"></a>You can use the <span class="in">`rbind()`</span> and <span class="in">`cbind()`</span> methods to append data vertically and horizontally, respectively. </span>
<span id="cb141-216"><a href="#cb141-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-217"><a href="#cb141-217" aria-hidden="true" tabindex="-1"></a>Here is an example use of <span class="in">`rbind()`</span>.</span>
<span id="cb141-218"><a href="#cb141-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-221"><a href="#cb141-221" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-222"><a href="#cb141-222" aria-hidden="true" tabindex="-1"></a>reg_task<span class="sc">$</span><span class="fu">rbind</span>(</span>
<span id="cb141-223"><a href="#cb141-223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(<span class="at">mpg =</span> <span class="dv">20</span>, <span class="at">am =</span> <span class="dv">1</span>, <span class="at">carb =</span> <span class="dv">3</span>, <span class="at">cyl =</span> <span class="dv">99</span>)</span>
<span id="cb141-224"><a href="#cb141-224" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb141-225"><a href="#cb141-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-226"><a href="#cb141-226" aria-hidden="true" tabindex="-1"></a><span class="co">#=== see the change ===#</span></span>
<span id="cb141-227"><a href="#cb141-227" aria-hidden="true" tabindex="-1"></a>reg_task<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb141-228"><a href="#cb141-228" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-229"><a href="#cb141-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-230"><a href="#cb141-230" aria-hidden="true" tabindex="-1"></a><span class="fu">## Learners</span></span>
<span id="cb141-231"><a href="#cb141-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-232"><a href="#cb141-232" aria-hidden="true" tabindex="-1"></a>In Python, the majority of ML packages are written to be compatible with <span class="in">`scikit-learn`</span> framework. However, in R, there is no single framework that is equivalent to <span class="in">`scikit-learn`</span> to which all the developers of ML packages conform to. Fortunately, the author of the <span class="in">`mlr3`</span> package picked popular ML packages (e.g., <span class="in">`ranger`</span>, <span class="in">`xgboost`</span>) and made it easier for us to use those packages under the unified framework.</span>
<span id="cb141-233"><a href="#cb141-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-234"><a href="#cb141-234" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb141-235"><a href="#cb141-235" aria-hidden="true" tabindex="-1"></a><span class="in">`tidymodels`</span> have their own collection of packages, which is very similar to what <span class="in">`mlr3`</span> has. </span>
<span id="cb141-236"><a href="#cb141-236" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb141-237"><a href="#cb141-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-238"><a href="#cb141-238" aria-hidden="true" tabindex="-1"></a>Here is the list of learners that is available after loading the <span class="in">`mlr3verse`</span> package.</span>
<span id="cb141-239"><a href="#cb141-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-242"><a href="#cb141-242" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-243"><a href="#cb141-243" aria-hidden="true" tabindex="-1"></a>mlr_learners</span>
<span id="cb141-244"><a href="#cb141-244" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-245"><a href="#cb141-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-246"><a href="#cb141-246" aria-hidden="true" tabindex="-1"></a>As you can see, packages that we have seen earlier (e.g., <span class="in">`glmnet`</span>,  <span class="in">`ranger`</span>, <span class="in">`xgboost`</span>, <span class="in">`gam`</span>) are available. the <span class="in">`mlr3extralearners`</span> package provides you with additional but less-supported learners. You can check the complete list of learners <span class="co">[</span><span class="ot">here</span><span class="co">](https://mlr3extralearners.mlr-org.com/articles/learners/list_learners.html)</span>.</span>
<span id="cb141-247"><a href="#cb141-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-248"><a href="#cb141-248" aria-hidden="true" tabindex="-1"></a>You set up a learner by giving the name of the learner you would like to implement from the list to <span class="in">`lrn()`</span> like below.</span>
<span id="cb141-249"><a href="#cb141-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-252"><a href="#cb141-252" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-253"><a href="#cb141-253" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">&lt;-</span> <span class="fu">lrn</span>(<span class="st">"regr.ranger"</span>)</span>
<span id="cb141-254"><a href="#cb141-254" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-255"><a href="#cb141-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-256"><a href="#cb141-256" aria-hidden="true" tabindex="-1"></a>Note that you need to pick the one with the appropriate prediction type prefix (the prefixes are self-explanatory). Here, since we are interested in regression, we picked <span class="in">`"regr.ranger"`</span>.</span>
<span id="cb141-257"><a href="#cb141-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-258"><a href="#cb141-258" aria-hidden="true" tabindex="-1"></a>Once you set up a learner, you can see the set of the learner's hyper-parameters.</span>
<span id="cb141-259"><a href="#cb141-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-262"><a href="#cb141-262" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-263"><a href="#cb141-263" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>param_set</span>
<span id="cb141-264"><a href="#cb141-264" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-265"><a href="#cb141-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-266"><a href="#cb141-266" aria-hidden="true" tabindex="-1"></a>Right now, only <span class="in">`num.threads`</span> is set explicitly.</span>
<span id="cb141-267"><a href="#cb141-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-270"><a href="#cb141-270" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-271"><a href="#cb141-271" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>param_set<span class="sc">$</span>values</span>
<span id="cb141-272"><a href="#cb141-272" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-273"><a href="#cb141-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-274"><a href="#cb141-274" aria-hidden="true" tabindex="-1"></a>You can update or assign the value of a parameter like this:</span>
<span id="cb141-275"><a href="#cb141-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-278"><a href="#cb141-278" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-279"><a href="#cb141-279" aria-hidden="true" tabindex="-1"></a><span class="co">#=== set max.depth to 5 ===#</span></span>
<span id="cb141-280"><a href="#cb141-280" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>max.depth <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb141-281"><a href="#cb141-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-282"><a href="#cb141-282" aria-hidden="true" tabindex="-1"></a><span class="co">#=== see the values ===#</span></span>
<span id="cb141-283"><a href="#cb141-283" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>param_set<span class="sc">$</span>values</span>
<span id="cb141-284"><a href="#cb141-284" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-285"><a href="#cb141-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-286"><a href="#cb141-286" aria-hidden="true" tabindex="-1"></a>When you would like to set values for multiple hyper-parameters at the same time, you can provide a named list to <span class="in">`$param_set$values`</span>. Here is an example:</span>
<span id="cb141-287"><a href="#cb141-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-290"><a href="#cb141-290" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-291"><a href="#cb141-291" aria-hidden="true" tabindex="-1"></a><span class="co">#=== create a named vector ===#</span></span>
<span id="cb141-292"><a href="#cb141-292" aria-hidden="true" tabindex="-1"></a>parameter_values <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">"min.node.size"</span> <span class="ot">=</span> <span class="dv">10</span>, <span class="st">"mtry"</span> <span class="ot">=</span> <span class="dv">5</span>, <span class="st">"num.trees"</span> <span class="ot">=</span> <span class="dv">500</span>)</span>
<span id="cb141-293"><a href="#cb141-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-294"><a href="#cb141-294" aria-hidden="true" tabindex="-1"></a><span class="co">#=== assign them ===#</span></span>
<span id="cb141-295"><a href="#cb141-295" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>param_set<span class="sc">$</span>values <span class="ot">&lt;-</span> parameter_values</span>
<span id="cb141-296"><a href="#cb141-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-297"><a href="#cb141-297" aria-hidden="true" tabindex="-1"></a><span class="co">#=== see the values ===#</span></span>
<span id="cb141-298"><a href="#cb141-298" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>param_set<span class="sc">$</span>values</span>
<span id="cb141-299"><a href="#cb141-299" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-300"><a href="#cb141-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-301"><a href="#cb141-301" aria-hidden="true" tabindex="-1"></a>But, notice that the values we set previously for <span class="in">`max.depth`</span> and <span class="in">`num.threads`</span> are gone. </span>
<span id="cb141-302"><a href="#cb141-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-303"><a href="#cb141-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-304"><a href="#cb141-304" aria-hidden="true" tabindex="-1"></a><span class="fu">## Train, predict, assessment</span></span>
<span id="cb141-305"><a href="#cb141-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-306"><a href="#cb141-306" aria-hidden="true" tabindex="-1"></a><span class="fu">### Train</span></span>
<span id="cb141-307"><a href="#cb141-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-308"><a href="#cb141-308" aria-hidden="true" tabindex="-1"></a>Training a model can be done using the <span class="in">`$train()`</span> method on a leaner by supplying a task to it. Let's first set up a task and learner.</span>
<span id="cb141-309"><a href="#cb141-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-312"><a href="#cb141-312" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-313"><a href="#cb141-313" aria-hidden="true" tabindex="-1"></a><span class="co">#=== define a task ===#</span></span>
<span id="cb141-314"><a href="#cb141-314" aria-hidden="true" tabindex="-1"></a>reg_task <span class="ot">&lt;-</span></span>
<span id="cb141-315"><a href="#cb141-315" aria-hidden="true" tabindex="-1"></a>  TaskRegr<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb141-316"><a href="#cb141-316" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="st">"example"</span>,</span>
<span id="cb141-317"><a href="#cb141-317" aria-hidden="true" tabindex="-1"></a>    <span class="at">backend =</span> mtcars,</span>
<span id="cb141-318"><a href="#cb141-318" aria-hidden="true" tabindex="-1"></a>    <span class="at">target =</span> <span class="st">"mpg"</span></span>
<span id="cb141-319"><a href="#cb141-319" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb141-320"><a href="#cb141-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-321"><a href="#cb141-321" aria-hidden="true" tabindex="-1"></a><span class="co">#=== set up a learner ===#</span></span>
<span id="cb141-322"><a href="#cb141-322" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">&lt;-</span> <span class="fu">lrn</span>(<span class="st">"regr.ranger"</span>)</span>
<span id="cb141-323"><a href="#cb141-323" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>param_set<span class="sc">$</span>values <span class="ot">&lt;-</span> </span>
<span id="cb141-324"><a href="#cb141-324" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb141-325"><a href="#cb141-325" aria-hidden="true" tabindex="-1"></a>    <span class="st">"min.node.size"</span> <span class="ot">=</span> <span class="dv">10</span>, </span>
<span id="cb141-326"><a href="#cb141-326" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mtry"</span> <span class="ot">=</span> <span class="dv">5</span>, </span>
<span id="cb141-327"><a href="#cb141-327" aria-hidden="true" tabindex="-1"></a>    <span class="st">"num.trees"</span> <span class="ot">=</span> <span class="dv">500</span></span>
<span id="cb141-328"><a href="#cb141-328" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb141-329"><a href="#cb141-329" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-330"><a href="#cb141-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-331"><a href="#cb141-331" aria-hidden="true" tabindex="-1"></a>Notice that the <span class="in">`model`</span> attribute of the learner is empty at this point.</span>
<span id="cb141-332"><a href="#cb141-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-335"><a href="#cb141-335" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-336"><a href="#cb141-336" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>model</span>
<span id="cb141-337"><a href="#cb141-337" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-338"><a href="#cb141-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-339"><a href="#cb141-339" aria-hidden="true" tabindex="-1"></a>Now, let's train.</span>
<span id="cb141-340"><a href="#cb141-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-343"><a href="#cb141-343" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-344"><a href="#cb141-344" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span><span class="fu">train</span>(reg_task)</span>
<span id="cb141-345"><a href="#cb141-345" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-346"><a href="#cb141-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-347"><a href="#cb141-347" aria-hidden="true" tabindex="-1"></a>We now how information about the trained model in the <span class="in">`model`</span> attribute.</span>
<span id="cb141-348"><a href="#cb141-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-351"><a href="#cb141-351" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-352"><a href="#cb141-352" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>model</span>
<span id="cb141-353"><a href="#cb141-353" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-354"><a href="#cb141-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-355"><a href="#cb141-355" aria-hidden="true" tabindex="-1"></a>Notice that this is exactly what you would get if you use <span class="in">`ranger()`</span> to train your model.</span>
<span id="cb141-356"><a href="#cb141-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-357"><a href="#cb141-357" aria-hidden="true" tabindex="-1"></a>The <span class="in">`train()`</span> function has the <span class="in">`row_ids()`</span> option, where you can specify which rows of the data backend in the task are used for training.</span>
<span id="cb141-358"><a href="#cb141-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-359"><a href="#cb141-359" aria-hidden="true" tabindex="-1"></a>Let's split extract the <span class="in">`row_ids`</span> attribute and then split it for train and test purposes.</span>
<span id="cb141-360"><a href="#cb141-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-361"><a href="#cb141-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-364"><a href="#cb141-364" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-365"><a href="#cb141-365" aria-hidden="true" tabindex="-1"></a><span class="co">#=== extract row ids ===#</span></span>
<span id="cb141-366"><a href="#cb141-366" aria-hidden="true" tabindex="-1"></a>row_ids <span class="ot">&lt;-</span> reg_task<span class="sc">$</span>row_ids</span>
<span id="cb141-367"><a href="#cb141-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-368"><a href="#cb141-368" aria-hidden="true" tabindex="-1"></a><span class="co">#=== train ===#</span></span>
<span id="cb141-369"><a href="#cb141-369" aria-hidden="true" tabindex="-1"></a>train_ids <span class="ot">&lt;-</span> row_ids[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(row_ids) <span class="sc">/</span> <span class="dv">2</span>)]</span>
<span id="cb141-370"><a href="#cb141-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-371"><a href="#cb141-371" aria-hidden="true" tabindex="-1"></a><span class="co">#=== test ===#</span></span>
<span id="cb141-372"><a href="#cb141-372" aria-hidden="true" tabindex="-1"></a>test_ids <span class="ot">&lt;-</span> row_ids[<span class="sc">!</span>(row_ids <span class="sc">%in%</span> train_ids)]</span>
<span id="cb141-373"><a href="#cb141-373" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-374"><a href="#cb141-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-375"><a href="#cb141-375" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb141-376"><a href="#cb141-376" aria-hidden="true" tabindex="-1"></a>He, we are doing the split manually. But, you should use resampling methods, which we will look at later. </span>
<span id="cb141-377"><a href="#cb141-377" aria-hidden="true" tabindex="-1"></a>::: </span>
<span id="cb141-378"><a href="#cb141-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-379"><a href="#cb141-379" aria-hidden="true" tabindex="-1"></a>Now train using the train data.</span>
<span id="cb141-380"><a href="#cb141-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-383"><a href="#cb141-383" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-384"><a href="#cb141-384" aria-hidden="true" tabindex="-1"></a><span class="co">#=== train ===#</span></span>
<span id="cb141-385"><a href="#cb141-385" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span><span class="fu">train</span>(reg_task, <span class="at">row_ids =</span> train_ids)</span>
<span id="cb141-386"><a href="#cb141-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-387"><a href="#cb141-387" aria-hidden="true" tabindex="-1"></a><span class="co">#=== seed the trained model ===#</span></span>
<span id="cb141-388"><a href="#cb141-388" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>model</span>
<span id="cb141-389"><a href="#cb141-389" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-390"><a href="#cb141-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-391"><a href="#cb141-391" aria-hidden="true" tabindex="-1"></a><span class="fu">### Prediction</span></span>
<span id="cb141-392"><a href="#cb141-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-393"><a href="#cb141-393" aria-hidden="true" tabindex="-1"></a>We can use the <span class="in">`predict()`</span> method to make predictions by supplying a task to it. Just like the <span class="in">`train()`</span> method, we can use the <span class="in">`row_ids`</span> option inside <span class="in">`predict_newdata()`</span> to apply prediction only on a portion of the data. Let's use <span class="in">`test_ids`</span> we created above.</span>
<span id="cb141-394"><a href="#cb141-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-397"><a href="#cb141-397" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-398"><a href="#cb141-398" aria-hidden="true" tabindex="-1"></a>prediction <span class="ot">&lt;-</span> learner<span class="sc">$</span><span class="fu">predict</span>(reg_task, <span class="at">row_ids =</span> test_ids)</span>
<span id="cb141-399"><a href="#cb141-399" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-400"><a href="#cb141-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-401"><a href="#cb141-401" aria-hidden="true" tabindex="-1"></a><span class="in">`prediction`</span> is of a class called <span class="in">`Prediction`</span>. You can make the prediction available as a <span class="in">`data.table`</span> by using <span class="in">`as.data.table()`</span>.</span>
<span id="cb141-402"><a href="#cb141-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-405"><a href="#cb141-405" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-406"><a href="#cb141-406" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(prediction)</span>
<span id="cb141-407"><a href="#cb141-407" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-408"><a href="#cb141-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-409"><a href="#cb141-409" aria-hidden="true" tabindex="-1"></a>You can predict on a new dataset by supplying a new dataset as a <span class="in">`data.frame`</span>/<span class="in">`data.table`</span> to the <span class="in">`predict_newdata()`</span> method. Here, we just use parts of <span class="in">`mtcars`</span> (just pretend this is a newdataset).</span>
<span id="cb141-410"><a href="#cb141-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-413"><a href="#cb141-413" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-414"><a href="#cb141-414" aria-hidden="true" tabindex="-1"></a>prediction <span class="ot">&lt;-</span> learner<span class="sc">$</span><span class="fu">predict_newdata</span>(mtcars)</span>
<span id="cb141-415"><a href="#cb141-415" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-416"><a href="#cb141-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-417"><a href="#cb141-417" aria-hidden="true" tabindex="-1"></a><span class="fu">### Performance assessment</span></span>
<span id="cb141-418"><a href="#cb141-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-419"><a href="#cb141-419" aria-hidden="true" tabindex="-1"></a>There are many measure of performance we can use under <span class="in">`mlr3`</span>. Here is the list:</span>
<span id="cb141-420"><a href="#cb141-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-423"><a href="#cb141-423" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-424"><a href="#cb141-424" aria-hidden="true" tabindex="-1"></a>mlr_measures</span>
<span id="cb141-425"><a href="#cb141-425" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-426"><a href="#cb141-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-427"><a href="#cb141-427" aria-hidden="true" tabindex="-1"></a>We can access a measure using the <span class="in">`msr()`</span> function.</span>
<span id="cb141-428"><a href="#cb141-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-431"><a href="#cb141-431" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-432"><a href="#cb141-432" aria-hidden="true" tabindex="-1"></a><span class="co">#=== get a measure ===#</span></span>
<span id="cb141-433"><a href="#cb141-433" aria-hidden="true" tabindex="-1"></a>measure <span class="ot">&lt;-</span> <span class="fu">msr</span>(<span class="st">"regr.mse"</span>)</span>
<span id="cb141-434"><a href="#cb141-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-435"><a href="#cb141-435" aria-hidden="true" tabindex="-1"></a><span class="co">#=== check the class ===#</span></span>
<span id="cb141-436"><a href="#cb141-436" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(measure)</span>
<span id="cb141-437"><a href="#cb141-437" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-438"><a href="#cb141-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-439"><a href="#cb141-439" aria-hidden="true" tabindex="-1"></a>We can do performance evaluation using the <span class="in">`$score()`</span> method on a <span class="in">`Prediction`</span> object by supplying a <span class="in">`Measure`</span> object.</span>
<span id="cb141-440"><a href="#cb141-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-443"><a href="#cb141-443" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-444"><a href="#cb141-444" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">score</span>(measure)</span>
<span id="cb141-445"><a href="#cb141-445" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-446"><a href="#cb141-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-447"><a href="#cb141-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-448"><a href="#cb141-448" aria-hidden="true" tabindex="-1"></a><span class="fu">## Resampling, cross-validation, and cross-fitting</span></span>
<span id="cb141-449"><a href="#cb141-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-450"><a href="#cb141-450" aria-hidden="true" tabindex="-1"></a><span class="fu">### Resampling</span></span>
<span id="cb141-451"><a href="#cb141-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-452"><a href="#cb141-452" aria-hidden="true" tabindex="-1"></a><span class="in">`mlr3`</span> offers the following resampling methods:</span>
<span id="cb141-453"><a href="#cb141-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-456"><a href="#cb141-456" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-457"><a href="#cb141-457" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(mlr_resamplings)</span>
<span id="cb141-458"><a href="#cb141-458" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-459"><a href="#cb141-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-460"><a href="#cb141-460" aria-hidden="true" tabindex="-1"></a>You can access a resampling method using the <span class="in">`rsmp()`</span> function. You can specify parameters at the same time.</span>
<span id="cb141-461"><a href="#cb141-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-464"><a href="#cb141-464" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-465"><a href="#cb141-465" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb141-466"><a href="#cb141-466" aria-hidden="true" tabindex="-1"></a>resampling <span class="ot">&lt;-</span> <span class="fu">rsmp</span>(<span class="st">"repeated_cv"</span>, <span class="at">repeats =</span> <span class="dv">2</span>, <span class="at">folds =</span> <span class="dv">3</span>)</span>
<span id="cb141-467"><a href="#cb141-467" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb141-468"><a href="#cb141-468" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-469"><a href="#cb141-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-470"><a href="#cb141-470" aria-hidden="true" tabindex="-1"></a>You can check the number of iterations (number of train-test datasets combinations) by accessing the <span class="in">`iters`</span> attribute.</span>
<span id="cb141-471"><a href="#cb141-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-474"><a href="#cb141-474" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-475"><a href="#cb141-475" aria-hidden="true" tabindex="-1"></a>resampling<span class="sc">$</span>iters</span>
<span id="cb141-476"><a href="#cb141-476" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-477"><a href="#cb141-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-478"><a href="#cb141-478" aria-hidden="true" tabindex="-1"></a>You can override parameters just like you did for a leaner.</span>
<span id="cb141-479"><a href="#cb141-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-482"><a href="#cb141-482" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-483"><a href="#cb141-483" aria-hidden="true" tabindex="-1"></a><span class="co">#=== update ===#</span></span>
<span id="cb141-484"><a href="#cb141-484" aria-hidden="true" tabindex="-1"></a>resampling<span class="sc">$</span>param_set<span class="sc">$</span>values <span class="ot">=</span> <span class="fu">list</span>(<span class="at">repeats =</span> <span class="dv">3</span>, <span class="at">folds =</span> <span class="dv">4</span>)</span>
<span id="cb141-485"><a href="#cb141-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-486"><a href="#cb141-486" aria-hidden="true" tabindex="-1"></a><span class="co">#=== see the updates ===#</span></span>
<span id="cb141-487"><a href="#cb141-487" aria-hidden="true" tabindex="-1"></a>resampling</span>
<span id="cb141-488"><a href="#cb141-488" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-489"><a href="#cb141-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-490"><a href="#cb141-490" aria-hidden="true" tabindex="-1"></a>We can use the <span class="in">`instantiate()`</span> method to implement the specified resampling method:</span>
<span id="cb141-491"><a href="#cb141-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-494"><a href="#cb141-494" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-495"><a href="#cb141-495" aria-hidden="true" tabindex="-1"></a>resampling<span class="sc">$</span><span class="fu">instantiate</span>(reg_task)</span>
<span id="cb141-496"><a href="#cb141-496" aria-hidden="true" tabindex="-1"></a><span class="in">```</span> </span>
<span id="cb141-497"><a href="#cb141-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-498"><a href="#cb141-498" aria-hidden="true" tabindex="-1"></a>You can access the train and test datasets using the <span class="in">`train_set()`</span> and <span class="in">`test_set()`</span> method. respectively. Since <span class="in">`repeats = 3`</span> and <span class="in">`folds = 4`</span>, we have 12 sets of train and test datasets. You indicate which set you want inside <span class="in">`train_set()`</span> and <span class="in">`test_set()`</span>.</span>
<span id="cb141-499"><a href="#cb141-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-500"><a href="#cb141-500" aria-hidden="true" tabindex="-1"></a>First pair:</span>
<span id="cb141-501"><a href="#cb141-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-504"><a href="#cb141-504" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-505"><a href="#cb141-505" aria-hidden="true" tabindex="-1"></a>resampling<span class="sc">$</span><span class="fu">train_set</span>(<span class="dv">1</span>)</span>
<span id="cb141-506"><a href="#cb141-506" aria-hidden="true" tabindex="-1"></a>resampling<span class="sc">$</span><span class="fu">test_set</span>(<span class="dv">1</span>)</span>
<span id="cb141-507"><a href="#cb141-507" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-508"><a href="#cb141-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-509"><a href="#cb141-509" aria-hidden="true" tabindex="-1"></a>Last pair:</span>
<span id="cb141-510"><a href="#cb141-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-513"><a href="#cb141-513" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-514"><a href="#cb141-514" aria-hidden="true" tabindex="-1"></a>resampling<span class="sc">$</span><span class="fu">train_set</span>(<span class="dv">12</span>)</span>
<span id="cb141-515"><a href="#cb141-515" aria-hidden="true" tabindex="-1"></a>resampling<span class="sc">$</span><span class="fu">test_set</span>(<span class="dv">12</span>)</span>
<span id="cb141-516"><a href="#cb141-516" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-517"><a href="#cb141-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-518"><a href="#cb141-518" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cross-validation and cross-fitting</span></span>
<span id="cb141-519"><a href="#cb141-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-520"><a href="#cb141-520" aria-hidden="true" tabindex="-1"></a>Now that data splits are determined (along with a task and leaner), we can conduct a cross-validation using the <span class="in">`resample()`</span> function like below.</span>
<span id="cb141-521"><a href="#cb141-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-524"><a href="#cb141-524" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-525"><a href="#cb141-525" aria-hidden="true" tabindex="-1"></a>cv_results <span class="ot">&lt;-</span> <span class="fu">resample</span>(reg_task, learner, resampling)</span>
<span id="cb141-526"><a href="#cb141-526" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-527"><a href="#cb141-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-528"><a href="#cb141-528" aria-hidden="true" tabindex="-1"></a>This code applies the method specified in <span class="in">`leaner`</span> to each of the 12 train datasets, and evaluate the trained model on each of the 12 test datasets.</span>
<span id="cb141-529"><a href="#cb141-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-530"><a href="#cb141-530" aria-hidden="true" tabindex="-1"></a>You can look at the prediction results using the <span class="in">`predictions()`</span> method.</span>
<span id="cb141-531"><a href="#cb141-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-534"><a href="#cb141-534" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-535"><a href="#cb141-535" aria-hidden="true" tabindex="-1"></a>cv_results<span class="sc">$</span><span class="fu">predictions</span>()</span>
<span id="cb141-536"><a href="#cb141-536" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-537"><a href="#cb141-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-538"><a href="#cb141-538" aria-hidden="true" tabindex="-1"></a>You can get the all predictions combined using the <span class="in">`prediction()`</span> method.</span>
<span id="cb141-539"><a href="#cb141-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-542"><a href="#cb141-542" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-543"><a href="#cb141-543" aria-hidden="true" tabindex="-1"></a><span class="co">#=== all combined ===#</span></span>
<span id="cb141-544"><a href="#cb141-544" aria-hidden="true" tabindex="-1"></a>all_predictions <span class="ot">&lt;-</span> cv_results<span class="sc">$</span><span class="fu">prediction</span>()</span>
<span id="cb141-545"><a href="#cb141-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-546"><a href="#cb141-546" aria-hidden="true" tabindex="-1"></a><span class="co">#=== check the class ===#</span></span>
<span id="cb141-547"><a href="#cb141-547" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(all_predictions)</span>
<span id="cb141-548"><a href="#cb141-548" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-549"><a href="#cb141-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-550"><a href="#cb141-550" aria-hidden="true" tabindex="-1"></a>Since it is a <span class="in">`Prediciton`</span> object, we can apply the <span class="in">`score()`</span> method like this. </span>
<span id="cb141-551"><a href="#cb141-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-554"><a href="#cb141-554" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-555"><a href="#cb141-555" aria-hidden="true" tabindex="-1"></a>all_predictions<span class="sc">$</span><span class="fu">score</span>(<span class="fu">msr</span>(<span class="st">"regr.mse"</span>))</span>
<span id="cb141-556"><a href="#cb141-556" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-557"><a href="#cb141-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-558"><a href="#cb141-558" aria-hidden="true" tabindex="-1"></a>Of course, you are also cross-fitting when you are doing cross-validation. You can just take the prediction results and use them if you are implementing DML for example.</span>
<span id="cb141-559"><a href="#cb141-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-562"><a href="#cb141-562" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-563"><a href="#cb141-563" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb141-564"><a href="#cb141-564" aria-hidden="true" tabindex="-1"></a>cross_fitted_yhat <span class="ot">&lt;-</span></span>
<span id="cb141-565"><a href="#cb141-565" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.table</span>(all_predictions) <span class="sc">%&gt;%</span></span>
<span id="cb141-566"><a href="#cb141-566" aria-hidden="true" tabindex="-1"></a>  .[, .(<span class="at">y_hat_cf =</span> <span class="fu">mean</span>(response)), <span class="at">by =</span> row_ids]</span>
<span id="cb141-567"><a href="#cb141-567" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb141-568"><a href="#cb141-568" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-569"><a href="#cb141-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-570"><a href="#cb141-570" aria-hidden="true" tabindex="-1"></a><span class="fu">## Hyper-parameter tuning</span></span>
<span id="cb141-571"><a href="#cb141-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-572"><a href="#cb141-572" aria-hidden="true" tabindex="-1"></a>In conducting hyper-parameter tuning under the <span class="in">`mlr3`</span> framework, you define <span class="in">`TuningInstance*`</span> class, select the tuning method, and then trigger it. </span>
<span id="cb141-573"><a href="#cb141-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-574"><a href="#cb141-574" aria-hidden="true" tabindex="-1"></a><span class="fu">### TuningInstance</span></span>
<span id="cb141-575"><a href="#cb141-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-576"><a href="#cb141-576" aria-hidden="true" tabindex="-1"></a>There are two tuning instance classes.</span>
<span id="cb141-577"><a href="#cb141-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-578"><a href="#cb141-578" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>TuningInstanceSingleCrit </span>
<span id="cb141-579"><a href="#cb141-579" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>TuningInstanceMultiCrit</span>
<span id="cb141-580"><a href="#cb141-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-581"><a href="#cb141-581" aria-hidden="true" tabindex="-1"></a>The difference should be clear by looking at the name of the classes. We focus on the <span class="in">`TuningInstanceSingleCrit`</span> class here. </span>
<span id="cb141-582"><a href="#cb141-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-583"><a href="#cb141-583" aria-hidden="true" tabindex="-1"></a>Tuning instance consists of six elements:</span>
<span id="cb141-584"><a href="#cb141-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-585"><a href="#cb141-585" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`task`</span></span>
<span id="cb141-586"><a href="#cb141-586" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`learner`</span></span>
<span id="cb141-587"><a href="#cb141-587" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`resampling`</span></span>
<span id="cb141-588"><a href="#cb141-588" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`measure`</span></span>
<span id="cb141-589"><a href="#cb141-589" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`search_space`</span></span>
<span id="cb141-590"><a href="#cb141-590" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`terminator`</span></span>
<span id="cb141-591"><a href="#cb141-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-592"><a href="#cb141-592" aria-hidden="true" tabindex="-1"></a>We have covered all except <span class="in">`search_space`</span> and <span class="in">`terminator`</span>. Let's look at these two.</span>
<span id="cb141-593"><a href="#cb141-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-594"><a href="#cb141-594" aria-hidden="true" tabindex="-1"></a>Let's quickly create the first four elements.</span>
<span id="cb141-595"><a href="#cb141-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-598"><a href="#cb141-598" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-599"><a href="#cb141-599" aria-hidden="true" tabindex="-1"></a><span class="co">#=== task ===#</span></span>
<span id="cb141-600"><a href="#cb141-600" aria-hidden="true" tabindex="-1"></a>reg_task <span class="ot">&lt;-</span></span>
<span id="cb141-601"><a href="#cb141-601" aria-hidden="true" tabindex="-1"></a>  TaskRegr<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb141-602"><a href="#cb141-602" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="st">"example"</span>,</span>
<span id="cb141-603"><a href="#cb141-603" aria-hidden="true" tabindex="-1"></a>    <span class="at">backend =</span> mtcars,</span>
<span id="cb141-604"><a href="#cb141-604" aria-hidden="true" tabindex="-1"></a>    <span class="at">target =</span> <span class="st">"mpg"</span></span>
<span id="cb141-605"><a href="#cb141-605" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb141-606"><a href="#cb141-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-607"><a href="#cb141-607" aria-hidden="true" tabindex="-1"></a><span class="co">#=== learner ===#</span></span>
<span id="cb141-608"><a href="#cb141-608" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">&lt;-</span> <span class="fu">lrn</span>(<span class="st">"regr.ranger"</span>)</span>
<span id="cb141-609"><a href="#cb141-609" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>max.depth <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb141-610"><a href="#cb141-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-611"><a href="#cb141-611" aria-hidden="true" tabindex="-1"></a><span class="co">#=== resampling ===#</span></span>
<span id="cb141-612"><a href="#cb141-612" aria-hidden="true" tabindex="-1"></a>resampling <span class="ot">&lt;-</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>) <span class="co"># k-fold cv</span></span>
<span id="cb141-613"><a href="#cb141-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-614"><a href="#cb141-614" aria-hidden="true" tabindex="-1"></a><span class="co">#=== measure ===#</span></span>
<span id="cb141-615"><a href="#cb141-615" aria-hidden="true" tabindex="-1"></a>measure <span class="ot">&lt;-</span> <span class="fu">msr</span>(<span class="st">"regr.mse"</span>)</span>
<span id="cb141-616"><a href="#cb141-616" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-617"><a href="#cb141-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-618"><a href="#cb141-618" aria-hidden="true" tabindex="-1"></a><span class="in">`search_space`</span> defines which hyper-parameters to tune and their ranges. You can use <span class="in">`ps()`</span> to create a search space. Before doing so, let's look at the parameters of the learner. </span>
<span id="cb141-619"><a href="#cb141-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-622"><a href="#cb141-622" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-623"><a href="#cb141-623" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>param_set</span>
<span id="cb141-624"><a href="#cb141-624" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-625"><a href="#cb141-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-626"><a href="#cb141-626" aria-hidden="true" tabindex="-1"></a>Let's tune three parameters here: <span class="in">`mtry.ratio`</span>, <span class="in">`min.node.size`</span>, and <span class="in">`num.trees`</span>. For each parameter to tune, we need to use an appropriate function to define the range. You can see what functions to use from <span class="in">`class`</span> variable.</span>
<span id="cb141-627"><a href="#cb141-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-630"><a href="#cb141-630" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-631"><a href="#cb141-631" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>param_set <span class="sc">%&gt;%</span> </span>
<span id="cb141-632"><a href="#cb141-632" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.table</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb141-633"><a href="#cb141-633" aria-hidden="true" tabindex="-1"></a>  .[id <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"mtry.ratio"</span>, <span class="st">"min.node.size"</span>), .(id, class, lower, upper)]</span>
<span id="cb141-634"><a href="#cb141-634" aria-hidden="true" tabindex="-1"></a><span class="in">```</span> </span>
<span id="cb141-635"><a href="#cb141-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-636"><a href="#cb141-636" aria-hidden="true" tabindex="-1"></a>In this case, we use <span class="in">`p_int()`</span> for "min.node.size" as its class is <span class="in">`ParamInt`</span> and use <span class="in">`p_dbl()`</span> for "mtry.ratio" as its class is <span class="in">`ParamDbl`</span>. You cannot specify the range that go beyond the <span class="in">`lower`</span> and <span class="in">`upper`</span> for each parameter.</span>
<span id="cb141-637"><a href="#cb141-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-638"><a href="#cb141-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-641"><a href="#cb141-641" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-642"><a href="#cb141-642" aria-hidden="true" tabindex="-1"></a>search_space <span class="ot">&lt;-</span> </span>
<span id="cb141-643"><a href="#cb141-643" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ps</span>(</span>
<span id="cb141-644"><a href="#cb141-644" aria-hidden="true" tabindex="-1"></a>    <span class="at">mtry.ratio =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="fl">0.5</span>, <span class="at">upper =</span> <span class="fl">0.9</span>),</span>
<span id="cb141-645"><a href="#cb141-645" aria-hidden="true" tabindex="-1"></a>    <span class="at">min.node.size =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> <span class="dv">1</span>, <span class="at">upper =</span> <span class="dv">20</span>)</span>
<span id="cb141-646"><a href="#cb141-646" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb141-647"><a href="#cb141-647" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-648"><a href="#cb141-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-649"><a href="#cb141-649" aria-hidden="true" tabindex="-1"></a>Let's define a <span class="in">`terminator`</span> now. <span class="in">`mlr3`</span> offers five different options. We will just look at the most common one here, which is <span class="in">`TerminatorEvals`</span>. <span class="in">`TerminatorEvals`</span> terminates tuning after a given number of iterations specified by the user (see <span class="co">[</span><span class="ot">here</span><span class="co">](https://mlr3book.mlr-org.com/04-optimization-tuning.html#tuning-optimization)</span> for other terminator options).</span>
<span id="cb141-650"><a href="#cb141-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-651"><a href="#cb141-651" aria-hidden="true" tabindex="-1"></a>You can use the <span class="in">`trm()`</span> function to define a Terminator object. </span>
<span id="cb141-652"><a href="#cb141-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-655"><a href="#cb141-655" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-656"><a href="#cb141-656" aria-hidden="true" tabindex="-1"></a>terminator <span class="ot">&lt;-</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">100</span>) </span>
<span id="cb141-657"><a href="#cb141-657" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-658"><a href="#cb141-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-659"><a href="#cb141-659" aria-hidden="true" tabindex="-1"></a>Inside <span class="in">`trm()`</span>, "evals" indicates that we would like to use the <span class="in">`TerminatorEvals`</span> option. </span>
<span id="cb141-660"><a href="#cb141-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-661"><a href="#cb141-661" aria-hidden="true" tabindex="-1"></a>Now that we have all the components specified, we can instantiate (generate) a TuningInstanceSingleCrit class.</span>
<span id="cb141-662"><a href="#cb141-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-665"><a href="#cb141-665" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-666"><a href="#cb141-666" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb141-667"><a href="#cb141-667" aria-hidden="true" tabindex="-1"></a>tuning_instance <span class="ot">&lt;-</span> </span>
<span id="cb141-668"><a href="#cb141-668" aria-hidden="true" tabindex="-1"></a>  TuningInstanceSingleCrit<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb141-669"><a href="#cb141-669" aria-hidden="true" tabindex="-1"></a>    <span class="at">task =</span> reg_task,</span>
<span id="cb141-670"><a href="#cb141-670" aria-hidden="true" tabindex="-1"></a>    <span class="at">learner =</span> learner,</span>
<span id="cb141-671"><a href="#cb141-671" aria-hidden="true" tabindex="-1"></a>    <span class="at">resampling =</span> resampling,</span>
<span id="cb141-672"><a href="#cb141-672" aria-hidden="true" tabindex="-1"></a>    <span class="at">measure =</span> measure,</span>
<span id="cb141-673"><a href="#cb141-673" aria-hidden="true" tabindex="-1"></a>    <span class="at">search_space =</span> search_space,</span>
<span id="cb141-674"><a href="#cb141-674" aria-hidden="true" tabindex="-1"></a>    <span class="at">terminator =</span> terminator</span>
<span id="cb141-675"><a href="#cb141-675" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb141-676"><a href="#cb141-676" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb141-677"><a href="#cb141-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-678"><a href="#cb141-678" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-679"><a href="#cb141-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-680"><a href="#cb141-680" aria-hidden="true" tabindex="-1"></a><span class="fu">### Tuner  </span></span>
<span id="cb141-681"><a href="#cb141-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-682"><a href="#cb141-682" aria-hidden="true" tabindex="-1"></a>Let's now define the method of tuning. <span class="in">`mlr3`</span> offers four options:</span>
<span id="cb141-683"><a href="#cb141-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-684"><a href="#cb141-684" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Grid Search (<span class="in">`TunerGridSearch`</span>)</span>
<span id="cb141-685"><a href="#cb141-685" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Random Search (<span class="in">`TunerRandomSearch`</span>)</span>
<span id="cb141-686"><a href="#cb141-686" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Generalized Simulated Annealing (<span class="in">`TunerGenSA`</span>)</span>
<span id="cb141-687"><a href="#cb141-687" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Non-Linear Optimization (<span class="in">`TunerNLoptr`</span>)</span>
<span id="cb141-688"><a href="#cb141-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-689"><a href="#cb141-689" aria-hidden="true" tabindex="-1"></a>Here we use <span class="in">`TunerGridSearch`</span>. We can set up a tuner using the <span class="in">`tnr()`</span> function.</span>
<span id="cb141-690"><a href="#cb141-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-693"><a href="#cb141-693" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-694"><a href="#cb141-694" aria-hidden="true" tabindex="-1"></a>tuner <span class="ot">&lt;-</span> <span class="fu">tnr</span>(<span class="st">"grid_search"</span>, <span class="at">resolution =</span> <span class="dv">4</span>) </span>
<span id="cb141-695"><a href="#cb141-695" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-696"><a href="#cb141-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-697"><a href="#cb141-697" aria-hidden="true" tabindex="-1"></a><span class="in">`resolution = 4`</span> means that each parameter takes four values where the values are equidistant between the upper and lower bounds specified in <span class="in">`search_space`</span>. So, this tuning will look at $4^2 = 16$ parameter configurations. Notice that we set the number of evaluations to 100 above. So, all $16$ cases will be evaluated. However, if you set <span class="in">`n_evals`</span> lower than $16$, then the tuning will not look at all the cases. </span>
<span id="cb141-698"><a href="#cb141-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-699"><a href="#cb141-699" aria-hidden="true" tabindex="-1"></a><span class="fu">### Tuning </span></span>
<span id="cb141-700"><a href="#cb141-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-701"><a href="#cb141-701" aria-hidden="true" tabindex="-1"></a>You can trigger tuning by supplying a tuning instance to the <span class="in">`optimizer()`</span> method on <span class="in">`tuner`</span>.</span>
<span id="cb141-702"><a href="#cb141-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-705"><a href="#cb141-705" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-706"><a href="#cb141-706" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb141-707"><a href="#cb141-707" aria-hidden="true" tabindex="-1"></a>tuner<span class="sc">$</span><span class="fu">optimize</span>(tuning_instance)</span>
<span id="cb141-708"><a href="#cb141-708" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-709"><a href="#cb141-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-712"><a href="#cb141-712" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-713"><a href="#cb141-713" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb141-714"><a href="#cb141-714" aria-hidden="true" tabindex="-1"></a>tuner<span class="sc">$</span><span class="fu">optimize</span>(tuning_instance)</span>
<span id="cb141-715"><a href="#cb141-715" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-716"><a href="#cb141-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-717"><a href="#cb141-717" aria-hidden="true" tabindex="-1"></a>Since the execution of this tuning prints so many lines of results, it is not presented here. </span>
<span id="cb141-718"><a href="#cb141-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-719"><a href="#cb141-719" aria-hidden="true" tabindex="-1"></a>One the tuning is done, you can get the optimized parameters by accessing the <span class="in">`result_learner_param_values`</span> attribute of the tuning instance.</span>
<span id="cb141-720"><a href="#cb141-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-723"><a href="#cb141-723" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-724"><a href="#cb141-724" aria-hidden="true" tabindex="-1"></a>tuning_instance<span class="sc">$</span>result_learner_param_vals</span>
<span id="cb141-725"><a href="#cb141-725" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-726"><a href="#cb141-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-727"><a href="#cb141-727" aria-hidden="true" tabindex="-1"></a>You can look at the evaluation results of other parameter configurations by accessing the <span class="in">`archive`</span> attribute of the tuning instance.</span>
<span id="cb141-728"><a href="#cb141-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-731"><a href="#cb141-731" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-732"><a href="#cb141-732" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(tuning_instance<span class="sc">$</span>archive) <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span>
<span id="cb141-733"><a href="#cb141-733" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-734"><a href="#cb141-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-735"><a href="#cb141-735" aria-hidden="true" tabindex="-1"></a><span class="fu">### AutoTuner</span></span>
<span id="cb141-736"><a href="#cb141-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-737"><a href="#cb141-737" aria-hidden="true" tabindex="-1"></a><span class="in">`AutoTuner`</span> sounds like it is a tuner, but it is really learner where tuning is automatically implemented when training is triggered with a task. An <span class="in">`AutoTuner`</span> class can be instantiated using the <span class="in">`new()`</span> method on <span class="in">`AutoTuner`</span> class like below.</span>
<span id="cb141-738"><a href="#cb141-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-741"><a href="#cb141-741" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-742"><a href="#cb141-742" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb141-743"><a href="#cb141-743" aria-hidden="true" tabindex="-1"></a>auto_tunning_learner <span class="ot">&lt;-</span> </span>
<span id="cb141-744"><a href="#cb141-744" aria-hidden="true" tabindex="-1"></a>  AutoTuner<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb141-745"><a href="#cb141-745" aria-hidden="true" tabindex="-1"></a>    <span class="at">learner =</span> learner,</span>
<span id="cb141-746"><a href="#cb141-746" aria-hidden="true" tabindex="-1"></a>    <span class="at">resampling =</span> resampling,</span>
<span id="cb141-747"><a href="#cb141-747" aria-hidden="true" tabindex="-1"></a>    <span class="at">measure =</span> measure,</span>
<span id="cb141-748"><a href="#cb141-748" aria-hidden="true" tabindex="-1"></a>    <span class="at">search_space =</span> search_space,</span>
<span id="cb141-749"><a href="#cb141-749" aria-hidden="true" tabindex="-1"></a>    <span class="at">terminator =</span> terminator,</span>
<span id="cb141-750"><a href="#cb141-750" aria-hidden="true" tabindex="-1"></a>    <span class="at">tuner =</span> tuner</span>
<span id="cb141-751"><a href="#cb141-751" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb141-752"><a href="#cb141-752" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb141-753"><a href="#cb141-753" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-754"><a href="#cb141-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-755"><a href="#cb141-755" aria-hidden="true" tabindex="-1"></a>Note that unlike TuningInstance, <span class="in">`AutoTuner`</span> does not take a task as its element and takes a <span class="in">`Tuner`</span> instead. Once an <span class="in">`AutoTuner`</span> is instantiated, you can use it like a learner and invoke the <span class="in">`train()`</span> method with a task to train a model. The difference from a regular leaner is that it automatically tune the parameters internally and use the optimized parameter values to train.  </span>
<span id="cb141-756"><a href="#cb141-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-759"><a href="#cb141-759" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-760"><a href="#cb141-760" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false </span></span>
<span id="cb141-761"><a href="#cb141-761" aria-hidden="true" tabindex="-1"></a>auto_tunning_learner<span class="sc">$</span><span class="fu">train</span>(reg_task)</span>
<span id="cb141-762"><a href="#cb141-762" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-763"><a href="#cb141-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-764"><a href="#cb141-764" aria-hidden="true" tabindex="-1"></a>You can access the optimized learner by accessing the <span class="in">`model$learner`</span> attribute.</span>
<span id="cb141-765"><a href="#cb141-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-768"><a href="#cb141-768" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-769"><a href="#cb141-769" aria-hidden="true" tabindex="-1"></a>auto_tunning_learner<span class="sc">$</span>model<span class="sc">$</span>learner</span>
<span id="cb141-770"><a href="#cb141-770" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-771"><a href="#cb141-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-772"><a href="#cb141-772" aria-hidden="true" tabindex="-1"></a>You can look at the history of tuning process like below:</span>
<span id="cb141-773"><a href="#cb141-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-776"><a href="#cb141-776" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-777"><a href="#cb141-777" aria-hidden="true" tabindex="-1"></a>auto_tunning_learner<span class="sc">$</span>model<span class="sc">$</span>tuning_instance</span>
<span id="cb141-778"><a href="#cb141-778" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-779"><a href="#cb141-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-780"><a href="#cb141-780" aria-hidden="true" tabindex="-1"></a>You can of course use the <span class="in">`predict()`</span> method as well. </span>
<span id="cb141-781"><a href="#cb141-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-784"><a href="#cb141-784" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-785"><a href="#cb141-785" aria-hidden="true" tabindex="-1"></a>auto_tunning_learner<span class="sc">$</span><span class="fu">predict</span>(reg_task)</span>
<span id="cb141-786"><a href="#cb141-786" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-787"><a href="#cb141-787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-788"><a href="#cb141-788" aria-hidden="true" tabindex="-1"></a><span class="fu">## `mlr3` in action {#sec-mlr3-in-action}</span></span>
<span id="cb141-789"><a href="#cb141-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-790"><a href="#cb141-790" aria-hidden="true" tabindex="-1"></a>Here, an example usage of the <span class="in">`mlr3`</span> framework as a part of a research process is presented. Suppose our goal is to estimate the heterogeneous treatment effect using causal forest using the R <span class="in">`grf`</span> package. The <span class="in">`grf::causal_forest()`</span> function implements causal forest as an R-learner and it uses random forest for its first-stage estimations by default. However, the function allows the users to provide their own estimated values of $y$ (dependent variable) and $T$ (treatment). We will code the process of conducting the first stage using <span class="in">`mlr3`</span> and then use <span class="in">`grf::causal_forest()`</span> to estimate heterogeneous treatment effects.</span>
<span id="cb141-791"><a href="#cb141-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-792"><a href="#cb141-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-795"><a href="#cb141-795" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-796"><a href="#cb141-796" aria-hidden="true" tabindex="-1"></a><span class="co">#=== load the Treatment dataset ===#</span></span>
<span id="cb141-797"><a href="#cb141-797" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"Treatment"</span>, <span class="at">package =</span> <span class="st">"Ecdat"</span>)</span>
<span id="cb141-798"><a href="#cb141-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-799"><a href="#cb141-799" aria-hidden="true" tabindex="-1"></a><span class="co">#=== convert to a data.table ===#</span></span>
<span id="cb141-800"><a href="#cb141-800" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb141-801"><a href="#cb141-801" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> </span>
<span id="cb141-802"><a href="#cb141-802" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(Treatment)</span>
<span id="cb141-803"><a href="#cb141-803" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb141-804"><a href="#cb141-804" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-805"><a href="#cb141-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-806"><a href="#cb141-806" aria-hidden="true" tabindex="-1"></a>The dependent variable is <span class="in">`re78`</span> ($Y$), which is real annual earnings in 1978 (after treatment). The treatment variable of interest is <span class="in">`treat`</span> ($T$), which is <span class="in">`TRUE`</span> if a person had gone through a training, <span class="in">`FALSE`</span> otherwise. The features that are included as potential drivers of the heterogeneity in the impact of <span class="in">`treat`</span> on <span class="in">`re78`</span> is <span class="in">`age`</span>, <span class="in">`educ`</span>, <span class="in">`ethn`</span>, and <span class="in">`married`</span> ($X$). Note that the focus of this section is just showcasing the use of <span class="in">`mlr3`</span> and no attention is paid to potential endogeneity problems. </span>
<span id="cb141-807"><a href="#cb141-807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-808"><a href="#cb141-808" aria-hidden="true" tabindex="-1"></a><span class="fu">### First stage</span></span>
<span id="cb141-809"><a href="#cb141-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-810"><a href="#cb141-810" aria-hidden="true" tabindex="-1"></a>We will use <span class="in">`ranger()`</span> and <span class="in">`xgboost()`</span> as learners. While <span class="in">`ranger()`</span> accepts factor variables, <span class="in">`xgboost()`</span> does not. So, we will one-hot-encode the data using <span class="in">`mltools::one_hot()`</span> so that we can just create a single <span class="in">`Task`</span> and use it for both. We also turn <span class="in">`treat`</span> to a factor so it is amenable with classification jobs by the two learner functions.</span>
<span id="cb141-811"><a href="#cb141-811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-814"><a href="#cb141-814" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-815"><a href="#cb141-815" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb141-816"><a href="#cb141-816" aria-hidden="true" tabindex="-1"></a>data_trt <span class="ot">&lt;-</span> </span>
<span id="cb141-817"><a href="#cb141-817" aria-hidden="true" tabindex="-1"></a>  mltools<span class="sc">::</span><span class="fu">one_hot</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb141-818"><a href="#cb141-818" aria-hidden="true" tabindex="-1"></a>  .[, <span class="at">treat :=</span> <span class="fu">factor</span>(treat)]</span>
<span id="cb141-819"><a href="#cb141-819" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb141-820"><a href="#cb141-820" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-821"><a href="#cb141-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-822"><a href="#cb141-822" aria-hidden="true" tabindex="-1"></a>Note that we need separate procedures for estimating $E<span class="co">[</span><span class="ot">Y|X</span><span class="co">]</span>$ and $E<span class="co">[</span><span class="ot">T|X</span><span class="co">]</span>$. The former is a regression and the latter is a classification task. </span>
<span id="cb141-823"><a href="#cb141-823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-824"><a href="#cb141-824" aria-hidden="true" tabindex="-1"></a>Let's first work on estimating $E<span class="co">[</span><span class="ot">Y|X</span><span class="co">]</span>$. First, we set up a task.</span>
<span id="cb141-825"><a href="#cb141-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-828"><a href="#cb141-828" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-829"><a href="#cb141-829" aria-hidden="true" tabindex="-1"></a>y_est_task <span class="ot">&lt;-</span> </span>
<span id="cb141-830"><a href="#cb141-830" aria-hidden="true" tabindex="-1"></a>  TaskRegr<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb141-831"><a href="#cb141-831" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="st">"estimate_y_on_x"</span>,</span>
<span id="cb141-832"><a href="#cb141-832" aria-hidden="true" tabindex="-1"></a>    <span class="at">backend =</span> data_trt[, .(</span>
<span id="cb141-833"><a href="#cb141-833" aria-hidden="true" tabindex="-1"></a>      re78, age, educ, married, </span>
<span id="cb141-834"><a href="#cb141-834" aria-hidden="true" tabindex="-1"></a>      ethn_other, ethn_black, ethn_hispanic </span>
<span id="cb141-835"><a href="#cb141-835" aria-hidden="true" tabindex="-1"></a>    )],</span>
<span id="cb141-836"><a href="#cb141-836" aria-hidden="true" tabindex="-1"></a>    <span class="at">target =</span> <span class="st">"re78"</span></span>
<span id="cb141-837"><a href="#cb141-837" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb141-838"><a href="#cb141-838" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-839"><a href="#cb141-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-840"><a href="#cb141-840" aria-hidden="true" tabindex="-1"></a>We consider two modeling approaches: random forest by <span class="in">`ranger`</span> and gradient boosted forest by <span class="in">`xgboost`</span>. </span>
<span id="cb141-841"><a href="#cb141-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-844"><a href="#cb141-844" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-845"><a href="#cb141-845" aria-hidden="true" tabindex="-1"></a>y_learner_ranger <span class="ot">&lt;-</span> <span class="fu">lrn</span>(<span class="st">"regr.ranger"</span>)</span>
<span id="cb141-846"><a href="#cb141-846" aria-hidden="true" tabindex="-1"></a>y_learner_xgboost <span class="ot">&lt;-</span> <span class="fu">lrn</span>(<span class="st">"regr.xgboost"</span>)</span>
<span id="cb141-847"><a href="#cb141-847" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-848"><a href="#cb141-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-849"><a href="#cb141-849" aria-hidden="true" tabindex="-1"></a>We will implement a K-fold cross-validation to select the better model with optimized hyper-parameter values. We do this by applying triggering <span class="in">`Tuner`</span> classed defined separately for the two learners.</span>
<span id="cb141-850"><a href="#cb141-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-851"><a href="#cb141-851" aria-hidden="true" tabindex="-1"></a>Let's define the resampling method, measure, terminator, and tuner that will be shared by the two approaches.</span>
<span id="cb141-852"><a href="#cb141-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-855"><a href="#cb141-855" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-856"><a href="#cb141-856" aria-hidden="true" tabindex="-1"></a>resampling_y <span class="ot">&lt;-</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">4</span>)</span>
<span id="cb141-857"><a href="#cb141-857" aria-hidden="true" tabindex="-1"></a>measure_y <span class="ot">&lt;-</span> <span class="fu">msr</span>(<span class="st">"regr.mse"</span>)</span>
<span id="cb141-858"><a href="#cb141-858" aria-hidden="true" tabindex="-1"></a>terminator <span class="ot">&lt;-</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">100</span>)</span>
<span id="cb141-859"><a href="#cb141-859" aria-hidden="true" tabindex="-1"></a>tuner <span class="ot">&lt;-</span> <span class="fu">tnr</span>(<span class="st">"grid_search"</span>, <span class="at">resolution =</span> <span class="dv">4</span>)</span>
<span id="cb141-860"><a href="#cb141-860" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-861"><a href="#cb141-861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-862"><a href="#cb141-862" aria-hidden="true" tabindex="-1"></a>Now, when we compare multiple models, we should use the same CV splits to have a fair comparison their model performance. To ensure this, we need to use an instantiated <span class="in">`Resampling`</span> object. </span>
<span id="cb141-863"><a href="#cb141-863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-864"><a href="#cb141-864" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb141-865"><a href="#cb141-865" aria-hidden="true" tabindex="-1"></a>If you provide an un-instantiated <span class="in">`Resampling`</span> object to an <span class="in">`AutoTuner`</span>, it will instantiate the <span class="in">`Resampling`</span> object internally and two separate <span class="in">`AutoTuner`</span>s can result in two distinct splits.  </span>
<span id="cb141-866"><a href="#cb141-866" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb141-867"><a href="#cb141-867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-870"><a href="#cb141-870" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-871"><a href="#cb141-871" aria-hidden="true" tabindex="-1"></a><span class="co">#=== instantiate ===#</span></span>
<span id="cb141-872"><a href="#cb141-872" aria-hidden="true" tabindex="-1"></a>resampling_y<span class="sc">$</span><span class="fu">instantiate</span>(y_est_task)</span>
<span id="cb141-873"><a href="#cb141-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-874"><a href="#cb141-874" aria-hidden="true" tabindex="-1"></a><span class="co">#=== confirm it is indeed instantiated ===#</span></span>
<span id="cb141-875"><a href="#cb141-875" aria-hidden="true" tabindex="-1"></a>resampling_y</span>
<span id="cb141-876"><a href="#cb141-876" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-877"><a href="#cb141-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-878"><a href="#cb141-878" aria-hidden="true" tabindex="-1"></a>Let's define search space for each of the learners.</span>
<span id="cb141-879"><a href="#cb141-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-882"><a href="#cb141-882" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-883"><a href="#cb141-883" aria-hidden="true" tabindex="-1"></a>search_space_ranger <span class="ot">&lt;-</span></span>
<span id="cb141-884"><a href="#cb141-884" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ps</span>(</span>
<span id="cb141-885"><a href="#cb141-885" aria-hidden="true" tabindex="-1"></a>    <span class="at">mtry =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> <span class="dv">1</span>, <span class="at">upper =</span> <span class="fu">length</span>(y_est_task<span class="sc">$</span>feature_names)),</span>
<span id="cb141-886"><a href="#cb141-886" aria-hidden="true" tabindex="-1"></a>    <span class="at">min.node.size =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> <span class="dv">1</span>, <span class="at">upper =</span> <span class="dv">20</span>)</span>
<span id="cb141-887"><a href="#cb141-887" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb141-888"><a href="#cb141-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-889"><a href="#cb141-889" aria-hidden="true" tabindex="-1"></a>search_space_xgboost <span class="ot">&lt;-</span></span>
<span id="cb141-890"><a href="#cb141-890" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ps</span>(</span>
<span id="cb141-891"><a href="#cb141-891" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrounds =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> <span class="dv">100</span>, <span class="at">upper =</span> <span class="dv">400</span>),</span>
<span id="cb141-892"><a href="#cb141-892" aria-hidden="true" tabindex="-1"></a>    <span class="at">eta =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="fl">0.01</span>, <span class="at">upper =</span> <span class="dv">1</span>)</span>
<span id="cb141-893"><a href="#cb141-893" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb141-894"><a href="#cb141-894" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-895"><a href="#cb141-895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-896"><a href="#cb141-896" aria-hidden="true" tabindex="-1"></a>We have all the ingredients to set up <span class="in">`TuningInstance`</span>s for the learners.</span>
<span id="cb141-897"><a href="#cb141-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-900"><a href="#cb141-900" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-901"><a href="#cb141-901" aria-hidden="true" tabindex="-1"></a>tuning_instance_ranger <span class="ot">&lt;-</span></span>
<span id="cb141-902"><a href="#cb141-902" aria-hidden="true" tabindex="-1"></a>  TuningInstanceSingleCrit<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb141-903"><a href="#cb141-903" aria-hidden="true" tabindex="-1"></a>    <span class="at">task =</span> y_est_task,</span>
<span id="cb141-904"><a href="#cb141-904" aria-hidden="true" tabindex="-1"></a>    <span class="at">learner =</span> y_learner_ranger,</span>
<span id="cb141-905"><a href="#cb141-905" aria-hidden="true" tabindex="-1"></a>    <span class="at">resampling =</span> resampling_y,</span>
<span id="cb141-906"><a href="#cb141-906" aria-hidden="true" tabindex="-1"></a>    <span class="at">measure =</span> measure_y,</span>
<span id="cb141-907"><a href="#cb141-907" aria-hidden="true" tabindex="-1"></a>    <span class="at">search_space =</span> search_space_ranger,</span>
<span id="cb141-908"><a href="#cb141-908" aria-hidden="true" tabindex="-1"></a>    <span class="at">terminator =</span> terminator</span>
<span id="cb141-909"><a href="#cb141-909" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb141-910"><a href="#cb141-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-911"><a href="#cb141-911" aria-hidden="true" tabindex="-1"></a>tuning_instance_xgboost <span class="ot">&lt;-</span></span>
<span id="cb141-912"><a href="#cb141-912" aria-hidden="true" tabindex="-1"></a>  TuningInstanceSingleCrit<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb141-913"><a href="#cb141-913" aria-hidden="true" tabindex="-1"></a>    <span class="at">task =</span> y_est_task,</span>
<span id="cb141-914"><a href="#cb141-914" aria-hidden="true" tabindex="-1"></a>    <span class="at">learner =</span> y_learner_xgboost,</span>
<span id="cb141-915"><a href="#cb141-915" aria-hidden="true" tabindex="-1"></a>    <span class="at">resampling =</span> resampling_y,</span>
<span id="cb141-916"><a href="#cb141-916" aria-hidden="true" tabindex="-1"></a>    <span class="at">measure =</span> measure_y,</span>
<span id="cb141-917"><a href="#cb141-917" aria-hidden="true" tabindex="-1"></a>    <span class="at">search_space =</span> search_space_xgboost,</span>
<span id="cb141-918"><a href="#cb141-918" aria-hidden="true" tabindex="-1"></a>    <span class="at">terminator =</span> terminator</span>
<span id="cb141-919"><a href="#cb141-919" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb141-920"><a href="#cb141-920" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-921"><a href="#cb141-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-922"><a href="#cb141-922" aria-hidden="true" tabindex="-1"></a>Let's tune them now (this can take a while).</span>
<span id="cb141-923"><a href="#cb141-923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-924"><a href="#cb141-924" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb141-925"><a href="#cb141-925" aria-hidden="true" tabindex="-1"></a>We use using the same tuner here, but you can use different tuning processes for the learners. For example, you can have <span class="in">`resolution = 5`</span> for tuning <span class="in">`regr.xgboost`</span>.</span>
<span id="cb141-926"><a href="#cb141-926" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb141-927"><a href="#cb141-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-928"><a href="#cb141-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-931"><a href="#cb141-931" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-932"><a href="#cb141-932" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb141-933"><a href="#cb141-933" aria-hidden="true" tabindex="-1"></a><span class="co">#=== tune ranger ===#</span></span>
<span id="cb141-934"><a href="#cb141-934" aria-hidden="true" tabindex="-1"></a>tuner<span class="sc">$</span><span class="fu">optimize</span>(tuning_instance_ranger)</span>
<span id="cb141-935"><a href="#cb141-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-936"><a href="#cb141-936" aria-hidden="true" tabindex="-1"></a><span class="co">#=== tune xgboost ===#</span></span>
<span id="cb141-937"><a href="#cb141-937" aria-hidden="true" tabindex="-1"></a>tuner<span class="sc">$</span><span class="fu">optimize</span>(tuning_instance_xgboost)</span>
<span id="cb141-938"><a href="#cb141-938" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-939"><a href="#cb141-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-942"><a href="#cb141-942" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-943"><a href="#cb141-943" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb141-944"><a href="#cb141-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-945"><a href="#cb141-945" aria-hidden="true" tabindex="-1"></a><span class="co">#=== tune ranger ===#</span></span>
<span id="cb141-946"><a href="#cb141-946" aria-hidden="true" tabindex="-1"></a>tuner<span class="sc">$</span><span class="fu">optimize</span>(tuning_instance_ranger)</span>
<span id="cb141-947"><a href="#cb141-947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-948"><a href="#cb141-948" aria-hidden="true" tabindex="-1"></a><span class="co">#=== tune xgboost ===#</span></span>
<span id="cb141-949"><a href="#cb141-949" aria-hidden="true" tabindex="-1"></a>tuner<span class="sc">$</span><span class="fu">optimize</span>(tuning_instance_xgboost)</span>
<span id="cb141-950"><a href="#cb141-950" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-951"><a href="#cb141-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-952"><a href="#cb141-952" aria-hidden="true" tabindex="-1"></a>Here are the MSEs from the two individually tuned learners.</span>
<span id="cb141-953"><a href="#cb141-953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-956"><a href="#cb141-956" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-957"><a href="#cb141-957" aria-hidden="true" tabindex="-1"></a>tuning_instance_ranger<span class="sc">$</span>result_y</span>
<span id="cb141-958"><a href="#cb141-958" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-959"><a href="#cb141-959" aria-hidden="true" tabindex="-1"></a>tuning_instance_xgboost<span class="sc">$</span>result_y</span>
<span id="cb141-960"><a href="#cb141-960" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-961"><a href="#cb141-961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-962"><a href="#cb141-962" aria-hidden="true" tabindex="-1"></a>So, in this example, we go with <span class="in">`regr.ranger`</span> with its optimized hyper-parameter values. Let's update our learner with the optimized hyper-parameter values.</span>
<span id="cb141-963"><a href="#cb141-963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-966"><a href="#cb141-966" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-967"><a href="#cb141-967" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb141-968"><a href="#cb141-968" aria-hidden="true" tabindex="-1"></a>y_learner_ranger<span class="sc">$</span>param_set<span class="sc">$</span>values <span class="ot">&lt;-</span> tuning_instance_ranger<span class="sc">$</span>result_learner_param_vals</span>
<span id="cb141-969"><a href="#cb141-969" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb141-970"><a href="#cb141-970" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-971"><a href="#cb141-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-972"><a href="#cb141-972" aria-hidden="true" tabindex="-1"></a>Now that we have decided on the model to use for predicting $E<span class="co">[</span><span class="ot">y|X</span><span class="co">]</span>$, let's implement cross-fitting.</span>
<span id="cb141-973"><a href="#cb141-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-976"><a href="#cb141-976" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-977"><a href="#cb141-977" aria-hidden="true" tabindex="-1"></a>cv_results_y <span class="ot">&lt;-</span></span>
<span id="cb141-978"><a href="#cb141-978" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resample</span>(</span>
<span id="cb141-979"><a href="#cb141-979" aria-hidden="true" tabindex="-1"></a>    y_est_task, </span>
<span id="cb141-980"><a href="#cb141-980" aria-hidden="true" tabindex="-1"></a>    y_learner_ranger, </span>
<span id="cb141-981"><a href="#cb141-981" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rsmp</span>(<span class="st">"repeated_cv"</span>, <span class="at">repeats =</span> <span class="dv">4</span>, <span class="at">folds =</span> <span class="dv">3</span>) </span>
<span id="cb141-982"><a href="#cb141-982" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb141-983"><a href="#cb141-983" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-984"><a href="#cb141-984" aria-hidden="true" tabindex="-1"></a><span class="co">#=== all combined ===#</span></span>
<span id="cb141-985"><a href="#cb141-985" aria-hidden="true" tabindex="-1"></a>all_predictions_y <span class="ot">&lt;-</span> </span>
<span id="cb141-986"><a href="#cb141-986" aria-hidden="true" tabindex="-1"></a>  cv_results_y<span class="sc">$</span><span class="fu">prediction</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb141-987"><a href="#cb141-987" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.table</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb141-988"><a href="#cb141-988" aria-hidden="true" tabindex="-1"></a>  .[, .(<span class="at">y_hat =</span> <span class="fu">mean</span>(response)), by <span class="ot">=</span> row_ids] <span class="sc">%&gt;%</span></span>
<span id="cb141-989"><a href="#cb141-989" aria-hidden="true" tabindex="-1"></a>  .[<span class="fu">order</span>(row_ids), ]</span>
<span id="cb141-990"><a href="#cb141-990" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-991"><a href="#cb141-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-992"><a href="#cb141-992" aria-hidden="true" tabindex="-1"></a>We basically follow the same process for estimating $E<span class="co">[</span><span class="ot">T|X</span><span class="co">]</span>$. Let's set up tuning processes for the learners.</span>
<span id="cb141-993"><a href="#cb141-993" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-996"><a href="#cb141-996" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-997"><a href="#cb141-997" aria-hidden="true" tabindex="-1"></a>t_est_task <span class="ot">&lt;-</span></span>
<span id="cb141-998"><a href="#cb141-998" aria-hidden="true" tabindex="-1"></a>  TaskClassif<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb141-999"><a href="#cb141-999" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="st">"estimate_t_on_x"</span>,</span>
<span id="cb141-1000"><a href="#cb141-1000" aria-hidden="true" tabindex="-1"></a>    <span class="at">backend =</span> </span>
<span id="cb141-1001"><a href="#cb141-1001" aria-hidden="true" tabindex="-1"></a>      data_trt[, .(</span>
<span id="cb141-1002"><a href="#cb141-1002" aria-hidden="true" tabindex="-1"></a>        treat, age, educ, married, </span>
<span id="cb141-1003"><a href="#cb141-1003" aria-hidden="true" tabindex="-1"></a>        ethn_other, ethn_black, ethn_hispanic </span>
<span id="cb141-1004"><a href="#cb141-1004" aria-hidden="true" tabindex="-1"></a>      )],</span>
<span id="cb141-1005"><a href="#cb141-1005" aria-hidden="true" tabindex="-1"></a>    <span class="at">target =</span> <span class="st">"treat"</span></span>
<span id="cb141-1006"><a href="#cb141-1006" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb141-1007"><a href="#cb141-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-1008"><a href="#cb141-1008" aria-hidden="true" tabindex="-1"></a>t_learner_ranger <span class="ot">&lt;-</span> <span class="fu">lrn</span>(<span class="st">"classif.ranger"</span>)</span>
<span id="cb141-1009"><a href="#cb141-1009" aria-hidden="true" tabindex="-1"></a>t_learner_xgboost <span class="ot">&lt;-</span> <span class="fu">lrn</span>(<span class="st">"classif.xgboost"</span>)</span>
<span id="cb141-1010"><a href="#cb141-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-1011"><a href="#cb141-1011" aria-hidden="true" tabindex="-1"></a>resampling_t <span class="ot">&lt;-</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">4</span>)</span>
<span id="cb141-1012"><a href="#cb141-1012" aria-hidden="true" tabindex="-1"></a>resampling_y<span class="sc">$</span><span class="fu">instantiate</span>(t_est_task)</span>
<span id="cb141-1013"><a href="#cb141-1013" aria-hidden="true" tabindex="-1"></a>measure_t <span class="ot">&lt;-</span> <span class="fu">msr</span>(<span class="st">"classif.ce"</span>)</span>
<span id="cb141-1014"><a href="#cb141-1014" aria-hidden="true" tabindex="-1"></a>terminator <span class="ot">&lt;-</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">100</span>)</span>
<span id="cb141-1015"><a href="#cb141-1015" aria-hidden="true" tabindex="-1"></a>tuner <span class="ot">&lt;-</span> <span class="fu">tnr</span>(<span class="st">"grid_search"</span>, <span class="at">resolution =</span> <span class="dv">4</span>)</span>
<span id="cb141-1016"><a href="#cb141-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-1017"><a href="#cb141-1017" aria-hidden="true" tabindex="-1"></a>tuning_instance_ranger <span class="ot">&lt;-</span></span>
<span id="cb141-1018"><a href="#cb141-1018" aria-hidden="true" tabindex="-1"></a>  TuningInstanceSingleCrit<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb141-1019"><a href="#cb141-1019" aria-hidden="true" tabindex="-1"></a>    <span class="at">task =</span> t_est_task,</span>
<span id="cb141-1020"><a href="#cb141-1020" aria-hidden="true" tabindex="-1"></a>    <span class="at">learner =</span> t_learner_ranger,</span>
<span id="cb141-1021"><a href="#cb141-1021" aria-hidden="true" tabindex="-1"></a>    <span class="at">resampling =</span> resampling_y,</span>
<span id="cb141-1022"><a href="#cb141-1022" aria-hidden="true" tabindex="-1"></a>    <span class="at">measure =</span> measure_t,</span>
<span id="cb141-1023"><a href="#cb141-1023" aria-hidden="true" tabindex="-1"></a>    <span class="at">search_space =</span> search_space_ranger,</span>
<span id="cb141-1024"><a href="#cb141-1024" aria-hidden="true" tabindex="-1"></a>    <span class="at">terminator =</span> terminator</span>
<span id="cb141-1025"><a href="#cb141-1025" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb141-1026"><a href="#cb141-1026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-1027"><a href="#cb141-1027" aria-hidden="true" tabindex="-1"></a>tuning_instance_xgboost <span class="ot">&lt;-</span></span>
<span id="cb141-1028"><a href="#cb141-1028" aria-hidden="true" tabindex="-1"></a>  TuningInstanceSingleCrit<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb141-1029"><a href="#cb141-1029" aria-hidden="true" tabindex="-1"></a>    <span class="at">task =</span> t_est_task,</span>
<span id="cb141-1030"><a href="#cb141-1030" aria-hidden="true" tabindex="-1"></a>    <span class="at">learner =</span> t_learner_xgboost,</span>
<span id="cb141-1031"><a href="#cb141-1031" aria-hidden="true" tabindex="-1"></a>    <span class="at">resampling =</span> resampling_y,</span>
<span id="cb141-1032"><a href="#cb141-1032" aria-hidden="true" tabindex="-1"></a>    <span class="at">measure =</span> measure_t,</span>
<span id="cb141-1033"><a href="#cb141-1033" aria-hidden="true" tabindex="-1"></a>    <span class="at">search_space =</span> search_space_xgboost,</span>
<span id="cb141-1034"><a href="#cb141-1034" aria-hidden="true" tabindex="-1"></a>    <span class="at">terminator =</span> terminator</span>
<span id="cb141-1035"><a href="#cb141-1035" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb141-1036"><a href="#cb141-1036" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-1037"><a href="#cb141-1037" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-1038"><a href="#cb141-1038" aria-hidden="true" tabindex="-1"></a>Here are the classification error from the two individually tuned learners.</span>
<span id="cb141-1039"><a href="#cb141-1039" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-1042"><a href="#cb141-1042" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-1043"><a href="#cb141-1043" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false </span></span>
<span id="cb141-1044"><a href="#cb141-1044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-1045"><a href="#cb141-1045" aria-hidden="true" tabindex="-1"></a><span class="co">#=== tune ranger ===#</span></span>
<span id="cb141-1046"><a href="#cb141-1046" aria-hidden="true" tabindex="-1"></a>tuner<span class="sc">$</span><span class="fu">optimize</span>(tuning_instance_ranger)</span>
<span id="cb141-1047"><a href="#cb141-1047" aria-hidden="true" tabindex="-1"></a>tuning_instance_ranger<span class="sc">$</span>result_y</span>
<span id="cb141-1048"><a href="#cb141-1048" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-1049"><a href="#cb141-1049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-1052"><a href="#cb141-1052" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-1053"><a href="#cb141-1053" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false </span></span>
<span id="cb141-1054"><a href="#cb141-1054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-1055"><a href="#cb141-1055" aria-hidden="true" tabindex="-1"></a><span class="co">#=== tune ranger ===#</span></span>
<span id="cb141-1056"><a href="#cb141-1056" aria-hidden="true" tabindex="-1"></a>tuner<span class="sc">$</span><span class="fu">optimize</span>(tuning_instance_ranger)</span>
<span id="cb141-1057"><a href="#cb141-1057" aria-hidden="true" tabindex="-1"></a>tuning_instance_ranger<span class="sc">$</span>result_y</span>
<span id="cb141-1058"><a href="#cb141-1058" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-1059"><a href="#cb141-1059" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-1062"><a href="#cb141-1062" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-1063"><a href="#cb141-1063" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false </span></span>
<span id="cb141-1064"><a href="#cb141-1064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-1065"><a href="#cb141-1065" aria-hidden="true" tabindex="-1"></a><span class="co">#=== tune xgboost ===#</span></span>
<span id="cb141-1066"><a href="#cb141-1066" aria-hidden="true" tabindex="-1"></a>tuner<span class="sc">$</span><span class="fu">optimize</span>(tuning_instance_xgboost)</span>
<span id="cb141-1067"><a href="#cb141-1067" aria-hidden="true" tabindex="-1"></a>tuning_instance_xgboost<span class="sc">$</span>result_y</span>
<span id="cb141-1068"><a href="#cb141-1068" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-1069"><a href="#cb141-1069" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-1072"><a href="#cb141-1072" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-1073"><a href="#cb141-1073" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false </span></span>
<span id="cb141-1074"><a href="#cb141-1074" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-1075"><a href="#cb141-1075" aria-hidden="true" tabindex="-1"></a><span class="co">#=== tune xgboost ===#</span></span>
<span id="cb141-1076"><a href="#cb141-1076" aria-hidden="true" tabindex="-1"></a>tuner<span class="sc">$</span><span class="fu">optimize</span>(tuning_instance_xgboost)</span>
<span id="cb141-1077"><a href="#cb141-1077" aria-hidden="true" tabindex="-1"></a>tuning_instance_xgboost<span class="sc">$</span>result_y</span>
<span id="cb141-1078"><a href="#cb141-1078" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-1079"><a href="#cb141-1079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-1080"><a href="#cb141-1080" aria-hidden="true" tabindex="-1"></a>So, we are picking the <span class="in">`classif.ranger`</span> option here as well as it has a lower classification error.</span>
<span id="cb141-1081"><a href="#cb141-1081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-1084"><a href="#cb141-1084" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-1085"><a href="#cb141-1085" aria-hidden="true" tabindex="-1"></a>t_learner_ranger<span class="sc">$</span>param_set<span class="sc">$</span>values <span class="ot">&lt;-</span> tuning_instance_ranger<span class="sc">$</span>result_learner_param_vals</span>
<span id="cb141-1086"><a href="#cb141-1086" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-1087"><a href="#cb141-1087" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-1088"><a href="#cb141-1088" aria-hidden="true" tabindex="-1"></a>Now that we have decided on the model to use for predicting $E<span class="co">[</span><span class="ot">T|X</span><span class="co">]</span>$, let's implement cross-fitting. Before cross-fitting, we need to tell <span class="in">`t_learner_ranger`</span> to predict probability instead of classification (either 0 or 1).</span>
<span id="cb141-1089"><a href="#cb141-1089" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-1092"><a href="#cb141-1092" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-1093"><a href="#cb141-1093" aria-hidden="true" tabindex="-1"></a>t_learner_ranger<span class="sc">$</span>predict_type <span class="ot">&lt;-</span> <span class="st">"prob"</span></span>
<span id="cb141-1094"><a href="#cb141-1094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-1095"><a href="#cb141-1095" aria-hidden="true" tabindex="-1"></a>cv_results_t <span class="ot">&lt;-</span></span>
<span id="cb141-1096"><a href="#cb141-1096" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resample</span>(</span>
<span id="cb141-1097"><a href="#cb141-1097" aria-hidden="true" tabindex="-1"></a>    t_est_task, </span>
<span id="cb141-1098"><a href="#cb141-1098" aria-hidden="true" tabindex="-1"></a>    t_learner_ranger, </span>
<span id="cb141-1099"><a href="#cb141-1099" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rsmp</span>(<span class="st">"repeated_cv"</span>, <span class="at">repeats =</span> <span class="dv">4</span>, <span class="at">folds =</span> <span class="dv">3</span>) </span>
<span id="cb141-1100"><a href="#cb141-1100" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb141-1101"><a href="#cb141-1101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-1102"><a href="#cb141-1102" aria-hidden="true" tabindex="-1"></a><span class="co">#=== all combined ===#</span></span>
<span id="cb141-1103"><a href="#cb141-1103" aria-hidden="true" tabindex="-1"></a>all_predictions_t <span class="ot">&lt;-</span> </span>
<span id="cb141-1104"><a href="#cb141-1104" aria-hidden="true" tabindex="-1"></a>  cv_results_t<span class="sc">$</span><span class="fu">prediction</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb141-1105"><a href="#cb141-1105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.table</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb141-1106"><a href="#cb141-1106" aria-hidden="true" tabindex="-1"></a>  .[, .(<span class="at">t_hat =</span> <span class="fu">mean</span>(prob.TRUE)), by <span class="ot">=</span> row_ids] <span class="sc">%&gt;%</span> </span>
<span id="cb141-1107"><a href="#cb141-1107" aria-hidden="true" tabindex="-1"></a>  .[<span class="fu">order</span>(row_ids), ]</span>
<span id="cb141-1108"><a href="#cb141-1108" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-1109"><a href="#cb141-1109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-1110"><a href="#cb141-1110" aria-hidden="true" tabindex="-1"></a>We now use <span class="in">`all_predictions_y`</span> and <span class="in">`all_predictions_t`</span> for <span class="in">`Y.hat`</span> and <span class="in">`W.hat`</span> in <span class="in">`grf::causal_forest()`</span>.</span>
<span id="cb141-1111"><a href="#cb141-1111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-1114"><a href="#cb141-1114" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb141-1115"><a href="#cb141-1115" aria-hidden="true" tabindex="-1"></a>grf<span class="sc">::</span><span class="fu">causal_forest</span>(</span>
<span id="cb141-1116"><a href="#cb141-1116" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> data_trt[, .(age, educ, married, ethn_other, ethn_black, ethn_hispanic)] <span class="sc">%&gt;%</span> <span class="fu">as.matrix</span>(),</span>
<span id="cb141-1117"><a href="#cb141-1117" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> data_trt[, re78],</span>
<span id="cb141-1118"><a href="#cb141-1118" aria-hidden="true" tabindex="-1"></a>  <span class="at">W =</span> data_trt[, <span class="fu">fifelse</span>(treat <span class="sc">==</span> <span class="cn">TRUE</span>, <span class="dv">1</span>, <span class="dv">0</span>)],</span>
<span id="cb141-1119"><a href="#cb141-1119" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y.hat =</span> all_predictions_y[, y_hat],</span>
<span id="cb141-1120"><a href="#cb141-1120" aria-hidden="true" tabindex="-1"></a>  <span class="at">W.hat =</span> all_predictions_t[, t_hat]</span>
<span id="cb141-1121"><a href="#cb141-1121" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb141-1122"><a href="#cb141-1122" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb141-1123"><a href="#cb141-1123" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>