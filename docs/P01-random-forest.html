<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.629">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Introduction to Machine Learning for Economists (Under Construction) - 6&nbsp; Random Forest</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./P02-boosted-regression-forest.html" rel="next">
<link href="./B05-bootstrap.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<link href="style.css" rel="stylesheet" type="text/css">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-45VKT2HZSL"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'G-45VKT2HZSL');
</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Random Forest</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Introduction to Machine Learning for Economists (Under Construction)</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/tmieno2/ML-Economist" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="" title="Share" id="sidebar-tool-dropdown-0" class="sidebar-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-share"></i></a>
    <ul class="dropdown-menu" aria-labelledby="sidebar-tool-dropdown-0">
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
            <i class="bi bi-bi-twitter pe-1"></i>
          Twitter
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
            <i class="bi bi-bi-facebook pe-1"></i>
          Facebook
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
            <i class="bi bi-bi-linkedin pe-1"></i>
          LinkedIn
          </a>
        </li>
    </ul>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Welcome</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./H00-preface.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Basics</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B01-nonlinear.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Non-linear function estimation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B02-bias-variance-tradeoff.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Bias-variance Trade-off</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B03-cross-validation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Cross-validation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B04-regularization.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Regression Shrinkage Methods</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B05-bootstrap.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Bootstrap</span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Prediction ML</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P01-random-forest.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Random Forest</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P02-boosted-regression-forest.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Boosted Regression Forest</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P03-xgb.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Extreme Gradient Boosting</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P04-local-linear-forest.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Local Linear Forest</span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./C0P-causal-ml.html" class="sidebar-item-text sidebar-link">Causal Machine Learning (CML) Methods</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C00-why-not-this.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Why can’t we just do this?</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C01-dml.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Double Machine Learning</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C02-xstr-learner.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">S-, X-, T-, and R-learner</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C03-cf-orf.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Forest-based CATE Estimators</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C04-cf-extension.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Extensions of Causal Forest</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C05-causal-model-selection.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Causal Model Selection</span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./E0P-extensions.html" class="sidebar-item-text sidebar-link">Extensions</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./E01-spatial-cv.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Spatial Cross-validation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./E02-grf.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Generalized Random Forest</span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">Programming: R</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PROG-R-01-mlr3.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Machine Learning with <code>mlr3</code></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PROG-R-02-reticulate.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Running Python from R</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PROG-R-03-model-selection-prediction.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Model Selection (Prediction)</span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">Programming: Python</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PROG-P-01-scikitlearn.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Prediction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PROG-P-02-CATE-econml.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Treatment Effect Estimation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PROG-P-03-model-selection.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Model selection</span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">Appendices</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A01-mc-simulation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Monte Carlo (MC) Simulation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A02-method-of-moment.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Primer on method of moment</span></a>
  </div>
</li>
    </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-rt" id="toc-sec-rt" class="nav-link active" data-scroll-target="#sec-rt"> <span class="header-section-number">6.1</span> Regression tree</a>
  <ul class="collapse">
  <li><a href="#what-is-it" id="toc-what-is-it" class="nav-link" data-scroll-target="#what-is-it"> <span class="header-section-number">6.1.1</span> What is it?</a></li>
  <li><a href="#sec-split-sim" id="toc-sec-split-sim" class="nav-link" data-scroll-target="#sec-split-sim"> <span class="header-section-number">6.1.2</span> A note on splitting algorithm</a></li>
  <li><a href="#training-a-regression-tree" id="toc-training-a-regression-tree" class="nav-link" data-scroll-target="#training-a-regression-tree"> <span class="header-section-number">6.1.3</span> Training a regression tree</a></li>
  </ul></li>
  <li><a href="#sec-rf" id="toc-sec-rf" class="nav-link" data-scroll-target="#sec-rf"> <span class="header-section-number">6.2</span> Random Forest (RF)</a>
  <ul class="collapse">
  <li><a href="#bagging-bootstrap-averaging" id="toc-bagging-bootstrap-averaging" class="nav-link" data-scroll-target="#bagging-bootstrap-averaging"> <span class="header-section-number">6.2.1</span> Bagging (Bootstrap Averaging)</a></li>
  <li><a href="#random-forest-rf" id="toc-random-forest-rf" class="nav-link" data-scroll-target="#random-forest-rf"> <span class="header-section-number">6.2.2</span> Random Forest (RF)</a></li>
  </ul></li>
  <li><a href="#implementation" id="toc-implementation" class="nav-link" data-scroll-target="#implementation"> <span class="header-section-number">6.3</span> Implementation</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/tmieno2/ML-Economist/edit/master/P01-random-forest.qmd" class="toc-action">Edit this page</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-rf" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Random Forest</span></span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<p>The main goal of this chapter is to learn random forest (RF) for regression. RF is first conceived by <span class="citation" data-cites="breiman2001random">Breiman (<a href="#ref-breiman2001random" role="doc-biblioref">2001</a>)</span>, and it has been one of the most popular machine learning methods. It also has been an inspiration to many other ML methods including extreme gradient boosting <span class="citation" data-cites="Chen_2016">(<a href="#ref-Chen_2016" role="doc-biblioref">Chen and Guestrin 2016</a>)</span>, generalized random forest <span class="citation" data-cites="athey2019generalized">(<a href="#ref-athey2019generalized" role="doc-biblioref">Athey, Tibshirani, and Wager 2019</a>)</span>.</p>
<p>We first start with understanding how a regression tree is built, which is the foundation of all the forest-based ML methods. We then learn how random forest is built as an extension of a regression tree and how to train it.</p>
<div class="callout-note callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
What you will learn
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Regression tree
<ul>
<li>How regression tree is built (algorithm)</li>
</ul></li>
<li>Random forest
<ul>
<li>How random forest is built
<ul>
<li>bagging (bootstrap averaging)</li>
<li>random variable selection for splitting</li>
</ul></li>
<li>How out-of-bag prediction works</li>
<li>How to train RF using R</li>
</ul></li>
</ul>
</div>
</div>
<div class="callout-tip callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Background knowledge
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>(necessary) bootstrap (<a href="B05-bootstrap.html"><span>Chapter&nbsp;5</span></a>)</li>
</ul>
</div>
</div>
<section id="sec-rt" class="level2 page-columns page-full" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="sec-rt"><span class="header-section-number">6.1</span> Regression tree</h2>

<div class="no-row-height column-margin column-container"><div class="">
<p><strong>Packages to load for replication</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rattle)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(wooldridge)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gganimate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div></div><section id="what-is-it" class="level3 page-columns page-full" data-number="6.1.1">
<h3 data-number="6.1.1" class="anchored" data-anchor-id="what-is-it"><span class="header-section-number">6.1.1</span> What is it?</h3>
<p>Here is an example of regression tree to explain logged salary (<code>lsalary</code>) using the <code>mlb1</code> data from the <code>wooldridge</code> package.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== get mlb1 data (from wooldridge) ===#</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(mlb1)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== build a simple tree ===#</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>simple_tree <span class="ot">&lt;-</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rpart</span>(</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    lsalary <span class="sc">~</span> hits <span class="sc">+</span> runsyr, </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> mlb1, </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">rpart.control</span>(<span class="at">minsplit =</span> <span class="dv">200</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="fu">fancyRpartPlot</span>(simple_tree, <span class="at">digits =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="P01-random-forest_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="callout-tip callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Terminology alert
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><span style="color:blue">node </span>: a group of observations represented by a green box</li>
<li><span style="color:blue">root node</span>: first node to which all the observations belong</li>
<li><span style="color:blue">leaf</span> or <span style="color:blue"> terminal node</span>: A node that is not split into more nodes</li>
</ul>
</div>
</div>
<p>Here is how you read the figure. At the first (root) node, all the observations belong to it (<span class="math inline">\(n=353\)</span>) and the estimate of <code>lsalary</code> is <span class="math inline">\(13.49\)</span>, which is simply the sample average of <code>lsalary</code>. Now, the whole dataset is split into two groups (nodes) based on the criteria of whether <code>hits</code> is less than <code>262</code> or not. If yes, then such observations will be grouped into the node with “2” on top (the leftmost node), and the estimated <code>lsalary</code> for all the observations in that group (<span class="math inline">\(n = 132\)</span>) is <span class="math inline">\(12.35\)</span>, which is the sample average of <code>lsalary</code> of the <span class="math inline">\(132\)</span> observations in the group. If no, then such observations will be grouped into the node with “3” on top, and the estimated <code>lsalary</code> for all the observations in that group (<span class="math inline">\(n = 221\)</span>) is <span class="math inline">\(14.17\)</span>. This node is further split into two groups based on whether <code>runsyr</code> is less than <span class="math inline">\(44\)</span> or not. For those observations with <code>runsyr</code> <span class="math inline">\(&lt; 44\)</span> (second node at the bottom), estimated <code>lsalary</code> is <span class="math inline">\(13.58\)</span>. For those with <code>runsyr</code> <span class="math inline">\(&gt;= 44\)</span> (rightmost node at the bottom), estimated <code>lsalary</code> is <span class="math inline">\(14.56\)</span>.</p>
<p>As illustrated in the figure above, a regression tree splits the data into groups based on the value of explanatory variables, and all the observations in the same group will be assigned the same estimate, which isthe sample average of the dependent variable of the group.</p>
<div class="callout-tip callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>The estimated value of <span class="math inline">\(Y\)</span> (the dependent variable) for <span class="math inline">\(X = x\)</span> is the average of <span class="math inline">\(Y\)</span> from all the observations that belong to the same terminal node (leaf) as <span class="math inline">\(X = x\)</span>.</p>
</div>
</div>
<p>Another way of illustrating this grouping is shown below:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mlb1) <span class="sc">+</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> hits, <span class="at">x =</span> runsyr, <span class="at">color =</span> lsalary)) <span class="sc">+</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">262</span>) <span class="sc">+</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">data.table</span>(<span class="at">x =</span> <span class="dv">44</span>, <span class="at">y =</span> <span class="fu">seq</span>(<span class="dv">262</span>, <span class="fu">max</span>(mlb1<span class="sc">$</span>hits), <span class="at">length =</span> <span class="dv">100</span>)), </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">x =</span> x)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"text"</span>, </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="dv">75</span>, <span class="at">y =</span> <span class="dv">100</span>, </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Region (Node) 2"</span>, </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"text"</span>, </span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="dv">22</span>, <span class="at">y =</span> <span class="dv">1500</span>, </span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Region (Node) 6"</span>, </span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"text"</span>, </span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="dv">90</span>, <span class="at">y =</span> <span class="dv">1500</span>, </span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Region (Node) 7"</span>, </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="P01-random-forest_files/figure-html/viz-tree-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>An algorithm called recursive binary splitting is used to split the predictor space like the example above. Suppose you have K explanatory variables (<span class="math inline">\(X_1, \dots, X_K\)</span>). Further, let <span class="math inline">\(c\)</span> denote the threshold that splits the sample into two regions such that {<span class="math inline">\(X|X_k &lt; c\)</span>} and {<span class="math inline">\(X|X_k \geq c\)</span>}.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>{<span class="math inline">\(X|X_k &lt; c\)</span>} means observations that satisfy the condition stated right to the vertical bar (|). Here, it means all the observations for which its <span class="math inline">\(X_k\)</span> value is less than <span class="math inline">\(c\)</span>.</p>
</div></div><ul>
<li>Step 1: For each of the covariates (<span class="math inline">\(X_1\)</span> through <span class="math inline">\(X_K\)</span>), find all the threshold values that result in <span style="color:blue"> unique</span> splits.</li>
<li>Step 2: For each of the covariate-threshold combinations, calculate the sum of the squared residuals of its resulting split, and find the threshold value with the lowest sum of the squared residuals by covariate.</li>
<li>Step 3: Among all the best splits by covariate (as many as the number of explanatory variables), pick the variable-threshold combination that leads to the lowest sum of the squared residuals.</li>
</ul>
<p>The data is then split according to the chosen criteria and then the same process is repeated for each of the branches, ad infinitum until the user-specified stopping criteria is met. This way of splitting is called a <strong>greedy</strong> (or I would call it myopic or shortsighted) approach because the split is sought to minimize the immediate RSS without considering the implication of the split for the later splits.</p>
<p>Let’s try to write this process for the first split from the beginning node using the <code>mlb1</code> data as an illustration based on a simple grid search to find the optimal thresholds (Step 1).</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>Note that the R codes here are deliberately inefficient as they focus on illustrating the process.</p>
</div></div><div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== get data ===#</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(wooldridge)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(mlb1)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>mlb1_dt <span class="ot">&lt;-</span> </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  mlb1 <span class="sc">%&gt;%</span> </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>() <span class="sc">%&gt;%</span> <span class="co"># turn into data.table </span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  .[, salary <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>] <span class="sc">%&gt;%</span> <span class="co"># remove salary (use lsalary instead)</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="co"># remove observations with NA in any of the variables</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s work on splitting based on <code>hruns</code>. One way to find the all the threshold values is simply find the mean of two consecutive numbers from the ordered unique <code>hruns</code> values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>value_seq <span class="ot">&lt;-</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== order hruns values and find the unique values ===#</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  mlb1_dt[<span class="fu">order</span>(hruns), <span class="fu">unique</span>(hruns)] <span class="sc">%&gt;%</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== get the rolling mean ===#</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">frollmean</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  .[<span class="sc">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-thre">Figure&nbsp;<span>6.1</span></a> shows all the threshold values (blue lines) stored in <code>value_seq</code> that result in unique splits.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>threshold_data <span class="ot">&lt;-</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(<span class="at">thre =</span> value_seq) <span class="sc">%&gt;%</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  .[, id <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span><span class="sc">:</span>.N]</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mlb1_dt) <span class="sc">+</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> lsalary, <span class="at">x =</span> hruns)) <span class="sc">+</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> threshold_data, </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">xintercept =</span> thre), </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"blue"</span>, </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">0.2</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> value_seq[[<span class="dv">50</span>]], <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> value_seq[[<span class="dv">70</span>]], <span class="at">color =</span> <span class="st">"orange"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-thre" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="P01-random-forest_files/figure-html/fig-thre-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Figure 6.1: All the threshold values when splitting based on <code>hruns</code></figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>For each value in <code>value_seq</code>, we find RSS. For example, for the 50th value in <code>value_seq</code> (the red line in <a href="#fig-thre">Figure&nbsp;<span>6.1</span></a>),</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">copy</span>(mlb1_dt) <span class="sc">%&gt;%</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== find the mean of lsalary by whether hruns is less than the threshold or not ===#</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  .[, y_hat <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(lsalary), by <span class="ot">=</span> (hruns <span class="sc">&lt;</span> value_seq[<span class="dv">50</span>])] <span class="sc">%&gt;%</span> </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== get squared residuals ===#</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  .[, (lsalary <span class="sc">-</span> y_hat)<span class="sc">^</span><span class="dv">2</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== get RSS ===#</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 291.1279</code></pre>
</div>
</div>
<p>How about 70th value in <code>value_seq</code> (the orange line in <a href="#fig-thre">Figure&nbsp;<span>6.1</span></a>)?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">copy</span>(mlb1_dt) <span class="sc">%&gt;%</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== find the mean of lsalary by whether hruns is less than the threshold or not ===#</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  .[, y_hat <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(lsalary), by <span class="ot">=</span> (hruns <span class="sc">&lt;</span> value_seq[<span class="dv">70</span>])] <span class="sc">%&gt;%</span> </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== get squared residuals ===#</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  .[, (lsalary <span class="sc">-</span> y_hat)<span class="sc">^</span><span class="dv">2</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== get RSS ===#</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 322.3688</code></pre>
</div>
</div>
<p>This means <code>value_seq[50]</code> (49.5) is a better threshold than <code>value_seq[70]</code> (79.5).</p>
<p>Okay, let’s consider all the candidate threshold values now, not just 50th and 70th, and then pick the best.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>get_rss <span class="ot">&lt;-</span> <span class="cf">function</span>(i, var_name, value_seq, data)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  rss <span class="ot">&lt;-</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">copy</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setnames</span>(var_name, <span class="st">"var"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    .[, y_hat <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(lsalary), by <span class="ot">=</span> (var <span class="sc">&lt;</span> value_seq[i])] <span class="sc">%&gt;%</span> </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    .[, (lsalary <span class="sc">-</span> y_hat)<span class="sc">^</span><span class="dv">2</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>()</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  return_data <span class="ot">&lt;-</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.table</span>(</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">rss =</span> rss,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">var_name =</span> var_name,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">var_value =</span> value_seq[i]</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(return_data)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here are RSS values at every value in <code>value_seq</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>rss_value <span class="ot">&lt;-</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq_len</span>(<span class="fu">length</span>(value_seq)),</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">get_rss</span>(x, <span class="st">"hruns"</span>, value_seq, mlb1_dt) </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>()</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(rss_value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        rss var_name var_value
1: 396.8287    hruns       0.5
2: 383.2393    hruns       1.5
3: 362.5779    hruns       2.5
4: 337.0760    hruns       3.5
5: 325.4865    hruns       4.5
6: 309.2780    hruns       5.5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(rss_value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        rss var_name var_value
1: 437.6865    hruns     279.0
2: 440.0806    hruns     291.5
3: 441.9307    hruns     348.0
4: 437.6143    hruns     398.5
5: 441.0689    hruns     406.5
6: 443.3740    hruns     423.0</code></pre>
</div>
</div>
<p>Finding the threshold value that minimizes RSS,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>rss_value[<span class="fu">which.min</span>(rss), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        rss var_name var_value
1: 259.7855    hruns      27.5</code></pre>
</div>
</div>
<p>Okay, so, the best threshold for <code>hruns</code> is 27.5</p>
<p>Suppose we are considering only five explanatory variables in building a regression tree: <code>hruns</code>, <code>years</code>, <code>rbisyr</code>, <code>allstar</code>, <code>runsyr</code>, <code>hits</code>, and <code>bavg</code>. We do the same operations we did for <code>hruns</code> for all the variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>get_rss_by_var <span class="ot">&lt;-</span> <span class="cf">function</span>(var_name, data)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  temp_data <span class="ot">&lt;-</span> </span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">copy</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setnames</span>(var_name, <span class="st">"temp_var"</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== define a sequence of values of hruns ===#</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  value_seq <span class="ot">&lt;-</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    temp_data[<span class="fu">order</span>(temp_var), <span class="fu">unique</span>(temp_var)] <span class="sc">%&gt;%</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">#=== get the rolling mean ===#</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">frollmean</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    .[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setnames</span>(temp_data, <span class="st">"temp_var"</span>, var_name)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== get RSS ===#</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>  rss_value <span class="ot">&lt;-</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">seq_len</span>(<span class="fu">length</span>(value_seq)),</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">function</span>(x) <span class="fu">get_rss</span>(x, var_name, value_seq, temp_data) </span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbindlist</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    .[<span class="fu">which.min</span>(rss),]</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(rss_value)</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Looping over the set of variables,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>min_rss_by_var <span class="ot">&lt;-</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"hruns"</span>, <span class="st">"years"</span>, <span class="st">"rbisyr"</span>, <span class="st">"allstar"</span>, <span class="st">"runsyr"</span>, <span class="st">"hits"</span>, <span class="st">"bavg"</span>),</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">get_rss_by_var</span>(x, mlb1_dt)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>()</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        rss var_name  var_value
1: 259.7855    hruns  27.500000
2: 249.9090    years   3.500000
3: 261.1537   rbisyr  31.794642
4: 277.3388  allstar   7.417582
5: 249.5106   runsyr  37.666666
6: 205.1488     hits 356.500000
7: 375.0281     bavg 252.499992</code></pre>
</div>
</div>
<p>So, the variable-threshold combination that minimizes RSS is hits - 356.5. We now have the first split. This tree is developed further by splitting nodes like this.</p>
</section>
<section id="sec-split-sim" class="level3 page-columns page-full" data-number="6.1.2">
<h3 data-number="6.1.2" class="anchored" data-anchor-id="sec-split-sim"><span class="header-section-number">6.1.2</span> A note on splitting algorithm</h3>
<p>Minimizing RSS is equivalent to <span style="color:blue"> maximize </span> the sum of <span style="color:blue"> similarity score </span>from the two splits. Let <span class="math inline">\(C_1(r)\)</span> and <span class="math inline">\(C_2(r)\)</span> denote the set of observations that belong to the first and second splits, respectively given splitting rule <span class="math inline">\(r\)</span>. For a given split combination <span class="math inline">\(C_1(r)\)</span> and <span class="math inline">\(C_2(r)\)</span>, the estimators for the two splits are simply the average value of <span class="math inline">\(Y\)</span> in the respective splits. Denoting the means as <span class="math inline">\(\hat{\mu}_1\)</span> and <span class="math inline">\(\hat{\mu}_2\)</span>, minimizing RSS can be written as</p>
<p><span id="eq-rss-min"><span class="math display">\[
\begin{aligned}
\min_r \sum_{i\in C_1} (\hat{\mu}_1 - Y_i)^2 + \sum_{i\in C_2} (\hat{\mu}_2 - Y_i)^2
\end{aligned}
\tag{6.1}\]</span></span></p>

<div class="no-row-height column-margin column-container"><div class="">
<p><span class="math inline">\(\hat{\mu}_k = \frac{\sum_{i\in C_k} Y_i}{N_k}\)</span>, where <span class="math inline">\(N_k\)</span> is the number of observations in <span class="math inline">\(C_k\)</span>.</p>
</div></div><p>Now, in general, the following holds</p>
<p><span class="math display">\[
\begin{aligned}
\sum_{i\in C_k} (\hat{\mu}_k - Y_i)^2 = \sum_{i\in C_k} Y_i^2 - \sum_{i\in C_k} \hat{\mu}_k^2
\end{aligned}
\]</span></p>
<p>So, <a href="#eq-rss-min">Equation&nbsp;<span>6.1</span></a> can be rewritten as</p>
<p><span class="math display">\[
\begin{aligned}
\min_r \sum_{i\in C_1(r)} Y_i^2 + \sum_{i\in C_2(r)} Y_i^2 - (\sum_{i\in C_1(r)} \hat{\mu}_1^2 + \sum_{i\in C_2(r)} \hat{\mu}_2^2)
\end{aligned}
\]</span></p>
<p>Since <span class="math inline">\(\sum_{i\in C_1(r)} Y_i^2 + \sum_{i\in C_2(r)} Y_i^2\)</span> is always the same, it can be further reduced to</p>
<p><span id="eq-min-score"><span class="math display">\[
\begin{aligned}
&amp; \min_r - N_1 (\frac{\sum_{i\in C_1(r)} Y_i}{N_1})^2 - N_2 (\frac{\sum_{i\in C_2(r)} Y_i}{N_2})^2 \\
\Rightarrow &amp; \min_r - \frac{(\sum_{i\in C_1(r)} Y_i)^2}{N_1} - \frac{(\sum_{i\in C_2(r)} Y_i)^2}{N_2}
\end{aligned}
\tag{6.2}\]</span></span></p>
<p>where <span class="math inline">\(N_1\)</span> and <span class="math inline">\(N_2\)</span> are the number of observations in <span class="math inline">\(C_1\)</span> and <span class="math inline">\(C_2\)</span>, respectively. <span class="math inline">\(\frac{(\sum_{i\in C_k} Y_i)^2}{N_k}\)</span> is called <span style="color:blue"> similarity score </span>. The name comes from the fact that the more similar element in <span class="math inline">\(C_k\)</span> are, the higher the score is. Consider for example, a four-observation case where their values of the dependent variable are <span class="math inline">\(\{3, 2, -1, -2\}\)</span>. For the split <span class="math inline">\(\{3, 2\}\)</span>, <span class="math inline">\(\{-1, -2\}\)</span>, the similarity score is <span class="math inline">\(17 (=25/2 + 9/2)\)</span>. However, if the split is <span class="math inline">\(\{2, -2\}\)</span>, <span class="math inline">\(\{3, -1\}\)</span>, then the score is <span class="math inline">\(2 (=0/2 + 4/2)\)</span>. Since summation happens first and then the sum is squared, the more similar the elements are, the higher the score is.</p>
<p><a href="#eq-min-score">Equation&nbsp;<span>6.2</span></a> can be reformulated as the maximization problem with the objective function being the sum of the similarity scores from the two splits.</p>
<p><span id="eq-max-score"><span class="math display">\[
\begin{aligned}
\textcolor{red}{\max}_r \frac{(\sum_{i\in C_1(r)} Y_i)^2}{N_1} + \frac{(\sum_{i\in C_2(r)} Y_i)^2}{N_2}
\end{aligned}
\tag{6.3}\]</span></span></p>
<p>Note that it is much more computationally efficient to solve this maximization problem than the RSS minimization problem (<a href="#eq-rss-min">Equation&nbsp;<span>6.1</span></a>). In the RSS minimization problem, for each split, you calculate the mean, subtract it from <span class="math inline">\(Y_i\)</span> for all the observations, square them and sum them. On the other hand, in the similarity score maximization problem, you can simply sum <span class="math inline">\(Y_i\)</span> and then square it for each split. So, programatically, tree building is done using <a href="#eq-max-score">Equation&nbsp;<span>6.3</span></a>. You can also see the use of <a href="#eq-max-score">Equation&nbsp;<span>6.3</span></a> in the extreme gradient boosting algorithm (<a href="P03-xgb.html"><span>Chapter&nbsp;8</span></a>) and also in the implementation of GRF (<a href="E02-grf.html"><span>Chapter&nbsp;17</span></a>).</p>
</section>
<section id="training-a-regression-tree" class="level3" data-number="6.1.3">
<h3 data-number="6.1.3" class="anchored" data-anchor-id="training-a-regression-tree"><span class="header-section-number">6.1.3</span> Training a regression tree</h3>
<p>You can fit a regression tree using <code>rpart()</code> from the <code>rpart</code> package. Its syntax is similar to that of <code>lm()</code> for a quick fitting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart</span>(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  formula,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  data</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Using <code>mlb1</code>, let’s fit a regression tree where <code>lsalary</code> is the dependent variable and <code>hruns</code>, <code>years</code>, <code>rbisyr</code>, <code>allstar</code>, <code>runsyr</code>, <code>hits</code>, and <code>bavg</code> are the explanatory variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== fit a tree ===#</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>fitted_tree <span class="ot">&lt;-</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rpart</span>(</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    lsalary <span class="sc">~</span> hruns <span class="sc">+</span> years <span class="sc">+</span> rbisyr <span class="sc">+</span> allstar <span class="sc">+</span> runsyr <span class="sc">+</span> hits <span class="sc">+</span> bavg, </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> mlb1_dt</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is the visualization of the fitted tree using <code>fancyRpartPlot()</code> from the <code>rattle</code> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fancyRpartPlot</span>(fitted_tree)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="P01-random-forest_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now, you may wonder why <code>rpart()</code> is not building a tree that has as many leaves as the number of observations so that we have a perfect prediction for the train data (<code>mlb1</code>). If we are simply implementing recursive binary splitting, then it should not have stopped where it stopped. This is because <code>rpart()</code> sets parameter values that control the development of a tree by default. Those default parameters can be seen below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.control</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$minsplit
[1] 20

$minbucket
[1] 7

$cp
[1] 0.01

$maxcompete
[1] 4

$maxsurrogate
[1] 5

$usesurrogate
[1] 2

$surrogatestyle
[1] 0

$maxdepth
[1] 30

$xval
[1] 10</code></pre>
</div>
</div>
<p>For example, <code>minsplit</code> is the minimum number of observations that must exist in a node in order for a split to be attempted. <code>cp</code> refers to the complexity parameter. For a given value of <code>cp</code>, a tree is build to minimize the following:</p>
<p><span class="math display">\[
\sum_{t=1}^T\sum_{x_i\in R_t} (y_i - \hat{y}_{R_t})^2 + cp\cdot T
\]</span></p>
<p>where <span class="math inline">\(R_t\)</span> is the <span class="math inline">\(t\)</span>th region and <span class="math inline">\(\hat{y_{R_t}}\)</span> is the estimate of <span class="math inline">\(y\)</span> for all the observations that reside in <span class="math inline">\(R_t\)</span>. So, the first term is RSS. The objective function has a penalization term (the second term) just like shrinkage methods we saw in <a href="B04-regularization.html#sec-shrinkage"><span>Section&nbsp;4.1</span></a>. A higher value of <code>cp</code> leads to a less complex tree with less leaves.</p>
<p>If you want to build a much deeper tree that has many leaves, then you can do so using the <code>control</code> option like below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>full_tree <span class="ot">&lt;-</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rpart</span>(</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    lsalary <span class="sc">~</span> hruns <span class="sc">+</span> years <span class="sc">+</span> rbisyr <span class="sc">+</span> allstar <span class="sc">+</span> runsyr <span class="sc">+</span> hits <span class="sc">+</span> bavg, <span class="co"># formula</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> mlb1_dt, <span class="co"># data</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="co"># control of the hyper parameters</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rpart.control</span>(</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">minsplit =</span> <span class="dv">2</span>, </span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">cp =</span> <span class="dv">0</span> <span class="co"># complexity parameter</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s see how amazing this tree is by comparing the observed and fitted <code>lsalary</code> values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== get fitted values ===#</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>mlb1_dt[, y_hat <span class="sc">:</span><span class="er">=</span> <span class="fu">predict</span>(full_tree, <span class="at">newdata =</span> mlb1_dt)]</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== visualize the fit ===#</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> mlb1_dt) <span class="sc">+</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> lsalary, <span class="at">x =</span> y_hat)) <span class="sc">+</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="P01-random-forest_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Yes, perfect prediction accuracy! At least for the train data anyway. But, we all know we want nothing to do with this kind of model. It is clearly over-fitting the train data.</p>
<p>In order to find a reasonable model, we can use KCV over <code>cp</code>. Fortunately, when we run <code>rpart()</code>, it automatically builds multiple trees at different values of <code>cp</code> that controls the number of leaves and conduct KCV. You can visualize this using <code>plotcp()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotcp</span>(fitted_tree)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="P01-random-forest_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>MSE and <code>cp</code> are presented on the y- and x-axis, respectively. According to the KCV results, <code>cp</code> <span class="math inline">\(= 0.018\)</span> provides the tree with the smallest number of leaves (the most simple) where the MSE value is within one standard deviation from the lowest MSE. You can access the tree built under <code>cp</code> <span class="math inline">\(= 0.018\)</span> like below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== get the best tree ===#</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>best_tree <span class="ot">&lt;-</span> <span class="fu">prune</span>(full_tree, <span class="at">cp =</span> <span class="fl">0.018</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== visualize it ===#</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="fu">fancyRpartPlot</span>(best_tree)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="P01-random-forest_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Even though how a regression tree is build in R. In practice, you never use a regression tree itself as the final model for your research as its performance is rather poor and tend to over-fit compared to other competitive methods. But, understanding how building a regression tree is important to understand its derivatives like random forest, boosted regression forest.</p>
</section>
</section>
<section id="sec-rf" class="level2 page-columns page-full" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="sec-rf"><span class="header-section-number">6.2</span> Random Forest (RF)</h2>
<p>Regression tree approach is often not robust and suffers from high variance. Here, we look at the process called <span style="color:blue"> bagging </span> and how it can be used to train RF model, which is much more robust than a regression tree.</p>
<section id="bagging-bootstrap-averaging" class="level3 page-columns page-full" data-number="6.2.1">
<h3 data-number="6.2.1" class="anchored" data-anchor-id="bagging-bootstrap-averaging"><span class="header-section-number">6.2.1</span> Bagging (Bootstrap Averaging)</h3>
<p>Before talking about how RF is trained. Let’s first talk about the concept of bagging. Let <span class="math inline">\(\theta(X)\)</span> denote the statistics of interest you would like to estimate from the data. Bagging (Bootstrap averaging) works like this:</p>
<ol type="1">
<li>Bootstrap the data many times</li>
<li>Estimate <span class="math inline">\(\theta(X)\)</span> for each of the bootstrapped datasets (<span class="math inline">\(\hat{\theta}_1, \dots, \hat{\theta}_B\)</span>)</li>
<li>Average the estimates and use it as the final estimate of <span class="math inline">\(\theta(X)\)</span>.</li>
</ol>
<p><span class="math display">\[
\hat{\theta}(X) = \frac{\hat{\theta}_1(X) + \dots + \hat{\theta}_B(X)}{B}
\]</span></p>
<p>To understand the power of bagging, we need to understand the power of averaging and when it is most effective using a very simple example of estimating the expected value of a random variable.</p>
<p>Consider two random variables <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> from the identical distribution, where <span class="math inline">\(E[x_i] = \alpha\)</span> and <span class="math inline">\(Var(x_i) = \sigma^2\)</span>. You are interested in estimating <span class="math inline">\(E[x_i]\)</span>. We have two options:</p>
<ul>
<li>Option 1: Use <span class="math inline">\(x_1\)</span> as the estimate of <span class="math inline">\(E[x_i]\)</span>.</li>
<li>Option 2: Use the mean of <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> as the estimate of <span class="math inline">\(E[x_i]\)</span></li>
</ul>
<p>The variance of the first estimator is of course simply the variance of <span class="math inline">\(x_1\)</span>, so <span class="math inline">\(\sigma^2\)</span>.</p>
<p>For option 2, we know the following relationship holds in general:</p>
<p><span class="math display">\[
\begin{aligned}
Var(\frac{x_1 + x_2}{2}) &amp; = \frac{Var(x_1)}{4} + \frac{Var(x_2)}{4} + \frac{Cov(x_1, x_2)}{2} \\
&amp; = \frac{\sigma^2}{2} + \frac{Cov(x_1, x_2)}{2}
\end{aligned}
\]</span></p>
<p>So, how good the mean of <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> as an estimator depends on <span class="math inline">\(Cov(x_1, x_2)\)</span>. When they are perfectly positively correlated, then <span class="math inline">\(Cov(x_1, x_2) = Var(x_1) = \sigma^2\)</span>. So, <span class="math inline">\(Var(\frac{x_1 + x_2}{2})\)</span> is <span class="math inline">\(\sigma^2\)</span>, which is no better than option 1.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>This makes sense because adding information from one more variable that is perfectly correlated with the other variable does nothing because they are the same values.</p>
</div></div><p>However, as long as <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> are not perfectly correlated, option 2 is better. The benefit of averaging is greater when the value of <span class="math inline">\(Cov(x_1, x_2)\)</span> is smaller.</p>
<p>Let’s do a little experiment to see this. We consider four approaches:</p>
<ul>
<li>Approach 0: use <span class="math inline">\(x_1\)</span> as the estimator</li>
<li>Approach 1: use <span class="math inline">\((x_1 + x_2)/2\)</span> as the estimator (<span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> are independent)</li>
<li>Approach 2: use <span class="math inline">\((x_1 + x_2)/2\)</span> as the estimator (<span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> are positively correlated)</li>
<li>Approach 3: use <span class="math inline">\((x_1 + x_2)/2\)</span> as the estimator (<span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> are negatively correlated)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== set the number of observations to 1000 ===#</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">1000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== first approach (no correlation) ===#</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>x_1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>x_2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(x_1, x_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.01441585</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== second approach (positively correlated) ===#</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>x_1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>x_2 <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> x_1 <span class="sc">+</span> <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">-</span>(<span class="fl">0.5</span>)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">*</span> <span class="fu">rnorm</span>(N)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(x_1, x_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5164931</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== third approach (negatively correlated) ===#</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>x_1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>x_2 <span class="ot">&lt;-</span> <span class="sc">-</span> <span class="fl">0.8</span> <span class="sc">*</span> x_1 <span class="sc">-</span> <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">-</span>(<span class="fl">0.8</span>)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">*</span> <span class="fu">rnorm</span>(N)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(x_1, x_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.7944112</code></pre>
</div>
</div>
<p>The following function runs a single iteration of estimating <span class="math inline">\(E[x]\)</span> using the four approaches.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>get_alpha <span class="ot">&lt;-</span> <span class="cf">function</span>(i)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== approach 0 ===#</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  alpha_hat_0 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== approach 1 (no correlation) ===#</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  x_1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  x_2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>  alpha_hat_1 <span class="ot">&lt;-</span> (x_1 <span class="sc">+</span> x_2) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== approach 2 (positively correlated) ===#</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  x_1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>  x_2 <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> x_1 <span class="sc">+</span> <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">-</span>(<span class="fl">0.5</span>)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">*</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>  alpha_hat_2 <span class="ot">&lt;-</span> (x_1 <span class="sc">+</span> x_2) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== approach 3 (negatively correlated) ===#</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>  x_1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>  x_2 <span class="ot">&lt;-</span> <span class="sc">-</span> <span class="fl">0.8</span> <span class="sc">*</span> x_1 <span class="sc">-</span> <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">-</span>(<span class="fl">0.8</span>)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">*</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>  alpha_hat_3 <span class="ot">&lt;-</span> (x_1 <span class="sc">+</span> x_2) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>  return_data <span class="ot">&lt;-</span></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.table</span>(</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">alpha_hat_0 =</span> alpha_hat_0,</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">alpha_hat_1 =</span> alpha_hat_1,</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">alpha_hat_2 =</span> alpha_hat_2,</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">alpha_hat_3 =</span> alpha_hat_3</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(return_data)</span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>} </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is the results of single iteration.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_alpha</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   alpha_hat_0 alpha_hat_1 alpha_hat_2 alpha_hat_3
1: -0.07877955   0.2331667    0.816512 -0.09266395</code></pre>
</div>
</div>
<p>Repeating this many times,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">234934</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>sim_results <span class="ot">&lt;-</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>,</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    get_alpha</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">melt</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-mc-simple">Figure&nbsp;<span>6.2</span></a> shows the density plot of the estimates from the four approaches.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>sim_results <span class="sc">%&gt;%</span> </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  .[, label <span class="sc">:</span><span class="er">=</span> <span class="fu">gsub</span>(<span class="st">"alpha_hat_"</span>, <span class="st">"Approach "</span>, variable)] <span class="sc">%&gt;%</span> </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">data =</span> .) <span class="sc">+</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_density</span>(</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> label), </span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">alpha =</span> <span class="fl">0.5</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete</span>(<span class="at">name =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-mc-simple" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="P01-random-forest_files/figure-html/fig-mc-simple-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Figure 6.2: Results of simple MC simulations to estimate the expected value of x</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>As you can see, they are all pretty much unbiased. However, all the approaches that average two values (approaches 1, 2, and 3) outperformed the base approach that relied on a single value each iteration. You can see that when the random variables are negatively correlated, the power of averaging is greater compared to when they are independent or positively correlated. The independent approach (approach 1) is better than the positive correlation approach (approach 2).</p>
<p>Now that we understand the power of bagging, let’s apply this to a regression problem using a tree. The statistics of interest is <span class="math inline">\(E[y|X]\)</span>, which is denoted as <span class="math inline">\(f(x)\)</span>.</p>
<ol type="1">
<li>Bootstrap the data <span class="math inline">\(B\)</span> times</li>
<li>Train a regression tree to each of the bootstrapped dataset, which results in <span class="math inline">\(B\)</span> distinctive trees</li>
<li>To predict <span class="math inline">\(E[y|x]\)</span>, average the estimate from all the trees (<span class="math inline">\(\hat{f}_1(x), \dots, \hat{f}_B(x)\)</span>) and use it as the final estimate.</li>
</ol>
<p><span class="math display">\[
\hat{f}(x) = \frac{\hat{f}_1(X) + \dots + \hat{f}_B(X)}{B}
\]</span></p>
<p>Let’s implement this for <span class="math inline">\(B = 10\)</span> using <code>mlb1_dt</code>. First, define a function that bootstrap data, fit a regression tree, and then return the fitted values (a single iteration).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>train_a_tree <span class="ot">&lt;-</span> <span class="cf">function</span>(i, data)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== number of observations ===#</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== bootstrapped data ===#</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  boot_data <span class="ot">&lt;-</span> data[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>N, N, <span class="at">replace =</span> <span class="cn">TRUE</span>), ]</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== train a regression tree ===#</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>  rpart <span class="ot">&lt;-</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rpart</span>(</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>      lsalary <span class="sc">~</span> hruns <span class="sc">+</span> years <span class="sc">+</span> rbisyr <span class="sc">+</span> allstar <span class="sc">+</span> runsyr <span class="sc">+</span> hits <span class="sc">+</span> bavg, </span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> boot_data</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== predict ===#</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>  return_data <span class="ot">&lt;-</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">copy</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>    .[, y_hat <span class="sc">:</span><span class="er">=</span> <span class="fu">predict</span>(rpart, <span class="at">newdata =</span> data)] <span class="sc">%&gt;%</span> </span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>    .[, .(id, y_hat)] <span class="sc">%&gt;%</span> </span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>    .[, tree <span class="sc">:</span><span class="er">=</span> i] </span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(return_data)</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We now repeat <code>train_a_tree()</code> 10 times.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== create observation id for later group-by averaging ===#</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>mlb1_dt[, id <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span><span class="sc">:</span>.N]</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>y_estimates <span class="ot">&lt;-</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">train_a_tree</span>(x, mlb1_dt) </span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  .[<span class="fu">order</span>(id),]</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       id    y_hat tree
   1:   1 15.15792    1
   2:   1 15.04446    2
   3:   1 15.21238    3
   4:   1 15.07311    4
   5:   1 14.92840    5
  ---                  
3296: 330 11.98177    6
3297: 330 12.09743    7
3298: 330 12.02678    8
3299: 330 12.02287    9
3300: 330 12.02302   10</code></pre>
</div>
</div>
<p>By averaging <span class="math inline">\(y\)</span> estimates by <code>id</code>, we can get bagging estimates.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>y_estimates[, <span class="fu">mean</span>(y_hat), by <span class="ot">=</span> id]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      id       V1
  1:   1 15.09137
  2:   2 14.66143
  3:   3 14.61425
  4:   4 14.31035
  5:   5 13.74852
 ---             
326: 326 13.04455
327: 327 12.79717
328: 328 12.79717
329: 329 13.67179
330: 330 12.02051</code></pre>
</div>
</div>
<p>This is bagging of many regression trees.</p>
</section>
<section id="random-forest-rf" class="level3" data-number="6.2.2">
<h3 data-number="6.2.2" class="anchored" data-anchor-id="random-forest-rf"><span class="header-section-number">6.2.2</span> Random Forest (RF)</h3>
<p>Now, let’s take a look at the individual estimates of <span class="math inline">\(y\)</span> for the first observation from the bagging process we just implemented.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>y_estimates[id <span class="sc">==</span> <span class="dv">1</span>, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    id    y_hat tree
 1:  1 15.15792    1
 2:  1 15.04446    2
 3:  1 15.21238    3
 4:  1 15.07311    4
 5:  1 14.92840    5
 6:  1 14.98571    6
 7:  1 15.12060    7
 8:  1 15.14064    8
 9:  1 15.05676    9
10:  1 15.19375   10</code></pre>
</div>
</div>
<p>Hmm, the estimates look very similar. Actually, that is not just of the observations with <code>id == 1</code>. This is because the trained trees are very similar for many reasons, and the trees are highly “positively” correlated with each other. From our very simple experiment above, we know that the power of bagging is not very high when that is the case.</p>
<p>RF introduces additional uncertainty to the process to make trees less correlated with each other (<em>decorrelate</em> trees). Specifically, for any leave of any tree, they consider only a randomly select subset of the explanatory variables when deciding how to split a leave. A typical choice of the number of variables considered at each split is <span class="math inline">\(\sqrt{K}\)</span>, where <span class="math inline">\(K\)</span> is the number of the included explanatory variables. In the naive example above, all <span class="math inline">\(K\)</span> variables are considered for all the split decisions of all the trees. Some variables are more influential than others and they get to be picked as the splitting variable at similar places, which can result in highly correlated trees. Instead, RF gives other variables a chance, which helps decorrelate the trees. This means that the tree we build in RF is not deterministic. Depending on which variables are selected for consideration in splitting, the tree will be different even if you use the same bootstrapped dataset.</p>
<p>Let’s code the process of building a tree for RF. We first bootstrap a dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>n_obs <span class="ot">&lt;-</span> <span class="fu">nrow</span>(mlb1_dt)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>boot_data <span class="ot">&lt;-</span> mlb1_dt[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>n_obs, n_obs, <span class="at">replace =</span> <span class="cn">TRUE</span>), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now build a tree using <code>boot_data</code>. We first split the entire dataset into two.</p>
<p>We can use <code>get_rss_by_var()</code> we wrote earlier, which gets us RSS-minimizing threshold and the minimized RSS value for a single variable. Earlier when we build a regression tree, we looped over all the explanatory variables, which are <code>hruns</code>, <code>years</code>, <code>rbisyr</code>, <code>allstar</code>, <code>runsyr</code>, <code>hits</code>, and <code>bavg</code>. But, when building a tree in RF, you can choose to select just a subset of the variables. Here, let’s randomly select <span class="math inline">\(\sqrt{K}\)</span> variables. So, rounding <span class="math inline">\(\sqrt{7}\)</span>, we have three.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>var_list <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"hruns"</span>, <span class="st">"years"</span>, <span class="st">"rbisyr"</span>, <span class="st">"allstar"</span>, <span class="st">"runsyr"</span>, <span class="st">"hits"</span>, <span class="st">"bavg"</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>K <span class="ot">&lt;-</span> <span class="fu">length</span>(var_list)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>K_for_split <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(K) <span class="sc">%&gt;%</span> <span class="fu">round</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We randomly select three variables among the list of variables (<code>var_list</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>vars_for_split <span class="ot">&lt;-</span> <span class="fu">sample</span>(var_list, K_for_split, <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "years"   "bavg"    "allstar"</code></pre>
</div>
</div>
<p>You only consider these 3 variables in this splitting process.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>min_rss_by_var <span class="ot">&lt;-</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    vars_for_split,</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">get_rss_by_var</span>(x, mlb1_dt)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>()</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        rss var_name  var_value
1: 249.9090    years   3.500000
2: 375.0281     bavg 252.499992
3: 277.3388  allstar   7.417582</code></pre>
</div>
</div>
<p>So, our choice of split criteria is</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>min_rss_by_var[<span class="fu">which.min</span>(rss), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       rss var_name var_value
1: 249.909    years       3.5</code></pre>
</div>
</div>
<p>You will repeat this process for any splits you consider until you met the stopping criteria.</p>
<p>By the way, if we were to use all the variables instead of just these three, then we would have use the following criteria.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    var_list,</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">get_rss_by_var</span>(x, mlb1_dt)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  .[<span class="fu">which.min</span>(rss), ]</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        rss var_name var_value
1: 205.1488     hits     356.5</code></pre>
</div>
</div>
</section>
</section>
<section id="implementation" class="level2 page-columns page-full" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="implementation"><span class="header-section-number">6.3</span> Implementation</h2>
<p>We can use <code>ranger()</code> from the <code>ranger</code> package to train an RF model. Another commonly used R package for RF is the <code>randomForest</code> package. However, <code>ranger()</code> is much faster.</p>
<p>The <code>ranger()</code> function has many options you can specify that determine how trees are built. Here are some of the important ones (see <a href="https://cran.r-project.org/web/packages/ranger/ranger.pdf">here</a> for the complete description of the hyper-parameters.):</p>
<ul>
<li><code>mtry</code>: the number of variables considered in each split (default is the square root of the total numbers of explanatory variables rounded down.)</li>
<li><code>num.trees</code>: the number of tree to be built (default is 500)</li>
<li><code>min.node.size</code>: minimum number of observations in each node (default varies based on the the type of analysis)</li>
<li><code>replace</code>: where sample with or without replacement when bootstrapping samples (default is <code>TRUE</code>)</li>
<li><code>sample.fraction</code>: the fraction of the entire observations that are used in each tree (default is 1 if sampling with replacement, 0.632 if sampling without replacement)</li>
</ul>

<div class="no-row-height column-margin column-container"><div class="">
<p>By setting <code>replace = FALSE</code>, you will only use a fraction (randomly selected) of the entire sample in building each tree. This is an alternative to the algorithm discussed earlier, which uses bootstrapped (sample with replacement) dataset to build each tree.</p>
</div></div><p>Let’s try fitting an RF with <code>ranger()</code> with the default parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== load the package ===#</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== fit and RF ===#</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>rf_fit <span class="ot">&lt;-</span> </span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ranger</span>(</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    lsalary <span class="sc">~</span> hruns <span class="sc">+</span> years <span class="sc">+</span> rbisyr <span class="sc">+</span> allstar <span class="sc">+</span> runsyr <span class="sc">+</span> hits <span class="sc">+</span> bavg, </span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> mlb1_dt</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Ranger result

Call:
 ranger(lsalary ~ hruns + years + rbisyr + allstar + runsyr +      hits + bavg, data = mlb1_dt) 

Type:                             Regression 
Number of trees:                  500 
Sample size:                      330 
Number of independent variables:  7 
Mtry:                             2 
Target node size:                 5 
Variable importance mode:         none 
Splitrule:                        variance 
OOB prediction error (MSE):       0.3640505 
R squared (OOB):                  0.7308852 </code></pre>
</div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>Since we have many trees, it is no longer possible to have a nice graphical representation of the trained RF model like we did with a regression tree.</p>
</div></div><p>In the output, you can see <code>OOB prediction error (MSE)</code>. OOB stands for <span style="color:red"> o</span>ut-<span style="color:red">o</span>f-<span style="color:red">b</span>ag. When bootstrapping, some of the train data will not be used to build a tree.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== bootstrapped data ===#</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>boot_data <span class="ot">&lt;-</span> mlb1_dt[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>n_obs, n_obs, <span class="at">replace =</span> <span class="cn">TRUE</span>), ]</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== which rows (observations) from the original datasets are missing? ===#</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>mlb1_dt[, id <span class="sc">%in%</span> <span class="fu">unique</span>(boot_data<span class="sc">$</span>id)] <span class="sc">%&gt;%</span> <span class="fu">mean</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.630303</code></pre>
</div>
</div>
<p>So, only <span class="math inline">\(65\%\)</span> of the rows from the original data (<code>mlb1_dt</code>) in this bootstrapped sample (many duplicates of the original observations). The observations that are NOT included in the bootstrapped sample is called out-of-bag observations. This provides a great opportunity to estimate test MSE while training an RF model! For a given regression tree, you can apply it to the out-of-bag samples to calculate MSE. You can repeat this for all the trees and average the MSEs, effectively conducting cross-validation. When the number of trees is large enough, OOB MSE is almost equivalent to MSE from LOOCV <span class="citation" data-cites="james2013introduction">(<a href="#ref-james2013introduction" role="doc-biblioref">James et al., n.d.</a>)</span>. This means that we can tune hyper-parameters by comparing OOB MSEs under different sets of hyper-parameter values.</p>
<p>You can use a simple grid-search to find the best hyper-parameter values. Grid-search is simply a brute-force optimization methods that goes through a set of combinations of hyper-parameters and see which combination comes at the top. The computational intensity of grid-search depends on how many hyper-parameters you want to vary and how many values you would like to look at for each of the hyper-parameters. Here, let’s tune <code>mtry</code>, <code>min.node.size</code>, and <code>sample.fraction</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== define set of values you want to look at ===#</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>mtry_seq <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">7</span>)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>min_node_size_seq <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">10</span>)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>sample_fraction_seq <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="dv">1</span>)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="co">#=== create a complete combinations of the three parameters ===#</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>parameters <span class="ot">&lt;-</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>  data.table<span class="sc">::</span><span class="fu">CJ</span>(</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">mtry =</span> mtry_seq,</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_node_size =</span> min_node_size_seq,</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample_fraction =</span> sample_fraction_seq</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    mtry min_node_size sample_fraction
 1:    2             2            0.50
 2:    2             2            0.75
 3:    2             2            1.00
 4:    2             5            0.50
 5:    2             5            0.75
 6:    2             5            1.00
 7:    2            10            0.50
 8:    2            10            0.75
 9:    2            10            1.00
10:    4             2            0.50
11:    4             2            0.75
12:    4             2            1.00
13:    4             5            0.50
14:    4             5            0.75
15:    4             5            1.00
16:    4            10            0.50
17:    4            10            0.75
18:    4            10            1.00
19:    7             2            0.50
20:    7             2            0.75
21:    7             2            1.00
22:    7             5            0.50
23:    7             5            0.75
24:    7             5            1.00
25:    7            10            0.50
26:    7            10            0.75
27:    7            10            1.00
    mtry min_node_size sample_fraction</code></pre>
</div>
</div>
<p>In total, we have 27 (<span class="math inline">\(3 \times 3 \times 3\)</span>) cases. You can see how quickly the number of cases increases as you increase the number of parameters to tune and the values of each parameter. We can now loop over the rows of this parameter data (<code>parameters</code>) and get OOB MSE for each of them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>oob_mse_all <span class="ot">&lt;-</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq_len</span>(<span class="fu">nrow</span>(parameters)),</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) {</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>      <span class="co">#=== Fit the mode ===#</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>      rf_fit <span class="ot">&lt;-</span> </span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ranger</span>(</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>          lsalary <span class="sc">~</span> hruns <span class="sc">+</span> years <span class="sc">+</span> rbisyr <span class="sc">+</span> allstar <span class="sc">+</span> runsyr <span class="sc">+</span> hits <span class="sc">+</span> bavg, </span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> mlb1_dt,</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">num.trees =</span> <span class="dv">1000</span>,</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>          <span class="at">mtry =</span> parameters[x, mtry],</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>          <span class="at">min.node.size =</span> parameters[x, min_node_size],</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">sample.fraction =</span> parameters[x, sample_fraction]</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>      <span class="co">#=== return OOB SME ===#</span></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(rf_fit<span class="sc">$</span>prediction.error)</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlist</span>()</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a><span class="co">#=== assign OOB MSE to the parameters data ===#</span></span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>parameters[, oob_mse <span class="sc">:</span><span class="er">=</span> oob_mse_all]</span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a><span class="co">#=== take a look ===#</span></span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a>parameters</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    mtry min_node_size sample_fraction   oob_mse
 1:    2             2            0.50 0.3611884
 2:    2             2            0.75 0.3622574
 3:    2             2            1.00 0.3701546
 4:    2             5            0.50 0.3601237
 5:    2             5            0.75 0.3634168
 6:    2             5            1.00 0.3665383
 7:    2            10            0.50 0.3618498
 8:    2            10            0.75 0.3621112
 9:    2            10            1.00 0.3662482
10:    4             2            0.50 0.3626452
11:    4             2            0.75 0.3668244
12:    4             2            1.00 0.3735296
13:    4             5            0.50 0.3630609
14:    4             5            0.75 0.3705019
15:    4             5            1.00 0.3742656
16:    4            10            0.50 0.3610209
17:    4            10            0.75 0.3623941
18:    4            10            1.00 0.3661138
19:    7             2            0.50 0.3737602
20:    7             2            0.75 0.3766916
21:    7             2            1.00 0.3827657
22:    7             5            0.50 0.3697100
23:    7             5            0.75 0.3725411
24:    7             5            1.00 0.3822502
25:    7            10            0.50 0.3695385
26:    7            10            0.75 0.3699830
27:    7            10            1.00 0.3800858
    mtry min_node_size sample_fraction   oob_mse</code></pre>
</div>
</div>
<p>So, the best choice among the ones tried is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>parameters[<span class="fu">which.min</span>(oob_mse), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   mtry min_node_size sample_fraction   oob_mse
1:    2             5             0.5 0.3601237</code></pre>
</div>
</div>
<div class="callout-tip callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>The same cross-validation procedure can be done with less coding effort using the <code>mlr3</code> framework (see <a href="PROG-R-01-mlr3.html"><span>Chapter&nbsp;18</span></a>).</p>
</div>
</div>
</section>
<section id="references" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="references">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-athey2019generalized" class="csl-entry" role="doc-biblioentry">
Athey, Susan, Julie Tibshirani, and Stefan Wager. 2019. <span>“Generalized Random Forests.”</span> <em>The Annals of Statistics</em> 47 (2): 1148–78.
</div>
<div id="ref-breiman2001random" class="csl-entry" role="doc-biblioentry">
Breiman, Leo. 2001. <span>“Random Forests.”</span> <em>Machine Learning</em> 45 (1): 5–32.
</div>
<div id="ref-Chen_2016" class="csl-entry" role="doc-biblioentry">
Chen, Tianqi, and Carlos Guestrin. 2016. <span>“<span>XGBoost</span>.”</span> In <em>Proceedings of the 22nd <span>ACM</span> <span>SIGKDD</span> International Conference on Knowledge Discovery and Data Mining</em>. <span>ACM</span>. <a href="https://doi.org/10.1145/2939672.2939785">https://doi.org/10.1145/2939672.2939785</a>.
</div>
<div id="ref-james2013introduction" class="csl-entry" role="doc-biblioentry">
James, Gareth, Daniela Witten, Trevor Hastie, and Robert Tibshirani. n.d. <em>An Introduction to Statistical Learning</em>. Vol. 112. Springer.
</div>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./B05-bootstrap.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Bootstrap</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./P02-boosted-regression-forest.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Boosted Regression Forest</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb69" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Random Forest {#sec-rf}</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>The main goal of this chapter is to learn random forest (RF) for regression. RF is first conceived by @breiman2001random, and it has been one of the most popular machine learning methods. It also has been an inspiration to many other ML methods including extreme gradient boosting <span class="co">[</span><span class="ot">@Chen_2016</span><span class="co">]</span>, generalized random forest <span class="co">[</span><span class="ot">@athey2019generalized</span><span class="co">]</span>.</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>We first start with understanding how a regression tree is built, which is the foundation of all the forest-based ML methods. We then learn how random forest is built as an extension of a regression tree and how to train it.</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a><span class="fu">## What you will learn</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Regression tree</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>How regression tree is built (algorithm)</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Random forest</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>How random forest is built</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>bagging (bootstrap averaging)</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>random variable selection for splitting</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>How out-of-bag prediction works</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>How to train RF using R</span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a><span class="fu">## Background knowledge</span></span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>(necessary) bootstrap (@sec-boot)</span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a><span class="fu">## Regression tree {#sec-rt}</span></span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a>**Packages to load for replication**</span>
<span id="cb69-35"><a href="#cb69-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-38"><a href="#cb69-38" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-39"><a href="#cb69-39" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb69-40"><a href="#cb69-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-41"><a href="#cb69-41" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb69-42"><a href="#cb69-42" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb69-43"><a href="#cb69-43" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart)</span>
<span id="cb69-44"><a href="#cb69-44" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rattle)</span>
<span id="cb69-45"><a href="#cb69-45" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(wooldridge)</span>
<span id="cb69-46"><a href="#cb69-46" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gganimate)</span>
<span id="cb69-47"><a href="#cb69-47" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-48"><a href="#cb69-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-51"><a href="#cb69-51" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-52"><a href="#cb69-52" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb69-53"><a href="#cb69-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-54"><a href="#cb69-54" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb69-55"><a href="#cb69-55" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb69-56"><a href="#cb69-56" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart)</span>
<span id="cb69-57"><a href="#cb69-57" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rattle)</span>
<span id="cb69-58"><a href="#cb69-58" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(wooldridge)</span>
<span id="cb69-59"><a href="#cb69-59" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gganimate)</span>
<span id="cb69-60"><a href="#cb69-60" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-61"><a href="#cb69-61" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb69-62"><a href="#cb69-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-63"><a href="#cb69-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-64"><a href="#cb69-64" aria-hidden="true" tabindex="-1"></a><span class="fu">### What is it?</span></span>
<span id="cb69-65"><a href="#cb69-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-66"><a href="#cb69-66" aria-hidden="true" tabindex="-1"></a>Here is an example of regression tree to explain logged salary (<span class="in">`lsalary`</span>) using the <span class="in">`mlb1`</span> data from the <span class="in">`wooldridge`</span> package. </span>
<span id="cb69-67"><a href="#cb69-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-70"><a href="#cb69-70" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-71"><a href="#cb69-71" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true </span></span>
<span id="cb69-72"><a href="#cb69-72" aria-hidden="true" tabindex="-1"></a><span class="co">#=== get mlb1 data (from wooldridge) ===#</span></span>
<span id="cb69-73"><a href="#cb69-73" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(mlb1)</span>
<span id="cb69-74"><a href="#cb69-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-75"><a href="#cb69-75" aria-hidden="true" tabindex="-1"></a><span class="co">#=== build a simple tree ===#</span></span>
<span id="cb69-76"><a href="#cb69-76" aria-hidden="true" tabindex="-1"></a>simple_tree <span class="ot">&lt;-</span></span>
<span id="cb69-77"><a href="#cb69-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rpart</span>(</span>
<span id="cb69-78"><a href="#cb69-78" aria-hidden="true" tabindex="-1"></a>    lsalary <span class="sc">~</span> hits <span class="sc">+</span> runsyr, </span>
<span id="cb69-79"><a href="#cb69-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> mlb1, </span>
<span id="cb69-80"><a href="#cb69-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">rpart.control</span>(<span class="at">minsplit =</span> <span class="dv">200</span>)</span>
<span id="cb69-81"><a href="#cb69-81" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb69-82"><a href="#cb69-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-83"><a href="#cb69-83" aria-hidden="true" tabindex="-1"></a><span class="fu">fancyRpartPlot</span>(simple_tree, <span class="at">digits =</span> <span class="dv">4</span>)</span>
<span id="cb69-84"><a href="#cb69-84" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-85"><a href="#cb69-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-86"><a href="#cb69-86" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb69-87"><a href="#cb69-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-88"><a href="#cb69-88" aria-hidden="true" tabindex="-1"></a><span class="fu">## Terminology alert</span></span>
<span id="cb69-89"><a href="#cb69-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-90"><a href="#cb69-90" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="kw">&lt;span</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:blue"</span><span class="kw">&gt;</span>node <span class="kw">&lt;/span&gt;</span>: a group of observations represented by a green box</span>
<span id="cb69-91"><a href="#cb69-91" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="kw">&lt;span</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:blue"</span><span class="kw">&gt;</span>root node<span class="kw">&lt;/span&gt;</span>: first node to which all the observations belong</span>
<span id="cb69-92"><a href="#cb69-92" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="kw">&lt;span</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:blue"</span><span class="kw">&gt;</span>leaf<span class="kw">&lt;/span&gt;</span> or <span class="kw">&lt;span</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:blue"</span><span class="kw">&gt;</span> terminal node<span class="kw">&lt;/span&gt;</span>: A node that is not split into more nodes</span>
<span id="cb69-93"><a href="#cb69-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-94"><a href="#cb69-94" aria-hidden="true" tabindex="-1"></a>::: </span>
<span id="cb69-95"><a href="#cb69-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-96"><a href="#cb69-96" aria-hidden="true" tabindex="-1"></a>Here is how you read the figure. At the first (root) node, all the observations belong to it ($n=353$) and the estimate of <span class="in">`lsalary`</span> is $13.49$, which is simply the sample average of <span class="in">`lsalary`</span>. Now, the whole dataset is split into two groups (nodes) based on the criteria of whether <span class="in">`hits`</span> is less than <span class="in">`262`</span> or not. If yes, then such observations will be grouped into the node with "2" on top (the leftmost node), and the estimated <span class="in">`lsalary`</span> for all the observations in that group ($n = 132$) is $12.35$, which is the sample average of <span class="in">`lsalary`</span> of the $132$ observations in the group. If no, then such observations will be grouped into the node with "3" on top, and the estimated <span class="in">`lsalary`</span> for all the observations in that group ($n = 221$) is $14.17$. This node is further split into two groups based on whether <span class="in">`runsyr`</span> is less than $44$ or not. For those observations with <span class="in">`runsyr`</span> $&lt; 44$ (second node at the bottom), estimated <span class="in">`lsalary`</span> is $13.58$. For those with <span class="in">`runsyr`</span> $&gt;= 44$ (rightmost node at the bottom), estimated <span class="in">`lsalary`</span> is $14.56$. </span>
<span id="cb69-97"><a href="#cb69-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-98"><a href="#cb69-98" aria-hidden="true" tabindex="-1"></a>As illustrated in the figure above, a regression tree splits the data into groups based on the value of explanatory variables, and all the observations in the same group will be assigned the same estimate, which isthe sample average of the dependent variable of the group. </span>
<span id="cb69-99"><a href="#cb69-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-100"><a href="#cb69-100" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb69-101"><a href="#cb69-101" aria-hidden="true" tabindex="-1"></a>The estimated value of $Y$ (the dependent variable) for $X = x$ is the average of $Y$ from all the observations that belong to the same terminal node (leaf) as $X = x$.</span>
<span id="cb69-102"><a href="#cb69-102" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb69-103"><a href="#cb69-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-104"><a href="#cb69-104" aria-hidden="true" tabindex="-1"></a>Another way of illustrating this grouping is shown below:</span>
<span id="cb69-105"><a href="#cb69-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-106"><a href="#cb69-106" aria-hidden="true" tabindex="-1"></a><span class="in">```{r viz-tree}</span></span>
<span id="cb69-107"><a href="#cb69-107" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true </span></span>
<span id="cb69-108"><a href="#cb69-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-109"><a href="#cb69-109" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mlb1) <span class="sc">+</span></span>
<span id="cb69-110"><a href="#cb69-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> hits, <span class="at">x =</span> runsyr, <span class="at">color =</span> lsalary)) <span class="sc">+</span></span>
<span id="cb69-111"><a href="#cb69-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb69-112"><a href="#cb69-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">262</span>) <span class="sc">+</span></span>
<span id="cb69-113"><a href="#cb69-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb69-114"><a href="#cb69-114" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">data.table</span>(<span class="at">x =</span> <span class="dv">44</span>, <span class="at">y =</span> <span class="fu">seq</span>(<span class="dv">262</span>, <span class="fu">max</span>(mlb1<span class="sc">$</span>hits), <span class="at">length =</span> <span class="dv">100</span>)), </span>
<span id="cb69-115"><a href="#cb69-115" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">x =</span> x)</span>
<span id="cb69-116"><a href="#cb69-116" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb69-117"><a href="#cb69-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb69-118"><a href="#cb69-118" aria-hidden="true" tabindex="-1"></a>    <span class="st">"text"</span>, </span>
<span id="cb69-119"><a href="#cb69-119" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="dv">75</span>, <span class="at">y =</span> <span class="dv">100</span>, </span>
<span id="cb69-120"><a href="#cb69-120" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Region (Node) 2"</span>, </span>
<span id="cb69-121"><a href="#cb69-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span></span>
<span id="cb69-122"><a href="#cb69-122" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb69-123"><a href="#cb69-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb69-124"><a href="#cb69-124" aria-hidden="true" tabindex="-1"></a>    <span class="st">"text"</span>, </span>
<span id="cb69-125"><a href="#cb69-125" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="dv">22</span>, <span class="at">y =</span> <span class="dv">1500</span>, </span>
<span id="cb69-126"><a href="#cb69-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Region (Node) 6"</span>, </span>
<span id="cb69-127"><a href="#cb69-127" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span></span>
<span id="cb69-128"><a href="#cb69-128" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb69-129"><a href="#cb69-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb69-130"><a href="#cb69-130" aria-hidden="true" tabindex="-1"></a>    <span class="st">"text"</span>, </span>
<span id="cb69-131"><a href="#cb69-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="dv">90</span>, <span class="at">y =</span> <span class="dv">1500</span>, </span>
<span id="cb69-132"><a href="#cb69-132" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Region (Node) 7"</span>, </span>
<span id="cb69-133"><a href="#cb69-133" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span></span>
<span id="cb69-134"><a href="#cb69-134" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb69-135"><a href="#cb69-135" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-136"><a href="#cb69-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-137"><a href="#cb69-137" aria-hidden="true" tabindex="-1"></a>An algorithm called recursive binary splitting is used to split the predictor space like the example above. Suppose you have K explanatory variables ($X_1, \dots, X_K$). Further, let $c$ denote the threshold that splits the sample into two regions such that <span class="sc">\{</span>$X|X_k &lt; c$<span class="sc">\}</span> and <span class="sc">\{</span>$X|X_k \geq c$<span class="sc">\}</span>.</span>
<span id="cb69-138"><a href="#cb69-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-139"><a href="#cb69-139" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb69-140"><a href="#cb69-140" aria-hidden="true" tabindex="-1"></a><span class="sc">\{</span>$X|X_k &lt; c$<span class="sc">\}</span> means observations that satisfy the condition stated right to the vertical bar (|). Here, it means all the observations for which its $X_k$ value is less than $c$.</span>
<span id="cb69-141"><a href="#cb69-141" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb69-142"><a href="#cb69-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-143"><a href="#cb69-143" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Step 1: For each of the covariates ($X_1$ through $X_K$), find all the threshold values that result in <span class="kw">&lt;span</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:blue"</span><span class="kw">&gt;</span> unique<span class="kw">&lt;/span&gt;</span> splits.</span>
<span id="cb69-144"><a href="#cb69-144" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Step 2: For each of the covariate-threshold combinations, calculate the sum of the squared residuals of its resulting split, and find the threshold value with the lowest sum of the squared residuals by covariate. </span>
<span id="cb69-145"><a href="#cb69-145" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Step 3: Among all the best splits by covariate (as many as the number of explanatory variables), pick the variable-threshold combination that leads to the lowest sum of the squared residuals.</span>
<span id="cb69-146"><a href="#cb69-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-147"><a href="#cb69-147" aria-hidden="true" tabindex="-1"></a>The data is then split according to the chosen criteria and then the same process is repeated for each of the branches, ad infinitum until the user-specified stopping criteria is met. This way of splitting is called a **greedy** (or I would call it myopic or shortsighted) approach because the split is sought to minimize the immediate RSS without considering the implication of the split for the later splits. </span>
<span id="cb69-148"><a href="#cb69-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-149"><a href="#cb69-149" aria-hidden="true" tabindex="-1"></a>Let's try to write this process for the first split from the beginning node using the <span class="in">`mlb1`</span> data as an illustration based on a simple grid search to find the optimal thresholds (Step 1). </span>
<span id="cb69-150"><a href="#cb69-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-151"><a href="#cb69-151" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb69-152"><a href="#cb69-152" aria-hidden="true" tabindex="-1"></a>Note that the R codes here are deliberately inefficient as they focus on illustrating the process.</span>
<span id="cb69-153"><a href="#cb69-153" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb69-154"><a href="#cb69-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-155"><a href="#cb69-155" aria-hidden="true" tabindex="-1"></a><span class="in">```{r set-up-data}</span></span>
<span id="cb69-156"><a href="#cb69-156" aria-hidden="true" tabindex="-1"></a><span class="co">#=== get data ===#</span></span>
<span id="cb69-157"><a href="#cb69-157" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(wooldridge)</span>
<span id="cb69-158"><a href="#cb69-158" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(mlb1)</span>
<span id="cb69-159"><a href="#cb69-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-160"><a href="#cb69-160" aria-hidden="true" tabindex="-1"></a>mlb1_dt <span class="ot">&lt;-</span> </span>
<span id="cb69-161"><a href="#cb69-161" aria-hidden="true" tabindex="-1"></a>  mlb1 <span class="sc">%&gt;%</span> </span>
<span id="cb69-162"><a href="#cb69-162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>() <span class="sc">%&gt;%</span> <span class="co"># turn into data.table </span></span>
<span id="cb69-163"><a href="#cb69-163" aria-hidden="true" tabindex="-1"></a>  .[, salary <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>] <span class="sc">%&gt;%</span> <span class="co"># remove salary (use lsalary instead)</span></span>
<span id="cb69-164"><a href="#cb69-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="co"># remove observations with NA in any of the variables</span></span>
<span id="cb69-165"><a href="#cb69-165" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-166"><a href="#cb69-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-167"><a href="#cb69-167" aria-hidden="true" tabindex="-1"></a>Let's work on splitting based on <span class="in">`hruns`</span>. One way to find the all the threshold values is simply find the mean of two consecutive numbers from the ordered unique <span class="in">`hruns`</span> values.</span>
<span id="cb69-168"><a href="#cb69-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-169"><a href="#cb69-169" aria-hidden="true" tabindex="-1"></a><span class="in">```{r gen-value-seq}</span></span>
<span id="cb69-170"><a href="#cb69-170" aria-hidden="true" tabindex="-1"></a>value_seq <span class="ot">&lt;-</span> </span>
<span id="cb69-171"><a href="#cb69-171" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== order hruns values and find the unique values ===#</span></span>
<span id="cb69-172"><a href="#cb69-172" aria-hidden="true" tabindex="-1"></a>  mlb1_dt[<span class="fu">order</span>(hruns), <span class="fu">unique</span>(hruns)] <span class="sc">%&gt;%</span></span>
<span id="cb69-173"><a href="#cb69-173" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== get the rolling mean ===#</span></span>
<span id="cb69-174"><a href="#cb69-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">frollmean</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb69-175"><a href="#cb69-175" aria-hidden="true" tabindex="-1"></a>  .[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb69-176"><a href="#cb69-176" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-177"><a href="#cb69-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-178"><a href="#cb69-178" aria-hidden="true" tabindex="-1"></a>@fig-thre shows all the threshold values (blue lines) stored in <span class="in">`value_seq`</span> that result in unique splits.</span>
<span id="cb69-179"><a href="#cb69-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-182"><a href="#cb69-182" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-183"><a href="#cb69-183" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb69-184"><a href="#cb69-184" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: All the threshold values when splitting based on `hruns` </span></span>
<span id="cb69-185"><a href="#cb69-185" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-thre</span></span>
<span id="cb69-186"><a href="#cb69-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-187"><a href="#cb69-187" aria-hidden="true" tabindex="-1"></a>threshold_data <span class="ot">&lt;-</span> </span>
<span id="cb69-188"><a href="#cb69-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(<span class="at">thre =</span> value_seq) <span class="sc">%&gt;%</span> </span>
<span id="cb69-189"><a href="#cb69-189" aria-hidden="true" tabindex="-1"></a>  .[, id <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span><span class="sc">:</span>.N]</span>
<span id="cb69-190"><a href="#cb69-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-191"><a href="#cb69-191" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mlb1_dt) <span class="sc">+</span></span>
<span id="cb69-192"><a href="#cb69-192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> lsalary, <span class="at">x =</span> hruns)) <span class="sc">+</span></span>
<span id="cb69-193"><a href="#cb69-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb69-194"><a href="#cb69-194" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> threshold_data, </span>
<span id="cb69-195"><a href="#cb69-195" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">xintercept =</span> thre), </span>
<span id="cb69-196"><a href="#cb69-196" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"blue"</span>, </span>
<span id="cb69-197"><a href="#cb69-197" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">0.2</span></span>
<span id="cb69-198"><a href="#cb69-198" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb69-199"><a href="#cb69-199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> value_seq[[<span class="dv">50</span>]], <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb69-200"><a href="#cb69-200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> value_seq[[<span class="dv">70</span>]], <span class="at">color =</span> <span class="st">"orange"</span>)</span>
<span id="cb69-201"><a href="#cb69-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-202"><a href="#cb69-202" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-203"><a href="#cb69-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-204"><a href="#cb69-204" aria-hidden="true" tabindex="-1"></a>For each value in <span class="in">`value_seq`</span>, we find RSS. For example, for the 50th value in <span class="in">`value_seq`</span> (the red line in @fig-thre),</span>
<span id="cb69-205"><a href="#cb69-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-208"><a href="#cb69-208" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-209"><a href="#cb69-209" aria-hidden="true" tabindex="-1"></a><span class="fu">copy</span>(mlb1_dt) <span class="sc">%&gt;%</span> </span>
<span id="cb69-210"><a href="#cb69-210" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== find the mean of lsalary by whether hruns is less than the threshold or not ===#</span></span>
<span id="cb69-211"><a href="#cb69-211" aria-hidden="true" tabindex="-1"></a>  .[, y_hat <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(lsalary), by <span class="ot">=</span> (hruns <span class="sc">&lt;</span> value_seq[<span class="dv">50</span>])] <span class="sc">%&gt;%</span> </span>
<span id="cb69-212"><a href="#cb69-212" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== get squared residuals ===#</span></span>
<span id="cb69-213"><a href="#cb69-213" aria-hidden="true" tabindex="-1"></a>  .[, (lsalary <span class="sc">-</span> y_hat)<span class="sc">^</span><span class="dv">2</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb69-214"><a href="#cb69-214" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== get RSS ===#</span></span>
<span id="cb69-215"><a href="#cb69-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>()</span>
<span id="cb69-216"><a href="#cb69-216" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-217"><a href="#cb69-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-218"><a href="#cb69-218" aria-hidden="true" tabindex="-1"></a>How about 70th value in <span class="in">`value_seq`</span> (the orange line in @fig-thre)?</span>
<span id="cb69-219"><a href="#cb69-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-222"><a href="#cb69-222" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-223"><a href="#cb69-223" aria-hidden="true" tabindex="-1"></a><span class="fu">copy</span>(mlb1_dt) <span class="sc">%&gt;%</span> </span>
<span id="cb69-224"><a href="#cb69-224" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== find the mean of lsalary by whether hruns is less than the threshold or not ===#</span></span>
<span id="cb69-225"><a href="#cb69-225" aria-hidden="true" tabindex="-1"></a>  .[, y_hat <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(lsalary), by <span class="ot">=</span> (hruns <span class="sc">&lt;</span> value_seq[<span class="dv">70</span>])] <span class="sc">%&gt;%</span> </span>
<span id="cb69-226"><a href="#cb69-226" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== get squared residuals ===#</span></span>
<span id="cb69-227"><a href="#cb69-227" aria-hidden="true" tabindex="-1"></a>  .[, (lsalary <span class="sc">-</span> y_hat)<span class="sc">^</span><span class="dv">2</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb69-228"><a href="#cb69-228" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== get RSS ===#</span></span>
<span id="cb69-229"><a href="#cb69-229" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>()</span>
<span id="cb69-230"><a href="#cb69-230" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-231"><a href="#cb69-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-232"><a href="#cb69-232" aria-hidden="true" tabindex="-1"></a>This means <span class="in">`value_seq[50]`</span> (<span class="in">`r value_seq[50]`</span>) is a better threshold than <span class="in">`value_seq[70]`</span> (<span class="in">`r value_seq[70]`</span>).</span>
<span id="cb69-233"><a href="#cb69-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-234"><a href="#cb69-234" aria-hidden="true" tabindex="-1"></a>Okay, let's consider all the candidate threshold values now, not just 50th and 70th, and then pick the best.</span>
<span id="cb69-235"><a href="#cb69-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-238"><a href="#cb69-238" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-239"><a href="#cb69-239" aria-hidden="true" tabindex="-1"></a>get_rss <span class="ot">&lt;-</span> <span class="cf">function</span>(i, var_name, value_seq, data)</span>
<span id="cb69-240"><a href="#cb69-240" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb69-241"><a href="#cb69-241" aria-hidden="true" tabindex="-1"></a>  rss <span class="ot">&lt;-</span></span>
<span id="cb69-242"><a href="#cb69-242" aria-hidden="true" tabindex="-1"></a>    <span class="fu">copy</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb69-243"><a href="#cb69-243" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setnames</span>(var_name, <span class="st">"var"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb69-244"><a href="#cb69-244" aria-hidden="true" tabindex="-1"></a>    .[, y_hat <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(lsalary), by <span class="ot">=</span> (var <span class="sc">&lt;</span> value_seq[i])] <span class="sc">%&gt;%</span> </span>
<span id="cb69-245"><a href="#cb69-245" aria-hidden="true" tabindex="-1"></a>    .[, (lsalary <span class="sc">-</span> y_hat)<span class="sc">^</span><span class="dv">2</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb69-246"><a href="#cb69-246" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>()</span>
<span id="cb69-247"><a href="#cb69-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-248"><a href="#cb69-248" aria-hidden="true" tabindex="-1"></a>  return_data <span class="ot">&lt;-</span></span>
<span id="cb69-249"><a href="#cb69-249" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.table</span>(</span>
<span id="cb69-250"><a href="#cb69-250" aria-hidden="true" tabindex="-1"></a>      <span class="at">rss =</span> rss,</span>
<span id="cb69-251"><a href="#cb69-251" aria-hidden="true" tabindex="-1"></a>      <span class="at">var_name =</span> var_name,</span>
<span id="cb69-252"><a href="#cb69-252" aria-hidden="true" tabindex="-1"></a>      <span class="at">var_value =</span> value_seq[i]</span>
<span id="cb69-253"><a href="#cb69-253" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb69-254"><a href="#cb69-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-255"><a href="#cb69-255" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(return_data)</span>
<span id="cb69-256"><a href="#cb69-256" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb69-257"><a href="#cb69-257" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-258"><a href="#cb69-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-259"><a href="#cb69-259" aria-hidden="true" tabindex="-1"></a>Here are RSS values at every value in <span class="in">`value_seq`</span>.</span>
<span id="cb69-260"><a href="#cb69-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-263"><a href="#cb69-263" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-264"><a href="#cb69-264" aria-hidden="true" tabindex="-1"></a>rss_value <span class="ot">&lt;-</span></span>
<span id="cb69-265"><a href="#cb69-265" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb69-266"><a href="#cb69-266" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq_len</span>(<span class="fu">length</span>(value_seq)),</span>
<span id="cb69-267"><a href="#cb69-267" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">get_rss</span>(x, <span class="st">"hruns"</span>, value_seq, mlb1_dt) </span>
<span id="cb69-268"><a href="#cb69-268" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb69-269"><a href="#cb69-269" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>()</span>
<span id="cb69-270"><a href="#cb69-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-271"><a href="#cb69-271" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(rss_value)</span>
<span id="cb69-272"><a href="#cb69-272" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(rss_value)</span>
<span id="cb69-273"><a href="#cb69-273" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-274"><a href="#cb69-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-275"><a href="#cb69-275" aria-hidden="true" tabindex="-1"></a>Finding the threshold value that minimizes RSS,</span>
<span id="cb69-276"><a href="#cb69-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-279"><a href="#cb69-279" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-280"><a href="#cb69-280" aria-hidden="true" tabindex="-1"></a>rss_value[<span class="fu">which.min</span>(rss), ]</span>
<span id="cb69-281"><a href="#cb69-281" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-282"><a href="#cb69-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-283"><a href="#cb69-283" aria-hidden="true" tabindex="-1"></a>Okay, so, the best threshold for <span class="in">`hruns`</span> is <span class="in">`r round(rss_value[which.min(rss), var_value], digits = 3)`</span></span>
<span id="cb69-284"><a href="#cb69-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-285"><a href="#cb69-285" aria-hidden="true" tabindex="-1"></a>Suppose we are considering only five explanatory variables in building a regression tree: <span class="in">`hruns`</span>, <span class="in">`years`</span>, <span class="in">`rbisyr`</span>, <span class="in">`allstar`</span>, <span class="in">`runsyr`</span>, <span class="in">`hits`</span>, and <span class="in">`bavg`</span>. We do the same operations we did for <span class="in">`hruns`</span> for all the variables. </span>
<span id="cb69-286"><a href="#cb69-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-289"><a href="#cb69-289" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-290"><a href="#cb69-290" aria-hidden="true" tabindex="-1"></a>get_rss_by_var <span class="ot">&lt;-</span> <span class="cf">function</span>(var_name, data)</span>
<span id="cb69-291"><a href="#cb69-291" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb69-292"><a href="#cb69-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-293"><a href="#cb69-293" aria-hidden="true" tabindex="-1"></a>  temp_data <span class="ot">&lt;-</span> </span>
<span id="cb69-294"><a href="#cb69-294" aria-hidden="true" tabindex="-1"></a>    <span class="fu">copy</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb69-295"><a href="#cb69-295" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setnames</span>(var_name, <span class="st">"temp_var"</span>)</span>
<span id="cb69-296"><a href="#cb69-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-297"><a href="#cb69-297" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== define a sequence of values of hruns ===#</span></span>
<span id="cb69-298"><a href="#cb69-298" aria-hidden="true" tabindex="-1"></a>  value_seq <span class="ot">&lt;-</span></span>
<span id="cb69-299"><a href="#cb69-299" aria-hidden="true" tabindex="-1"></a>    temp_data[<span class="fu">order</span>(temp_var), <span class="fu">unique</span>(temp_var)] <span class="sc">%&gt;%</span></span>
<span id="cb69-300"><a href="#cb69-300" aria-hidden="true" tabindex="-1"></a>    <span class="co">#=== get the rolling mean ===#</span></span>
<span id="cb69-301"><a href="#cb69-301" aria-hidden="true" tabindex="-1"></a>    <span class="fu">frollmean</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb69-302"><a href="#cb69-302" aria-hidden="true" tabindex="-1"></a>    .[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb69-303"><a href="#cb69-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-304"><a href="#cb69-304" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setnames</span>(temp_data, <span class="st">"temp_var"</span>, var_name)</span>
<span id="cb69-305"><a href="#cb69-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-306"><a href="#cb69-306" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== get RSS ===#</span></span>
<span id="cb69-307"><a href="#cb69-307" aria-hidden="true" tabindex="-1"></a>  rss_value <span class="ot">&lt;-</span></span>
<span id="cb69-308"><a href="#cb69-308" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(</span>
<span id="cb69-309"><a href="#cb69-309" aria-hidden="true" tabindex="-1"></a>      <span class="fu">seq_len</span>(<span class="fu">length</span>(value_seq)),</span>
<span id="cb69-310"><a href="#cb69-310" aria-hidden="true" tabindex="-1"></a>      <span class="cf">function</span>(x) <span class="fu">get_rss</span>(x, var_name, value_seq, temp_data) </span>
<span id="cb69-311"><a href="#cb69-311" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb69-312"><a href="#cb69-312" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbindlist</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb69-313"><a href="#cb69-313" aria-hidden="true" tabindex="-1"></a>    .[<span class="fu">which.min</span>(rss),]</span>
<span id="cb69-314"><a href="#cb69-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-315"><a href="#cb69-315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(rss_value)</span>
<span id="cb69-316"><a href="#cb69-316" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb69-317"><a href="#cb69-317" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-318"><a href="#cb69-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-319"><a href="#cb69-319" aria-hidden="true" tabindex="-1"></a>Looping over the set of variables,</span>
<span id="cb69-320"><a href="#cb69-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-323"><a href="#cb69-323" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-324"><a href="#cb69-324" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb69-325"><a href="#cb69-325" aria-hidden="true" tabindex="-1"></a>min_rss_by_var <span class="ot">&lt;-</span></span>
<span id="cb69-326"><a href="#cb69-326" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb69-327"><a href="#cb69-327" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"hruns"</span>, <span class="st">"years"</span>, <span class="st">"rbisyr"</span>, <span class="st">"allstar"</span>, <span class="st">"runsyr"</span>, <span class="st">"hits"</span>, <span class="st">"bavg"</span>),</span>
<span id="cb69-328"><a href="#cb69-328" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">get_rss_by_var</span>(x, mlb1_dt)</span>
<span id="cb69-329"><a href="#cb69-329" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb69-330"><a href="#cb69-330" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>()</span>
<span id="cb69-331"><a href="#cb69-331" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-332"><a href="#cb69-332" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-333"><a href="#cb69-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-334"><a href="#cb69-334" aria-hidden="true" tabindex="-1"></a>So, the variable-threshold combination that minimizes RSS is <span class="in">`r min_rss_by_var[which.min(rss), var_name]`</span> - <span class="in">`r min_rss_by_var[which.min(rss), round(var_value, digits = 2)]`</span>. We now have the first split. This tree is developed further by splitting nodes like this. </span>
<span id="cb69-335"><a href="#cb69-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-336"><a href="#cb69-336" aria-hidden="true" tabindex="-1"></a><span class="fu">### A note on splitting algorithm {#sec-split-sim}</span></span>
<span id="cb69-337"><a href="#cb69-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-338"><a href="#cb69-338" aria-hidden="true" tabindex="-1"></a>Minimizing RSS is equivalent to <span class="kw">&lt;span</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:blue"</span><span class="kw">&gt;</span> maximize <span class="kw">&lt;/span&gt;</span> the sum of <span class="kw">&lt;span</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:blue"</span><span class="kw">&gt;</span> similarity score <span class="kw">&lt;/span&gt;</span>from the two splits. Let $C_1(r)$ and $C_2(r)$ denote the set of observations that belong to the first and second splits, respectively given splitting rule $r$. For a given split combination $C_1(r)$ and $C_2(r)$, the estimators for the two splits are simply the average value of $Y$ in the respective splits. Denoting the means as $\hat{\mu}_1$ and $\hat{\mu}_2$, minimizing RSS can be written as </span>
<span id="cb69-339"><a href="#cb69-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-340"><a href="#cb69-340" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb69-341"><a href="#cb69-341" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb69-342"><a href="#cb69-342" aria-hidden="true" tabindex="-1"></a>\min_r \sum_{i\in C_1} (\hat{\mu}_1 - Y_i)^2 + \sum_{i\in C_2} (\hat{\mu}_2 - Y_i)^2</span>
<span id="cb69-343"><a href="#cb69-343" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb69-344"><a href="#cb69-344" aria-hidden="true" tabindex="-1"></a>$$ {#eq-rss-min}</span>
<span id="cb69-345"><a href="#cb69-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-346"><a href="#cb69-346" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb69-347"><a href="#cb69-347" aria-hidden="true" tabindex="-1"></a>$\hat{\mu}_k = \frac{\sum_{i\in C_k} Y_i}{N_k}$, where $N_k$ is the number of observations in $C_k$.</span>
<span id="cb69-348"><a href="#cb69-348" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb69-349"><a href="#cb69-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-350"><a href="#cb69-350" aria-hidden="true" tabindex="-1"></a>Now, in general, the following holds</span>
<span id="cb69-351"><a href="#cb69-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-352"><a href="#cb69-352" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb69-353"><a href="#cb69-353" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb69-354"><a href="#cb69-354" aria-hidden="true" tabindex="-1"></a>\sum_{i\in C_k} (\hat{\mu}_k - Y_i)^2 = \sum_{i\in C_k} Y_i^2 - \sum_{i\in C_k} \hat{\mu}_k^2</span>
<span id="cb69-355"><a href="#cb69-355" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb69-356"><a href="#cb69-356" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb69-357"><a href="#cb69-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-358"><a href="#cb69-358" aria-hidden="true" tabindex="-1"></a>So, @eq-rss-min can be rewritten as </span>
<span id="cb69-359"><a href="#cb69-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-360"><a href="#cb69-360" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb69-361"><a href="#cb69-361" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb69-362"><a href="#cb69-362" aria-hidden="true" tabindex="-1"></a>\min_r \sum_{i\in C_1(r)} Y_i^2 + \sum_{i\in C_2(r)} Y_i^2 - (\sum_{i\in C_1(r)} \hat{\mu}_1^2 + \sum_{i\in C_2(r)} \hat{\mu}_2^2) </span>
<span id="cb69-363"><a href="#cb69-363" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb69-364"><a href="#cb69-364" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb69-365"><a href="#cb69-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-366"><a href="#cb69-366" aria-hidden="true" tabindex="-1"></a>Since $\sum_{i\in C_1(r)} Y_i^2 + \sum_{i\in C_2(r)} Y_i^2$ is always the same, it can be further reduced to</span>
<span id="cb69-367"><a href="#cb69-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-368"><a href="#cb69-368" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb69-369"><a href="#cb69-369" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb69-370"><a href="#cb69-370" aria-hidden="true" tabindex="-1"></a> &amp; \min_r - N_1 (\frac{\sum_{i\in C_1(r)} Y_i}{N_1})^2 - N_2 (\frac{\sum_{i\in C_2(r)} Y_i}{N_2})^2 <span class="sc">\\</span></span>
<span id="cb69-371"><a href="#cb69-371" aria-hidden="true" tabindex="-1"></a>\Rightarrow &amp; \min_r - \frac{(\sum_{i\in C_1(r)} Y_i)^2}{N_1} - \frac{(\sum_{i\in C_2(r)} Y_i)^2}{N_2}</span>
<span id="cb69-372"><a href="#cb69-372" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb69-373"><a href="#cb69-373" aria-hidden="true" tabindex="-1"></a>$$ {#eq-min-score}</span>
<span id="cb69-374"><a href="#cb69-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-375"><a href="#cb69-375" aria-hidden="true" tabindex="-1"></a>where $N_1$ and $N_2$ are the number of observations in $C_1$ and $C_2$, respectively. $\frac{(\sum_{i\in C_k} Y_i)^2}{N_k}$ is called <span class="kw">&lt;span</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:blue"</span><span class="kw">&gt;</span> similarity score <span class="kw">&lt;/span&gt;</span>. The name comes from the fact that the more similar element in $C_k$ are, the higher the score is. Consider for example, a four-observation case where their values of the dependent variable are $<span class="sc">\{</span>3, 2, -1, -2<span class="sc">\}</span>$. For the split $<span class="sc">\{</span>3, 2<span class="sc">\}</span>$, $<span class="sc">\{</span>-1, -2<span class="sc">\}</span>$, the similarity score is $17 (=25/2 + 9/2)$. However, if the split is $<span class="sc">\{</span>2, -2<span class="sc">\}</span>$, $<span class="sc">\{</span>3, -1<span class="sc">\}</span>$, then the score is $2 (=0/2 + 4/2)$. Since summation happens first and then the sum is squared, the more similar the elements are, the higher the score is.</span>
<span id="cb69-376"><a href="#cb69-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-377"><a href="#cb69-377" aria-hidden="true" tabindex="-1"></a>@eq-min-score can be reformulated as the maximization problem with the objective function being the sum of the similarity scores from the two splits.</span>
<span id="cb69-378"><a href="#cb69-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-379"><a href="#cb69-379" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb69-380"><a href="#cb69-380" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb69-381"><a href="#cb69-381" aria-hidden="true" tabindex="-1"></a>\textcolor{red}{\max}_r \frac{(\sum_{i\in C_1(r)} Y_i)^2}{N_1} + \frac{(\sum_{i\in C_2(r)} Y_i)^2}{N_2}</span>
<span id="cb69-382"><a href="#cb69-382" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb69-383"><a href="#cb69-383" aria-hidden="true" tabindex="-1"></a>$$ {#eq-max-score}</span>
<span id="cb69-384"><a href="#cb69-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-385"><a href="#cb69-385" aria-hidden="true" tabindex="-1"></a>Note that it is much more computationally efficient to solve this maximization problem than the RSS minimization problem (@eq-rss-min). In the RSS minimization problem, for each split, you calculate the mean, subtract it from $Y_i$ for all the observations, square them and sum them. On the other hand, in the similarity score maximization problem, you can simply sum $Y_i$ and then square it for each split. So, programatically, tree building is done using @eq-max-score. You can also see the use of @eq-max-score in the extreme gradient boosting algorithm (@sec-xgb) and also in the implementation of GRF (@sec-grf).</span>
<span id="cb69-386"><a href="#cb69-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-387"><a href="#cb69-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-388"><a href="#cb69-388" aria-hidden="true" tabindex="-1"></a><span class="fu">### Training a regression tree</span></span>
<span id="cb69-389"><a href="#cb69-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-390"><a href="#cb69-390" aria-hidden="true" tabindex="-1"></a>You can fit a regression tree using <span class="in">`rpart()`</span> from the <span class="in">`rpart`</span> package. Its syntax is similar to that of <span class="in">`lm()`</span> for a quick fitting.</span>
<span id="cb69-391"><a href="#cb69-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-394"><a href="#cb69-394" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-395"><a href="#cb69-395" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false </span></span>
<span id="cb69-396"><a href="#cb69-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-397"><a href="#cb69-397" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart</span>(</span>
<span id="cb69-398"><a href="#cb69-398" aria-hidden="true" tabindex="-1"></a>  formula,</span>
<span id="cb69-399"><a href="#cb69-399" aria-hidden="true" tabindex="-1"></a>  data</span>
<span id="cb69-400"><a href="#cb69-400" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-401"><a href="#cb69-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-402"><a href="#cb69-402" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-403"><a href="#cb69-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-404"><a href="#cb69-404" aria-hidden="true" tabindex="-1"></a>Using <span class="in">`mlb1`</span>, let's fit a regression tree where <span class="in">`lsalary`</span> is the dependent variable and <span class="in">`hruns`</span>, <span class="in">`years`</span>, <span class="in">`rbisyr`</span>, <span class="in">`allstar`</span>, <span class="in">`runsyr`</span>, <span class="in">`hits`</span>, and <span class="in">`bavg`</span> are the explanatory variables.</span>
<span id="cb69-405"><a href="#cb69-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-408"><a href="#cb69-408" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-409"><a href="#cb69-409" aria-hidden="true" tabindex="-1"></a><span class="co">#=== fit a tree ===#</span></span>
<span id="cb69-410"><a href="#cb69-410" aria-hidden="true" tabindex="-1"></a>fitted_tree <span class="ot">&lt;-</span></span>
<span id="cb69-411"><a href="#cb69-411" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rpart</span>(</span>
<span id="cb69-412"><a href="#cb69-412" aria-hidden="true" tabindex="-1"></a>    lsalary <span class="sc">~</span> hruns <span class="sc">+</span> years <span class="sc">+</span> rbisyr <span class="sc">+</span> allstar <span class="sc">+</span> runsyr <span class="sc">+</span> hits <span class="sc">+</span> bavg, </span>
<span id="cb69-413"><a href="#cb69-413" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> mlb1_dt</span>
<span id="cb69-414"><a href="#cb69-414" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb69-415"><a href="#cb69-415" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-416"><a href="#cb69-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-417"><a href="#cb69-417" aria-hidden="true" tabindex="-1"></a>Here is the visualization of the fitted tree using <span class="in">`fancyRpartPlot()`</span> from the <span class="in">`rattle`</span> package.</span>
<span id="cb69-418"><a href="#cb69-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-421"><a href="#cb69-421" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-422"><a href="#cb69-422" aria-hidden="true" tabindex="-1"></a><span class="fu">fancyRpartPlot</span>(fitted_tree)</span>
<span id="cb69-423"><a href="#cb69-423" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-424"><a href="#cb69-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-425"><a href="#cb69-425" aria-hidden="true" tabindex="-1"></a>Now, you may wonder why <span class="in">`rpart()`</span> is not building a tree that has as many leaves as the number of observations so that we have a perfect prediction for the train data (<span class="in">`mlb1`</span>). If we are simply implementing recursive binary splitting, then it should not have stopped where it stopped. This is because <span class="in">`rpart()`</span> sets parameter values that control the development of a tree by default. Those default parameters can be seen below:</span>
<span id="cb69-426"><a href="#cb69-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-429"><a href="#cb69-429" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-430"><a href="#cb69-430" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.control</span>()</span>
<span id="cb69-431"><a href="#cb69-431" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-432"><a href="#cb69-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-433"><a href="#cb69-433" aria-hidden="true" tabindex="-1"></a>For example, <span class="in">`minsplit`</span> is the minimum number of observations that must exist in a node in order for a split to be attempted. <span class="in">`cp`</span> refers to the complexity parameter. For a given value of <span class="in">`cp`</span>, a tree is build to minimize the following:</span>
<span id="cb69-434"><a href="#cb69-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-435"><a href="#cb69-435" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb69-436"><a href="#cb69-436" aria-hidden="true" tabindex="-1"></a>\sum_{t=1}^T\sum_{x_i\in R_t} (y_i - \hat{y}_{R_t})^2 + cp\cdot T</span>
<span id="cb69-437"><a href="#cb69-437" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb69-438"><a href="#cb69-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-439"><a href="#cb69-439" aria-hidden="true" tabindex="-1"></a>where $R_t$ is the $t$th region and $\hat{y_{R_t}}$ is the estimate of $y$ for all the observations that reside in $R_t$. So, the first term is RSS. The objective function has a penalization term (the second term) just like shrinkage methods we saw in @sec-shrinkage. A higher value of <span class="in">`cp`</span> leads to a less complex tree with less leaves.</span>
<span id="cb69-440"><a href="#cb69-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-441"><a href="#cb69-441" aria-hidden="true" tabindex="-1"></a>If you want to build a much deeper tree that has many leaves, then you can do so using the <span class="in">`control`</span> option like below.</span>
<span id="cb69-442"><a href="#cb69-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-445"><a href="#cb69-445" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-446"><a href="#cb69-446" aria-hidden="true" tabindex="-1"></a>full_tree <span class="ot">&lt;-</span></span>
<span id="cb69-447"><a href="#cb69-447" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rpart</span>(</span>
<span id="cb69-448"><a href="#cb69-448" aria-hidden="true" tabindex="-1"></a>    lsalary <span class="sc">~</span> hruns <span class="sc">+</span> years <span class="sc">+</span> rbisyr <span class="sc">+</span> allstar <span class="sc">+</span> runsyr <span class="sc">+</span> hits <span class="sc">+</span> bavg, <span class="co"># formula</span></span>
<span id="cb69-449"><a href="#cb69-449" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> mlb1_dt, <span class="co"># data</span></span>
<span id="cb69-450"><a href="#cb69-450" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="co"># control of the hyper parameters</span></span>
<span id="cb69-451"><a href="#cb69-451" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rpart.control</span>(</span>
<span id="cb69-452"><a href="#cb69-452" aria-hidden="true" tabindex="-1"></a>        <span class="at">minsplit =</span> <span class="dv">2</span>, </span>
<span id="cb69-453"><a href="#cb69-453" aria-hidden="true" tabindex="-1"></a>        <span class="at">cp =</span> <span class="dv">0</span> <span class="co"># complexity parameter</span></span>
<span id="cb69-454"><a href="#cb69-454" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb69-455"><a href="#cb69-455" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb69-456"><a href="#cb69-456" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-457"><a href="#cb69-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-458"><a href="#cb69-458" aria-hidden="true" tabindex="-1"></a>Let's see how amazing this tree is by comparing the observed and fitted <span class="in">`lsalary`</span> values.</span>
<span id="cb69-459"><a href="#cb69-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-462"><a href="#cb69-462" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-463"><a href="#cb69-463" aria-hidden="true" tabindex="-1"></a><span class="co">#=== get fitted values ===#</span></span>
<span id="cb69-464"><a href="#cb69-464" aria-hidden="true" tabindex="-1"></a>mlb1_dt[, y_hat <span class="sc">:</span><span class="er">=</span> <span class="fu">predict</span>(full_tree, <span class="at">newdata =</span> mlb1_dt)]</span>
<span id="cb69-465"><a href="#cb69-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-466"><a href="#cb69-466" aria-hidden="true" tabindex="-1"></a><span class="co">#=== visualize the fit ===#</span></span>
<span id="cb69-467"><a href="#cb69-467" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> mlb1_dt) <span class="sc">+</span></span>
<span id="cb69-468"><a href="#cb69-468" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> lsalary, <span class="at">x =</span> y_hat)) <span class="sc">+</span></span>
<span id="cb69-469"><a href="#cb69-469" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"red"</span>)</span>
<span id="cb69-470"><a href="#cb69-470" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-471"><a href="#cb69-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-472"><a href="#cb69-472" aria-hidden="true" tabindex="-1"></a>Yes, perfect prediction accuracy! At least for the train data anyway. But, we all know we want nothing to do with this kind of model. It is clearly over-fitting the train data.  </span>
<span id="cb69-473"><a href="#cb69-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-474"><a href="#cb69-474" aria-hidden="true" tabindex="-1"></a>In order to find a reasonable model, we can use KCV over <span class="in">`cp`</span>. Fortunately, when we run <span class="in">`rpart()`</span>, it automatically builds multiple trees at different values of <span class="in">`cp`</span> that controls the number of leaves and conduct KCV. You can visualize this using <span class="in">`plotcp()`</span>.</span>
<span id="cb69-475"><a href="#cb69-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-478"><a href="#cb69-478" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-479"><a href="#cb69-479" aria-hidden="true" tabindex="-1"></a><span class="fu">plotcp</span>(fitted_tree)</span>
<span id="cb69-480"><a href="#cb69-480" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-481"><a href="#cb69-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-482"><a href="#cb69-482" aria-hidden="true" tabindex="-1"></a>MSE and <span class="in">`cp`</span> are presented on the y- and x-axis, respectively. According to the KCV results, <span class="in">`cp`</span> $= 0.018$ provides the tree with the smallest number of leaves (the most simple) where the MSE value is within one standard deviation from the lowest MSE. You can access the tree built under <span class="in">`cp`</span> $= 0.018$ like below.</span>
<span id="cb69-483"><a href="#cb69-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-486"><a href="#cb69-486" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-487"><a href="#cb69-487" aria-hidden="true" tabindex="-1"></a><span class="co">#=== get the best tree ===#</span></span>
<span id="cb69-488"><a href="#cb69-488" aria-hidden="true" tabindex="-1"></a>best_tree <span class="ot">&lt;-</span> <span class="fu">prune</span>(full_tree, <span class="at">cp =</span> <span class="fl">0.018</span>)</span>
<span id="cb69-489"><a href="#cb69-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-490"><a href="#cb69-490" aria-hidden="true" tabindex="-1"></a><span class="co">#=== visualize it ===#</span></span>
<span id="cb69-491"><a href="#cb69-491" aria-hidden="true" tabindex="-1"></a><span class="fu">fancyRpartPlot</span>(best_tree)</span>
<span id="cb69-492"><a href="#cb69-492" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-493"><a href="#cb69-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-494"><a href="#cb69-494" aria-hidden="true" tabindex="-1"></a>Even though how a regression tree is build in R. In practice, you never use a regression tree itself as the final model for your research as its performance is rather poor and tend to over-fit compared to other competitive methods. But, understanding how building a regression tree is important to understand its derivatives like random forest, boosted regression forest.</span>
<span id="cb69-495"><a href="#cb69-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-496"><a href="#cb69-496" aria-hidden="true" tabindex="-1"></a><span class="fu">## Random Forest (RF) {#sec-rf}</span></span>
<span id="cb69-497"><a href="#cb69-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-498"><a href="#cb69-498" aria-hidden="true" tabindex="-1"></a>Regression tree approach is often not robust and suffers from high variance. Here, we look at the process called <span class="kw">&lt;span</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:blue"</span><span class="kw">&gt;</span> bagging <span class="kw">&lt;/span&gt;</span> and how it can be used to train RF model, which is much more robust than a regression tree. </span>
<span id="cb69-499"><a href="#cb69-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-500"><a href="#cb69-500" aria-hidden="true" tabindex="-1"></a><span class="fu">### Bagging (Bootstrap Averaging)</span></span>
<span id="cb69-501"><a href="#cb69-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-502"><a href="#cb69-502" aria-hidden="true" tabindex="-1"></a>Before talking about how RF is trained. Let's first talk about the concept of bagging. Let $\theta(X)$ denote the statistics of interest you would like to estimate from the data. Bagging (Bootstrap averaging) works like this:</span>
<span id="cb69-503"><a href="#cb69-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-504"><a href="#cb69-504" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Bootstrap the data many times</span>
<span id="cb69-505"><a href="#cb69-505" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Estimate $\theta(X)$ for each of the bootstrapped datasets ($\hat{\theta}_1, \dots, \hat{\theta}_B$)</span>
<span id="cb69-506"><a href="#cb69-506" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Average the estimates and use it as the final estimate of $\theta(X)$.</span>
<span id="cb69-507"><a href="#cb69-507" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb69-508"><a href="#cb69-508" aria-hidden="true" tabindex="-1"></a>\hat{\theta}(X) = \frac{\hat{\theta}_1(X) + \dots + \hat{\theta}_B(X)}{B}</span>
<span id="cb69-509"><a href="#cb69-509" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb69-510"><a href="#cb69-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-511"><a href="#cb69-511" aria-hidden="true" tabindex="-1"></a>To understand the power of bagging, we need to understand the power of averaging and when it is most effective using a very simple example of estimating the expected value of a random variable.</span>
<span id="cb69-512"><a href="#cb69-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-513"><a href="#cb69-513" aria-hidden="true" tabindex="-1"></a>Consider two random variables $x_1$ and $x_2$ from the identical distribution, where $E<span class="co">[</span><span class="ot">x_i</span><span class="co">]</span> = \alpha$ and $Var(x_i) = \sigma^2$. You are interested in estimating $E<span class="co">[</span><span class="ot">x_i</span><span class="co">]</span>$. We have two options:</span>
<span id="cb69-514"><a href="#cb69-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-515"><a href="#cb69-515" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Option 1: Use $x_1$ as the estimate of $E<span class="co">[</span><span class="ot">x_i</span><span class="co">]</span>$. </span>
<span id="cb69-516"><a href="#cb69-516" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Option 2: Use the mean of $x_1$ and $x_2$ as the estimate of $E<span class="co">[</span><span class="ot">x_i</span><span class="co">]</span>$</span>
<span id="cb69-517"><a href="#cb69-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-518"><a href="#cb69-518" aria-hidden="true" tabindex="-1"></a>The variance of the first estimator is of course simply the variance of $x_1$, so $\sigma^2$.</span>
<span id="cb69-519"><a href="#cb69-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-520"><a href="#cb69-520" aria-hidden="true" tabindex="-1"></a>For option 2, we know the following relationship holds in general:</span>
<span id="cb69-521"><a href="#cb69-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-522"><a href="#cb69-522" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb69-523"><a href="#cb69-523" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb69-524"><a href="#cb69-524" aria-hidden="true" tabindex="-1"></a>Var(\frac{x_1 + x_2}{2}) &amp; = \frac{Var(x_1)}{4} + \frac{Var(x_2)}{4} + \frac{Cov(x_1, x_2)}{2} <span class="sc">\\</span></span>
<span id="cb69-525"><a href="#cb69-525" aria-hidden="true" tabindex="-1"></a>&amp; = \frac{\sigma^2}{2} + \frac{Cov(x_1, x_2)}{2}</span>
<span id="cb69-526"><a href="#cb69-526" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb69-527"><a href="#cb69-527" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb69-528"><a href="#cb69-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-529"><a href="#cb69-529" aria-hidden="true" tabindex="-1"></a>So, how good the mean of $x_1$ and $x_2$ as an estimator depends on $Cov(x_1, x_2)$. When they are perfectly positively correlated, then $Cov(x_1, x_2) = Var(x_1) = \sigma^2$. So, $Var(\frac{x_1 + x_2}{2})$ is $\sigma^2$, which is no better than option 1. </span>
<span id="cb69-530"><a href="#cb69-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-531"><a href="#cb69-531" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb69-532"><a href="#cb69-532" aria-hidden="true" tabindex="-1"></a>This makes sense because adding information from one more variable that is perfectly correlated with the other variable does nothing because they are the same values.</span>
<span id="cb69-533"><a href="#cb69-533" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb69-534"><a href="#cb69-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-535"><a href="#cb69-535" aria-hidden="true" tabindex="-1"></a>However, as long as $x_1$ and $x_2$ are not perfectly correlated, option 2 is better. The benefit of averaging is greater when the value of $Cov(x_1, x_2)$ is smaller.</span>
<span id="cb69-536"><a href="#cb69-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-537"><a href="#cb69-537" aria-hidden="true" tabindex="-1"></a>Let's do a little experiment to see this. We consider four approaches:</span>
<span id="cb69-538"><a href="#cb69-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-539"><a href="#cb69-539" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Approach 0: use $x_1$ as the estimator</span>
<span id="cb69-540"><a href="#cb69-540" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Approach 1: use $(x_1 + x_2)/2$ as the estimator ($x_1$ and $x_2$ are independent)</span>
<span id="cb69-541"><a href="#cb69-541" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Approach 2: use $(x_1 + x_2)/2$ as the estimator ($x_1$ and $x_2$ are positively correlated)</span>
<span id="cb69-542"><a href="#cb69-542" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Approach 3: use $(x_1 + x_2)/2$ as the estimator ($x_1$ and $x_2$ are negatively correlated)</span>
<span id="cb69-543"><a href="#cb69-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-546"><a href="#cb69-546" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-547"><a href="#cb69-547" aria-hidden="true" tabindex="-1"></a><span class="co">#=== set the number of observations to 1000 ===#</span></span>
<span id="cb69-548"><a href="#cb69-548" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb69-549"><a href="#cb69-549" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-550"><a href="#cb69-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-553"><a href="#cb69-553" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-554"><a href="#cb69-554" aria-hidden="true" tabindex="-1"></a><span class="co">#=== first approach (no correlation) ===#</span></span>
<span id="cb69-555"><a href="#cb69-555" aria-hidden="true" tabindex="-1"></a>x_1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N)</span>
<span id="cb69-556"><a href="#cb69-556" aria-hidden="true" tabindex="-1"></a>x_2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N)</span>
<span id="cb69-557"><a href="#cb69-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-558"><a href="#cb69-558" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(x_1, x_2)</span>
<span id="cb69-559"><a href="#cb69-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-560"><a href="#cb69-560" aria-hidden="true" tabindex="-1"></a><span class="co">#=== second approach (positively correlated) ===#</span></span>
<span id="cb69-561"><a href="#cb69-561" aria-hidden="true" tabindex="-1"></a>x_1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N)</span>
<span id="cb69-562"><a href="#cb69-562" aria-hidden="true" tabindex="-1"></a>x_2 <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> x_1 <span class="sc">+</span> <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">-</span>(<span class="fl">0.5</span>)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">*</span> <span class="fu">rnorm</span>(N)</span>
<span id="cb69-563"><a href="#cb69-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-564"><a href="#cb69-564" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(x_1, x_2)</span>
<span id="cb69-565"><a href="#cb69-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-566"><a href="#cb69-566" aria-hidden="true" tabindex="-1"></a><span class="co">#=== third approach (negatively correlated) ===#</span></span>
<span id="cb69-567"><a href="#cb69-567" aria-hidden="true" tabindex="-1"></a>x_1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N)</span>
<span id="cb69-568"><a href="#cb69-568" aria-hidden="true" tabindex="-1"></a>x_2 <span class="ot">&lt;-</span> <span class="sc">-</span> <span class="fl">0.8</span> <span class="sc">*</span> x_1 <span class="sc">-</span> <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">-</span>(<span class="fl">0.8</span>)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">*</span> <span class="fu">rnorm</span>(N)</span>
<span id="cb69-569"><a href="#cb69-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-570"><a href="#cb69-570" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(x_1, x_2)</span>
<span id="cb69-571"><a href="#cb69-571" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-572"><a href="#cb69-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-573"><a href="#cb69-573" aria-hidden="true" tabindex="-1"></a>The following function runs a single iteration of estimating $E<span class="co">[</span><span class="ot">x</span><span class="co">]</span>$ using the four approaches.</span>
<span id="cb69-574"><a href="#cb69-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-577"><a href="#cb69-577" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-578"><a href="#cb69-578" aria-hidden="true" tabindex="-1"></a>get_alpha <span class="ot">&lt;-</span> <span class="cf">function</span>(i)</span>
<span id="cb69-579"><a href="#cb69-579" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb69-580"><a href="#cb69-580" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== approach 0 ===#</span></span>
<span id="cb69-581"><a href="#cb69-581" aria-hidden="true" tabindex="-1"></a>  alpha_hat_0 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb69-582"><a href="#cb69-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-583"><a href="#cb69-583" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== approach 1 (no correlation) ===#</span></span>
<span id="cb69-584"><a href="#cb69-584" aria-hidden="true" tabindex="-1"></a>  x_1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb69-585"><a href="#cb69-585" aria-hidden="true" tabindex="-1"></a>  x_2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb69-586"><a href="#cb69-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-587"><a href="#cb69-587" aria-hidden="true" tabindex="-1"></a>  alpha_hat_1 <span class="ot">&lt;-</span> (x_1 <span class="sc">+</span> x_2) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb69-588"><a href="#cb69-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-589"><a href="#cb69-589" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== approach 2 (positively correlated) ===#</span></span>
<span id="cb69-590"><a href="#cb69-590" aria-hidden="true" tabindex="-1"></a>  x_1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb69-591"><a href="#cb69-591" aria-hidden="true" tabindex="-1"></a>  x_2 <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> x_1 <span class="sc">+</span> <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">-</span>(<span class="fl">0.5</span>)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">*</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb69-592"><a href="#cb69-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-593"><a href="#cb69-593" aria-hidden="true" tabindex="-1"></a>  alpha_hat_2 <span class="ot">&lt;-</span> (x_1 <span class="sc">+</span> x_2) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb69-594"><a href="#cb69-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-595"><a href="#cb69-595" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== approach 3 (negatively correlated) ===#</span></span>
<span id="cb69-596"><a href="#cb69-596" aria-hidden="true" tabindex="-1"></a>  x_1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb69-597"><a href="#cb69-597" aria-hidden="true" tabindex="-1"></a>  x_2 <span class="ot">&lt;-</span> <span class="sc">-</span> <span class="fl">0.8</span> <span class="sc">*</span> x_1 <span class="sc">-</span> <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">-</span>(<span class="fl">0.8</span>)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">*</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb69-598"><a href="#cb69-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-599"><a href="#cb69-599" aria-hidden="true" tabindex="-1"></a>  alpha_hat_3 <span class="ot">&lt;-</span> (x_1 <span class="sc">+</span> x_2) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb69-600"><a href="#cb69-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-601"><a href="#cb69-601" aria-hidden="true" tabindex="-1"></a>  return_data <span class="ot">&lt;-</span></span>
<span id="cb69-602"><a href="#cb69-602" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.table</span>(</span>
<span id="cb69-603"><a href="#cb69-603" aria-hidden="true" tabindex="-1"></a>      <span class="at">alpha_hat_0 =</span> alpha_hat_0,</span>
<span id="cb69-604"><a href="#cb69-604" aria-hidden="true" tabindex="-1"></a>      <span class="at">alpha_hat_1 =</span> alpha_hat_1,</span>
<span id="cb69-605"><a href="#cb69-605" aria-hidden="true" tabindex="-1"></a>      <span class="at">alpha_hat_2 =</span> alpha_hat_2,</span>
<span id="cb69-606"><a href="#cb69-606" aria-hidden="true" tabindex="-1"></a>      <span class="at">alpha_hat_3 =</span> alpha_hat_3</span>
<span id="cb69-607"><a href="#cb69-607" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb69-608"><a href="#cb69-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-609"><a href="#cb69-609" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(return_data)</span>
<span id="cb69-610"><a href="#cb69-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-611"><a href="#cb69-611" aria-hidden="true" tabindex="-1"></a>} </span>
<span id="cb69-612"><a href="#cb69-612" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-613"><a href="#cb69-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-614"><a href="#cb69-614" aria-hidden="true" tabindex="-1"></a>Here is the results of single iteration.</span>
<span id="cb69-615"><a href="#cb69-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-618"><a href="#cb69-618" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-619"><a href="#cb69-619" aria-hidden="true" tabindex="-1"></a><span class="fu">get_alpha</span>(<span class="dv">1</span>)</span>
<span id="cb69-620"><a href="#cb69-620" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-621"><a href="#cb69-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-622"><a href="#cb69-622" aria-hidden="true" tabindex="-1"></a>Repeating this many times,</span>
<span id="cb69-623"><a href="#cb69-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-626"><a href="#cb69-626" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-627"><a href="#cb69-627" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb69-628"><a href="#cb69-628" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">234934</span>)</span>
<span id="cb69-629"><a href="#cb69-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-630"><a href="#cb69-630" aria-hidden="true" tabindex="-1"></a>sim_results <span class="ot">&lt;-</span></span>
<span id="cb69-631"><a href="#cb69-631" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb69-632"><a href="#cb69-632" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>,</span>
<span id="cb69-633"><a href="#cb69-633" aria-hidden="true" tabindex="-1"></a>    get_alpha</span>
<span id="cb69-634"><a href="#cb69-634" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb69-635"><a href="#cb69-635" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb69-636"><a href="#cb69-636" aria-hidden="true" tabindex="-1"></a>  <span class="fu">melt</span>()</span>
<span id="cb69-637"><a href="#cb69-637" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-638"><a href="#cb69-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-639"><a href="#cb69-639" aria-hidden="true" tabindex="-1"></a>@fig-mc-simple shows the density plot of the estimates from the four approaches.</span>
<span id="cb69-640"><a href="#cb69-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-643"><a href="#cb69-643" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-644"><a href="#cb69-644" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Results of simple MC simulations to estimate the expected value of x</span></span>
<span id="cb69-645"><a href="#cb69-645" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-mc-simple</span></span>
<span id="cb69-646"><a href="#cb69-646" aria-hidden="true" tabindex="-1"></a>sim_results <span class="sc">%&gt;%</span> </span>
<span id="cb69-647"><a href="#cb69-647" aria-hidden="true" tabindex="-1"></a>  .[, label <span class="sc">:</span><span class="er">=</span> <span class="fu">gsub</span>(<span class="st">"alpha_hat_"</span>, <span class="st">"Approach "</span>, variable)] <span class="sc">%&gt;%</span> </span>
<span id="cb69-648"><a href="#cb69-648" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">data =</span> .) <span class="sc">+</span></span>
<span id="cb69-649"><a href="#cb69-649" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_density</span>(</span>
<span id="cb69-650"><a href="#cb69-650" aria-hidden="true" tabindex="-1"></a>      <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> label), </span>
<span id="cb69-651"><a href="#cb69-651" aria-hidden="true" tabindex="-1"></a>      <span class="at">alpha =</span> <span class="fl">0.5</span></span>
<span id="cb69-652"><a href="#cb69-652" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb69-653"><a href="#cb69-653" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_discrete</span>(<span class="at">name =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb69-654"><a href="#cb69-654" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb69-655"><a href="#cb69-655" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-656"><a href="#cb69-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-657"><a href="#cb69-657" aria-hidden="true" tabindex="-1"></a>As you can see, they are all pretty much unbiased. However, all the approaches that average two values (approaches 1, 2, and 3) outperformed the base approach that relied on a single value each iteration. You can see that when the random variables are negatively correlated, the power of averaging is greater compared to when they are independent or positively correlated. The independent approach (approach 1) is better than the positive correlation approach (approach 2). </span>
<span id="cb69-658"><a href="#cb69-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-659"><a href="#cb69-659" aria-hidden="true" tabindex="-1"></a>Now that we understand the power of bagging, let's apply this to a regression problem using a tree. The statistics of interest is $E<span class="co">[</span><span class="ot">y|X</span><span class="co">]</span>$, which is denoted as $f(x)$.</span>
<span id="cb69-660"><a href="#cb69-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-661"><a href="#cb69-661" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Bootstrap the data $B$ times</span>
<span id="cb69-662"><a href="#cb69-662" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Train a regression tree to each of the bootstrapped dataset, which results in $B$ distinctive trees</span>
<span id="cb69-663"><a href="#cb69-663" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>To predict $E<span class="co">[</span><span class="ot">y|x</span><span class="co">]</span>$, average the estimate from all the trees ($\hat{f}_1(x), \dots, \hat{f}_B(x)$) and use it as the final estimate.</span>
<span id="cb69-664"><a href="#cb69-664" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb69-665"><a href="#cb69-665" aria-hidden="true" tabindex="-1"></a>\hat{f}(x) = \frac{\hat{f}_1(X) + \dots + \hat{f}_B(X)}{B}</span>
<span id="cb69-666"><a href="#cb69-666" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb69-667"><a href="#cb69-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-668"><a href="#cb69-668" aria-hidden="true" tabindex="-1"></a>Let's implement this for $B = 10$ using <span class="in">`mlb1_dt`</span>. First, define a function that bootstrap data, fit a regression tree, and then return the fitted values (a single iteration). </span>
<span id="cb69-669"><a href="#cb69-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-672"><a href="#cb69-672" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-673"><a href="#cb69-673" aria-hidden="true" tabindex="-1"></a>train_a_tree <span class="ot">&lt;-</span> <span class="cf">function</span>(i, data)</span>
<span id="cb69-674"><a href="#cb69-674" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb69-675"><a href="#cb69-675" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== number of observations ===#</span></span>
<span id="cb69-676"><a href="#cb69-676" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data)</span>
<span id="cb69-677"><a href="#cb69-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-678"><a href="#cb69-678" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== bootstrapped data ===#</span></span>
<span id="cb69-679"><a href="#cb69-679" aria-hidden="true" tabindex="-1"></a>  boot_data <span class="ot">&lt;-</span> data[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>N, N, <span class="at">replace =</span> <span class="cn">TRUE</span>), ]</span>
<span id="cb69-680"><a href="#cb69-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-681"><a href="#cb69-681" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== train a regression tree ===#</span></span>
<span id="cb69-682"><a href="#cb69-682" aria-hidden="true" tabindex="-1"></a>  rpart <span class="ot">&lt;-</span></span>
<span id="cb69-683"><a href="#cb69-683" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rpart</span>(</span>
<span id="cb69-684"><a href="#cb69-684" aria-hidden="true" tabindex="-1"></a>      lsalary <span class="sc">~</span> hruns <span class="sc">+</span> years <span class="sc">+</span> rbisyr <span class="sc">+</span> allstar <span class="sc">+</span> runsyr <span class="sc">+</span> hits <span class="sc">+</span> bavg, </span>
<span id="cb69-685"><a href="#cb69-685" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> boot_data</span>
<span id="cb69-686"><a href="#cb69-686" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb69-687"><a href="#cb69-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-688"><a href="#cb69-688" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== predict ===#</span></span>
<span id="cb69-689"><a href="#cb69-689" aria-hidden="true" tabindex="-1"></a>  return_data <span class="ot">&lt;-</span></span>
<span id="cb69-690"><a href="#cb69-690" aria-hidden="true" tabindex="-1"></a>    <span class="fu">copy</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb69-691"><a href="#cb69-691" aria-hidden="true" tabindex="-1"></a>    .[, y_hat <span class="sc">:</span><span class="er">=</span> <span class="fu">predict</span>(rpart, <span class="at">newdata =</span> data)] <span class="sc">%&gt;%</span> </span>
<span id="cb69-692"><a href="#cb69-692" aria-hidden="true" tabindex="-1"></a>    .[, .(id, y_hat)] <span class="sc">%&gt;%</span> </span>
<span id="cb69-693"><a href="#cb69-693" aria-hidden="true" tabindex="-1"></a>    .[, tree <span class="sc">:</span><span class="er">=</span> i] </span>
<span id="cb69-694"><a href="#cb69-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-695"><a href="#cb69-695" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(return_data)</span>
<span id="cb69-696"><a href="#cb69-696" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb69-697"><a href="#cb69-697" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-698"><a href="#cb69-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-699"><a href="#cb69-699" aria-hidden="true" tabindex="-1"></a>We now repeat <span class="in">`train_a_tree()`</span> 10 times.</span>
<span id="cb69-700"><a href="#cb69-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-703"><a href="#cb69-703" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-704"><a href="#cb69-704" aria-hidden="true" tabindex="-1"></a><span class="co">#=== create observation id for later group-by averaging ===#</span></span>
<span id="cb69-705"><a href="#cb69-705" aria-hidden="true" tabindex="-1"></a>mlb1_dt[, id <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span><span class="sc">:</span>.N]</span>
<span id="cb69-706"><a href="#cb69-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-707"><a href="#cb69-707" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb69-708"><a href="#cb69-708" aria-hidden="true" tabindex="-1"></a>y_estimates <span class="ot">&lt;-</span></span>
<span id="cb69-709"><a href="#cb69-709" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb69-710"><a href="#cb69-710" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,</span>
<span id="cb69-711"><a href="#cb69-711" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">train_a_tree</span>(x, mlb1_dt) </span>
<span id="cb69-712"><a href="#cb69-712" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb69-713"><a href="#cb69-713" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb69-714"><a href="#cb69-714" aria-hidden="true" tabindex="-1"></a>  .[<span class="fu">order</span>(id),]</span>
<span id="cb69-715"><a href="#cb69-715" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-716"><a href="#cb69-716" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-717"><a href="#cb69-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-718"><a href="#cb69-718" aria-hidden="true" tabindex="-1"></a>By averaging $y$ estimates by <span class="in">`id`</span>, we can get bagging estimates.</span>
<span id="cb69-719"><a href="#cb69-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-722"><a href="#cb69-722" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-723"><a href="#cb69-723" aria-hidden="true" tabindex="-1"></a>y_estimates[, <span class="fu">mean</span>(y_hat), by <span class="ot">=</span> id]</span>
<span id="cb69-724"><a href="#cb69-724" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-725"><a href="#cb69-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-726"><a href="#cb69-726" aria-hidden="true" tabindex="-1"></a>This is bagging of many regression trees.</span>
<span id="cb69-727"><a href="#cb69-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-728"><a href="#cb69-728" aria-hidden="true" tabindex="-1"></a><span class="fu">### Random Forest (RF)</span></span>
<span id="cb69-729"><a href="#cb69-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-730"><a href="#cb69-730" aria-hidden="true" tabindex="-1"></a>Now, let's take a look at the individual estimates of $y$ for the first observation from the bagging process we just implemented.</span>
<span id="cb69-731"><a href="#cb69-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-734"><a href="#cb69-734" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-735"><a href="#cb69-735" aria-hidden="true" tabindex="-1"></a>y_estimates[id <span class="sc">==</span> <span class="dv">1</span>, ]</span>
<span id="cb69-736"><a href="#cb69-736" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-737"><a href="#cb69-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-738"><a href="#cb69-738" aria-hidden="true" tabindex="-1"></a>Hmm, the estimates look very similar. Actually, that is not just of the observations with <span class="in">`id == 1`</span>. This is because the trained trees are very similar for many reasons, and the trees are highly "positively" correlated with each other. From our very simple experiment above, we know that the power of bagging is not very high when that is the case. </span>
<span id="cb69-739"><a href="#cb69-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-740"><a href="#cb69-740" aria-hidden="true" tabindex="-1"></a>RF introduces additional uncertainty to the process to make trees less correlated with each other (*decorrelate* trees). Specifically, for any leave of any tree, they consider only a randomly select subset of the explanatory variables when deciding how to split a leave. A typical choice of the number of variables considered at each split is $\sqrt{K}$, where $K$ is the number of the included explanatory variables. In the naive example above, all $K$ variables are considered for all the split decisions of all the trees. Some variables are more influential than others and they get to be picked as the splitting variable at similar places, which can result in highly correlated trees. Instead, RF gives other variables a chance, which helps decorrelate the trees. This means that the tree we build in RF is not deterministic. Depending on which variables are selected for consideration in splitting, the tree will be different even if you use the same bootstrapped dataset.</span>
<span id="cb69-741"><a href="#cb69-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-742"><a href="#cb69-742" aria-hidden="true" tabindex="-1"></a>Let's code the process of building a tree for RF. We first bootstrap a dataset. </span>
<span id="cb69-743"><a href="#cb69-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-746"><a href="#cb69-746" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-747"><a href="#cb69-747" aria-hidden="true" tabindex="-1"></a>n_obs <span class="ot">&lt;-</span> <span class="fu">nrow</span>(mlb1_dt)</span>
<span id="cb69-748"><a href="#cb69-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-749"><a href="#cb69-749" aria-hidden="true" tabindex="-1"></a>boot_data <span class="ot">&lt;-</span> mlb1_dt[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>n_obs, n_obs, <span class="at">replace =</span> <span class="cn">TRUE</span>), ]</span>
<span id="cb69-750"><a href="#cb69-750" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-751"><a href="#cb69-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-752"><a href="#cb69-752" aria-hidden="true" tabindex="-1"></a>Let's now build a tree using <span class="in">`boot_data`</span>. We first split the entire dataset into two.  </span>
<span id="cb69-753"><a href="#cb69-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-754"><a href="#cb69-754" aria-hidden="true" tabindex="-1"></a>We can use <span class="in">`get_rss_by_var()`</span> we wrote earlier, which gets us RSS-minimizing threshold and the minimized RSS value for a single variable. Earlier when we build a regression tree, we looped over all the explanatory variables, which are <span class="in">`hruns`</span>, <span class="in">`years`</span>, <span class="in">`rbisyr`</span>, <span class="in">`allstar`</span>, <span class="in">`runsyr`</span>, <span class="in">`hits`</span>, and <span class="in">`bavg`</span>. But, when building a tree in RF, you can choose to select just a subset of the variables. Here, let's randomly select $\sqrt{K}$ variables. So, rounding $\sqrt{7}$, we have three. </span>
<span id="cb69-755"><a href="#cb69-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-758"><a href="#cb69-758" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-759"><a href="#cb69-759" aria-hidden="true" tabindex="-1"></a>var_list <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"hruns"</span>, <span class="st">"years"</span>, <span class="st">"rbisyr"</span>, <span class="st">"allstar"</span>, <span class="st">"runsyr"</span>, <span class="st">"hits"</span>, <span class="st">"bavg"</span>)</span>
<span id="cb69-760"><a href="#cb69-760" aria-hidden="true" tabindex="-1"></a>K <span class="ot">&lt;-</span> <span class="fu">length</span>(var_list)</span>
<span id="cb69-761"><a href="#cb69-761" aria-hidden="true" tabindex="-1"></a>K_for_split <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(K) <span class="sc">%&gt;%</span> <span class="fu">round</span>()</span>
<span id="cb69-762"><a href="#cb69-762" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-763"><a href="#cb69-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-764"><a href="#cb69-764" aria-hidden="true" tabindex="-1"></a>We randomly select three variables among the list of variables (<span class="in">`var_list`</span>).</span>
<span id="cb69-765"><a href="#cb69-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-768"><a href="#cb69-768" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-769"><a href="#cb69-769" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb69-770"><a href="#cb69-770" aria-hidden="true" tabindex="-1"></a>vars_for_split <span class="ot">&lt;-</span> <span class="fu">sample</span>(var_list, K_for_split, <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb69-771"><a href="#cb69-771" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-772"><a href="#cb69-772" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-773"><a href="#cb69-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-774"><a href="#cb69-774" aria-hidden="true" tabindex="-1"></a>You only consider these <span class="in">`r K_for_split`</span> variables in this splitting process.</span>
<span id="cb69-775"><a href="#cb69-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-778"><a href="#cb69-778" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-779"><a href="#cb69-779" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb69-780"><a href="#cb69-780" aria-hidden="true" tabindex="-1"></a>min_rss_by_var <span class="ot">&lt;-</span></span>
<span id="cb69-781"><a href="#cb69-781" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb69-782"><a href="#cb69-782" aria-hidden="true" tabindex="-1"></a>    vars_for_split,</span>
<span id="cb69-783"><a href="#cb69-783" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">get_rss_by_var</span>(x, mlb1_dt)</span>
<span id="cb69-784"><a href="#cb69-784" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb69-785"><a href="#cb69-785" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>()</span>
<span id="cb69-786"><a href="#cb69-786" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-787"><a href="#cb69-787" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-788"><a href="#cb69-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-789"><a href="#cb69-789" aria-hidden="true" tabindex="-1"></a>So, our choice of split criteria is</span>
<span id="cb69-790"><a href="#cb69-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-793"><a href="#cb69-793" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-794"><a href="#cb69-794" aria-hidden="true" tabindex="-1"></a>min_rss_by_var[<span class="fu">which.min</span>(rss), ]</span>
<span id="cb69-795"><a href="#cb69-795" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-796"><a href="#cb69-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-797"><a href="#cb69-797" aria-hidden="true" tabindex="-1"></a>You will repeat this process for any splits you consider until you met the stopping criteria. </span>
<span id="cb69-798"><a href="#cb69-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-799"><a href="#cb69-799" aria-hidden="true" tabindex="-1"></a>By the way, if we were to use all the variables instead of just these three, then we would have use the following criteria.</span>
<span id="cb69-800"><a href="#cb69-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-803"><a href="#cb69-803" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-804"><a href="#cb69-804" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb69-805"><a href="#cb69-805" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb69-806"><a href="#cb69-806" aria-hidden="true" tabindex="-1"></a>    var_list,</span>
<span id="cb69-807"><a href="#cb69-807" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">get_rss_by_var</span>(x, mlb1_dt)</span>
<span id="cb69-808"><a href="#cb69-808" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb69-809"><a href="#cb69-809" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb69-810"><a href="#cb69-810" aria-hidden="true" tabindex="-1"></a>  .[<span class="fu">which.min</span>(rss), ]</span>
<span id="cb69-811"><a href="#cb69-811" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-812"><a href="#cb69-812" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-813"><a href="#cb69-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-814"><a href="#cb69-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-815"><a href="#cb69-815" aria-hidden="true" tabindex="-1"></a><span class="fu">## Implementation</span></span>
<span id="cb69-816"><a href="#cb69-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-817"><a href="#cb69-817" aria-hidden="true" tabindex="-1"></a>We can use <span class="in">`ranger()`</span> from the <span class="in">`ranger`</span> package to train an RF model. Another commonly used R package for RF is the <span class="in">`randomForest`</span> package. However, <span class="in">`ranger()`</span> is much faster. </span>
<span id="cb69-818"><a href="#cb69-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-819"><a href="#cb69-819" aria-hidden="true" tabindex="-1"></a>The <span class="in">`ranger()`</span> function has many options you can specify that determine how trees are built. Here are some of the important ones (see <span class="co">[</span><span class="ot">here</span><span class="co">](https://cran.r-project.org/web/packages/ranger/ranger.pdf)</span> for the complete description of the hyper-parameters.):</span>
<span id="cb69-820"><a href="#cb69-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-821"><a href="#cb69-821" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`mtry`</span>: the number of variables considered in each split (default is the square root of the total numbers of explanatory variables rounded down.)</span>
<span id="cb69-822"><a href="#cb69-822" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`num.trees`</span>: the number of tree to be built (default is 500)</span>
<span id="cb69-823"><a href="#cb69-823" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`min.node.size`</span>: minimum number of observations in each node (default varies based on the the type of analysis)</span>
<span id="cb69-824"><a href="#cb69-824" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`replace`</span>: where sample with or without replacement when bootstrapping samples (default is <span class="in">`TRUE`</span>)</span>
<span id="cb69-825"><a href="#cb69-825" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span><span class="in">`sample.fraction`</span>: the fraction of the entire observations that are used in each tree (default is 1 if sampling with replacement, 0.632 if sampling without replacement)</span>
<span id="cb69-826"><a href="#cb69-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-827"><a href="#cb69-827" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb69-828"><a href="#cb69-828" aria-hidden="true" tabindex="-1"></a>By setting <span class="in">`replace = FALSE`</span>, you will only use a fraction (randomly selected) of the entire sample in building each tree. This is an alternative to the algorithm discussed earlier, which uses bootstrapped (sample with replacement) dataset to build each tree. </span>
<span id="cb69-829"><a href="#cb69-829" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb69-830"><a href="#cb69-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-831"><a href="#cb69-831" aria-hidden="true" tabindex="-1"></a>Let's try fitting an RF with <span class="in">`ranger()`</span> with the default parameters.</span>
<span id="cb69-832"><a href="#cb69-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-835"><a href="#cb69-835" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-836"><a href="#cb69-836" aria-hidden="true" tabindex="-1"></a><span class="co">#=== load the package ===#</span></span>
<span id="cb69-837"><a href="#cb69-837" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger)</span>
<span id="cb69-838"><a href="#cb69-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-839"><a href="#cb69-839" aria-hidden="true" tabindex="-1"></a><span class="co">#=== fit and RF ===#</span></span>
<span id="cb69-840"><a href="#cb69-840" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb69-841"><a href="#cb69-841" aria-hidden="true" tabindex="-1"></a>rf_fit <span class="ot">&lt;-</span> </span>
<span id="cb69-842"><a href="#cb69-842" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ranger</span>(</span>
<span id="cb69-843"><a href="#cb69-843" aria-hidden="true" tabindex="-1"></a>    lsalary <span class="sc">~</span> hruns <span class="sc">+</span> years <span class="sc">+</span> rbisyr <span class="sc">+</span> allstar <span class="sc">+</span> runsyr <span class="sc">+</span> hits <span class="sc">+</span> bavg, </span>
<span id="cb69-844"><a href="#cb69-844" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> mlb1_dt</span>
<span id="cb69-845"><a href="#cb69-845" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb69-846"><a href="#cb69-846" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-847"><a href="#cb69-847" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-848"><a href="#cb69-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-849"><a href="#cb69-849" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb69-850"><a href="#cb69-850" aria-hidden="true" tabindex="-1"></a>Since we have many trees, it is no longer possible to have a nice graphical representation of the trained RF model like we did with a regression tree.</span>
<span id="cb69-851"><a href="#cb69-851" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb69-852"><a href="#cb69-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-853"><a href="#cb69-853" aria-hidden="true" tabindex="-1"></a>In the output, you can see <span class="in">`OOB prediction error (MSE)`</span>. OOB stands for <span class="kw">&lt;span</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:red"</span><span class="kw">&gt;</span> o<span class="kw">&lt;/span&gt;</span>ut-<span class="kw">&lt;span</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:red"</span><span class="kw">&gt;</span>o<span class="kw">&lt;/span&gt;</span>f-<span class="kw">&lt;span</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:red"</span><span class="kw">&gt;</span>b<span class="kw">&lt;/span&gt;</span>ag. When bootstrapping, some of the train data will not be used to build a tree. </span>
<span id="cb69-854"><a href="#cb69-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-857"><a href="#cb69-857" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-858"><a href="#cb69-858" aria-hidden="true" tabindex="-1"></a><span class="co">#=== bootstrapped data ===#</span></span>
<span id="cb69-859"><a href="#cb69-859" aria-hidden="true" tabindex="-1"></a>boot_data <span class="ot">&lt;-</span> mlb1_dt[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>n_obs, n_obs, <span class="at">replace =</span> <span class="cn">TRUE</span>), ]</span>
<span id="cb69-860"><a href="#cb69-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-861"><a href="#cb69-861" aria-hidden="true" tabindex="-1"></a><span class="co">#=== which rows (observations) from the original datasets are missing? ===#</span></span>
<span id="cb69-862"><a href="#cb69-862" aria-hidden="true" tabindex="-1"></a>mlb1_dt[, id <span class="sc">%in%</span> <span class="fu">unique</span>(boot_data<span class="sc">$</span>id)] <span class="sc">%&gt;%</span> <span class="fu">mean</span>()</span>
<span id="cb69-863"><a href="#cb69-863" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-864"><a href="#cb69-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-865"><a href="#cb69-865" aria-hidden="true" tabindex="-1"></a>So, only $65\%$ of the rows from the original data (<span class="in">`mlb1_dt`</span>) in this bootstrapped sample (many duplicates of the original observations). The observations that are NOT included in the bootstrapped sample is called out-of-bag observations. This provides a great opportunity to estimate test MSE while training an RF model! For a given regression tree, you can apply it to the out-of-bag samples to calculate MSE. You can repeat this for all the trees and average the MSEs, effectively conducting cross-validation. When the number of trees is large enough, OOB MSE is almost equivalent to MSE from LOOCV <span class="co">[</span><span class="ot">@james2013introduction</span><span class="co">]</span>. This means that we can tune hyper-parameters by comparing OOB MSEs under different sets of hyper-parameter values.</span>
<span id="cb69-866"><a href="#cb69-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-867"><a href="#cb69-867" aria-hidden="true" tabindex="-1"></a>You can use a simple grid-search to find the best hyper-parameter values. Grid-search is simply a brute-force optimization methods that goes through a set of combinations of hyper-parameters and see which combination comes at the top. The computational intensity of grid-search depends on how many hyper-parameters you want to vary and how many values you would like to look at for each of the hyper-parameters. Here, let's tune <span class="in">`mtry`</span>, <span class="in">`min.node.size`</span>, and <span class="in">`sample.fraction`</span>.</span>
<span id="cb69-868"><a href="#cb69-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-871"><a href="#cb69-871" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-872"><a href="#cb69-872" aria-hidden="true" tabindex="-1"></a><span class="co">#=== define set of values you want to look at ===#</span></span>
<span id="cb69-873"><a href="#cb69-873" aria-hidden="true" tabindex="-1"></a>mtry_seq <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">7</span>)</span>
<span id="cb69-874"><a href="#cb69-874" aria-hidden="true" tabindex="-1"></a>min_node_size_seq <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">10</span>)</span>
<span id="cb69-875"><a href="#cb69-875" aria-hidden="true" tabindex="-1"></a>sample_fraction_seq <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="dv">1</span>)</span>
<span id="cb69-876"><a href="#cb69-876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-877"><a href="#cb69-877" aria-hidden="true" tabindex="-1"></a><span class="co">#=== create a complete combinations of the three parameters ===#</span></span>
<span id="cb69-878"><a href="#cb69-878" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb69-879"><a href="#cb69-879" aria-hidden="true" tabindex="-1"></a>parameters <span class="ot">&lt;-</span></span>
<span id="cb69-880"><a href="#cb69-880" aria-hidden="true" tabindex="-1"></a>  data.table<span class="sc">::</span><span class="fu">CJ</span>(</span>
<span id="cb69-881"><a href="#cb69-881" aria-hidden="true" tabindex="-1"></a>    <span class="at">mtry =</span> mtry_seq,</span>
<span id="cb69-882"><a href="#cb69-882" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_node_size =</span> min_node_size_seq,</span>
<span id="cb69-883"><a href="#cb69-883" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample_fraction =</span> sample_fraction_seq</span>
<span id="cb69-884"><a href="#cb69-884" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb69-885"><a href="#cb69-885" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-886"><a href="#cb69-886" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-887"><a href="#cb69-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-888"><a href="#cb69-888" aria-hidden="true" tabindex="-1"></a>In total, we have 27 ($3 \times 3 \times 3$) cases. You can see how quickly the number of cases increases  as you increase the number of parameters to tune and the values of each parameter. We can now loop over the rows of this parameter data (<span class="in">`parameters`</span>) and get OOB MSE for each of them.</span>
<span id="cb69-889"><a href="#cb69-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-892"><a href="#cb69-892" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-893"><a href="#cb69-893" aria-hidden="true" tabindex="-1"></a>oob_mse_all <span class="ot">&lt;-</span></span>
<span id="cb69-894"><a href="#cb69-894" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb69-895"><a href="#cb69-895" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq_len</span>(<span class="fu">nrow</span>(parameters)),</span>
<span id="cb69-896"><a href="#cb69-896" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) {</span>
<span id="cb69-897"><a href="#cb69-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-898"><a href="#cb69-898" aria-hidden="true" tabindex="-1"></a>      <span class="co">#=== Fit the mode ===#</span></span>
<span id="cb69-899"><a href="#cb69-899" aria-hidden="true" tabindex="-1"></a>      rf_fit <span class="ot">&lt;-</span> </span>
<span id="cb69-900"><a href="#cb69-900" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ranger</span>(</span>
<span id="cb69-901"><a href="#cb69-901" aria-hidden="true" tabindex="-1"></a>          lsalary <span class="sc">~</span> hruns <span class="sc">+</span> years <span class="sc">+</span> rbisyr <span class="sc">+</span> allstar <span class="sc">+</span> runsyr <span class="sc">+</span> hits <span class="sc">+</span> bavg, </span>
<span id="cb69-902"><a href="#cb69-902" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> mlb1_dt,</span>
<span id="cb69-903"><a href="#cb69-903" aria-hidden="true" tabindex="-1"></a>          <span class="at">num.trees =</span> <span class="dv">1000</span>,</span>
<span id="cb69-904"><a href="#cb69-904" aria-hidden="true" tabindex="-1"></a>          <span class="at">mtry =</span> parameters[x, mtry],</span>
<span id="cb69-905"><a href="#cb69-905" aria-hidden="true" tabindex="-1"></a>          <span class="at">min.node.size =</span> parameters[x, min_node_size],</span>
<span id="cb69-906"><a href="#cb69-906" aria-hidden="true" tabindex="-1"></a>          <span class="at">sample.fraction =</span> parameters[x, sample_fraction]</span>
<span id="cb69-907"><a href="#cb69-907" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb69-908"><a href="#cb69-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-909"><a href="#cb69-909" aria-hidden="true" tabindex="-1"></a>      <span class="co">#=== return OOB SME ===#</span></span>
<span id="cb69-910"><a href="#cb69-910" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(rf_fit<span class="sc">$</span>prediction.error)</span>
<span id="cb69-911"><a href="#cb69-911" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb69-912"><a href="#cb69-912" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb69-913"><a href="#cb69-913" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb69-914"><a href="#cb69-914" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlist</span>()</span>
<span id="cb69-915"><a href="#cb69-915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-916"><a href="#cb69-916" aria-hidden="true" tabindex="-1"></a><span class="co">#=== assign OOB MSE to the parameters data ===#</span></span>
<span id="cb69-917"><a href="#cb69-917" aria-hidden="true" tabindex="-1"></a>parameters[, oob_mse <span class="sc">:</span><span class="er">=</span> oob_mse_all]</span>
<span id="cb69-918"><a href="#cb69-918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-919"><a href="#cb69-919" aria-hidden="true" tabindex="-1"></a><span class="co">#=== take a look ===#</span></span>
<span id="cb69-920"><a href="#cb69-920" aria-hidden="true" tabindex="-1"></a>parameters</span>
<span id="cb69-921"><a href="#cb69-921" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-922"><a href="#cb69-922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-923"><a href="#cb69-923" aria-hidden="true" tabindex="-1"></a>So, the best choice among the ones tried is:</span>
<span id="cb69-924"><a href="#cb69-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-927"><a href="#cb69-927" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-928"><a href="#cb69-928" aria-hidden="true" tabindex="-1"></a>parameters[<span class="fu">which.min</span>(oob_mse), ]</span>
<span id="cb69-929"><a href="#cb69-929" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-930"><a href="#cb69-930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-931"><a href="#cb69-931" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb69-932"><a href="#cb69-932" aria-hidden="true" tabindex="-1"></a>The same cross-validation procedure can be done with less coding effort using the <span class="in">`mlr3`</span> framework (see @sec-mlr3). </span>
<span id="cb69-933"><a href="#cb69-933" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb69-934"><a href="#cb69-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-935"><a href="#cb69-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-936"><a href="#cb69-936" aria-hidden="true" tabindex="-1"></a><span class="fu">## References {.unnumbered}</span></span>
<span id="cb69-937"><a href="#cb69-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-938"><a href="#cb69-938" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;div</span> <span class="er">id</span><span class="ot">=</span><span class="st">"refs"</span><span class="kw">&gt;&lt;/div&gt;</span></span>
<span id="cb69-939"><a href="#cb69-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-940"><a href="#cb69-940" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>