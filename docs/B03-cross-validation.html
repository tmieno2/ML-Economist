<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.629">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Introduction to Machine Learning for Economists (Under Construction) - 3&nbsp; Cross-validation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./B04-regularization.html" rel="next">
<link href="./B02-bias-variance-tradeoff.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<link href="style.css" rel="stylesheet" type="text/css">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-45VKT2HZSL"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'G-45VKT2HZSL');
</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Cross-validation</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Introduction to Machine Learning for Economists (Under Construction)</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/tmieno2/ML-Economist" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="" title="Share" id="sidebar-tool-dropdown-0" class="sidebar-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-share"></i></a>
    <ul class="dropdown-menu" aria-labelledby="sidebar-tool-dropdown-0">
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
            <i class="bi bi-bi-twitter pe-1"></i>
          Twitter
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
            <i class="bi bi-bi-facebook pe-1"></i>
          Facebook
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
            <i class="bi bi-bi-linkedin pe-1"></i>
          LinkedIn
          </a>
        </li>
    </ul>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Welcome</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./H00-preface.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Basics</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B01-nonlinear.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Non-linear function estimation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B02-bias-variance-tradeoff.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Bias-variance Trade-off</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B03-cross-validation.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Cross-validation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B04-regularization.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Regression Shrinkage Methods</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B05-bootstrap.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Bootstrap</span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Prediction ML</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P01-random-forest.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Random Forest</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P02-boosted-regression-forest.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Boosted Regression Forest</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P03-xgb.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Extreme Gradient Boosting</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P04-local-linear-forest.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Local Linear Forest</span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./C0P-causal-ml.html" class="sidebar-item-text sidebar-link">Causal Machine Learning (CML) Methods</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C00-why-not-this.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Why can’t we just do this?</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C01-dml.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Double Machine Learning</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C02-xstr-learner.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">S-, X-, T-, and R-learner</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C03-cf-orf.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Forest-based CATE Estimators</span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./E0P-extensions.html" class="sidebar-item-text sidebar-link">Extensions</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./E01-spatial-cv.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Spatial Cross-validation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./E02-grf.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Generalized Random Forest</span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./PROG-00-programming.html" class="sidebar-item-text sidebar-link">Programming Guide</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PROG-01-mlr3.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Machine Learning with <code>mlr3</code> in R</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PROG-02-reticulate.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Running Python from R</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PROG-03-model-selection-prediction.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Model Selection (Prediction)</span></a>
  </div>
</li>
    </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">Appendices</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A01-mc-simulation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Monte Carlo (MC) Simulation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A02-method-of-moment.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Primer on method of moment</span></a>
  </div>
</li>
    </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#motivations" id="toc-motivations" class="nav-link active" data-scroll-target="#motivations"> <span class="header-section-number">3.1</span> Motivations</a></li>
  <li><a href="#leave-one-out-cross-validation-loocv" id="toc-leave-one-out-cross-validation-loocv" class="nav-link" data-scroll-target="#leave-one-out-cross-validation-loocv"> <span class="header-section-number">3.2</span> Leave-One-Out Cross-Validation (LOOCV)</a>
  <ul class="collapse">
  <li><a href="#r-demonstration-using-mgcvgam" id="toc-r-demonstration-using-mgcvgam" class="nav-link" data-scroll-target="#r-demonstration-using-mgcvgam"> <span class="header-section-number">3.2.1</span> R demonstration using <code>mgcv::gam()</code></a></li>
  <li><a href="#selecting-the-best-gam-specification-illustration" id="toc-selecting-the-best-gam-specification-illustration" class="nav-link" data-scroll-target="#selecting-the-best-gam-specification-illustration"> <span class="header-section-number">3.2.2</span> Selecting the best GAM specification: Illustration</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"> <span class="header-section-number">3.2.3</span> Summary</a></li>
  </ul></li>
  <li><a href="#k-fold-cross-validation-kcv" id="toc-k-fold-cross-validation-kcv" class="nav-link" data-scroll-target="#k-fold-cross-validation-kcv"> <span class="header-section-number">3.3</span> K-fold Cross-Validation (KCV)</a>
  <ul class="collapse">
  <li><a href="#selecting-the-best-gam-specification-illustration-1" id="toc-selecting-the-best-gam-specification-illustration-1" class="nav-link" data-scroll-target="#selecting-the-best-gam-specification-illustration-1"> <span class="header-section-number">3.3.1</span> Selecting the best GAM specification: Illustration</a></li>
  </ul></li>
  <li><a href="#repeated-k-fold-cross-validation-rkcv" id="toc-repeated-k-fold-cross-validation-rkcv" class="nav-link" data-scroll-target="#repeated-k-fold-cross-validation-rkcv"> <span class="header-section-number">3.4</span> Repeated K-fold Cross-Validation (RKCV)</a></li>
  <li><a href="#how-are-loocv-kcv-and-rkcv-different" id="toc-how-are-loocv-kcv-and-rkcv-different" class="nav-link" data-scroll-target="#how-are-loocv-kcv-and-rkcv-different"> <span class="header-section-number">3.5</span> How are LOOCV, KCV and RKCV different?</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/tmieno2/ML-Economist/edit/master/B03-cross-validation.qmd" class="toc-action">Edit this page</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-cross-validation" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Cross-validation</span></span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<section id="motivations" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="motivations"><span class="header-section-number">3.1</span> Motivations</h2>
<p>No model works the best all the time, and searching for the best modeling approach and specifications is an essential part of modeling applications.</p>
<p>For example, we may consider five approaches with varying modeling specifications for each of the approaches:</p>
<ul>
<li>Random Forest (RF)
<ul>
<li>number of trees (1000, 2000)</li>
<li>number of variables used in each tree (3, 5, 8)</li>
<li>and many other hyper parameters</li>
</ul></li>
<li>LASSO
<ul>
<li>penalty parameter (1, 2, 3, etc)</li>
</ul></li>
<li>GAM
<ul>
<li>number of knots</li>
<li>penalty parameter</li>
</ul></li>
<li>Boosted Regression Forest (BRF)
<ul>
<li>number of trees (1000, 2000)</li>
<li>number of variables used in each tree (3, 5, 8)</li>
<li>and many other hyper parameters</li>
</ul></li>
<li>Convolutional Neural Network (CNN)
<ul>
<li>convolution matrix dimension</li>
<li>the order of convolution</li>
<li>learning rate</li>
<li>and many other hyper parameters</li>
</ul></li>
</ul>
<p>Our goal here is to find the model that would performs the best when applied to the data that has not been seen yet.</p>
<p>We saw earlier that training MSE is not appropriate for that purpose as picking the model with the lowest training MSE would very much likely to lead you to an over-fitted model. In this lecture, we consider a better way of selecting a model using only train data.</p>
<div class="callout-important callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Why CV?</strong> When the amount of data is limited and you cannot afford to split the data into training and test datasets, you can use a CV to estimate test MSE (by validating a trained model as if you have test data within the training data) for the purpose of picking the right model and hyper-parameter values.</p>
</div>
</div>
<p>Here is a workflow of identifying the final model and come up with the final trained model.</p>
<ul>
<li>Make a list of models (e.g., RF, BRF, NN) with various hyper-parameter values to try for each of of the models (like above)</li>
<li>Conduct a CV to see which model-hyper-parameter combination minimizes MSE</li>
<li>Train the best model specification to the entire training dataset, which becomes your final trained model</li>
</ul>
<div class="callout-note callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that you do not use any of the models trained during the CV process. They are ran purely for the purpose of finding the best model and hyper-parameter values.</p>
</div>
</div>
</section>
<section id="leave-one-out-cross-validation-loocv" class="level2 page-columns page-full" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="leave-one-out-cross-validation-loocv"><span class="header-section-number">3.2</span> Leave-One-Out Cross-Validation (LOOCV)</h2>

<div class="no-row-height column-margin column-container"><div class="">
<p><strong>Packages to load for replication</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rsample)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div></div><p>Consider a dataset: <span class="math inline">\(D = \{X_1, y_1\}, \{X_2, y_2\}, \dots, \{X_N, y_N\}\)</span>, where <span class="math inline">\(X_i\)</span> is a collection of features and <span class="math inline">\(y_i\)</span> is the dependent variable for <span class="math inline">\(i\)</span>th observation. Further, suppose you use <span class="math inline">\(D\)</span> for training ML models and <span class="math inline">\(\hat{f}()\)</span> is a trained model.</p>
<p>LOOCV leaves out a single observation (say <span class="math inline">\(i\)</span>), and train a model (say, GAM with the number of knots of 10) using the all the other observations (-<span class="math inline">\(i\)</span>), and then find MSE for the left-out observation. This process is repeated for all the observations, and then the average of the individual MSEs is calculated.</p>
<section id="r-demonstration-using-mgcvgam" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="r-demonstration-using-mgcvgam"><span class="header-section-number">3.2.1</span> R demonstration using <code>mgcv::gam()</code></h3>
<p>Let’s demonstrate this using R. Here is the dataset we use.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">943843</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># define the data generating process</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># x fixed</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>gen_data <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  ey <span class="ot">&lt;-</span> (x <span class="sc">-</span> <span class="fl">2.5</span>)<span class="sc">^</span><span class="dv">3</span> <span class="co"># E[y|x]</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> ey <span class="sc">+</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(x)) <span class="co"># y = E[y|x] + u</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  return_data <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">y =</span> y, <span class="at">x =</span> x, <span class="at">ey =</span> ey)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(return_data)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="do">## generate train data</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">gen_data</span>(<span class="at">x =</span> <span class="fu">runif</span>(<span class="dv">100</span>) <span class="sc">*</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Visually, here is the relationship between <span class="math inline">\(E[y]\)</span> and <span class="math inline">\(x\)</span>:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> data) <span class="sc">+</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> ey, <span class="at">x =</span> x)) <span class="sc">+</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="B03-cross-validation_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<p>For example, for the case where the first observation is left out for validation,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># leave out the first observation</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>left_out_observation <span class="ot">&lt;-</span> data[<span class="dv">1</span>, ]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># all the rest</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> data[<span class="sc">-</span><span class="dv">1</span>, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we train a gam model using the train_data, predict <span class="math inline">\(y\)</span> for the first observation, and find the MSE.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== train the model ===#</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>fitted <span class="ot">&lt;-</span> <span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">10</span>), <span class="at">sp =</span> <span class="dv">0</span>, <span class="at">data =</span> train_data)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== predict y for the first observation ===#</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>y_fitted <span class="ot">&lt;-</span> <span class="fu">predict</span>(fitted, <span class="at">newdata =</span> left_out_observation)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">#=== get MSE ===#</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>MSE <span class="ot">&lt;-</span> (left_out_observation[, y] <span class="sc">-</span> y_fitted) <span class="sc">^</span> <span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As described above, LOOCV repeats this process for every single observation of the data. Now, let’s write a function that does the above process for any <span class="math inline">\(i\)</span> you specify.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== define the modeling approach ===#</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>gam_k_10 <span class="ot">&lt;-</span> <span class="cf">function</span>(train_data) </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">30</span>), <span class="at">sp =</span> <span class="dv">0</span>, <span class="at">data =</span> train_data)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">#=== define the process of getting MSE for ith observation ===#</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>get_mse <span class="ot">&lt;-</span> <span class="cf">function</span>(i, model)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  left_out_observation <span class="ot">&lt;-</span> data[i, ]</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># all the rest</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  train_data <span class="ot">&lt;-</span> data[<span class="sc">-</span>i, ]</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== train the model ===#</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  fitted <span class="ot">&lt;-</span> <span class="fu">model</span>(train_data)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== predict y for the first observation ===#</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  y_fitted <span class="ot">&lt;-</span> <span class="fu">predict</span>(fitted, <span class="at">newdata =</span> left_out_observation)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== get MSE ===#</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  MSE <span class="ot">&lt;-</span> (left_out_observation[, y] <span class="sc">-</span> y_fitted) <span class="sc">^</span> <span class="dv">2</span> </span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(MSE)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>} </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For example, this gets MSE for the 10th observation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_mse</span>(<span class="dv">10</span>, gam_k_10)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       1 
1.523446 </code></pre>
</div>
</div>
<p>Let’s now loop over <span class="math inline">\(i = 1:100\)</span>.</p>
<div class="cell" data-hash="B03-cross-validation_cache/html/unnamed-chunk-9_53a6f67f08a94673e1e98dcddd4ae774">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>mse_indiv <span class="ot">&lt;-</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">get_mse</span>(x, gam_k_10)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== list to a vector ===#</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlist</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is the distribution of MSEs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(mse_indiv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="B03-cross-validation_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We now get the average MSE.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(mse_indiv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 12.46016</code></pre>
</div>
</div>
</section>
<section id="selecting-the-best-gam-specification-illustration" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="selecting-the-best-gam-specification-illustration"><span class="header-section-number">3.2.2</span> Selecting the best GAM specification: Illustration</h3>
<p>Now, let’s try to find the best (among the ones we try) GAM specification using LOOCV. We will try ten different GAM specifications which vary in penalization parameter. Penalization parameter can be set using the <code>sp</code> option for <code>mgcv::gam()</code>. A greater value of <code>sp</code> leads to a more smooth fitted curve.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>specify_gam <span class="ot">&lt;-</span> <span class="cf">function</span>(sp) {</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(train_data) {</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">30</span>), <span class="at">sp =</span> sp, <span class="at">data =</span> train_data)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>get_mse_by_sp <span class="ot">&lt;-</span> <span class="cf">function</span>(sp)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  temp_gam <span class="ot">&lt;-</span> <span class="fu">specify_gam</span>(sp)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  mse_indiv <span class="ot">&lt;-</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>      <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>,</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">function</span>(x) <span class="fu">get_mse</span>(x, temp_gam)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#=== list to a vector ===#</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>()</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>  return_data <span class="ot">&lt;-</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.table</span>(</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">mse =</span> mse_indiv,</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">sp =</span> sp</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(return_data)</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For example, the following code gets you the average MSE for <code>sp</code> <span class="math inline">\(= 3\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_mse_by_sp</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        mse sp
1: 11.56747  3</code></pre>
</div>
</div>
<p>Now, let’s loop over ten values of <code>sp</code>: 0, 0.2, 0.4, 0.6, 0.8, 1, 1.2, 1.4, 1.6, 1.8, 2.</p>
<div class="cell" data-hash="B03-cross-validation_cache/html/unnamed-chunk-14_edb7c81c24452713ed020b9b23ed278e">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>mse_data <span class="ot">&lt;-</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">2</span>, <span class="at">by =</span> <span class="fl">0.2</span>),</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">get_mse_by_sp</span>(x)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>()</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          mse  sp
 1: 12.460156 0.0
 2:  9.909992 0.2
 3:  9.957858 0.4
 4: 10.049327 0.6
 5: 10.164749 0.8
 6: 10.293142 1.0
 7: 10.427948 1.2
 8: 10.565081 1.4
 9: 10.701933 1.6
10: 10.836829 1.8
11: 10.968701 2.0</code></pre>
</div>
</div>
<div class="cell">

</div>
<p>So, according to the LOOCV, we should pick <code>sp</code> <span class="math inline">\(= 0.2\)</span> as the penalty parameter.</p>
<p>Now, that we know <code>sp</code> <span class="math inline">\(= 0.2\)</span> produces the lowest LOOCV MSE, we rerun <code>gam()</code> using the entire dataset (not leaving out any of the observations) and make it our final trained model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>final_gam_spec <span class="ot">&lt;-</span> <span class="fu">specify_gam</span>(<span class="at">sp =</span> <span class="dv">1</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>fit_gam <span class="ot">&lt;-</span> <span class="fu">final_gam_spec</span>(train_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is what the fitted curve looks like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit_gam)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="B03-cross-validation_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Looks good. By the way, here are the fitted curves for some other <code>sp</code> values.</p>
<div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>fitted_curves <span class="ot">&lt;-</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.6</span>, <span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) {</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>      temp_gam <span class="ot">&lt;-</span> <span class="fu">specify_gam</span>(<span class="at">sp =</span> x)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>      fit_gam <span class="ot">&lt;-</span> <span class="fu">temp_gam</span>(train_data)   </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  )  </span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (plot <span class="cf">in</span> fitted_curves) {</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(plot)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-fitted-penalization-others" class="cell quarto-layout-panel">
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-fitted-penalization-others-1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="B03-cross-validation_files/figure-html/fig-fitted-penalization-others-1.png" class="img-fluid figure-img" data-ref-parent="fig-fitted-penalization-others" width="672"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">(a) sp = 0</figcaption><p></p>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-fitted-penalization-others-2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="B03-cross-validation_files/figure-html/fig-fitted-penalization-others-2.png" class="img-fluid figure-img" data-ref-parent="fig-fitted-penalization-others" width="672"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">(b) sp = 0.6</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-fitted-penalization-others-3" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="B03-cross-validation_files/figure-html/fig-fitted-penalization-others-3.png" class="img-fluid figure-img" data-ref-parent="fig-fitted-penalization-others" width="672"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">(c) sp = 1</figcaption><p></p>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-fitted-penalization-others-4" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="B03-cross-validation_files/figure-html/fig-fitted-penalization-others-4.png" class="img-fluid figure-img" data-ref-parent="fig-fitted-penalization-others" width="672"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">(d) sp = 2</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p></p><figcaption aria-hidden="true" class="figure-caption">Figure 3.1: Fitted curves at various penalization parameters</figcaption><p></p>
</figure>
</div>
</div>
<p>LOOCV is perfectly general and can be applied to any statistical methods. However, it can be extremely computationally burdensome because you need to fit the same model for as many as the number of observations. So, if you have 10,000 observations, then you need to fit the model 10,000 times, which can take a long long time.</p>
</section>
<section id="summary" class="level3" data-number="3.2.3">
<h3 data-number="3.2.3" class="anchored" data-anchor-id="summary"><span class="header-section-number">3.2.3</span> Summary</h3>
<div class="callout-note callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>LOOCV is perfectly general and can be applied to any statistical methods.</p>
</div>
</div>
<div class="callout-warning callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>LOOCV can be highly computation-intensive when the dataset is large</p>
</div>
</div>
</section>
</section>
<section id="k-fold-cross-validation-kcv" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="k-fold-cross-validation-kcv"><span class="header-section-number">3.3</span> K-fold Cross-Validation (KCV)</h2>
<p>KCV is a type of cross-validation that overcomes the LOOCV’s drawback of being computationally too intensive when the dataset is large. KCV first splits the entire dataset intro <span class="math inline">\(K\)</span> folds (K groups) randomly. It then leaves out a chunk of observations that belongs to a fold (group), trains the model using the rest of the observations in the other folds, evaluate the trained model using the left-out group. It repeats this process for all the groups and average the MSEs obtained for each group.</p>
<p>Let’s demonstrate this process using R.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">89534</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">gen_data</span>(<span class="at">x =</span> <span class="fu">runif</span>(<span class="dv">500</span>) <span class="sc">*</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can use <code>rsample::vfold_cv()</code> to split the data into groups.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== split into 5 groups ===#</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>data_folds <span class="ot">&lt;-</span> rsample<span class="sc">::</span><span class="fu">vfold_cv</span>(data, <span class="at">v =</span> <span class="dv">5</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#  5-fold cross-validation 
# A tibble: 5 × 2
  splits            id   
  &lt;list&gt;            &lt;chr&gt;
1 &lt;split [400/100]&gt; Fold1
2 &lt;split [400/100]&gt; Fold2
3 &lt;split [400/100]&gt; Fold3
4 &lt;split [400/100]&gt; Fold4
5 &lt;split [400/100]&gt; Fold5</code></pre>
</div>
</div>
<p>As you can see, <code>rsample::vfold_cv()</code> creates <span class="math inline">\(v\)</span> (<span class="math inline">\(=5\)</span> here) splits. And each split has both train and test datasets. <code>&lt;split [400/100]&gt;</code> means that <span class="math inline">\(400\)</span> and <span class="math inline">\(100\)</span> observations for the train and test datasets, respectively. Note that, the <span class="math inline">\(100\)</span> observations in the first split (called <code>Fold 1</code>) are in the train datasets of the rest of the splits (<code>Fold 2</code> through <code>Fold 5</code>).</p>
<p>You can extract the train and test datasets like below using the <code>training()</code> and <code>testing()</code> functions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> data_folds[<span class="dv">1</span>, ]<span class="sc">$</span>splits[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> <span class="fu">training</span>()</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> data_folds[<span class="dv">1</span>, ]<span class="sc">$</span>splits[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> <span class="fu">testing</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, let’s get MSE for the first fold.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== train the model ===#</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>fitted_model <span class="ot">&lt;-</span> <span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">30</span>), <span class="at">sp =</span> <span class="dv">0</span>, <span class="at">data =</span> train_data)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co">#=== predict y for the test data ===#</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>y_hat <span class="ot">&lt;-</span> <span class="fu">predict</span>(fitted_model, test_data)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co">#=== calculate MSE for the fold ===#</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>(test_data[, y] <span class="sc">-</span> y_hat)<span class="sc">^</span><span class="dv">2</span> <span class="sc">%&gt;%</span> <span class="fu">mean</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 12.05604</code></pre>
</div>
</div>
<p>Now that we know how to get MSE for a single fold, let’s loop over folds and get MSE for each of the folds. We first create a function that gets us MSE for a single fold.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>get_mse_by_fold <span class="ot">&lt;-</span> <span class="cf">function</span>(data, fold, model)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  test_data <span class="ot">&lt;-</span> data_folds[fold, ]<span class="sc">$</span>splits[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> <span class="fu">testing</span>()</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  train_data <span class="ot">&lt;-</span> data_folds[fold, ]<span class="sc">$</span>splits[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> <span class="fu">training</span>()</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== train the model ===#</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  fitted_model <span class="ot">&lt;-</span> <span class="fu">model</span>(train_data)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== predict y for the test data ===#</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  y_hat <span class="ot">&lt;-</span> <span class="fu">predict</span>(fitted_model, test_data)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== calculate MSE for the fold ===#</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  mse <span class="ot">&lt;-</span> (test_data[, y] <span class="sc">-</span> y_hat)<span class="sc">^</span><span class="dv">2</span> <span class="sc">%&gt;%</span> <span class="fu">mean</span>() </span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  return_data <span class="ot">&lt;-</span> </span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.table</span>(</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">k =</span> fold, </span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">mse =</span> mse</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(return_data)</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This will get you MSE for the third fold.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_mse_by_fold</span>(data, <span class="dv">3</span>, gam_k_10)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   k      mse
1: 3 10.65129</code></pre>
</div>
</div>
<p>Now, let’s loop over the row number of <code>data_folds</code> (loop over <code>splits</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>mse_all <span class="ot">&lt;-</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq_len</span>(<span class="fu">nrow</span>(data_folds)),</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">get_mse_by_fold</span>(data, x, gam_k_10)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>()</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   k       mse
1: 1 12.056038
2: 2  9.863496
3: 3 10.651289
4: 4 10.705704
5: 5 10.166634</code></pre>
</div>
</div>
<p>By averaging MSE values, we get</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>mse_all[, <span class="fu">mean</span>(mse)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10.68863</code></pre>
</div>
</div>
<section id="selecting-the-best-gam-specification-illustration-1" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="selecting-the-best-gam-specification-illustration-1"><span class="header-section-number">3.3.1</span> Selecting the best GAM specification: Illustration</h3>
<p>Just like we found the best gam specification (choice of penalization parameter) using LOOCV, we do the same now using KCV.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>get_mse_by_sp_kcv <span class="ot">&lt;-</span> <span class="cf">function</span>(sp)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  temp_gam <span class="ot">&lt;-</span> <span class="fu">specify_gam</span>(sp)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  mse_by_k <span class="ot">&lt;-</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">seq_len</span>(<span class="fu">nrow</span>(data_folds)),</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">function</span>(x) <span class="fu">get_mse_by_fold</span>(train_data, x, temp_gam)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbindlist</span>()</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>  return_data <span class="ot">&lt;-</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    mse_by_k <span class="sc">%&gt;%</span> </span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    .[, sp <span class="sc">:</span><span class="er">=</span> sp]</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(return_data[])</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For example, the following code gets you the MSE for all the folds for <code>sp</code> <span class="math inline">\(= 3\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_mse_by_sp_kcv</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   k      mse sp
1: 1 13.56925  3
2: 2 11.22831  3
3: 3 11.45746  3
4: 4 10.48461  3
5: 5 11.29421  3</code></pre>
</div>
</div>
<p>Now, let’s loop over ten values of <code>sp</code>: 0, 0.2, 0.4, 0.6, 0.8, 1, 1.2, 1.4, 1.6, 1.8, 2.</p>
<div class="cell" data-hash="B03-cross-validation_cache/html/unnamed-chunk-29_2239790bf0fd7d74b8ecce1aa3d6f182">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>mse_results <span class="ot">&lt;-</span> </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">2</span>, <span class="at">by =</span> <span class="fl">0.2</span>),</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">get_mse_by_sp_kcv</span>(x)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>()</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    k       mse  sp
 1: 1 12.056038 0.0
 2: 2  9.863496 0.0
 3: 3 10.651289 0.0
 4: 4 10.705704 0.0
 5: 5 10.166634 0.0
 6: 1 11.476153 0.2
 7: 2  9.840434 0.2
 8: 3  9.813155 0.2
 9: 4 10.289085 0.2
10: 5  9.895722 0.2
11: 1 11.620416 0.4
12: 2  9.882467 0.4
13: 3  9.916178 0.4
14: 4 10.239119 0.4
15: 5  9.992636 0.4
16: 1 11.785544 0.6
17: 2  9.952820 0.6
18: 3 10.033789 0.6
19: 4 10.218321 0.6
20: 5 10.090156 0.6
21: 1 11.957640 0.8
22: 2 10.040814 0.8
23: 3 10.156511 0.8
24: 4 10.211168 0.8
25: 5 10.189377 0.8
26: 1 12.130712 1.0
27: 2 10.140277 1.0
28: 3 10.281839 1.0
29: 4 10.213564 1.0
30: 5 10.290230 1.0
31: 1 12.301318 1.2
32: 2 10.246975 1.2
33: 3 10.408152 1.2
34: 4 10.223465 1.2
35: 5 10.392306 1.2
36: 1 12.467400 1.4
37: 2 10.357879 1.4
38: 3 10.534197 1.4
39: 4 10.239448 1.4
40: 5 10.495093 1.4
41: 1 12.627767 1.6
42: 2 10.470802 1.6
43: 3 10.659006 1.6
44: 4 10.260390 1.6
45: 5 10.598085 1.6
46: 1 12.781780 1.8
47: 2 10.584159 1.8
48: 3 10.781853 1.8
49: 4 10.285370 1.8
50: 5 10.700824 1.8
51: 1 12.929162 2.0
52: 2 10.696811 2.0
53: 3 10.902210 2.0
54: 4 10.313617 2.0
55: 5 10.802917 2.0
    k       mse  sp</code></pre>
</div>
</div>
<p>Let’s now get the average MSE by sp:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>mean_mse_data <span class="ot">&lt;-</span> mse_results[, .(<span class="at">mean_mse =</span> <span class="fu">mean</span>(mse)), <span class="at">by =</span> sp]</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     sp mean_mse
 1: 0.0 10.68863
 2: 0.2 10.26291
 3: 0.4 10.33016
 4: 0.6 10.41613
 5: 0.8 10.51110
 6: 1.0 10.61132
 7: 1.2 10.71444
 8: 1.4 10.81880
 9: 1.6 10.92321
10: 1.8 11.02680
11: 2.0 11.12894</code></pre>
</div>
</div>
<div class="cell">

</div>
<p>So, according to the KCV, we should pick <code>sp</code> <span class="math inline">\(= 0.2\)</span> as the penalty parameter.</p>
<p>By the way, here is what MSE values look like for each fold based on the value of <code>sp</code> by fold.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> mse_results) <span class="sc">+</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> mse, <span class="at">x =</span> sp, <span class="at">color =</span> <span class="fu">factor</span>(k))) <span class="sc">+</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_discrete</span>(<span class="at">name =</span> <span class="st">"Fold"</span>) <span class="sc">+</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="B03-cross-validation_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="576"></p>
</div>
</div>
<div class="callout-note callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Even though we compared different specification of the same approach (GAM), we can compare across different models as well. For example, you can find KCV for an RF model with a particular specifications of its hyper-parameters and compare the KCV with those of the GAM model specifications and see what comes at the top.</p>
</div>
</div>
</section>
</section>
<section id="repeated-k-fold-cross-validation-rkcv" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="repeated-k-fold-cross-validation-rkcv"><span class="header-section-number">3.4</span> Repeated K-fold Cross-Validation (RKCV)</h2>
<p>As its name suggest, repeated KCV repeats the process of KCV multiple times. Each KCV iteration splits the original data into k-fold in a different way. A single KCV may not be reliable as the original data was split into such a way that favors one parameter set of or model class over the others. However, if we repeat KCV multiple times, then we can safe-guard against this randomness in a KCV procedure. Repeated KCV is preferred over a single KCV.</p>
<p>You can use <code>rsample::vfold_cv()</code> to create repeated k-fold datasets by using the <code>repeats</code> argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">#=== split into 5 groups ===#</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>data_folds <span class="ot">&lt;-</span> rsample<span class="sc">::</span><span class="fu">vfold_cv</span>(data, <span class="at">v =</span> <span class="dv">5</span>, <span class="at">repeats =</span> <span class="dv">5</span>)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#  5-fold cross-validation repeated 5 times 
# A tibble: 25 × 3
   splits            id      id2  
   &lt;list&gt;            &lt;chr&gt;   &lt;chr&gt;
 1 &lt;split [400/100]&gt; Repeat1 Fold1
 2 &lt;split [400/100]&gt; Repeat1 Fold2
 3 &lt;split [400/100]&gt; Repeat1 Fold3
 4 &lt;split [400/100]&gt; Repeat1 Fold4
 5 &lt;split [400/100]&gt; Repeat1 Fold5
 6 &lt;split [400/100]&gt; Repeat2 Fold1
 7 &lt;split [400/100]&gt; Repeat2 Fold2
 8 &lt;split [400/100]&gt; Repeat2 Fold3
 9 &lt;split [400/100]&gt; Repeat2 Fold4
10 &lt;split [400/100]&gt; Repeat2 Fold5
# … with 15 more rows</code></pre>
</div>
</div>
<p>The output has 5 (number of folds) times 5 (number of repeats) splits. It also has an additional column that indicates which repeat each row is in (<code>id</code>). You can apply <code>get_mse_by_fold()</code> (this function is defined above and calculate MSE) to each row (split) one by one and calculate MSE just like we did above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>mean_mse <span class="ot">&lt;-</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq_len</span>(<span class="fu">nrow</span>(data_folds)),</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">get_mse_by_fold</span>(data, x, gam_k_10)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  .[, <span class="fu">mean</span>(mse)]</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10.65908</code></pre>
</div>
</div>
</section>
<section id="how-are-loocv-kcv-and-rkcv-different" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="how-are-loocv-kcv-and-rkcv-different"><span class="header-section-number">3.5</span> How are LOOCV, KCV and RKCV different?</h2>
<!-- ## Does KCV really work?

LOOCV and KCV use the train data to estimate test MSE. But, does it really work? In other words, does it let us pick the parameter that minimizes the test MSE? We will run a simple MC simulations to test this. We continue to use the same data generating process and GAM models for this simulation as well. 

Now, since we know the data generating process, we can actually use the following metric instead of MSE.



$$
\sum_{i=1}^N(\hat{f}(x_i) - E[y|x_i])^2
$$



This measure removes the influence of the error term that appears in the test MSE. Your objective is to minimize this measure. Of course, you cannot do this in practice because you do not observe $E[y|x]$. Let's call this "pure" MSE.

First, we define a function that gets you MSE from KCV and MSE using the test data as a function of `sp`.


::: {.cell}

```{.r .cell-code}
get_mse_by_sp <- function(sp)
{

  #=== generate train data and test data ===#
  train_data <- gen_data(x = runif(500) * 5)
  test_data <- gen_data(x = runif(500) * 5)

  #/*----------------------------------*/
  #' ## MSE from KCV 
  #/*----------------------------------*/
  #=== split train_data into 5 groups ===#
  data_folds <- rsample::vfold_cv(train_data, v = 5)
  
  #=== specify the model ===#
  temp_gam <- specify_gam(sp)

  #=== get MSE by fold ===#
  mse_by_k <-
    lapply(
      seq_len(nrow(data_folds)),
      function(x) get_mse_by_fold(train_data, x, temp_gam)
    ) %>% 
    rbindlist()

  #=== find the average MSE (over folds) ===#
  mse_kcv <-
    mse_by_k %>% 
    .[, .(mse = mean(mse))] %>% 
    .[, sp := sp] %>% 
    .[, type := "KCV"]

  #/*----------------------------------*/
  #' ## pure MSE from the test data  
  #/*----------------------------------*/
  #=== train using the entire train dataset ===#
  fitted <- temp_gam(train_data)

  #=== find the average MSE (over observations) ===#
  mse_test <- 
    test_data %>% 
    #=== predict y ===#
    .[, y_hat := predict(fitted, newdata = .)] %>% 
    .[, .(mse = mean((ey - y_hat)^2))] %>% 
    .[, sp := sp] %>% 
    .[, type := "Pure"]

  #/*----------------------------------*/
  #' ## Combine and return
  #/*----------------------------------*/
  return_data <- rbind(mse_kcv, mse_test)

  return(return_data)
}
```
:::


:::{.callout-warning}
Note that you do not have to use an independent test data to obtain pure MSE above even though the code does it so. You could just use the `train_data` in getting pure MSE and the results would be essentially the same.
:::


For example, this will give you MSE from KCV and MSE using the test data for `sp` $= 2$.


::: {.cell}

```{.r .cell-code}
get_mse_by_sp(2)
```

::: {.cell-output .cell-output-stdout}
```
          mse sp type
1: 11.0072347  2  KCV
2:  0.7131384  2 Pure
```
:::
:::


Now, we define a function that loops over all the `sp` values we test.


::: {.cell}

```{.r .cell-code}
sp_seq <- seq(0, 2, by = 0.2)

get_mse <- function(i)
{ 
  print(i) # progress tracker

  lapply(
    sp_seq,
    function(x) get_mse_by_sp(x)
  ) %>% 
  rbindlist()
}
```
:::


For example, the following gives you MSE values for all the `sp` values for a single iteration.


::: {.cell}

```{.r .cell-code}
get_mse(1)
```

::: {.cell-output .cell-output-stdout}
```
[1] 1
```
:::

::: {.cell-output .cell-output-stdout}
```
            mse  sp type
 1: 10.49305386 0.0  KCV
 2:  0.46854532 0.0 Pure
 3: 10.07060222 0.2  KCV
 4:  0.06385132 0.2 Pure
 5: 10.14490012 0.4  KCV
 6:  0.28102534 0.4 Pure
 7: 10.23670256 0.6  KCV
 8:  0.29782934 0.6 Pure
 9: 10.33852029 0.8  KCV
10:  0.46728439 0.8 Pure
11: 10.44652013 1.0  KCV
12:  0.78308220 1.0 Pure
13: 10.55803026 1.2  KCV
14:  0.15087488 1.2 Pure
15: 10.67109831 1.4  KCV
16:  0.64433189 1.4 Pure
17: 10.78429633 1.6  KCV
18:  0.59293569 1.6 Pure
19: 10.89658887 1.8  KCV
20:  0.86996493 1.8 Pure
21: 11.00723472 2.0  KCV
22:  0.92992710 2.0 Pure
            mse  sp type
```
:::
:::


Finally, we run `get_mse()` 500 times.


::: {.cell hash='B03-cross-validation_cache/html/unnamed-chunk-39_e958c085d9ddaf34a105556e7644281a'}

```{.r .cell-code}
mse_results <-
  mclapply(
    1:500,
    get_mse,
    mc.cores = 12
  ) %>% 
  rbindlist(idcol = "sim_id")

#=== use this if you are a Windows user ===#
# mse_results <-
#   lapply(
#     1:500,
#     get_mse
#   )
```
:::


For each simulation round, let's find the best `sp` using KCV and pure MSE.


::: {.cell}

```{.r .cell-code}
(
which_sp_optimal <-
  mse_results %>% 
  .[, .SD[which.min(mse), ], by = .(type, sim_id)] %>% 
  #=== drop mse ===#
  .[, mse := NULL] %>% 
  dcast(sim_id ~ type, value.var = "sp") %>% 
  .[, num_comb := .N, by = .(KCV, Pure)]
)
```
:::


For example, for the first simulation, `sp` that would have minimized pure MSE (least error relative to the true $E[y|x]$ across varying values of $x$) was 0.8. On the other hand, if you relied on KCV, you would have chosen 0.2. 

The following figure shows the relationship between KCV-based and pure MSE-based `sp` values.


::: {.cell}

```{.r .cell-code}
#=== plot the frequency of sp chosen by KCV ===#
ggplot(data = which_sp_optimal) +
  geom_point(aes(y = Pure, x = KCV, size = num_comb)) +
  scale_y_continuous(breaks = sp_seq) +
  scale_x_continuous(breaks = sp_seq) 
```

::: {.cell-output-display}
![](B03-cross-validation_files/figure-html/unnamed-chunk-41-1.png){width=672}
:::
:::


As you can see KCV gives you `sp` that is close to the `sp` based on pure MSE in many cases. But, you can also see that KCV can suggest you a very different number as well. KCV is not perfect, which is kind of obvious.

 -->
</section>
<section id="references" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="references">References</h2>
<div id="refs" role="doc-bibliography">

</div>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./B02-bias-variance-tradeoff.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Bias-variance Trade-off</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./B04-regularization.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Regression Shrinkage Methods</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb46" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Cross-validation {#sec-cross-validation}</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="fu">## Motivations</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>No model works the best all the time, and searching for the best modeling approach and specifications is an essential part of modeling applications. </span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>For example, we may consider five approaches with varying modeling specifications for each of the approaches:</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Random Forest (RF)</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>number of trees (1000, 2000)</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>number of variables used in each tree (3, 5, 8)</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>and many other hyper parameters</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>LASSO</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>penalty parameter (1, 2, 3, etc)</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>GAM</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>number of knots</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>penalty parameter</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Boosted Regression Forest (BRF)</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>number of trees (1000, 2000)</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>number of variables used in each tree (3, 5, 8)</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>and many other hyper parameters</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Convolutional Neural Network (CNN)</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>convolution matrix dimension</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>the order of convolution</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>learning rate</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span>and many other hyper parameters</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>Our goal here is to find the model that would performs the best when applied to the data that has not been seen yet. </span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>We saw earlier that training MSE is not appropriate for that purpose as picking the model with the lowest training MSE would very much likely to lead you to an over-fitted model. In this lecture, we consider a better way of selecting a model using only train data.</span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a>**Why CV?**</span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>When the amount of data is limited and you cannot afford to split the data into training and test datasets, you can use a CV to estimate test MSE (by validating a trained model as if you have test data within the training data) for the purpose of picking the right model and hyper-parameter values.</span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a>Here is a workflow of identifying the final model and come up with the final trained model.</span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Make a list of models (e.g., RF, BRF, NN) with various hyper-parameter values to try for each of of the models (like above)</span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Conduct a CV to see which model-hyper-parameter combination minimizes MSE</span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a><span class="ss">+ </span>Train the best model specification to the entire training dataset, which becomes your final trained model</span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a>Note that you do not use any of the models trained during the CV process. They are ran purely for the purpose of finding the best model and hyper-parameter values. </span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a><span class="fu">## Leave-One-Out Cross-Validation (LOOCV)</span></span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a>**Packages to load for replication**</span>
<span id="cb46-53"><a href="#cb46-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-56"><a href="#cb46-56" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-57"><a href="#cb46-57" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb46-58"><a href="#cb46-58" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb46-59"><a href="#cb46-59" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb46-60"><a href="#cb46-60" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb46-61"><a href="#cb46-61" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rsample)</span>
<span id="cb46-62"><a href="#cb46-62" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb46-63"><a href="#cb46-63" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-64"><a href="#cb46-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-67"><a href="#cb46-67" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-68"><a href="#cb46-68" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb46-69"><a href="#cb46-69" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb46-70"><a href="#cb46-70" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb46-71"><a href="#cb46-71" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb46-72"><a href="#cb46-72" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rsample)</span>
<span id="cb46-73"><a href="#cb46-73" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb46-74"><a href="#cb46-74" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-75"><a href="#cb46-75" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb46-76"><a href="#cb46-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-77"><a href="#cb46-77" aria-hidden="true" tabindex="-1"></a>Consider a dataset: $D = <span class="sc">\{</span>X_1, y_1<span class="sc">\}</span>, <span class="sc">\{</span>X_2, y_2<span class="sc">\}</span>, </span>
<span id="cb46-78"><a href="#cb46-78" aria-hidden="true" tabindex="-1"></a>\dots, <span class="sc">\{</span>X_N, y_N<span class="sc">\}</span>$, where $X_i$ is a collection of features and $y_i$ is the dependent variable for $i$th observation. Further, suppose you use $D$ for training ML models and $\hat{f}()$ is a trained model. </span>
<span id="cb46-79"><a href="#cb46-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-80"><a href="#cb46-80" aria-hidden="true" tabindex="-1"></a>LOOCV leaves out a single observation (say $i$), and train a model (say, GAM with the number of knots of 10) using the all the other observations (-$i$), and then find MSE for the left-out observation. This process is repeated for all the observations, and then the average of the individual MSEs is calculated.</span>
<span id="cb46-81"><a href="#cb46-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-82"><a href="#cb46-82" aria-hidden="true" tabindex="-1"></a><span class="fu">### R demonstration using `mgcv::gam()`</span></span>
<span id="cb46-83"><a href="#cb46-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-84"><a href="#cb46-84" aria-hidden="true" tabindex="-1"></a>Let's demonstrate this using R. Here is the dataset we use.</span>
<span id="cb46-85"><a href="#cb46-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-88"><a href="#cb46-88" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-89"><a href="#cb46-89" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">943843</span>)</span>
<span id="cb46-90"><a href="#cb46-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-91"><a href="#cb46-91" aria-hidden="true" tabindex="-1"></a><span class="co"># define the data generating process</span></span>
<span id="cb46-92"><a href="#cb46-92" aria-hidden="true" tabindex="-1"></a><span class="co"># x fixed</span></span>
<span id="cb46-93"><a href="#cb46-93" aria-hidden="true" tabindex="-1"></a>gen_data <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb46-94"><a href="#cb46-94" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-95"><a href="#cb46-95" aria-hidden="true" tabindex="-1"></a>  ey <span class="ot">&lt;-</span> (x <span class="sc">-</span> <span class="fl">2.5</span>)<span class="sc">^</span><span class="dv">3</span> <span class="co"># E[y|x]</span></span>
<span id="cb46-96"><a href="#cb46-96" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> ey <span class="sc">+</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(x)) <span class="co"># y = E[y|x] + u</span></span>
<span id="cb46-97"><a href="#cb46-97" aria-hidden="true" tabindex="-1"></a>  return_data <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">y =</span> y, <span class="at">x =</span> x, <span class="at">ey =</span> ey)</span>
<span id="cb46-98"><a href="#cb46-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-99"><a href="#cb46-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(return_data)</span>
<span id="cb46-100"><a href="#cb46-100" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-101"><a href="#cb46-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-102"><a href="#cb46-102" aria-hidden="true" tabindex="-1"></a><span class="do">## generate train data</span></span>
<span id="cb46-103"><a href="#cb46-103" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">gen_data</span>(<span class="at">x =</span> <span class="fu">runif</span>(<span class="dv">100</span>) <span class="sc">*</span> <span class="dv">5</span>)</span>
<span id="cb46-104"><a href="#cb46-104" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-105"><a href="#cb46-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-106"><a href="#cb46-106" aria-hidden="true" tabindex="-1"></a>Visually, here is the relationship between $E<span class="co">[</span><span class="ot">y</span><span class="co">]</span>$ and $x$:</span>
<span id="cb46-107"><a href="#cb46-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-110"><a href="#cb46-110" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-111"><a href="#cb46-111" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb46-112"><a href="#cb46-112" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 3 </span></span>
<span id="cb46-113"><a href="#cb46-113" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 5 </span></span>
<span id="cb46-114"><a href="#cb46-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-115"><a href="#cb46-115" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> data) <span class="sc">+</span></span>
<span id="cb46-116"><a href="#cb46-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> ey, <span class="at">x =</span> x)) <span class="sc">+</span></span>
<span id="cb46-117"><a href="#cb46-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb46-118"><a href="#cb46-118" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-119"><a href="#cb46-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-120"><a href="#cb46-120" aria-hidden="true" tabindex="-1"></a>For example, for the case where the first observation is left out for validation,</span>
<span id="cb46-121"><a href="#cb46-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-124"><a href="#cb46-124" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-125"><a href="#cb46-125" aria-hidden="true" tabindex="-1"></a><span class="co"># leave out the first observation</span></span>
<span id="cb46-126"><a href="#cb46-126" aria-hidden="true" tabindex="-1"></a>left_out_observation <span class="ot">&lt;-</span> data[<span class="dv">1</span>, ]</span>
<span id="cb46-127"><a href="#cb46-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-128"><a href="#cb46-128" aria-hidden="true" tabindex="-1"></a><span class="co"># all the rest</span></span>
<span id="cb46-129"><a href="#cb46-129" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> data[<span class="sc">-</span><span class="dv">1</span>, ]</span>
<span id="cb46-130"><a href="#cb46-130" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-131"><a href="#cb46-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-132"><a href="#cb46-132" aria-hidden="true" tabindex="-1"></a>Now we train a gam model using the train_data, predict $y$ for the first observation, and find the MSE. </span>
<span id="cb46-133"><a href="#cb46-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-136"><a href="#cb46-136" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-137"><a href="#cb46-137" aria-hidden="true" tabindex="-1"></a><span class="co">#=== train the model ===#</span></span>
<span id="cb46-138"><a href="#cb46-138" aria-hidden="true" tabindex="-1"></a>fitted <span class="ot">&lt;-</span> <span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">10</span>), <span class="at">sp =</span> <span class="dv">0</span>, <span class="at">data =</span> train_data)</span>
<span id="cb46-139"><a href="#cb46-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-140"><a href="#cb46-140" aria-hidden="true" tabindex="-1"></a><span class="co">#=== predict y for the first observation ===#</span></span>
<span id="cb46-141"><a href="#cb46-141" aria-hidden="true" tabindex="-1"></a>y_fitted <span class="ot">&lt;-</span> <span class="fu">predict</span>(fitted, <span class="at">newdata =</span> left_out_observation)</span>
<span id="cb46-142"><a href="#cb46-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-143"><a href="#cb46-143" aria-hidden="true" tabindex="-1"></a><span class="co">#=== get MSE ===#</span></span>
<span id="cb46-144"><a href="#cb46-144" aria-hidden="true" tabindex="-1"></a>MSE <span class="ot">&lt;-</span> (left_out_observation[, y] <span class="sc">-</span> y_fitted) <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb46-145"><a href="#cb46-145" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-146"><a href="#cb46-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-147"><a href="#cb46-147" aria-hidden="true" tabindex="-1"></a>As described above, LOOCV repeats this process for every single observation of the data. Now, let's write a function that does the above process for any $i$ you specify.</span>
<span id="cb46-148"><a href="#cb46-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-151"><a href="#cb46-151" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-152"><a href="#cb46-152" aria-hidden="true" tabindex="-1"></a><span class="co">#=== define the modeling approach ===#</span></span>
<span id="cb46-153"><a href="#cb46-153" aria-hidden="true" tabindex="-1"></a>gam_k_10 <span class="ot">&lt;-</span> <span class="cf">function</span>(train_data) </span>
<span id="cb46-154"><a href="#cb46-154" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb46-155"><a href="#cb46-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">30</span>), <span class="at">sp =</span> <span class="dv">0</span>, <span class="at">data =</span> train_data)</span>
<span id="cb46-156"><a href="#cb46-156" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-157"><a href="#cb46-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-158"><a href="#cb46-158" aria-hidden="true" tabindex="-1"></a><span class="co">#=== define the process of getting MSE for ith observation ===#</span></span>
<span id="cb46-159"><a href="#cb46-159" aria-hidden="true" tabindex="-1"></a>get_mse <span class="ot">&lt;-</span> <span class="cf">function</span>(i, model)</span>
<span id="cb46-160"><a href="#cb46-160" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb46-161"><a href="#cb46-161" aria-hidden="true" tabindex="-1"></a>  left_out_observation <span class="ot">&lt;-</span> data[i, ]</span>
<span id="cb46-162"><a href="#cb46-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-163"><a href="#cb46-163" aria-hidden="true" tabindex="-1"></a>  <span class="co"># all the rest</span></span>
<span id="cb46-164"><a href="#cb46-164" aria-hidden="true" tabindex="-1"></a>  train_data <span class="ot">&lt;-</span> data[<span class="sc">-</span>i, ]</span>
<span id="cb46-165"><a href="#cb46-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-166"><a href="#cb46-166" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== train the model ===#</span></span>
<span id="cb46-167"><a href="#cb46-167" aria-hidden="true" tabindex="-1"></a>  fitted <span class="ot">&lt;-</span> <span class="fu">model</span>(train_data)</span>
<span id="cb46-168"><a href="#cb46-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-169"><a href="#cb46-169" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== predict y for the first observation ===#</span></span>
<span id="cb46-170"><a href="#cb46-170" aria-hidden="true" tabindex="-1"></a>  y_fitted <span class="ot">&lt;-</span> <span class="fu">predict</span>(fitted, <span class="at">newdata =</span> left_out_observation)</span>
<span id="cb46-171"><a href="#cb46-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-172"><a href="#cb46-172" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== get MSE ===#</span></span>
<span id="cb46-173"><a href="#cb46-173" aria-hidden="true" tabindex="-1"></a>  MSE <span class="ot">&lt;-</span> (left_out_observation[, y] <span class="sc">-</span> y_fitted) <span class="sc">^</span> <span class="dv">2</span> </span>
<span id="cb46-174"><a href="#cb46-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-175"><a href="#cb46-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(MSE)</span>
<span id="cb46-176"><a href="#cb46-176" aria-hidden="true" tabindex="-1"></a>} </span>
<span id="cb46-177"><a href="#cb46-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-178"><a href="#cb46-178" aria-hidden="true" tabindex="-1"></a><span class="in">```</span> </span>
<span id="cb46-179"><a href="#cb46-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-180"><a href="#cb46-180" aria-hidden="true" tabindex="-1"></a>For example, this gets MSE for the 10th observation.</span>
<span id="cb46-181"><a href="#cb46-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-184"><a href="#cb46-184" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-185"><a href="#cb46-185" aria-hidden="true" tabindex="-1"></a><span class="fu">get_mse</span>(<span class="dv">10</span>, gam_k_10)</span>
<span id="cb46-186"><a href="#cb46-186" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-187"><a href="#cb46-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-188"><a href="#cb46-188" aria-hidden="true" tabindex="-1"></a>Let's now loop over $i = 1:100$.</span>
<span id="cb46-189"><a href="#cb46-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-192"><a href="#cb46-192" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-193"><a href="#cb46-193" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: true</span></span>
<span id="cb46-194"><a href="#cb46-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-195"><a href="#cb46-195" aria-hidden="true" tabindex="-1"></a>mse_indiv <span class="ot">&lt;-</span></span>
<span id="cb46-196"><a href="#cb46-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb46-197"><a href="#cb46-197" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>,</span>
<span id="cb46-198"><a href="#cb46-198" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">get_mse</span>(x, gam_k_10)</span>
<span id="cb46-199"><a href="#cb46-199" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb46-200"><a href="#cb46-200" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== list to a vector ===#</span></span>
<span id="cb46-201"><a href="#cb46-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlist</span>() </span>
<span id="cb46-202"><a href="#cb46-202" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-203"><a href="#cb46-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-204"><a href="#cb46-204" aria-hidden="true" tabindex="-1"></a>Here is the distribution of MSEs.</span>
<span id="cb46-205"><a href="#cb46-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-208"><a href="#cb46-208" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-209"><a href="#cb46-209" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(mse_indiv)</span>
<span id="cb46-210"><a href="#cb46-210" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-211"><a href="#cb46-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-212"><a href="#cb46-212" aria-hidden="true" tabindex="-1"></a>We now get the average MSE.</span>
<span id="cb46-213"><a href="#cb46-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-216"><a href="#cb46-216" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-217"><a href="#cb46-217" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(mse_indiv)</span>
<span id="cb46-218"><a href="#cb46-218" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-219"><a href="#cb46-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-220"><a href="#cb46-220" aria-hidden="true" tabindex="-1"></a><span class="fu">### Selecting the best GAM specification: Illustration</span></span>
<span id="cb46-221"><a href="#cb46-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-222"><a href="#cb46-222" aria-hidden="true" tabindex="-1"></a>Now, let's try to find the best (among the ones we try) GAM specification using LOOCV. We will try ten different GAM specifications which vary in penalization parameter. Penalization parameter can be set using the <span class="in">`sp`</span> option for <span class="in">`mgcv::gam()`</span>. A greater value of <span class="in">`sp`</span> leads to a more smooth fitted curve.</span>
<span id="cb46-223"><a href="#cb46-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-226"><a href="#cb46-226" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-227"><a href="#cb46-227" aria-hidden="true" tabindex="-1"></a>specify_gam <span class="ot">&lt;-</span> <span class="cf">function</span>(sp) {</span>
<span id="cb46-228"><a href="#cb46-228" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(train_data) {</span>
<span id="cb46-229"><a href="#cb46-229" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">30</span>), <span class="at">sp =</span> sp, <span class="at">data =</span> train_data)</span>
<span id="cb46-230"><a href="#cb46-230" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb46-231"><a href="#cb46-231" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-232"><a href="#cb46-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-233"><a href="#cb46-233" aria-hidden="true" tabindex="-1"></a>get_mse_by_sp <span class="ot">&lt;-</span> <span class="cf">function</span>(sp)</span>
<span id="cb46-234"><a href="#cb46-234" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb46-235"><a href="#cb46-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-236"><a href="#cb46-236" aria-hidden="true" tabindex="-1"></a>  temp_gam <span class="ot">&lt;-</span> <span class="fu">specify_gam</span>(sp)</span>
<span id="cb46-237"><a href="#cb46-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-238"><a href="#cb46-238" aria-hidden="true" tabindex="-1"></a>  mse_indiv <span class="ot">&lt;-</span></span>
<span id="cb46-239"><a href="#cb46-239" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(</span>
<span id="cb46-240"><a href="#cb46-240" aria-hidden="true" tabindex="-1"></a>      <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>,</span>
<span id="cb46-241"><a href="#cb46-241" aria-hidden="true" tabindex="-1"></a>      <span class="cf">function</span>(x) <span class="fu">get_mse</span>(x, temp_gam)</span>
<span id="cb46-242"><a href="#cb46-242" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb46-243"><a href="#cb46-243" aria-hidden="true" tabindex="-1"></a>    <span class="co">#=== list to a vector ===#</span></span>
<span id="cb46-244"><a href="#cb46-244" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb46-245"><a href="#cb46-245" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>()</span>
<span id="cb46-246"><a href="#cb46-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-247"><a href="#cb46-247" aria-hidden="true" tabindex="-1"></a>  return_data <span class="ot">&lt;-</span></span>
<span id="cb46-248"><a href="#cb46-248" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.table</span>(</span>
<span id="cb46-249"><a href="#cb46-249" aria-hidden="true" tabindex="-1"></a>      <span class="at">mse =</span> mse_indiv,</span>
<span id="cb46-250"><a href="#cb46-250" aria-hidden="true" tabindex="-1"></a>      <span class="at">sp =</span> sp</span>
<span id="cb46-251"><a href="#cb46-251" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb46-252"><a href="#cb46-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-253"><a href="#cb46-253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(return_data)</span>
<span id="cb46-254"><a href="#cb46-254" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-255"><a href="#cb46-255" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-256"><a href="#cb46-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-257"><a href="#cb46-257" aria-hidden="true" tabindex="-1"></a>For example, the following code gets you the average MSE for <span class="in">`sp`</span> $= 3$.</span>
<span id="cb46-258"><a href="#cb46-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-261"><a href="#cb46-261" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-262"><a href="#cb46-262" aria-hidden="true" tabindex="-1"></a><span class="fu">get_mse_by_sp</span>(<span class="dv">3</span>)</span>
<span id="cb46-263"><a href="#cb46-263" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-264"><a href="#cb46-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-265"><a href="#cb46-265" aria-hidden="true" tabindex="-1"></a>Now, let's loop over ten values of <span class="in">`sp`</span>: <span class="in">`r seq(0, 2, by = 0.2)`</span>.</span>
<span id="cb46-266"><a href="#cb46-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-269"><a href="#cb46-269" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-270"><a href="#cb46-270" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: true </span></span>
<span id="cb46-271"><a href="#cb46-271" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb46-272"><a href="#cb46-272" aria-hidden="true" tabindex="-1"></a>mse_data <span class="ot">&lt;-</span> </span>
<span id="cb46-273"><a href="#cb46-273" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb46-274"><a href="#cb46-274" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">2</span>, <span class="at">by =</span> <span class="fl">0.2</span>),</span>
<span id="cb46-275"><a href="#cb46-275" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">get_mse_by_sp</span>(x)</span>
<span id="cb46-276"><a href="#cb46-276" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb46-277"><a href="#cb46-277" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>()</span>
<span id="cb46-278"><a href="#cb46-278" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-279"><a href="#cb46-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-280"><a href="#cb46-280" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-281"><a href="#cb46-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-284"><a href="#cb46-284" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-285"><a href="#cb46-285" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb46-286"><a href="#cb46-286" aria-hidden="true" tabindex="-1"></a>best_sp <span class="ot">&lt;-</span> mse_data[mse <span class="sc">==</span> <span class="fu">min</span>(mse), ] <span class="sc">%&gt;%</span> .[, sp]</span>
<span id="cb46-287"><a href="#cb46-287" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-288"><a href="#cb46-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-289"><a href="#cb46-289" aria-hidden="true" tabindex="-1"></a>So, according to the LOOCV, we should pick <span class="in">`sp`</span> $= <span class="in">`r best_sp`</span>$ as the penalty parameter.</span>
<span id="cb46-290"><a href="#cb46-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-291"><a href="#cb46-291" aria-hidden="true" tabindex="-1"></a>Now, that we know <span class="in">`sp`</span> $= <span class="in">`r best_sp`</span>$ produces the lowest LOOCV MSE, we rerun <span class="in">`gam()`</span> using the entire dataset (not leaving out any of the observations) and make it our final trained model.</span>
<span id="cb46-292"><a href="#cb46-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-295"><a href="#cb46-295" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-296"><a href="#cb46-296" aria-hidden="true" tabindex="-1"></a>final_gam_spec <span class="ot">&lt;-</span> <span class="fu">specify_gam</span>(<span class="at">sp =</span> <span class="dv">1</span>)</span>
<span id="cb46-297"><a href="#cb46-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-298"><a href="#cb46-298" aria-hidden="true" tabindex="-1"></a>fit_gam <span class="ot">&lt;-</span> <span class="fu">final_gam_spec</span>(train_data)</span>
<span id="cb46-299"><a href="#cb46-299" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-300"><a href="#cb46-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-301"><a href="#cb46-301" aria-hidden="true" tabindex="-1"></a>Here is what the fitted curve looks like:</span>
<span id="cb46-302"><a href="#cb46-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-305"><a href="#cb46-305" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-306"><a href="#cb46-306" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit_gam)</span>
<span id="cb46-307"><a href="#cb46-307" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-308"><a href="#cb46-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-309"><a href="#cb46-309" aria-hidden="true" tabindex="-1"></a>Looks good. By the way, here are the fitted curves for some other <span class="in">`sp`</span> values.</span>
<span id="cb46-310"><a href="#cb46-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-313"><a href="#cb46-313" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-314"><a href="#cb46-314" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb46-315"><a href="#cb46-315" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-fitted-penalization-others</span></span>
<span id="cb46-316"><a href="#cb46-316" aria-hidden="true" tabindex="-1"></a><span class="co">#| layout-ncol: 2</span></span>
<span id="cb46-317"><a href="#cb46-317" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Fitted curves at various penalization parameters</span></span>
<span id="cb46-318"><a href="#cb46-318" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-subcap: </span></span>
<span id="cb46-319"><a href="#cb46-319" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "sp = 0"</span></span>
<span id="cb46-320"><a href="#cb46-320" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "sp = 0.6"</span></span>
<span id="cb46-321"><a href="#cb46-321" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "sp = 1"</span></span>
<span id="cb46-322"><a href="#cb46-322" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "sp = 2"</span></span>
<span id="cb46-323"><a href="#cb46-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-324"><a href="#cb46-324" aria-hidden="true" tabindex="-1"></a>fitted_curves <span class="ot">&lt;-</span> </span>
<span id="cb46-325"><a href="#cb46-325" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb46-326"><a href="#cb46-326" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.6</span>, <span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb46-327"><a href="#cb46-327" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) {</span>
<span id="cb46-328"><a href="#cb46-328" aria-hidden="true" tabindex="-1"></a>      temp_gam <span class="ot">&lt;-</span> <span class="fu">specify_gam</span>(<span class="at">sp =</span> x)</span>
<span id="cb46-329"><a href="#cb46-329" aria-hidden="true" tabindex="-1"></a>      fit_gam <span class="ot">&lt;-</span> <span class="fu">temp_gam</span>(train_data)   </span>
<span id="cb46-330"><a href="#cb46-330" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb46-331"><a href="#cb46-331" aria-hidden="true" tabindex="-1"></a>  )  </span>
<span id="cb46-332"><a href="#cb46-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-333"><a href="#cb46-333" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (plot <span class="cf">in</span> fitted_curves) {</span>
<span id="cb46-334"><a href="#cb46-334" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(plot)</span>
<span id="cb46-335"><a href="#cb46-335" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-336"><a href="#cb46-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-337"><a href="#cb46-337" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-338"><a href="#cb46-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-339"><a href="#cb46-339" aria-hidden="true" tabindex="-1"></a>LOOCV is perfectly general and can be applied to any statistical methods. However, it can be extremely computationally burdensome because you need to fit the same model for as many as the number of observations. So, if you have 10,000 observations, then you need to fit the model 10,000 times, which can take a long long time. </span>
<span id="cb46-340"><a href="#cb46-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-341"><a href="#cb46-341" aria-hidden="true" tabindex="-1"></a><span class="fu">### Summary</span></span>
<span id="cb46-342"><a href="#cb46-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-343"><a href="#cb46-343" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb46-344"><a href="#cb46-344" aria-hidden="true" tabindex="-1"></a>LOOCV is perfectly general and can be applied to any statistical methods. </span>
<span id="cb46-345"><a href="#cb46-345" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb46-346"><a href="#cb46-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-347"><a href="#cb46-347" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb46-348"><a href="#cb46-348" aria-hidden="true" tabindex="-1"></a>LOOCV can be highly computation-intensive when the dataset is large</span>
<span id="cb46-349"><a href="#cb46-349" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb46-350"><a href="#cb46-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-351"><a href="#cb46-351" aria-hidden="true" tabindex="-1"></a><span class="fu">## K-fold Cross-Validation (KCV)</span></span>
<span id="cb46-352"><a href="#cb46-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-353"><a href="#cb46-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-354"><a href="#cb46-354" aria-hidden="true" tabindex="-1"></a>KCV is a type of cross-validation that overcomes the LOOCV's drawback of being computationally too intensive when the dataset is large. KCV first splits the entire dataset intro $K$ folds (K groups) randomly. It then leaves out a chunk of observations that belongs to a fold (group), trains the model using the rest of the observations in the other folds, evaluate the trained model using the left-out group. It repeats this process for all the groups and average the MSEs obtained for each group.</span>
<span id="cb46-355"><a href="#cb46-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-356"><a href="#cb46-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-357"><a href="#cb46-357" aria-hidden="true" tabindex="-1"></a>Let's demonstrate this process using R.</span>
<span id="cb46-358"><a href="#cb46-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-361"><a href="#cb46-361" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-362"><a href="#cb46-362" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">89534</span>)</span>
<span id="cb46-363"><a href="#cb46-363" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">gen_data</span>(<span class="at">x =</span> <span class="fu">runif</span>(<span class="dv">500</span>) <span class="sc">*</span> <span class="dv">5</span>)</span>
<span id="cb46-364"><a href="#cb46-364" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-365"><a href="#cb46-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-366"><a href="#cb46-366" aria-hidden="true" tabindex="-1"></a>You can use <span class="in">`rsample::vfold_cv()`</span> to split the data into groups. </span>
<span id="cb46-367"><a href="#cb46-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-370"><a href="#cb46-370" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-371"><a href="#cb46-371" aria-hidden="true" tabindex="-1"></a><span class="co">#=== split into 5 groups ===#</span></span>
<span id="cb46-372"><a href="#cb46-372" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb46-373"><a href="#cb46-373" aria-hidden="true" tabindex="-1"></a>data_folds <span class="ot">&lt;-</span> rsample<span class="sc">::</span><span class="fu">vfold_cv</span>(data, <span class="at">v =</span> <span class="dv">5</span>)</span>
<span id="cb46-374"><a href="#cb46-374" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-375"><a href="#cb46-375" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-376"><a href="#cb46-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-377"><a href="#cb46-377" aria-hidden="true" tabindex="-1"></a>As you can see, <span class="in">`rsample::vfold_cv()`</span> creates $v$ ($=5$ here) splits. And each split has both train and test datasets. <span class="in">`&lt;split [400/100]&gt;`</span> means that $400$ and $100$ observations for the train and test datasets, respectively. Note that, the $100$ observations in the first split (called <span class="in">`Fold 1`</span>) are in the train datasets of the rest of the splits (<span class="in">`Fold 2`</span> through <span class="in">`Fold 5`</span>).</span>
<span id="cb46-378"><a href="#cb46-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-379"><a href="#cb46-379" aria-hidden="true" tabindex="-1"></a>You can extract the train and test datasets like below using the <span class="in">`training()`</span> and <span class="in">`testing()`</span> functions.</span>
<span id="cb46-380"><a href="#cb46-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-383"><a href="#cb46-383" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-384"><a href="#cb46-384" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> data_folds[<span class="dv">1</span>, ]<span class="sc">$</span>splits[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> <span class="fu">training</span>()</span>
<span id="cb46-385"><a href="#cb46-385" aria-hidden="true" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> data_folds[<span class="dv">1</span>, ]<span class="sc">$</span>splits[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> <span class="fu">testing</span>()</span>
<span id="cb46-386"><a href="#cb46-386" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-387"><a href="#cb46-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-388"><a href="#cb46-388" aria-hidden="true" tabindex="-1"></a>Now, let's get MSE for the first fold.</span>
<span id="cb46-389"><a href="#cb46-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-392"><a href="#cb46-392" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-393"><a href="#cb46-393" aria-hidden="true" tabindex="-1"></a><span class="co">#=== train the model ===#</span></span>
<span id="cb46-394"><a href="#cb46-394" aria-hidden="true" tabindex="-1"></a>fitted_model <span class="ot">&lt;-</span> <span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">30</span>), <span class="at">sp =</span> <span class="dv">0</span>, <span class="at">data =</span> train_data)</span>
<span id="cb46-395"><a href="#cb46-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-396"><a href="#cb46-396" aria-hidden="true" tabindex="-1"></a><span class="co">#=== predict y for the test data ===#</span></span>
<span id="cb46-397"><a href="#cb46-397" aria-hidden="true" tabindex="-1"></a>y_hat <span class="ot">&lt;-</span> <span class="fu">predict</span>(fitted_model, test_data)</span>
<span id="cb46-398"><a href="#cb46-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-399"><a href="#cb46-399" aria-hidden="true" tabindex="-1"></a><span class="co">#=== calculate MSE for the fold ===#</span></span>
<span id="cb46-400"><a href="#cb46-400" aria-hidden="true" tabindex="-1"></a>(test_data[, y] <span class="sc">-</span> y_hat)<span class="sc">^</span><span class="dv">2</span> <span class="sc">%&gt;%</span> <span class="fu">mean</span>()</span>
<span id="cb46-401"><a href="#cb46-401" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-402"><a href="#cb46-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-403"><a href="#cb46-403" aria-hidden="true" tabindex="-1"></a>Now that we know how to get MSE for a single fold, let's loop over folds and get MSE for each of the folds. We first create a function that gets us MSE for a single fold.</span>
<span id="cb46-404"><a href="#cb46-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-407"><a href="#cb46-407" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-408"><a href="#cb46-408" aria-hidden="true" tabindex="-1"></a>get_mse_by_fold <span class="ot">&lt;-</span> <span class="cf">function</span>(data, fold, model)</span>
<span id="cb46-409"><a href="#cb46-409" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb46-410"><a href="#cb46-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-411"><a href="#cb46-411" aria-hidden="true" tabindex="-1"></a>  test_data <span class="ot">&lt;-</span> data_folds[fold, ]<span class="sc">$</span>splits[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> <span class="fu">testing</span>()</span>
<span id="cb46-412"><a href="#cb46-412" aria-hidden="true" tabindex="-1"></a>  train_data <span class="ot">&lt;-</span> data_folds[fold, ]<span class="sc">$</span>splits[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> <span class="fu">training</span>()</span>
<span id="cb46-413"><a href="#cb46-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-414"><a href="#cb46-414" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== train the model ===#</span></span>
<span id="cb46-415"><a href="#cb46-415" aria-hidden="true" tabindex="-1"></a>  fitted_model <span class="ot">&lt;-</span> <span class="fu">model</span>(train_data)</span>
<span id="cb46-416"><a href="#cb46-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-417"><a href="#cb46-417" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== predict y for the test data ===#</span></span>
<span id="cb46-418"><a href="#cb46-418" aria-hidden="true" tabindex="-1"></a>  y_hat <span class="ot">&lt;-</span> <span class="fu">predict</span>(fitted_model, test_data)</span>
<span id="cb46-419"><a href="#cb46-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-420"><a href="#cb46-420" aria-hidden="true" tabindex="-1"></a>  <span class="co">#=== calculate MSE for the fold ===#</span></span>
<span id="cb46-421"><a href="#cb46-421" aria-hidden="true" tabindex="-1"></a>  mse <span class="ot">&lt;-</span> (test_data[, y] <span class="sc">-</span> y_hat)<span class="sc">^</span><span class="dv">2</span> <span class="sc">%&gt;%</span> <span class="fu">mean</span>() </span>
<span id="cb46-422"><a href="#cb46-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-423"><a href="#cb46-423" aria-hidden="true" tabindex="-1"></a>  return_data <span class="ot">&lt;-</span> </span>
<span id="cb46-424"><a href="#cb46-424" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.table</span>(</span>
<span id="cb46-425"><a href="#cb46-425" aria-hidden="true" tabindex="-1"></a>      <span class="at">k =</span> fold, </span>
<span id="cb46-426"><a href="#cb46-426" aria-hidden="true" tabindex="-1"></a>      <span class="at">mse =</span> mse</span>
<span id="cb46-427"><a href="#cb46-427" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb46-428"><a href="#cb46-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-429"><a href="#cb46-429" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(return_data)</span>
<span id="cb46-430"><a href="#cb46-430" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-431"><a href="#cb46-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-432"><a href="#cb46-432" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-433"><a href="#cb46-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-434"><a href="#cb46-434" aria-hidden="true" tabindex="-1"></a>This will get you MSE for the third fold.</span>
<span id="cb46-435"><a href="#cb46-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-438"><a href="#cb46-438" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-439"><a href="#cb46-439" aria-hidden="true" tabindex="-1"></a><span class="fu">get_mse_by_fold</span>(data, <span class="dv">3</span>, gam_k_10)</span>
<span id="cb46-440"><a href="#cb46-440" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-441"><a href="#cb46-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-442"><a href="#cb46-442" aria-hidden="true" tabindex="-1"></a>Now, let's loop over the row number of <span class="in">`data_folds`</span> (loop over <span class="in">`splits`</span>).</span>
<span id="cb46-443"><a href="#cb46-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-446"><a href="#cb46-446" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-447"><a href="#cb46-447" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb46-448"><a href="#cb46-448" aria-hidden="true" tabindex="-1"></a>mse_all <span class="ot">&lt;-</span></span>
<span id="cb46-449"><a href="#cb46-449" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb46-450"><a href="#cb46-450" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq_len</span>(<span class="fu">nrow</span>(data_folds)),</span>
<span id="cb46-451"><a href="#cb46-451" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">get_mse_by_fold</span>(data, x, gam_k_10)</span>
<span id="cb46-452"><a href="#cb46-452" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb46-453"><a href="#cb46-453" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>()</span>
<span id="cb46-454"><a href="#cb46-454" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-455"><a href="#cb46-455" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-456"><a href="#cb46-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-457"><a href="#cb46-457" aria-hidden="true" tabindex="-1"></a>By averaging MSE values, we get</span>
<span id="cb46-458"><a href="#cb46-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-461"><a href="#cb46-461" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-462"><a href="#cb46-462" aria-hidden="true" tabindex="-1"></a>mse_all[, <span class="fu">mean</span>(mse)]</span>
<span id="cb46-463"><a href="#cb46-463" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-464"><a href="#cb46-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-465"><a href="#cb46-465" aria-hidden="true" tabindex="-1"></a><span class="fu">### Selecting the best GAM specification: Illustration</span></span>
<span id="cb46-466"><a href="#cb46-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-467"><a href="#cb46-467" aria-hidden="true" tabindex="-1"></a>Just like we found the best gam specification (choice of penalization parameter) using LOOCV, we do the same now using KCV.</span>
<span id="cb46-468"><a href="#cb46-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-471"><a href="#cb46-471" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-472"><a href="#cb46-472" aria-hidden="true" tabindex="-1"></a>get_mse_by_sp_kcv <span class="ot">&lt;-</span> <span class="cf">function</span>(sp)</span>
<span id="cb46-473"><a href="#cb46-473" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb46-474"><a href="#cb46-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-475"><a href="#cb46-475" aria-hidden="true" tabindex="-1"></a>  temp_gam <span class="ot">&lt;-</span> <span class="fu">specify_gam</span>(sp)</span>
<span id="cb46-476"><a href="#cb46-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-477"><a href="#cb46-477" aria-hidden="true" tabindex="-1"></a>  mse_by_k <span class="ot">&lt;-</span></span>
<span id="cb46-478"><a href="#cb46-478" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(</span>
<span id="cb46-479"><a href="#cb46-479" aria-hidden="true" tabindex="-1"></a>      <span class="fu">seq_len</span>(<span class="fu">nrow</span>(data_folds)),</span>
<span id="cb46-480"><a href="#cb46-480" aria-hidden="true" tabindex="-1"></a>      <span class="cf">function</span>(x) <span class="fu">get_mse_by_fold</span>(train_data, x, temp_gam)</span>
<span id="cb46-481"><a href="#cb46-481" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb46-482"><a href="#cb46-482" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbindlist</span>()</span>
<span id="cb46-483"><a href="#cb46-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-484"><a href="#cb46-484" aria-hidden="true" tabindex="-1"></a>  return_data <span class="ot">&lt;-</span></span>
<span id="cb46-485"><a href="#cb46-485" aria-hidden="true" tabindex="-1"></a>    mse_by_k <span class="sc">%&gt;%</span> </span>
<span id="cb46-486"><a href="#cb46-486" aria-hidden="true" tabindex="-1"></a>    .[, sp <span class="sc">:</span><span class="er">=</span> sp]</span>
<span id="cb46-487"><a href="#cb46-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-488"><a href="#cb46-488" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(return_data[])</span>
<span id="cb46-489"><a href="#cb46-489" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-490"><a href="#cb46-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-491"><a href="#cb46-491" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-492"><a href="#cb46-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-493"><a href="#cb46-493" aria-hidden="true" tabindex="-1"></a>For example, the following code gets you the MSE for all the folds for <span class="in">`sp`</span> $= 3$.</span>
<span id="cb46-494"><a href="#cb46-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-497"><a href="#cb46-497" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-498"><a href="#cb46-498" aria-hidden="true" tabindex="-1"></a><span class="fu">get_mse_by_sp_kcv</span>(<span class="dv">3</span>)</span>
<span id="cb46-499"><a href="#cb46-499" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-500"><a href="#cb46-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-501"><a href="#cb46-501" aria-hidden="true" tabindex="-1"></a>Now, let's loop over ten values of <span class="in">`sp`</span>: <span class="in">`r seq(0, 2, by = 0.2)`</span>.</span>
<span id="cb46-502"><a href="#cb46-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-505"><a href="#cb46-505" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-506"><a href="#cb46-506" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: true</span></span>
<span id="cb46-507"><a href="#cb46-507" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb46-508"><a href="#cb46-508" aria-hidden="true" tabindex="-1"></a>mse_results <span class="ot">&lt;-</span> </span>
<span id="cb46-509"><a href="#cb46-509" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb46-510"><a href="#cb46-510" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">2</span>, <span class="at">by =</span> <span class="fl">0.2</span>),</span>
<span id="cb46-511"><a href="#cb46-511" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">get_mse_by_sp_kcv</span>(x)</span>
<span id="cb46-512"><a href="#cb46-512" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb46-513"><a href="#cb46-513" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>()</span>
<span id="cb46-514"><a href="#cb46-514" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-515"><a href="#cb46-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-516"><a href="#cb46-516" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-517"><a href="#cb46-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-518"><a href="#cb46-518" aria-hidden="true" tabindex="-1"></a>Let's now get the average MSE by sp:</span>
<span id="cb46-519"><a href="#cb46-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-522"><a href="#cb46-522" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-523"><a href="#cb46-523" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb46-524"><a href="#cb46-524" aria-hidden="true" tabindex="-1"></a>mean_mse_data <span class="ot">&lt;-</span> mse_results[, .(<span class="at">mean_mse =</span> <span class="fu">mean</span>(mse)), <span class="at">by =</span> sp]</span>
<span id="cb46-525"><a href="#cb46-525" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-526"><a href="#cb46-526" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-527"><a href="#cb46-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-530"><a href="#cb46-530" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-531"><a href="#cb46-531" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb46-532"><a href="#cb46-532" aria-hidden="true" tabindex="-1"></a>best_sp <span class="ot">&lt;-</span> mean_mse_data[mean_mse <span class="sc">==</span> <span class="fu">min</span>(mean_mse), ] <span class="sc">%&gt;%</span> .[, sp]</span>
<span id="cb46-533"><a href="#cb46-533" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-534"><a href="#cb46-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-535"><a href="#cb46-535" aria-hidden="true" tabindex="-1"></a>So, according to the KCV, we should pick <span class="in">`sp`</span> $= <span class="in">`r best_sp`</span>$ as the penalty parameter. </span>
<span id="cb46-536"><a href="#cb46-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-537"><a href="#cb46-537" aria-hidden="true" tabindex="-1"></a>By the way, here is what MSE values look like for each fold based on the value of <span class="in">`sp`</span> by fold.</span>
<span id="cb46-538"><a href="#cb46-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-541"><a href="#cb46-541" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-542"><a href="#cb46-542" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb46-543"><a href="#cb46-543" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4</span></span>
<span id="cb46-544"><a href="#cb46-544" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 6</span></span>
<span id="cb46-545"><a href="#cb46-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-546"><a href="#cb46-546" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> mse_results) <span class="sc">+</span></span>
<span id="cb46-547"><a href="#cb46-547" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> mse, <span class="at">x =</span> sp, <span class="at">color =</span> <span class="fu">factor</span>(k))) <span class="sc">+</span></span>
<span id="cb46-548"><a href="#cb46-548" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_discrete</span>(<span class="at">name =</span> <span class="st">"Fold"</span>) <span class="sc">+</span></span>
<span id="cb46-549"><a href="#cb46-549" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb46-550"><a href="#cb46-550" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-551"><a href="#cb46-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-552"><a href="#cb46-552" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb46-553"><a href="#cb46-553" aria-hidden="true" tabindex="-1"></a>Even though we compared different specification of the same approach (GAM), we can compare across different models as well. For example, you can find KCV for an RF model with a particular specifications of its hyper-parameters and compare the KCV with those of the GAM model specifications and see what comes at the top.  </span>
<span id="cb46-554"><a href="#cb46-554" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb46-555"><a href="#cb46-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-556"><a href="#cb46-556" aria-hidden="true" tabindex="-1"></a><span class="fu">## Repeated K-fold Cross-Validation (RKCV)</span></span>
<span id="cb46-557"><a href="#cb46-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-558"><a href="#cb46-558" aria-hidden="true" tabindex="-1"></a>As its name suggest, repeated KCV repeats the process of KCV multiple times. Each KCV iteration splits the original data into k-fold in a different way. A single KCV may not be reliable as the original data was split into such a way that favors one parameter set of or model class over the others. However, if we repeat KCV multiple times, then we can safe-guard against this randomness in a KCV procedure. Repeated KCV is preferred over a single KCV. </span>
<span id="cb46-559"><a href="#cb46-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-560"><a href="#cb46-560" aria-hidden="true" tabindex="-1"></a>You can use <span class="in">`rsample::vfold_cv()`</span> to create repeated k-fold datasets by using the <span class="in">`repeats`</span> argument.</span>
<span id="cb46-561"><a href="#cb46-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-564"><a href="#cb46-564" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-565"><a href="#cb46-565" aria-hidden="true" tabindex="-1"></a><span class="co">#=== split into 5 groups ===#</span></span>
<span id="cb46-566"><a href="#cb46-566" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb46-567"><a href="#cb46-567" aria-hidden="true" tabindex="-1"></a>data_folds <span class="ot">&lt;-</span> rsample<span class="sc">::</span><span class="fu">vfold_cv</span>(data, <span class="at">v =</span> <span class="dv">5</span>, <span class="at">repeats =</span> <span class="dv">5</span>)</span>
<span id="cb46-568"><a href="#cb46-568" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-569"><a href="#cb46-569" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-570"><a href="#cb46-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-571"><a href="#cb46-571" aria-hidden="true" tabindex="-1"></a>The output has 5 (number of folds) times 5 (number of repeats) splits. It also has an additional column that indicates which repeat each row is in (<span class="in">`id`</span>). You can apply <span class="in">`get_mse_by_fold()`</span> (this function is defined above and calculate MSE) to each row (split) one by one and calculate MSE just like we did above. </span>
<span id="cb46-572"><a href="#cb46-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-575"><a href="#cb46-575" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-576"><a href="#cb46-576" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb46-577"><a href="#cb46-577" aria-hidden="true" tabindex="-1"></a>mean_mse <span class="ot">&lt;-</span></span>
<span id="cb46-578"><a href="#cb46-578" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(</span>
<span id="cb46-579"><a href="#cb46-579" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq_len</span>(<span class="fu">nrow</span>(data_folds)),</span>
<span id="cb46-580"><a href="#cb46-580" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">get_mse_by_fold</span>(data, x, gam_k_10)</span>
<span id="cb46-581"><a href="#cb46-581" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb46-582"><a href="#cb46-582" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb46-583"><a href="#cb46-583" aria-hidden="true" tabindex="-1"></a>  .[, <span class="fu">mean</span>(mse)]</span>
<span id="cb46-584"><a href="#cb46-584" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-585"><a href="#cb46-585" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-586"><a href="#cb46-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-587"><a href="#cb46-587" aria-hidden="true" tabindex="-1"></a><span class="fu">## How are LOOCV, KCV and RKCV different?</span></span>
<span id="cb46-588"><a href="#cb46-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-589"><a href="#cb46-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-590"><a href="#cb46-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-591"><a href="#cb46-591" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ## Does KCV really work?</span></span>
<span id="cb46-592"><a href="#cb46-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-593"><a href="#cb46-593" aria-hidden="true" tabindex="-1"></a><span class="co">LOOCV and KCV use the train data to estimate test MSE. But, does it really work? In other words, does it let us pick the parameter that minimizes the test MSE? We will run a simple MC simulations to test this. We continue to use the same data generating process and GAM models for this simulation as well. </span></span>
<span id="cb46-594"><a href="#cb46-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-595"><a href="#cb46-595" aria-hidden="true" tabindex="-1"></a><span class="co">Now, since we know the data generating process, we can actually use the following metric instead of MSE.</span></span>
<span id="cb46-596"><a href="#cb46-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-597"><a href="#cb46-597" aria-hidden="true" tabindex="-1"></a><span class="co">$$</span></span>
<span id="cb46-598"><a href="#cb46-598" aria-hidden="true" tabindex="-1"></a><span class="co">\sum_{i=1}^N(\hat{f}(x_i) - E[y|x_i])^2</span></span>
<span id="cb46-599"><a href="#cb46-599" aria-hidden="true" tabindex="-1"></a><span class="co">$$</span></span>
<span id="cb46-600"><a href="#cb46-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-601"><a href="#cb46-601" aria-hidden="true" tabindex="-1"></a><span class="co">This measure removes the influence of the error term that appears in the test MSE. Your objective is to minimize this measure. Of course, you cannot do this in practice because you do not observe $E[y|x]$. Let's call this "pure" MSE.</span></span>
<span id="cb46-602"><a href="#cb46-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-603"><a href="#cb46-603" aria-hidden="true" tabindex="-1"></a><span class="co">First, we define a function that gets you MSE from KCV and MSE using the test data as a function of `sp`.</span></span>
<span id="cb46-604"><a href="#cb46-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-607"><a href="#cb46-607" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-608"><a href="#cb46-608" aria-hidden="true" tabindex="-1"></a><span class="co">get_mse_by_sp &lt;- function(sp)</span></span>
<span id="cb46-609"><a href="#cb46-609" aria-hidden="true" tabindex="-1"></a><span class="co">{</span></span>
<span id="cb46-610"><a href="#cb46-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-611"><a href="#cb46-611" aria-hidden="true" tabindex="-1"></a><span class="co">  #=== generate train data and test data ===#</span></span>
<span id="cb46-612"><a href="#cb46-612" aria-hidden="true" tabindex="-1"></a><span class="co">  train_data &lt;- gen_data(x = runif(500) * 5)</span></span>
<span id="cb46-613"><a href="#cb46-613" aria-hidden="true" tabindex="-1"></a><span class="co">  test_data &lt;- gen_data(x = runif(500) * 5)</span></span>
<span id="cb46-614"><a href="#cb46-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-615"><a href="#cb46-615" aria-hidden="true" tabindex="-1"></a><span class="co">  #/*----------------------------------*/</span></span>
<span id="cb46-616"><a href="#cb46-616" aria-hidden="true" tabindex="-1"></a><span class="co">  #' ## MSE from KCV </span></span>
<span id="cb46-617"><a href="#cb46-617" aria-hidden="true" tabindex="-1"></a><span class="co">  #/*----------------------------------*/</span></span>
<span id="cb46-618"><a href="#cb46-618" aria-hidden="true" tabindex="-1"></a><span class="co">  #=== split train_data into 5 groups ===#</span></span>
<span id="cb46-619"><a href="#cb46-619" aria-hidden="true" tabindex="-1"></a><span class="co">  data_folds &lt;- rsample::vfold_cv(train_data, v = 5)</span></span>
<span id="cb46-620"><a href="#cb46-620" aria-hidden="true" tabindex="-1"></a><span class="co">  </span></span>
<span id="cb46-621"><a href="#cb46-621" aria-hidden="true" tabindex="-1"></a><span class="co">  #=== specify the model ===#</span></span>
<span id="cb46-622"><a href="#cb46-622" aria-hidden="true" tabindex="-1"></a><span class="co">  temp_gam &lt;- specify_gam(sp)</span></span>
<span id="cb46-623"><a href="#cb46-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-624"><a href="#cb46-624" aria-hidden="true" tabindex="-1"></a><span class="co">  #=== get MSE by fold ===#</span></span>
<span id="cb46-625"><a href="#cb46-625" aria-hidden="true" tabindex="-1"></a><span class="co">  mse_by_k &lt;-</span></span>
<span id="cb46-626"><a href="#cb46-626" aria-hidden="true" tabindex="-1"></a><span class="co">    lapply(</span></span>
<span id="cb46-627"><a href="#cb46-627" aria-hidden="true" tabindex="-1"></a><span class="co">      seq_len(nrow(data_folds)),</span></span>
<span id="cb46-628"><a href="#cb46-628" aria-hidden="true" tabindex="-1"></a><span class="co">      function(x) get_mse_by_fold(train_data, x, temp_gam)</span></span>
<span id="cb46-629"><a href="#cb46-629" aria-hidden="true" tabindex="-1"></a><span class="co">    ) %&gt;% </span></span>
<span id="cb46-630"><a href="#cb46-630" aria-hidden="true" tabindex="-1"></a><span class="co">    rbindlist()</span></span>
<span id="cb46-631"><a href="#cb46-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-632"><a href="#cb46-632" aria-hidden="true" tabindex="-1"></a><span class="co">  #=== find the average MSE (over folds) ===#</span></span>
<span id="cb46-633"><a href="#cb46-633" aria-hidden="true" tabindex="-1"></a><span class="co">  mse_kcv &lt;-</span></span>
<span id="cb46-634"><a href="#cb46-634" aria-hidden="true" tabindex="-1"></a><span class="co">    mse_by_k %&gt;% </span></span>
<span id="cb46-635"><a href="#cb46-635" aria-hidden="true" tabindex="-1"></a><span class="co">    .[, .(mse = mean(mse))] %&gt;% </span></span>
<span id="cb46-636"><a href="#cb46-636" aria-hidden="true" tabindex="-1"></a><span class="co">    .[, sp := sp] %&gt;% </span></span>
<span id="cb46-637"><a href="#cb46-637" aria-hidden="true" tabindex="-1"></a><span class="co">    .[, type := "KCV"]</span></span>
<span id="cb46-638"><a href="#cb46-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-639"><a href="#cb46-639" aria-hidden="true" tabindex="-1"></a><span class="co">  #/*----------------------------------*/</span></span>
<span id="cb46-640"><a href="#cb46-640" aria-hidden="true" tabindex="-1"></a><span class="co">  #' ## pure MSE from the test data  </span></span>
<span id="cb46-641"><a href="#cb46-641" aria-hidden="true" tabindex="-1"></a><span class="co">  #/*----------------------------------*/</span></span>
<span id="cb46-642"><a href="#cb46-642" aria-hidden="true" tabindex="-1"></a><span class="co">  #=== train using the entire train dataset ===#</span></span>
<span id="cb46-643"><a href="#cb46-643" aria-hidden="true" tabindex="-1"></a><span class="co">  fitted &lt;- temp_gam(train_data)</span></span>
<span id="cb46-644"><a href="#cb46-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-645"><a href="#cb46-645" aria-hidden="true" tabindex="-1"></a><span class="co">  #=== find the average MSE (over observations) ===#</span></span>
<span id="cb46-646"><a href="#cb46-646" aria-hidden="true" tabindex="-1"></a><span class="co">  mse_test &lt;- </span></span>
<span id="cb46-647"><a href="#cb46-647" aria-hidden="true" tabindex="-1"></a><span class="co">    test_data %&gt;% </span></span>
<span id="cb46-648"><a href="#cb46-648" aria-hidden="true" tabindex="-1"></a><span class="co">    #=== predict y ===#</span></span>
<span id="cb46-649"><a href="#cb46-649" aria-hidden="true" tabindex="-1"></a><span class="co">    .[, y_hat := predict(fitted, newdata = .)] %&gt;% </span></span>
<span id="cb46-650"><a href="#cb46-650" aria-hidden="true" tabindex="-1"></a><span class="co">    .[, .(mse = mean((ey - y_hat)^2))] %&gt;% </span></span>
<span id="cb46-651"><a href="#cb46-651" aria-hidden="true" tabindex="-1"></a><span class="co">    .[, sp := sp] %&gt;% </span></span>
<span id="cb46-652"><a href="#cb46-652" aria-hidden="true" tabindex="-1"></a><span class="co">    .[, type := "Pure"]</span></span>
<span id="cb46-653"><a href="#cb46-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-654"><a href="#cb46-654" aria-hidden="true" tabindex="-1"></a><span class="co">  #/*----------------------------------*/</span></span>
<span id="cb46-655"><a href="#cb46-655" aria-hidden="true" tabindex="-1"></a><span class="co">  #' ## Combine and return</span></span>
<span id="cb46-656"><a href="#cb46-656" aria-hidden="true" tabindex="-1"></a><span class="co">  #/*----------------------------------*/</span></span>
<span id="cb46-657"><a href="#cb46-657" aria-hidden="true" tabindex="-1"></a><span class="co">  return_data &lt;- rbind(mse_kcv, mse_test)</span></span>
<span id="cb46-658"><a href="#cb46-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-659"><a href="#cb46-659" aria-hidden="true" tabindex="-1"></a><span class="co">  return(return_data)</span></span>
<span id="cb46-660"><a href="#cb46-660" aria-hidden="true" tabindex="-1"></a><span class="co">}</span></span>
<span id="cb46-661"><a href="#cb46-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-662"><a href="#cb46-662" aria-hidden="true" tabindex="-1"></a><span class="co">```</span></span>
<span id="cb46-663"><a href="#cb46-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-664"><a href="#cb46-664" aria-hidden="true" tabindex="-1"></a><span class="co">:::{.callout-warning}</span></span>
<span id="cb46-665"><a href="#cb46-665" aria-hidden="true" tabindex="-1"></a><span class="co">Note that you do not have to use an independent test data to obtain pure MSE above even though the code does it so. You could just use the `train_data` in getting pure MSE and the results would be essentially the same.</span></span>
<span id="cb46-666"><a href="#cb46-666" aria-hidden="true" tabindex="-1"></a><span class="co">:::</span></span>
<span id="cb46-667"><a href="#cb46-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-668"><a href="#cb46-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-669"><a href="#cb46-669" aria-hidden="true" tabindex="-1"></a><span class="co">For example, this will give you MSE from KCV and MSE using the test data for `sp` $= 2$.</span></span>
<span id="cb46-670"><a href="#cb46-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-673"><a href="#cb46-673" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-674"><a href="#cb46-674" aria-hidden="true" tabindex="-1"></a><span class="co">get_mse_by_sp(2)</span></span>
<span id="cb46-675"><a href="#cb46-675" aria-hidden="true" tabindex="-1"></a><span class="co">```</span></span>
<span id="cb46-676"><a href="#cb46-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-677"><a href="#cb46-677" aria-hidden="true" tabindex="-1"></a><span class="co">Now, we define a function that loops over all the `sp` values we test.</span></span>
<span id="cb46-678"><a href="#cb46-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-681"><a href="#cb46-681" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-682"><a href="#cb46-682" aria-hidden="true" tabindex="-1"></a><span class="co">sp_seq &lt;- seq(0, 2, by = 0.2)</span></span>
<span id="cb46-683"><a href="#cb46-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-684"><a href="#cb46-684" aria-hidden="true" tabindex="-1"></a><span class="co">get_mse &lt;- function(i)</span></span>
<span id="cb46-685"><a href="#cb46-685" aria-hidden="true" tabindex="-1"></a><span class="co">{ </span></span>
<span id="cb46-686"><a href="#cb46-686" aria-hidden="true" tabindex="-1"></a><span class="co">  print(i) # progress tracker</span></span>
<span id="cb46-687"><a href="#cb46-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-688"><a href="#cb46-688" aria-hidden="true" tabindex="-1"></a><span class="co">  lapply(</span></span>
<span id="cb46-689"><a href="#cb46-689" aria-hidden="true" tabindex="-1"></a><span class="co">    sp_seq,</span></span>
<span id="cb46-690"><a href="#cb46-690" aria-hidden="true" tabindex="-1"></a><span class="co">    function(x) get_mse_by_sp(x)</span></span>
<span id="cb46-691"><a href="#cb46-691" aria-hidden="true" tabindex="-1"></a><span class="co">  ) %&gt;% </span></span>
<span id="cb46-692"><a href="#cb46-692" aria-hidden="true" tabindex="-1"></a><span class="co">  rbindlist()</span></span>
<span id="cb46-693"><a href="#cb46-693" aria-hidden="true" tabindex="-1"></a><span class="co">}</span></span>
<span id="cb46-694"><a href="#cb46-694" aria-hidden="true" tabindex="-1"></a><span class="co">```</span></span>
<span id="cb46-695"><a href="#cb46-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-696"><a href="#cb46-696" aria-hidden="true" tabindex="-1"></a><span class="co">For example, the following gives you MSE values for all the `sp` values for a single iteration.</span></span>
<span id="cb46-697"><a href="#cb46-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-700"><a href="#cb46-700" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-701"><a href="#cb46-701" aria-hidden="true" tabindex="-1"></a><span class="co">get_mse(1)</span></span>
<span id="cb46-702"><a href="#cb46-702" aria-hidden="true" tabindex="-1"></a><span class="co">```</span></span>
<span id="cb46-703"><a href="#cb46-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-704"><a href="#cb46-704" aria-hidden="true" tabindex="-1"></a><span class="co">Finally, we run `get_mse()` 500 times.</span></span>
<span id="cb46-705"><a href="#cb46-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-708"><a href="#cb46-708" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-709"><a href="#cb46-709" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: true</span></span>
<span id="cb46-710"><a href="#cb46-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-711"><a href="#cb46-711" aria-hidden="true" tabindex="-1"></a><span class="co">mse_results &lt;-</span></span>
<span id="cb46-712"><a href="#cb46-712" aria-hidden="true" tabindex="-1"></a><span class="co">  mclapply(</span></span>
<span id="cb46-713"><a href="#cb46-713" aria-hidden="true" tabindex="-1"></a><span class="co">    1:500,</span></span>
<span id="cb46-714"><a href="#cb46-714" aria-hidden="true" tabindex="-1"></a><span class="co">    get_mse,</span></span>
<span id="cb46-715"><a href="#cb46-715" aria-hidden="true" tabindex="-1"></a><span class="co">    mc.cores = 12</span></span>
<span id="cb46-716"><a href="#cb46-716" aria-hidden="true" tabindex="-1"></a><span class="co">  ) %&gt;% </span></span>
<span id="cb46-717"><a href="#cb46-717" aria-hidden="true" tabindex="-1"></a><span class="co">  rbindlist(idcol = "sim_id")</span></span>
<span id="cb46-718"><a href="#cb46-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-719"><a href="#cb46-719" aria-hidden="true" tabindex="-1"></a><span class="co">#=== use this if you are a Windows user ===#</span></span>
<span id="cb46-720"><a href="#cb46-720" aria-hidden="true" tabindex="-1"></a><span class="co"># mse_results &lt;-</span></span>
<span id="cb46-721"><a href="#cb46-721" aria-hidden="true" tabindex="-1"></a><span class="co">#   lapply(</span></span>
<span id="cb46-722"><a href="#cb46-722" aria-hidden="true" tabindex="-1"></a><span class="co">#     1:500,</span></span>
<span id="cb46-723"><a href="#cb46-723" aria-hidden="true" tabindex="-1"></a><span class="co">#     get_mse</span></span>
<span id="cb46-724"><a href="#cb46-724" aria-hidden="true" tabindex="-1"></a><span class="co">#   )</span></span>
<span id="cb46-725"><a href="#cb46-725" aria-hidden="true" tabindex="-1"></a><span class="co">```</span></span>
<span id="cb46-726"><a href="#cb46-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-727"><a href="#cb46-727" aria-hidden="true" tabindex="-1"></a><span class="co">For each simulation round, let's find the best `sp` using KCV and pure MSE.</span></span>
<span id="cb46-728"><a href="#cb46-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-731"><a href="#cb46-731" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-732"><a href="#cb46-732" aria-hidden="true" tabindex="-1"></a><span class="co">(</span></span>
<span id="cb46-733"><a href="#cb46-733" aria-hidden="true" tabindex="-1"></a><span class="co">which_sp_optimal &lt;-</span></span>
<span id="cb46-734"><a href="#cb46-734" aria-hidden="true" tabindex="-1"></a><span class="co">  mse_results %&gt;% </span></span>
<span id="cb46-735"><a href="#cb46-735" aria-hidden="true" tabindex="-1"></a><span class="co">  .[, .SD[which.min(mse), ], by = .(type, sim_id)] %&gt;% </span></span>
<span id="cb46-736"><a href="#cb46-736" aria-hidden="true" tabindex="-1"></a><span class="co">  #=== drop mse ===#</span></span>
<span id="cb46-737"><a href="#cb46-737" aria-hidden="true" tabindex="-1"></a><span class="co">  .[, mse := NULL] %&gt;% </span></span>
<span id="cb46-738"><a href="#cb46-738" aria-hidden="true" tabindex="-1"></a><span class="co">  dcast(sim_id ~ type, value.var = "sp") %&gt;% </span></span>
<span id="cb46-739"><a href="#cb46-739" aria-hidden="true" tabindex="-1"></a><span class="co">  .[, num_comb := .N, by = .(KCV, Pure)]</span></span>
<span id="cb46-740"><a href="#cb46-740" aria-hidden="true" tabindex="-1"></a><span class="co">)</span></span>
<span id="cb46-741"><a href="#cb46-741" aria-hidden="true" tabindex="-1"></a><span class="co">```</span></span>
<span id="cb46-742"><a href="#cb46-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-743"><a href="#cb46-743" aria-hidden="true" tabindex="-1"></a><span class="co">For example, for the first simulation, `sp` that would have minimized pure MSE (least error relative to the true $E[y|x]$ across varying values of $x$) was `r which_sp_optimal[1, Pure]`. On the other hand, if you relied on KCV, you would have chosen `r which_sp_optimal[1, KCV]`. </span></span>
<span id="cb46-744"><a href="#cb46-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-745"><a href="#cb46-745" aria-hidden="true" tabindex="-1"></a><span class="co">The following figure shows the relationship between KCV-based and pure MSE-based `sp` values.</span></span>
<span id="cb46-746"><a href="#cb46-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-749"><a href="#cb46-749" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-750"><a href="#cb46-750" aria-hidden="true" tabindex="-1"></a><span class="co">#=== plot the frequency of sp chosen by KCV ===#</span></span>
<span id="cb46-751"><a href="#cb46-751" aria-hidden="true" tabindex="-1"></a><span class="co">ggplot(data = which_sp_optimal) +</span></span>
<span id="cb46-752"><a href="#cb46-752" aria-hidden="true" tabindex="-1"></a><span class="co">  geom_point(aes(y = Pure, x = KCV, size = num_comb)) +</span></span>
<span id="cb46-753"><a href="#cb46-753" aria-hidden="true" tabindex="-1"></a><span class="co">  scale_y_continuous(breaks = sp_seq) +</span></span>
<span id="cb46-754"><a href="#cb46-754" aria-hidden="true" tabindex="-1"></a><span class="co">  scale_x_continuous(breaks = sp_seq) </span></span>
<span id="cb46-755"><a href="#cb46-755" aria-hidden="true" tabindex="-1"></a><span class="co">```</span></span>
<span id="cb46-756"><a href="#cb46-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-757"><a href="#cb46-757" aria-hidden="true" tabindex="-1"></a><span class="co">As you can see KCV gives you `sp` that is close to the `sp` based on pure MSE in many cases. But, you can also see that KCV can suggest you a very different number as well. KCV is not perfect, which is kind of obvious.</span></span>
<span id="cb46-758"><a href="#cb46-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-759"><a href="#cb46-759" aria-hidden="true" tabindex="-1"></a><span class="co"> --&gt;</span></span>
<span id="cb46-760"><a href="#cb46-760" aria-hidden="true" tabindex="-1"></a><span class="fu">## References {.unnumbered}</span></span>
<span id="cb46-761"><a href="#cb46-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-762"><a href="#cb46-762" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;div</span> <span class="er">id</span><span class="ot">=</span><span class="st">"refs"</span><span class="kw">&gt;&lt;/div&gt;</span></span>
<span id="cb46-763"><a href="#cb46-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-764"><a href="#cb46-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-765"><a href="#cb46-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-766"><a href="#cb46-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-767"><a href="#cb46-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-768"><a href="#cb46-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-769"><a href="#cb46-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-770"><a href="#cb46-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-771"><a href="#cb46-771" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>