<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.563">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Introduction to Machine Learning for Economists - 3&nbsp; Cross-validation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./B04-regularization.html" rel="next">
<link href="./B02-bias-variance-tradeoff.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Cross-validation</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Introduction to Machine Learning for Economists</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/tmieno2/ML-Economist" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="" title="Share" id="sidebar-tool-dropdown-0" class="sidebar-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-share"></i></a>
    <ul class="dropdown-menu" aria-labelledby="sidebar-tool-dropdown-0">
<li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=%7Curl%7C">
            <i class="bi bi-bi-twitter pe-1"></i>
          Twitter
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=%7Curl%7C">
            <i class="bi bi-bi-facebook pe-1"></i>
          Facebook
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=%7Curl%7C">
            <i class="bi bi-bi-linkedin pe-1"></i>
          LinkedIn
          </a>
        </li>
    </ul>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Welcome</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface.html" class="sidebar-item-text sidebar-link">Preface: Prediction v.s. Causal Inference</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./basics.html" class="sidebar-item-text sidebar-link">Basics</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B01-nonlinear.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Non-linear function estimation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B02-bias-variance-tradeoff.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Bias-variance Trade-off</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B03-cross-validation.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Cross-validation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B04-regularization.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Regression Shrinkage Methods</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B05-bootstrap.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Bootstrap</span></a>
  </div>
</li>
    </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./prediction-ml.html" class="sidebar-item-text sidebar-link">Prediction ML</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P01-random-forest.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Random Forest</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P02-boosted-regression-forest.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Boosted Regression Forest</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P03-xgb.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Extreme Gradient Boosting</span></a>
  </div>
</li>
    </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./causal-ml.html" class="sidebar-item-text sidebar-link">Causal Machine Learning (CML) Methods</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">Appendices</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./A01-mc-simulation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Monte Carlo (MC) Simulation</span></a>
  </div>
</li>
    </ul>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#motivations" id="toc-motivations" class="nav-link active" data-scroll-target="#motivations"> <span class="header-section-number">3.1</span> Motivations</a></li>
  <li>
<a href="#leave-one-out-cross-validation-loocv" id="toc-leave-one-out-cross-validation-loocv" class="nav-link" data-scroll-target="#leave-one-out-cross-validation-loocv"> <span class="header-section-number">3.2</span> Leave-One-Out Cross-Validation (LOOCV)</a>
  <ul class="collapse">
<li><a href="#r-demonstration-using-mgcvgam" id="toc-r-demonstration-using-mgcvgam" class="nav-link" data-scroll-target="#r-demonstration-using-mgcvgam"> <span class="header-section-number">3.2.1</span> R demonstration using <code>mgcv::gam()</code></a></li>
  <li><a href="#selecting-the-best-gam-specification-illustration" id="toc-selecting-the-best-gam-specification-illustration" class="nav-link" data-scroll-target="#selecting-the-best-gam-specification-illustration"> <span class="header-section-number">3.2.2</span> Selecting the best GAM specification: Illustration</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"> <span class="header-section-number">3.2.3</span> Summary</a></li>
  </ul>
</li>
  <li>
<a href="#k-fold-cross-validation-kcv" id="toc-k-fold-cross-validation-kcv" class="nav-link" data-scroll-target="#k-fold-cross-validation-kcv"> <span class="header-section-number">3.3</span> K-fold Cross-Validation (KCV)</a>
  <ul class="collapse">
<li><a href="#selecting-the-best-gam-specification-illustration-1" id="toc-selecting-the-best-gam-specification-illustration-1" class="nav-link" data-scroll-target="#selecting-the-best-gam-specification-illustration-1"> <span class="header-section-number">3.3.1</span> Selecting the best GAM specification: Illustration</a></li>
  </ul>
</li>
  <li><a href="#repeated-k-fold-cross-validation-kcv" id="toc-repeated-k-fold-cross-validation-kcv" class="nav-link" data-scroll-target="#repeated-k-fold-cross-validation-kcv"> <span class="header-section-number">3.4</span> Repeated K-fold Cross-Validation (KCV)</a></li>
  <li><a href="#does-kcv-really-work" id="toc-does-kcv-really-work" class="nav-link" data-scroll-target="#does-kcv-really-work"> <span class="header-section-number">3.5</span> Does KCV really work?</a></li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/tmieno2/ML-Economist/edit/master/B03-cross-validation.qmd" class="toc-action">Edit this page</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-cross-validation" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Cross-validation</span></span></h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header><section id="motivations" class="level2" data-number="3.1"><h2 data-number="3.1" class="anchored" data-anchor-id="motivations">
<span class="header-section-number">3.1</span> Motivations</h2>
<p>No model works the best all the time, and searching for the best modeling approach and specifications is an essential part of modeling applications.</p>
<p>For example, we may consider five approaches with varying modeling specifications for each of the approaches:</p>
<ul>
<li>Random Forest (RF)
<ul>
<li>number of trees (1000, 2000)</li>
<li>number of variables used in each tree (3, 5, 8)</li>
<li>and many other hyper parameters</li>
</ul>
</li>
<li>LASSO
<ul>
<li>penalty parameter (1, 2, 3, etc)</li>
</ul>
</li>
<li>GAM
<ul>
<li>number of knots</li>
<li>penalty parameter</li>
</ul>
</li>
<li>Boosted Regression Forest (BRF)
<ul>
<li>number of trees (1000, 2000)</li>
<li>number of variables used in each tree (3, 5, 8)</li>
<li>and many other hyper parameters</li>
</ul>
</li>
<li>Convolutional Neural Network (CNN)
<ul>
<li>convolution matrix dimension</li>
<li>the order of convolution</li>
<li>learning rate</li>
<li>and many other hyper parameters</li>
</ul>
</li>
</ul>
<p>Our goal here is to find the model that would performs the best when applied to the data that has not been seen yet.</p>
<p>We saw earlier that training MSE is not appropriate for that purpose as picking the model with the lowest training MSE would very much likely to lead you to the over-fitted model. In this lecture, we consider a better way of selecting a model using only train data.</p>
</section><section id="leave-one-out-cross-validation-loocv" class="level2 page-columns page-full" data-number="3.2"><h2 data-number="3.2" class="anchored" data-anchor-id="leave-one-out-cross-validation-loocv">
<span class="header-section-number">3.2</span> Leave-One-Out Cross-Validation (LOOCV)</h2>

<div class="no-row-height column-margin column-container"><div class="">
<p><strong>Packages to load for replication</strong></p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">mgcv</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rsample.tidymodels.org">rsample</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div></div><p>Consider a dataset: <span class="math inline">\(D = \{X_1, y_1\}, \{X_2, y_2\}, \dots, \{X_N, y_N\}\)</span>, where <span class="math inline">\(X_i\)</span> is a collection of features and <span class="math inline">\(y_i\)</span> is the dependent variable for <span class="math inline">\(i\)</span>th observation. Further, suppose you use <span class="math inline">\(D\)</span> for training ML models and <span class="math inline">\(\hat{f}()\)</span> is a trained model.</p>
<p>LOOCV leaves out a single observation (say <span class="math inline">\(i\)</span>), and train a model (say, GAM with the number of knots of 10) using the all the other observations (-<span class="math inline">\(i\)</span>), and then find MSE for the left-out observation. This process is repeated for all the observations, and then the average of the individual MSEs is calculated.</p>
<section id="r-demonstration-using-mgcvgam" class="level3" data-number="3.2.1"><h3 data-number="3.2.1" class="anchored" data-anchor-id="r-demonstration-using-mgcvgam">
<span class="header-section-number">3.2.1</span> R demonstration using <code>mgcv::gam()</code>
</h3>
<p>Let’s demonstrate this using R. Here is the dataset we use.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">943843</span><span class="op">)</span>

<span class="co"># define the data generating process</span>
<span class="co"># x fixed</span>
<span class="va">gen_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="va">ey</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fl">2.5</span><span class="op">)</span><span class="op">^</span><span class="fl">3</span> <span class="co"># E[y|x]</span>
  <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">ey</span> <span class="op">+</span> <span class="fl">3</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="co"># y = E[y|x] + u</span>
  <span class="va">return_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span>, x <span class="op">=</span> <span class="va">x</span>, ey <span class="op">=</span> <span class="va">ey</span><span class="op">)</span>

  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">return_data</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">## generate train data</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">gen_data</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Visually, here is the relationship between <span class="math inline">\(E[y]\)</span> and <span class="math inline">\(x\)</span>:</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">ey</span>, x <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="B03-cross-validation_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>For example, for the case where the first observation is left out for validation,</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co"># leave out the first observation</span>
<span class="va">left_out_observation</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>

<span class="co"># all the rest</span>
<span class="va">train_data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>, <span class="op">]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we train a gam model using the train_data, predict <span class="math inline">\(y\)</span> for the first observation, and find the MSE.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co">#=== train the model ===#</span>
<span class="va">fitted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html">gam</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html">s</a></span><span class="op">(</span><span class="va">x</span>, k <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>, sp <span class="op">=</span> <span class="fl">0</span>, data <span class="op">=</span> <span class="va">train_data</span><span class="op">)</span>

<span class="co">#=== predict y for the first observation ===#</span>
<span class="va">y_fitted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fitted</span>, newdata <span class="op">=</span> <span class="va">left_out_observation</span><span class="op">)</span>

<span class="co">#=== get MSE ===#</span>
<span class="va">MSE</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">left_out_observation</span><span class="op">[</span>, <span class="va">y</span><span class="op">]</span> <span class="op">-</span> <span class="va">y_fitted</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As described above, LOOCV repeats this process for every single observation of the data. Now, let’s write a function that does the above process for any <span class="math inline">\(i\)</span> you specify.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co">#=== define the modeling approach ===#</span>
<span class="va">gam_k_10</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">train_data</span><span class="op">)</span> 
<span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html">gam</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html">s</a></span><span class="op">(</span><span class="va">x</span>, k <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>, sp <span class="op">=</span> <span class="fl">0</span>, data <span class="op">=</span> <span class="va">train_data</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">#=== define the process of getting MSE for ith observation ===#</span>
<span class="va">get_mse</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">model</span><span class="op">)</span>
<span class="op">{</span>
  <span class="va">left_out_observation</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span>

  <span class="co"># all the rest</span>
  <span class="va">train_data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="op">-</span><span class="va">i</span>, <span class="op">]</span>

  <span class="co">#=== train the model ===#</span>
  <span class="va">fitted</span> <span class="op">&lt;-</span> <span class="fu">model</span><span class="op">(</span><span class="va">train_data</span><span class="op">)</span>

  <span class="co">#=== predict y for the first observation ===#</span>
  <span class="va">y_fitted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fitted</span>, newdata <span class="op">=</span> <span class="va">left_out_observation</span><span class="op">)</span>

  <span class="co">#=== get MSE ===#</span>
  <span class="va">MSE</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">left_out_observation</span><span class="op">[</span>, <span class="va">y</span><span class="op">]</span> <span class="op">-</span> <span class="va">y_fitted</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span> 

  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">MSE</span><span class="op">)</span>
<span class="op">}</span> </code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For example, this gets MSE for the 10th observation.</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu">get_mse</span><span class="op">(</span><span class="fl">10</span>, <span class="va">gam_k_10</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       1 
1.523446 </code></pre>
</div>
</div>
<p>Let’s now loop over <span class="math inline">\(i = 1:100\)</span>.</p>
<div class="cell" data-hash="B03-cross-validation_cache/html/unnamed-chunk-18_ec27a9a1711d7dac6994f2be48401857">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">mse_indiv</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
    <span class="fl">1</span><span class="op">:</span><span class="fl">100</span>,
    <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">get_mse</span><span class="op">(</span><span class="va">x</span>, <span class="va">gam_k_10</span><span class="op">)</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="co">#=== list to a vector ===#</span>
  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="op">)</span> </code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is the distribution of MSEs.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">mse_indiv</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="B03-cross-validation_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We now get the average MSE.</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">mse_average</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mse_indiv</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="selecting-the-best-gam-specification-illustration" class="level3" data-number="3.2.2"><h3 data-number="3.2.2" class="anchored" data-anchor-id="selecting-the-best-gam-specification-illustration">
<span class="header-section-number">3.2.2</span> Selecting the best GAM specification: Illustration</h3>
<p>Now, let’s try to find the best (among the ones we try) GAM specification using LOOCV. We will try ten different GAM specifications which vary in penalization parameter. Penalization parameter can be set using the <code>sp</code> option for <code><a href="https://rdrr.io/pkg/mgcv/man/gam.html">mgcv::gam()</a></code>. A greater value of <code>sp</code> leads to a more smooth fitted curve.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">specify_gam</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sp</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">function</span><span class="op">(</span><span class="va">train_data</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html">gam</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html">s</a></span><span class="op">(</span><span class="va">x</span>, k <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>, sp <span class="op">=</span> <span class="va">sp</span>, data <span class="op">=</span> <span class="va">train_data</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="va">get_mse_by_sp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sp</span><span class="op">)</span>
<span class="op">{</span>

  <span class="va">temp_gam</span> <span class="op">&lt;-</span> <span class="fu">specify_gam</span><span class="op">(</span><span class="va">sp</span><span class="op">)</span>

  <span class="va">mse_indiv</span> <span class="op">&lt;-</span>
    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
      <span class="fl">1</span><span class="op">:</span><span class="fl">100</span>,
      <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">get_mse</span><span class="op">(</span><span class="va">x</span>, <span class="va">temp_gam</span><span class="op">)</span>
    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="co">#=== list to a vector ===#</span>
    <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">)</span>

  <span class="va">return_data</span> <span class="op">&lt;-</span>
    <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>
      mse <span class="op">=</span> <span class="va">mse_indiv</span>,
      sp <span class="op">=</span> <span class="va">sp</span>
    <span class="op">)</span>

  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">return_data</span><span class="op">)</span>
<span class="op">}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For example, the following code gets you the average MSE for <code>sp</code> <span class="math inline">\(= 3\)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu">get_mse_by_sp</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        mse sp
1: 11.56747  3</code></pre>
</div>
</div>
<p>Now, let’s loop over ten values of <code>sp</code>: 0, 0.2, 0.4, 0.6, 0.8, 1, 1.2, 1.4, 1.6, 1.8, 2.</p>
<div class="cell" data-hash="B03-cross-validation_cache/html/unnamed-chunk-28_e99ff50638662b941cf0206a34c15c6a">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="op">(</span>
<span class="va">mse_data</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, by <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>,
    <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">get_mse_by_sp</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          mse  sp
 1: 12.460156 0.0
 2:  9.909992 0.2
 3:  9.957858 0.4
 4: 10.049327 0.6
 5: 10.164749 0.8
 6: 10.293142 1.0
 7: 10.427948 1.2
 8: 10.565081 1.4
 9: 10.701933 1.6
10: 10.836829 1.8
11: 10.968701 2.0</code></pre>
</div>
</div>
<div class="cell">

</div>
<p>So, according to the LOOCV, we should pick <code>sp</code> <span class="math inline">\(= 0.2\)</span> as the penalty parameter.</p>
<p>Now, that we know <code>sp</code> <span class="math inline">\(= 0.2\)</span> produces the lowest LOOCV MSE, we rerun <code><a href="https://rdrr.io/pkg/mgcv/man/gam.html">gam()</a></code> using the entire dataset (not leaving out any of the observations) and make it our final trained model.</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">final_gam_spec</span> <span class="op">&lt;-</span> <span class="fu">specify_gam</span><span class="op">(</span>sp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>

<span class="va">fit_gam</span> <span class="op">&lt;-</span> <span class="fu">final_gam_spec</span><span class="op">(</span><span class="va">train_data</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is what the fitted curve looks like:</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit_gam</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="B03-cross-validation_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Looks good. By the way, here are the fitted curves for some other <code>sp</code> values.</p>
<div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">fitted_curves</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.6</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,
    <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">temp_gam</span> <span class="op">&lt;-</span> <span class="fu">specify_gam</span><span class="op">(</span>sp <span class="op">=</span> <span class="va">x</span><span class="op">)</span>
      <span class="va">fit_gam</span> <span class="op">&lt;-</span> <span class="fu">temp_gam</span><span class="op">(</span><span class="va">train_data</span><span class="op">)</span>   
    <span class="op">}</span>
  <span class="op">)</span>  

<span class="kw">for</span> <span class="op">(</span><span class="va">plot</span> <span class="kw">in</span> <span class="va">fitted_curves</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">plot</span><span class="op">)</span>
<span class="op">}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-fitted-penalization-others" class="cell quarto-layout-panel">
<figure class="figure"><div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-fitted-penalization-others-1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="B03-cross-validation_files/figure-html/fig-fitted-penalization-others-1.png" class="img-fluid figure-img" data-ref-parent="fig-fitted-penalization-others" width="672"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">(a) k = 0</figcaption><p></p>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-fitted-penalization-others-2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="B03-cross-validation_files/figure-html/fig-fitted-penalization-others-2.png" class="img-fluid figure-img" data-ref-parent="fig-fitted-penalization-others" width="672"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">(b) k = 0.6</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-fitted-penalization-others-3" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="B03-cross-validation_files/figure-html/fig-fitted-penalization-others-3.png" class="img-fluid figure-img" data-ref-parent="fig-fitted-penalization-others" width="672"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">(c) k = 1</figcaption><p></p>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-fitted-penalization-others-4" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="B03-cross-validation_files/figure-html/fig-fitted-penalization-others-4.png" class="img-fluid figure-img" data-ref-parent="fig-fitted-penalization-others" width="672"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">(d) k = 2</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p></p><figcaption aria-hidden="true" class="figure-caption">Figure 3.1: Fitted curves at various penalization parameters</figcaption><p></p>
</figure>
</div>
</div>
<p>LOOCV is perfectly general and can be applied to any statistical methods. However, it can be extremely computationally burdensome because you need to fit the same model for as many as the number of observations. So, if you have 10,000 observations, then you need to fit the model 10,000 times, which can take a long long time.</p>
</section><section id="summary" class="level3" data-number="3.2.3"><h3 data-number="3.2.3" class="anchored" data-anchor-id="summary">
<span class="header-section-number">3.2.3</span> Summary</h3>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>LOOCV is perfectly general and can be applied to any statistical methods.</p>
</div>
</div>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>LOOCV can be highly computation-intensive when the dataset is large</p>
</div>
</div>
</section></section><section id="k-fold-cross-validation-kcv" class="level2" data-number="3.3"><h2 data-number="3.3" class="anchored" data-anchor-id="k-fold-cross-validation-kcv">
<span class="header-section-number">3.3</span> K-fold Cross-Validation (KCV)</h2>
<p>KCV is a type of cross-validation that overcomes the LOOCV’s drawback of being computationally too intensive when the dataset is large. KCV first splits the entire dataset intro <span class="math inline">\(K\)</span> folds (K groups) randomly. It then leaves out a chunk of observations that belongs to a fold (group), trains the model using the rest of the observations in the other folds, evaluate the trained model using the left-out group. It repeats this process for all the groups and average the MSEs obtained for each group.</p>
<p>Let’s demonstrate this process using R.</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">89534</span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">gen_data</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">500</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can use <code><a href="https://rsample.tidymodels.org/reference/vfold_cv.html">rsample::vfold_cv()</a></code> to split the data into groups.</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co">#=== split into 5 groups ===#</span>
<span class="op">(</span>
<span class="va">data_folds</span> <span class="op">&lt;-</span> <span class="fu">rsample</span><span class="fu">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/vfold_cv.html">vfold_cv</a></span><span class="op">(</span><span class="va">data</span>, v <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#  5-fold cross-validation 
# A tibble: 5 × 2
  splits            id   
  &lt;list&gt;            &lt;chr&gt;
1 &lt;split [400/100]&gt; Fold1
2 &lt;split [400/100]&gt; Fold2
3 &lt;split [400/100]&gt; Fold3
4 &lt;split [400/100]&gt; Fold4
5 &lt;split [400/100]&gt; Fold5</code></pre>
</div>
</div>
<p>As you can see, <code><a href="https://rsample.tidymodels.org/reference/vfold_cv.html">rsample::vfold_cv()</a></code> creates <span class="math inline">\(v\)</span> (<span class="math inline">\(=5\)</span> here) splits. And each split has both train and test datasets. <code>&lt;split [400/100]&gt;</code> means that <span class="math inline">\(400\)</span> and <span class="math inline">\(100\)</span> observations for the train and test datasets, respectively. Note that, the <span class="math inline">\(100\)</span> observations in the first split (called <code>Fold 1</code>) are in the train datasets of the rest of the splits (<code>Fold 2</code> through <code>Fold 5</code>).</p>
<p>You can extract the train and test datasets like below using the <code><a href="https://rsample.tidymodels.org/reference/initial_split.html">training()</a></code> and <code><a href="https://rsample.tidymodels.org/reference/initial_split.html">testing()</a></code> functions.</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">train_data</span> <span class="op">&lt;-</span> <span class="va">data_folds</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">$</span><span class="va">splits</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html">training</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">test_data</span> <span class="op">&lt;-</span> <span class="va">data_folds</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">$</span><span class="va">splits</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html">testing</a></span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, let’s get MSE for the first fold.</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co">#=== train the model ===#</span>
<span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html">gam</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html">s</a></span><span class="op">(</span><span class="va">x</span>, k <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>, sp <span class="op">=</span> <span class="fl">0</span>, data <span class="op">=</span> <span class="va">train_data</span><span class="op">)</span>

<span class="co">#=== predict y for the test data ===#</span>
<span class="va">y_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fitted_model</span>, <span class="va">test_data</span><span class="op">)</span>

<span class="co">#=== calculate MSE for the fold ===#</span>
<span class="op">(</span><span class="va">test_data</span><span class="op">[</span>, <span class="va">y</span><span class="op">]</span> <span class="op">-</span> <span class="va">y_hat</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 12.05604</code></pre>
</div>
</div>
<p>Now that we know how to get MSE for a single fold, let’s loop over folds and get MSE for each of the folds. We first create a function that gets us MSE for a single fold.</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">get_mse_by_fold</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">fold</span>, <span class="va">model</span><span class="op">)</span>
<span class="op">{</span>

  <span class="va">test_data</span> <span class="op">&lt;-</span> <span class="va">data_folds</span><span class="op">[</span><span class="va">fold</span>, <span class="op">]</span><span class="op">$</span><span class="va">splits</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html">testing</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">train_data</span> <span class="op">&lt;-</span> <span class="va">data_folds</span><span class="op">[</span><span class="va">fold</span>, <span class="op">]</span><span class="op">$</span><span class="va">splits</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html">training</a></span><span class="op">(</span><span class="op">)</span>

  <span class="co">#=== train the model ===#</span>
  <span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">model</span><span class="op">(</span><span class="va">train_data</span><span class="op">)</span>

  <span class="co">#=== predict y for the test data ===#</span>
  <span class="va">y_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fitted_model</span>, <span class="va">test_data</span><span class="op">)</span>

  <span class="co">#=== calculate MSE for the fold ===#</span>
  <span class="va">mse</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">test_data</span><span class="op">[</span>, <span class="va">y</span><span class="op">]</span> <span class="op">-</span> <span class="va">y_hat</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">)</span> 

  <span class="va">return_data</span> <span class="op">&lt;-</span> 
    <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>
      k <span class="op">=</span> <span class="va">fold</span>, 
      mse <span class="op">=</span> <span class="va">mse</span>
    <span class="op">)</span>

  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">return_data</span><span class="op">)</span>
<span class="op">}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This will get you MSE for the third fold.</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu">get_mse_by_fold</span><span class="op">(</span><span class="va">data</span>, <span class="fl">3</span>, <span class="va">gam_k_10</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   k      mse
1: 3 10.65129</code></pre>
</div>
</div>
<p>Now, let’s loop over the row number of <code>data_folds</code> (loop over <code>splits</code>).</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="op">(</span>
<span class="va">mse_all</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_folds</span><span class="op">)</span><span class="op">)</span>,
    <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">get_mse_by_fold</span><span class="op">(</span><span class="va">data</span>, <span class="va">x</span>, <span class="va">gam_k_10</span><span class="op">)</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   k       mse
1: 1 12.056038
2: 2  9.863496
3: 3 10.651289
4: 4 10.705704
5: 5 10.166634</code></pre>
</div>
</div>
<p>By averaging MSE values, we get</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">mse_all</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mse</span><span class="op">)</span><span class="op">]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10.68863</code></pre>
</div>
</div>
<section id="selecting-the-best-gam-specification-illustration-1" class="level3" data-number="3.3.1"><h3 data-number="3.3.1" class="anchored" data-anchor-id="selecting-the-best-gam-specification-illustration-1">
<span class="header-section-number">3.3.1</span> Selecting the best GAM specification: Illustration</h3>
<p>Just like we found the best gam specification (choice of penalization parameter), we do the same now using KCV.</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">get_mse_by_sp_kcv</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sp</span><span class="op">)</span>
<span class="op">{</span>

  <span class="va">temp_gam</span> <span class="op">&lt;-</span> <span class="fu">specify_gam</span><span class="op">(</span><span class="va">sp</span><span class="op">)</span>

  <span class="va">mse_by_k</span> <span class="op">&lt;-</span>
    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_folds</span><span class="op">)</span><span class="op">)</span>,
      <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">get_mse_by_fold</span><span class="op">(</span><span class="va">train_data</span>, <span class="va">x</span>, <span class="va">temp_gam</span><span class="op">)</span>
    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="op">)</span>

  <span class="va">return_data</span> <span class="op">&lt;-</span>
    <span class="va">mse_by_k</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="va">.</span><span class="op">[</span>, <span class="va">sp</span> <span class="op">:=</span> <span class="va">sp</span><span class="op">]</span>

  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">return_data</span><span class="op">[</span><span class="op">]</span><span class="op">)</span>
<span class="op">}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For example, the following code gets you the MSE for all the folds for <code>sp</code> <span class="math inline">\(= 3\)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu">get_mse_by_sp_kcv</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   k      mse sp
1: 1 13.56925  3
2: 2 11.22831  3
3: 3 11.45746  3
4: 4 10.48461  3
5: 5 11.29421  3</code></pre>
</div>
</div>
<p>Now, let’s loop over ten values of <code>sp</code>: 0, 0.2, 0.4, 0.6, 0.8, 1, 1.2, 1.4, 1.6, 1.8, 2.</p>
<div class="cell" data-hash="B03-cross-validation_cache/html/unnamed-chunk-57_70ab04e2771c610248ff4385b8768a93">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="op">(</span>
<span class="va">mse_results</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, by <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>,
    <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">get_mse_by_sp_kcv</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    k       mse  sp
 1: 1 12.056038 0.0
 2: 2  9.863496 0.0
 3: 3 10.651289 0.0
 4: 4 10.705704 0.0
 5: 5 10.166634 0.0
 6: 1 11.476153 0.2
 7: 2  9.840434 0.2
 8: 3  9.813155 0.2
 9: 4 10.289085 0.2
10: 5  9.895722 0.2
11: 1 11.620416 0.4
12: 2  9.882467 0.4
13: 3  9.916178 0.4
14: 4 10.239119 0.4
15: 5  9.992636 0.4
16: 1 11.785544 0.6
17: 2  9.952820 0.6
18: 3 10.033789 0.6
19: 4 10.218321 0.6
20: 5 10.090156 0.6
21: 1 11.957640 0.8
22: 2 10.040814 0.8
23: 3 10.156511 0.8
24: 4 10.211168 0.8
25: 5 10.189377 0.8
26: 1 12.130712 1.0
27: 2 10.140277 1.0
28: 3 10.281839 1.0
29: 4 10.213564 1.0
30: 5 10.290230 1.0
31: 1 12.301318 1.2
32: 2 10.246975 1.2
33: 3 10.408152 1.2
34: 4 10.223465 1.2
35: 5 10.392306 1.2
36: 1 12.467400 1.4
37: 2 10.357879 1.4
38: 3 10.534197 1.4
39: 4 10.239448 1.4
40: 5 10.495093 1.4
41: 1 12.627767 1.6
42: 2 10.470802 1.6
43: 3 10.659006 1.6
44: 4 10.260390 1.6
45: 5 10.598085 1.6
46: 1 12.781780 1.8
47: 2 10.584159 1.8
48: 3 10.781853 1.8
49: 4 10.285370 1.8
50: 5 10.700824 1.8
51: 1 12.929162 2.0
52: 2 10.696811 2.0
53: 3 10.902210 2.0
54: 4 10.313617 2.0
55: 5 10.802917 2.0
    k       mse  sp</code></pre>
</div>
</div>
<p>Let’s now get the average MSE by sp:</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="op">(</span>
<span class="va">mean_mse_data</span> <span class="op">&lt;-</span> <span class="va">mse_results</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>mean_mse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mse</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">sp</span><span class="op">]</span>
<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     sp mean_mse
 1: 0.0 10.68863
 2: 0.2 10.26291
 3: 0.4 10.33016
 4: 0.6 10.41613
 5: 0.8 10.51110
 6: 1.0 10.61132
 7: 1.2 10.71444
 8: 1.4 10.81880
 9: 1.6 10.92321
10: 1.8 11.02680
11: 2.0 11.12894</code></pre>
</div>
</div>
<div class="cell">

</div>
<p>So, according to the KCV, we should pick <code>sp</code> <span class="math inline">\(= 0.2\)</span> as the penalty parameter.</p>
<p>By the way, here is what MSE values look like for each fold based on the value of <code>sp</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">mse_results</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">mse</span>, x <span class="op">=</span> <span class="va">sp</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">k</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_discrete.html">scale_color_discrete</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">""</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="B03-cross-validation_files/figure-html/unnamed-chunk-63-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Even though we compared different specification of the same approach (GAM), we can compare across different models as well. For example, you can find KCV for an RF model with a particular specifications of its hyper-parameters and compare the KCV with those of the GAM model specifications and see what comes at the top.</p>
</div>
</div>
</section></section><section id="repeated-k-fold-cross-validation-kcv" class="level2" data-number="3.4"><h2 data-number="3.4" class="anchored" data-anchor-id="repeated-k-fold-cross-validation-kcv">
<span class="header-section-number">3.4</span> Repeated K-fold Cross-Validation (KCV)</h2>
<p>As its name suggest, repeated KCV repeats the process of KCV multiple times. Each KCV iteration splits the original data into k-fold in a different way. A single KCV may not be reliable as the original data was split into such a way that favors one parameter set of or model class over the others. However, if we repeat KCV multiple times, then we can safe-guard against this randomness in a KCV procedure. Repeated KCV is preferred over a single KCV.</p>
<p>You can use <code><a href="https://rsample.tidymodels.org/reference/vfold_cv.html">rsample::vfold_cv()</a></code> to create repeated k-fold datasets by using the <code>repeats</code> argument.</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co">#=== split into 5 groups ===#</span>
<span class="op">(</span>
<span class="va">data_folds</span> <span class="op">&lt;-</span> <span class="fu">rsample</span><span class="fu">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/vfold_cv.html">vfold_cv</a></span><span class="op">(</span><span class="va">data</span>, v <span class="op">=</span> <span class="fl">5</span>, repeats <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#  5-fold cross-validation repeated 5 times 
# A tibble: 25 × 3
   splits            id      id2  
   &lt;list&gt;            &lt;chr&gt;   &lt;chr&gt;
 1 &lt;split [400/100]&gt; Repeat1 Fold1
 2 &lt;split [400/100]&gt; Repeat1 Fold2
 3 &lt;split [400/100]&gt; Repeat1 Fold3
 4 &lt;split [400/100]&gt; Repeat1 Fold4
 5 &lt;split [400/100]&gt; Repeat1 Fold5
 6 &lt;split [400/100]&gt; Repeat2 Fold1
 7 &lt;split [400/100]&gt; Repeat2 Fold2
 8 &lt;split [400/100]&gt; Repeat2 Fold3
 9 &lt;split [400/100]&gt; Repeat2 Fold4
10 &lt;split [400/100]&gt; Repeat2 Fold5
# … with 15 more rows</code></pre>
</div>
</div>
<p>The output has 5 (number of folds) times 5 (number of repeats) splits. It also has an additional column that indicates which repeat each row is in (<code>id</code>). You can apply <code>get_mse_by_fold()</code> (this function is defined above and calculate MSE) to each row (split) one by one and calculate MSE just like we did above.</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="op">(</span>
<span class="va">mean_mse</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_folds</span><span class="op">)</span><span class="op">)</span>,
    <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">get_mse_by_fold</span><span class="op">(</span><span class="va">data</span>, <span class="va">x</span>, <span class="va">gam_k_10</span><span class="op">)</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="va">.</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mse</span><span class="op">)</span><span class="op">]</span>
<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10.65908</code></pre>
</div>
</div>
</section><section id="does-kcv-really-work" class="level2" data-number="3.5"><h2 data-number="3.5" class="anchored" data-anchor-id="does-kcv-really-work">
<span class="header-section-number">3.5</span> Does KCV really work?</h2>
<p>LOOCV and KCV use the train data to estimate test MSE. But, does it really work? In other words, does it let us pick the parameter that minimizes the test MSE? We will run a simple MC simulations to test this. We continue to use the same data generating process and gam models for this simulation as well.</p>
<p>Now, since we know the data generating process, we can actually use the following metric instead of MSE.</p>
<p><span class="math display">\[
\sum_{i=1}^N(\hat{f}(x_i) - E[y|x_i])^2
\]</span></p>
<p>This measure removes the influence of the error term that appears in the test MSE. Your objective is to minimize this measure. Of course, you cannot do this in practice because you do not observe <span class="math inline">\(E[y|x]\)</span>. Let’s call this “pure” MSE.</p>
<p>First, we define a function that gets you MSE from KCV and MSE using the test data as a function of <code>sp</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">get_mse_by_sp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sp</span><span class="op">)</span>
<span class="op">{</span>

  <span class="co">#=== generate train data and test data ===#</span>
  <span class="va">train_data</span> <span class="op">&lt;-</span> <span class="fu">gen_data</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">500</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span><span class="op">)</span>
  <span class="va">test_data</span> <span class="op">&lt;-</span> <span class="fu">gen_data</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">500</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span><span class="op">)</span>

  <span class="co">#/*----------------------------------*/</span>
  <span class="co">#' ## MSE from KCV </span>
  <span class="co">#/*----------------------------------*/</span>
  <span class="co">#=== split train_data into 5 groups ===#</span>
  <span class="va">data_folds</span> <span class="op">&lt;-</span> <span class="fu">rsample</span><span class="fu">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/vfold_cv.html">vfold_cv</a></span><span class="op">(</span><span class="va">train_data</span>, v <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
  
  <span class="co">#=== specify the model ===#</span>
  <span class="va">temp_gam</span> <span class="op">&lt;-</span> <span class="fu">specify_gam</span><span class="op">(</span><span class="va">sp</span><span class="op">)</span>

  <span class="co">#=== get MSE by fold ===#</span>
  <span class="va">mse_by_k</span> <span class="op">&lt;-</span>
    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_folds</span><span class="op">)</span><span class="op">)</span>,
      <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">get_mse_by_fold</span><span class="op">(</span><span class="va">train_data</span>, <span class="va">x</span>, <span class="va">temp_gam</span><span class="op">)</span>
    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="op">)</span>

  <span class="co">#=== find the average MSE (over folds) ===#</span>
  <span class="va">mse_kcv</span> <span class="op">&lt;-</span>
    <span class="va">mse_by_k</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="va">.</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>mse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mse</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="va">.</span><span class="op">[</span>, <span class="va">sp</span> <span class="op">:=</span> <span class="va">sp</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="va">.</span><span class="op">[</span>, <span class="va">type</span> <span class="op">:=</span> <span class="st">"KCV"</span><span class="op">]</span>

  <span class="co">#/*----------------------------------*/</span>
  <span class="co">#' ## pure MSE from the test data  </span>
  <span class="co">#/*----------------------------------*/</span>
  <span class="co">#=== train using the entire train dataset ===#</span>
  <span class="va">fitted</span> <span class="op">&lt;-</span> <span class="fu">temp_gam</span><span class="op">(</span><span class="va">train_data</span><span class="op">)</span>

  <span class="co">#=== find the average MSE (over observations) ===#</span>
  <span class="va">mse_test</span> <span class="op">&lt;-</span> 
    <span class="va">test_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="co">#=== predict y ===#</span>
    <span class="va">.</span><span class="op">[</span>, <span class="va">y_hat</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fitted</span>, newdata <span class="op">=</span> <span class="va">.</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="va">.</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>mse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">ey</span> <span class="op">-</span> <span class="va">y_hat</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="va">.</span><span class="op">[</span>, <span class="va">sp</span> <span class="op">:=</span> <span class="va">sp</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="va">.</span><span class="op">[</span>, <span class="va">type</span> <span class="op">:=</span> <span class="st">"Pure"</span><span class="op">]</span>

  <span class="co">#/*----------------------------------*/</span>
  <span class="co">#' ## Combine and return</span>
  <span class="co">#/*----------------------------------*/</span>
  <span class="va">return_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbind</a></span><span class="op">(</span><span class="va">mse_kcv</span>, <span class="va">mse_test</span><span class="op">)</span>

  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">return_data</span><span class="op">)</span>
<span class="op">}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that you do not have to use an independent test data to obtain pure MSE above even though the code does it so. You could just use the <code>train_data</code> in getting pure MSE and the results would be essentially the same.</p>
</div>
</div>
<p>For example, this will give you MSE from KCV and MSE using the test data for <code>sp</code> <span class="math inline">\(= 2\)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu">get_mse_by_sp</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          mse sp type
1: 11.0072347  2  KCV
2:  0.7131384  2 Pure</code></pre>
</div>
</div>
<p>Now, we define a function that loops over all the <code>sp</code> values we test.</p>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">sp_seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, by <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>

<span class="va">get_mse</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span>
<span class="op">{</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="co"># progress tracker</span>

  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
    <span class="va">sp_seq</span>,
    <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">get_mse_by_sp</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For example, the following gives you MSE values for all the <code>sp</code> values for a single iteration.</p>
<div class="cell">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu">get_mse</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>            mse  sp type
 1: 10.49305386 0.0  KCV
 2:  0.46854532 0.0 Pure
 3: 10.07060222 0.2  KCV
 4:  0.06385132 0.2 Pure
 5: 10.14490012 0.4  KCV
 6:  0.28102534 0.4 Pure
 7: 10.23670256 0.6  KCV
 8:  0.29782934 0.6 Pure
 9: 10.33852029 0.8  KCV
10:  0.46728439 0.8 Pure
11: 10.44652013 1.0  KCV
12:  0.78308220 1.0 Pure
13: 10.55803026 1.2  KCV
14:  0.15087488 1.2 Pure
15: 10.67109831 1.4  KCV
16:  0.64433189 1.4 Pure
17: 10.78429633 1.6  KCV
18:  0.59293569 1.6 Pure
19: 10.89658887 1.8  KCV
20:  0.86996493 1.8 Pure
21: 11.00723472 2.0  KCV
22:  0.92992710 2.0 Pure
            mse  sp type</code></pre>
</div>
</div>
<p>Finally, we run <code>get_mse()</code> 500 times.</p>
<div class="cell" data-hash="B03-cross-validation_cache/html/unnamed-chunk-77_ecc43b1f707ecafff4ffa32b9e664dcf">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">mse_results</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span>
    <span class="fl">1</span><span class="op">:</span><span class="fl">500</span>,
    <span class="va">get_mse</span>,
    mc.cores <span class="op">=</span> <span class="fl">12</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span>idcol <span class="op">=</span> <span class="st">"sim_id"</span><span class="op">)</span>

<span class="co">#=== use this if you are a Windows user ===#</span>
<span class="co"># mse_results &lt;-</span>
<span class="co">#   lapply(</span>
<span class="co">#     1:500,</span>
<span class="co">#     get_mse</span>
<span class="co">#   )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For each simulation round, let’s find the best <code>sp</code> using KCV and pure MSE.</p>
<div class="cell">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="op">(</span>
<span class="va">which_sp_optimal</span> <span class="op">&lt;-</span>
  <span class="va">mse_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="va">.</span><span class="op">[</span>, <span class="va">.SD</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.min</a></span><span class="op">(</span><span class="va">mse</span><span class="op">)</span>, <span class="op">]</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">type</span>, <span class="va">sim_id</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="co">#=== drop mse ===#</span>
  <span class="va">.</span><span class="op">[</span>, <span class="va">mse</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/dcast.data.table.html">dcast</a></span><span class="op">(</span><span class="va">sim_id</span> <span class="op">~</span> <span class="va">type</span>, value.var <span class="op">=</span> <span class="st">"sp"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="va">.</span><span class="op">[</span>, <span class="va">num_comb</span> <span class="op">:=</span> <span class="va">.N</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">KCV</span>, <span class="va">Pure</span><span class="op">)</span><span class="op">]</span>
<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For example, for the first simulation, <code>sp</code> that would have minimized pure MSE (least error relative to the true <span class="math inline">\(E[y|x]\)</span> across varying values of <span class="math inline">\(x\)</span>) was 0.2. On the other hand, if you relied on KCV, you would have chosen 0.2.</p>
<p>The following figure shows the relationship between KCV-based and pure MSE-based <code>sp</code> values.</p>
<div class="cell">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co">#=== plot the frequency of sp chosen by KCV ===#</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">which_sp_optimal</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">Pure</span>, x <span class="op">=</span> <span class="va">KCV</span>, size <span class="op">=</span> <span class="va">num_comb</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">sp_seq</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">sp_seq</span><span class="op">)</span> </code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="B03-cross-validation_files/figure-html/unnamed-chunk-81-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>As you can see KCV gives you <code>sp</code> that is close to the <code>sp</code> based on pure MSE in many cases. But, you can also see that KCV can suggest you a very different number as well. KCV is not perfect, which is kind of obvious.</p>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./B02-bias-variance-tradeoff.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Bias-variance Trade-off</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./B04-regularization.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Regression Shrinkage Methods</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>