<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.563">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Introduction to Machine Learning for Economists - 2&nbsp; Non-linear function estimation: Smoothing Splines and K-nearest neighbor regression</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./B02-bias-variance-tradeoff.html" rel="next">
<link href="./basics.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">
<span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Non-linear function estimation: Smoothing Splines and K-nearest neighbor regression</span>
</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Introduction to Machine Learning for Economists</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/tmieno2/ML-Economist" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="" title="Share" id="sidebar-tool-dropdown-0" class="sidebar-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-share"></i></a>
    <ul class="dropdown-menu" aria-labelledby="sidebar-tool-dropdown-0">
<li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=%7Curl%7C">
            <i class="bi bi-bi-twitter pe-1"></i>
          Twitter
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=%7Curl%7C">
            <i class="bi bi-bi-facebook pe-1"></i>
          Facebook
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=%7Curl%7C">
            <i class="bi bi-bi-linkedin pe-1"></i>
          LinkedIn
          </a>
        </li>
    </ul>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Welcome</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Preface: Prediction v.s. Causal Inference</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./basics.html" class="sidebar-item-text sidebar-link">Basics</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B01-gam.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Non-linear function estimation: Smoothing Splines and K-nearest neighbor regression</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B02-bias-variance-tradeoff.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Variance-Bias Trade-off</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B03-lasso.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Regression Shrinkage Methods: LASSO (Ridge and Elastic Net)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B04-cross-validation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Cross-validation based on mean squared error (MSE)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./B05-bootstrap.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Bootstrap</span></a>
  </div>
</li>
    </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./prediction-ml.html" class="sidebar-item-text sidebar-link">Prediction ML</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P01-random-forest.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Random Forest</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P02-boosted-regression-forest.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Boosted Regression Forest</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./P03-xgb.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Extreme Gradient Boosting</span></a>
  </div>
</li>
    </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./causal-ml.html" class="sidebar-item-text sidebar-link">Causal Machine Learning (CML) Methods</a>
  </div>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#flexible-functional-form-estimation" id="toc-flexible-functional-form-estimation" class="nav-link active" data-scroll-target="#flexible-functional-form-estimation"> <span class="header-section-number">2.1</span> Flexible functional form estimation</a></li>
  <li><a href="#flexible-representation-using-spline-basis-functions" id="toc-flexible-representation-using-spline-basis-functions" class="nav-link" data-scroll-target="#flexible-representation-using-spline-basis-functions"> <span class="header-section-number">2.2</span> Flexible representation using spline basis functions</a></li>
  <li><a href="#flexible-representation-using-k-nearest-neighbor" id="toc-flexible-representation-using-k-nearest-neighbor" class="nav-link" data-scroll-target="#flexible-representation-using-k-nearest-neighbor"> <span class="header-section-number">2.3</span> Flexible representation using K-nearest neighbor</a></li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/tmieno2/ML-Economist/edit/master/B01-gam.qmd" class="toc-action">Edit this page</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title d-none d-lg-block">
<span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Non-linear function estimation: Smoothing Splines and K-nearest neighbor regression</span>
</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header><p>The purpose of this section is to introduce you to the idea of semi-parametric and non-parametric regression methods. We only scratch the surface by just looking at smoothing splines and K-nearest neighbor regression methods. The world of semi-parametric and non-parametric regression is much deeper. But, that’s out of the scope of this section. The primary goal of this section is to familiarize you with the concepts of over-fitting, regularization, hyper-parameters, and parameter tuning using smoothing splines and K-nearest neighbor regression methods as examples.</p>
<section id="flexible-functional-form-estimation" class="level2" data-number="2.1"><h2 data-number="2.1" class="anchored" data-anchor-id="flexible-functional-form-estimation">
<span class="header-section-number">2.1</span> Flexible functional form estimation</h2>
<p>There are many quantitative relationship of two variables that cannot be represented easily by liner (in parameter) parametric models. For example, consider crop yield response to fertilizer. Typically, yield increases at the diminishing rate as fertilizer rate increases. However, at a high enough fertilizer rate, yield stops increasing (fertilizer is not a limiting factor at that point). This relationship is illustrated in the figure below.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">83944</span><span class="op">)</span>

<span class="co">#=== generate data ===#</span>
<span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">300</span> <span class="co"># number of observations</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">250</span>, length <span class="op">=</span> <span class="va">N</span><span class="op">)</span> 
<span class="va">y_det</span> <span class="op">&lt;-</span> <span class="fl">240</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fl">0.4</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span> <span class="fl">0.03</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="va">e</span> <span class="op">&lt;-</span> <span class="fl">50</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span> <span class="co"># error</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y_det</span> <span class="op">+</span> <span class="va">e</span>, y_det <span class="op">=</span> <span class="va">y_det</span><span class="op">)</span>

<span class="co">#=== plot ===#</span>
<span class="op">(</span>
<span class="va">g_base</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y_det</span>, x <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="B01-gam_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Let’s try to fit this data using linear parametric models with <span class="math inline">\(sqrt(x)\)</span>, <span class="math inline">\(log(x)\)</span>, and <span class="math inline">\(x + x^2\)</span>, where the dependent variable is <code>y_det</code>, which is <span class="math inline">\(E[y|x]\)</span> (no error added).</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co">#=== sqrt ===#</span>
<span class="va">lm_sq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y_det</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span>
<span class="va">data</span><span class="op">[</span>, <span class="va">y_hat_sqrt</span> <span class="op">:=</span> <span class="va">lm_sq</span><span class="op">$</span><span class="va">fit</span><span class="op">]</span>

<span class="co">#=== log ===#</span>
<span class="va">lm_log</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y_det</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span>
<span class="va">data</span><span class="op">[</span>, <span class="va">y_hat_log</span> <span class="op">:=</span> <span class="va">lm_log</span><span class="op">$</span><span class="va">fit</span><span class="op">]</span>

<span class="co">#=== quadratic ===#</span>
<span class="va">lm_quad</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y_det</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="va">x</span><span class="op">^</span><span class="fl">2</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span>
<span class="va">data</span><span class="op">[</span>, <span class="va">y_hat_quad</span> <span class="op">:=</span> <span class="va">lm_quad</span><span class="op">$</span><span class="va">fit</span><span class="op">]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">plot_data</span> <span class="op">&lt;-</span>
  <span class="fu">melt</span><span class="op">(</span><span class="va">data</span>, id.var <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="va">.</span><span class="op">[</span><span class="va">variable</span> <span class="op">!=</span> <span class="st">"y"</span>, <span class="op">]</span> <span class="op">%&gt;%</span> 
  <span class="va">.</span><span class="op">[</span>, <span class="va">fit_case</span> <span class="op">:=</span> <span class="fu">fcase</span><span class="op">(</span>
    <span class="va">variable</span> <span class="op">==</span> <span class="st">"y_det"</span>, <span class="st">"True response"</span>,
    <span class="va">variable</span> <span class="op">==</span> <span class="st">"y_hat_sqrt"</span>, <span class="st">"sqrt"</span>,
    <span class="va">variable</span> <span class="op">==</span> <span class="st">"y_hat_log"</span>, <span class="st">"log"</span>,
    <span class="va">variable</span> <span class="op">==</span> <span class="st">"y_hat_quad"</span>, <span class="st">"quadratic"</span>
  <span class="op">)</span><span class="op">]</span>

<span class="fu">ggplot</span><span class="op">(</span><span class="va">plot_data</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">value</span>, x <span class="op">=</span> <span class="va">x</span>, color <span class="op">=</span> <span class="va">fit_case</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_color_discrete</span><span class="op">(</span>name <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="B01-gam_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>None of the specifications do quite well. Indeed, you cannot represent the relationship well using well-known popular functional forms. Let’s now look at methods that are flexible enough to capture the relationship. First, smoothing splines, and then K-nearest neighbor next.</p>
</section><section id="flexible-representation-using-spline-basis-functions" class="level2 page-columns page-full" data-number="2.2"><h2 data-number="2.2" class="anchored" data-anchor-id="flexible-representation-using-spline-basis-functions">
<span class="header-section-number">2.2</span> Flexible representation using spline basis functions</h2>
<p>Detailed discussion of smoothing splines is out of the scope of this book. Only its basic ideas will be presented in this chapter. See <span class="citation" data-cites="wood2006generalized">@wood2006generalized</span> for a fuller treatment of this topic.</p>
<p>Consider a simple quantitative relationship of two variables <span class="math inline">\(y\)</span> and <span class="math inline">\(x\)</span>: <span class="math inline">\(y = f(x)\)</span>.</p>
<p><span class="math display">\[
\begin{aligned}
y = f(x)
\end{aligned}
\]</span></p>
<p>It is possible to characterize this function by using many functions in additive manner: <span class="math inline">\(b_1(x), \dots, b_K(x)\)</span>.</p>
<p><span class="math display">\[
\begin{aligned}
y = \sum_{k=1}^K \beta_k b_k(x)
\end{aligned}
\]</span></p>
<p>where <span class="math inline">\(\beta_k\)</span> is the coefficient on <span class="math inline">\(b_k(x)\)</span>.</p>
<p>Here are example of <span class="math inline">\(b_1(x), \dots, b_K(x)\)</span> may look like (1 intercept and 9 cubic spline functions).</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">basis_data</span> <span class="op">&lt;-</span>
  <span class="fu">gam</span><span class="op">(</span><span class="va">y_det</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">x</span>, k <span class="op">=</span> <span class="fl">10</span>, bs <span class="op">=</span> <span class="st">"cr"</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">.</span>, type <span class="op">=</span> <span class="st">"lpmatrix"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">data.table</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="va">.</span><span class="op">[</span>, <span class="va">x</span> <span class="op">:=</span> <span class="va">data</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span> 
  <span class="fu">melt</span><span class="op">(</span>id.var <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span>

<span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">basis_data</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">value</span>, x <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_grid</span><span class="op">(</span><span class="va">variable</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="B01-gam_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>By assigning different values to <span class="math inline">\(b_1(x), \dots, b_K(x)\)</span>, their summation can represent different functional relationships.</p>
<p>Here is what <span class="math inline">\(\sum_{k=1}^K \beta_k b_k(x)\)</span> looks like when <span class="math inline">\(\beta_1\)</span> through <span class="math inline">\(\beta_10\)</span> are all <span class="math inline">\(200\)</span>.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p><span class="math display">\[
y = \sum_{k=1}^10 200 b_k(x)
\]</span></p>
</div></div><div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu">data.table</span><span class="op">(</span>
  variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">basis_data</span><span class="op">$</span><span class="va">variable</span><span class="op">)</span>,
  coef <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">10</span><span class="op">)</span>
<span class="op">)</span> <span class="op">%&gt;%</span> 
<span class="va">.</span><span class="op">[</span><span class="va">basis_data</span>, on <span class="op">=</span> <span class="st">"variable"</span><span class="op">]</span> <span class="op">%&gt;%</span> 
<span class="va">.</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">coef</span> <span class="op">*</span> <span class="va">value</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">x</span><span class="op">]</span> <span class="op">%&gt;%</span> 
<span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">.</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">V1</span>, x <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="B01-gam_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Here is what <span class="math inline">\(\sum_{k=1}^K \beta_k b_k(x)\)</span> looks like when <span class="math inline">\(\beta_1\)</span> through <span class="math inline">\(\beta_4\)</span> are all <span class="math inline">\(50\)</span> and <span class="math inline">\(\beta_5\)</span> through <span class="math inline">\(\beta_9\)</span> are all <span class="math inline">\(200\)</span>.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p><span class="math display">\[
y = \sum_{k=1}^5 50 b_k(x) + \sum_{k=6}^10 200 b_k(x)
\]</span></p>
</div></div><div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu">data.table</span><span class="op">(</span>
  variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">basis_data</span><span class="op">$</span><span class="va">variable</span><span class="op">)</span>,
  coef <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span> <span class="op">%&gt;%</span> 
<span class="va">.</span><span class="op">[</span><span class="va">basis_data</span>, on <span class="op">=</span> <span class="st">"variable"</span><span class="op">]</span> <span class="op">%&gt;%</span> 
<span class="va">.</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">coef</span> <span class="op">*</span> <span class="va">value</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">x</span><span class="op">]</span> <span class="op">%&gt;%</span> 
<span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">.</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">V1</span>, x <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="B01-gam_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>In practice, we fit the model to a dataset to find coefficient estimates that fit the data well. Here, we use the <code>gam()</code> function from the <code>mgcv</code> package. Note that, we use <span class="math inline">\(E[y|x]\)</span> (<code>y_det</code>) as the dependent variable to demonstrate the ability of smoothing splines to imitate the true function.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p><code>gam</code> stands for <span style="color:red"> G</span>eneralized <span style="color:red">A</span>dditive <span style="color:red">M</span>odel. It is a much wider class of model than our examples in this section. See <span class="citation" data-cites="wood2006generalized">@wood2006generalized</span> for more details.</p>
</div></div><div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">gam_fit</span> <span class="op">&lt;-</span> <span class="fu">gam</span><span class="op">(</span><span class="va">y_det</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">x</span>, k <span class="op">=</span> <span class="fl">10</span>, bs <span class="op">=</span> <span class="st">"cr"</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>s(x, k = 10, bs = "cr")</code> in the regression formula tells <code>gam()</code> to use 10 knots, which results in an intercept and nine spline basis functions. <code>bs = "cr"</code> tells <code>gam()</code> to use cubic spline basis functions.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>There are many other spline basis options offered by the <code>mgcv</code> package. Interested readers are referred to <span class="citation" data-cites="wood2006generalized">@wood2006generalized</span>.</p>
</div></div><p>Here are the coefficient estimates:</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">gam_fit</span><span class="op">$</span><span class="va">coefficient</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)      s(x).1      s(x).2      s(x).3      s(x).4      s(x).5 
 227.421061   -1.486636   16.747228   28.309674   32.115070   34.173085 
     s(x).6      s(x).7      s(x).8      s(x).9 
  35.178339   34.541380   38.586536   21.979396 </code></pre>
</div>
</div>
<p>This translate into the following fitted curve.</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu">data.table</span><span class="op">(</span>
  variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">basis_data</span><span class="op">$</span><span class="va">variable</span><span class="op">)</span>,
  coef <span class="op">=</span> <span class="va">gam_fit</span><span class="op">$</span><span class="va">coefficient</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>
<span class="op">)</span> <span class="op">%&gt;%</span> 
<span class="va">.</span><span class="op">[</span><span class="va">basis_data</span>, on <span class="op">=</span> <span class="st">"variable"</span><span class="op">]</span> <span class="op">%&gt;%</span> 
<span class="va">.</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>y_no_int <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">coef</span> <span class="op">*</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">x</span><span class="op">]</span> <span class="op">%&gt;%</span> 
<span class="va">.</span><span class="op">[</span>, <span class="va">y_hat</span> <span class="op">:=</span> <span class="va">gam_fit</span><span class="op">$</span><span class="va">coefficient</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">y_no_int</span><span class="op">]</span> <span class="op">%&gt;%</span> 
<span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">.</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y_hat</span>, x <span class="op">=</span> <span class="va">x</span>, color <span class="op">=</span> <span class="st">"gam-fitted"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>, <span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y_det</span>, x <span class="op">=</span> <span class="va">x</span>, color <span class="op">=</span> <span class="st">"True"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>
    name <span class="op">=</span> <span class="st">""</span>,
    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gam-fitted"</span> <span class="op">=</span> <span class="st">"red"</span>, <span class="st">"True"</span> <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">ylab</span><span class="op">(</span><span class="st">"y"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">xlab</span><span class="op">(</span><span class="st">"x"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>Warning in as.data.table.list(x, keep.rownames = keep.rownames, check.names
= check.names, : Item 2 has 9 rows but longest item has 10; recycled with
remainder.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="B01-gam_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>As you can see, the trained model is almost perfect in representing the functional relationship of <span class="math inline">\(y\)</span> and <span class="math inline">\(x\)</span>.</p>
<p>Now, when <code>gam()</code> fits a model to a dataset, it penalizes the wiggliness (how wavy the curve is) of the estimated function to safe-guard against fitting the model too well to the data. Specifically, it finds coefficients that minimizes the sum of the squared residuals (for regression) plus an additional term that captures how wavy the resulting function is.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>Here is an example of wiggly (first) v.s. smooth (second) functions.</p>
<div class="cell">
<details><summary>Code</summary><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">gam_fit_wiggly</span> <span class="op">&lt;-</span> <span class="fu">gam</span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">x</span>, k <span class="op">=</span> <span class="fl">40</span>, bs <span class="op">=</span> <span class="st">"cr"</span>, sp <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">gam_fit_wiggly</span>, se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="B01-gam_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid" width="672"></p>
</div>
<details><summary>Code</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">gam_fit_smooth</span> <span class="op">&lt;-</span> <span class="fu">gam</span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">x</span>, k <span class="op">=</span> <span class="fl">5</span>, bs <span class="op">=</span> <span class="st">"cr"</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">gam_fit_smooth</span>, se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="B01-gam_files/figure-html/unnamed-chunk-22-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</div></div><p><span class="math display">\[
\begin{aligned}
Min_{\hat{f}(x)} \sum_{i=1}^N(y_i - \hat{f}(x_i))^2 + \lambda \Omega(\hat{f}(x))
\end{aligned}
\]</span></p>
<p>where <span class="math inline">\(\Omega(\hat{f}(x)) &gt; 0\)</span> is a function that captures how wavy the resulting function is. It takes a higher value when <span class="math inline">\(\hat{f}(x)\)</span> is more wiggly. <span class="math inline">\(\lambda &gt; 0\)</span> is the penalization parameter. As <span class="math inline">\(\lambda\)</span> gets larger, a greater penalty on the wiggliness of <span class="math inline">\(\hat{f}(x)\)</span>, thus resulting in a smoother curve.</p>
<p>You can specify <span class="math inline">\(\lambda\)</span> by <code>sp</code> parameter in <code>gam()</code>. When <code>sp</code> is not specified by the user, <code>gam()</code> finds the optimal value of <code>sp</code> internally using cross-validation (cross-validation will be introduce formally in <a href="#sec-cross-validation"><span class="quarto-unresolved-ref">sec-cross-validation</span></a>). For now, just consider it as a method to find parameters that make the trained model a good representation of the underlying conditional mean function (<span class="math inline">\(E[y|x]\)</span>).</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>More specifically, it uses generalized cross-validation (GCV). A special type of cross-validation that can be done when the model is linear in parameter.</p>
</div></div><p>If you do not pick the value of <code>sp</code> well, the estimated curve will be very wiggly. Let’s see an example by setting the value of <code>sp</code> to 0, meaning no punishment for being very wiggly. We also set the number of splines to <span class="math inline">\(39\)</span> so that <span class="math inline">\(\sum_{k=1}^K \beta_k b_k(x)\)</span> is <span style="color:red"> very </span>flexible.</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co">#=== fit ===#</span>
<span class="va">gam_fit_wiggly</span> <span class="op">&lt;-</span> <span class="fu">gam</span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">x</span>, k <span class="op">=</span> <span class="fl">40</span>, bs <span class="op">=</span> <span class="st">"cr"</span>, sp <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span>

<span class="co">#=== assign the fitted values to a variable ===#</span>
<span class="va">data</span><span class="op">[</span>, <span class="va">y_hat</span> <span class="op">:=</span> <span class="va">gam_fit_wiggly</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">]</span>

<span class="co">#=== plot ===#</span>
<span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y_hat</span>, x <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span>, x <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="B01-gam_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We call this phenomenon over-fitting (of the data by the model). An over-fitted model does well in predicting <span class="math inline">\(y\)</span> when applied to the data the model used to train itself. However, it would do a terrible job in prediction on the data it has never seen clearly because it is not predicting <span class="math inline">\(E[y|x]\)</span> well.</p>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>
<span style="color:red"> Hyper-parameter</span>: parameters that one needs to specify <span style="color:red"> before</span> fitting the model and affect the fitting process in ways that change the outcome of the fitting.</li>
<li>
<span style="color:red"> Parameter tuning</span>: process that attempts to find the optimal set of hyper-parameters.</li>
</ul>
</div>
</div>
<p>In <code><a href="https://rdrr.io/pkg/mgcv/man/gam.html">mgcv::gam()</a></code>, the hyper-parameters are the penalty parameter <span class="math inline">\(\lambda\)</span> (specified by. <code>sp</code>), the number of knots (specified by <code>k</code>)<span class="math inline">\(^1\)</span>, the type of splines (specified by <code>bs</code>). Coefficient estimates (<span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\beta_1, \dots, \beta_K\)</span>) change when the value of <code>sp</code> is altered. Here is what happens when <code>k</code> <span class="math inline">\(= 3\)</span> (less flexible than the <code>k</code> <span class="math inline">\(= 39\)</span> case above).</p>

<div class="no-row-height column-margin column-container"><div class="">
<p><span class="math inline">\(^1\)</span> or more precisely, how many knots and where to place them</p>
</div></div><div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co">#=== fit ===#</span>
<span class="va">gam_fit_wiggly</span> <span class="op">&lt;-</span> <span class="fu">gam</span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">x</span>, k <span class="op">=</span> <span class="fl">3</span>, bs <span class="op">=</span> <span class="st">"cr"</span>, sp <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span>

<span class="co">#=== assign the fitted values to a variable ===#</span>
<span class="va">data</span><span class="op">[</span>, <span class="va">y_hat</span> <span class="op">:=</span> <span class="va">gam_fit_wiggly</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">]</span>

<span class="co">#=== plot ===#</span>
<span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y_hat</span>, x <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span>, x <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="B01-gam_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Hyper-parameters can significantly influence the outcome. Since the user get to pick any numbers, it can be potentially used to twist the results in a way that favors the outcomes they want to have. Therefore, it is important to pick the values of hyper-parameters wisely. One way of achieving the goal is cross-validation, which is a data-driven way to finding the best value of hyper-parameters. We will discuss cross-validation in <a href="#sec-cv"><span class="quarto-unresolved-ref">sec-cv</span></a> in detail.</p>
<p>Here is the fitted curve when the optimal value of <code>sp</code> is picked given <code>k = 40</code> and <code>bs = "cr"</code> using cross-validation.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>That is, we are not tuning <code>k</code> and <code>bs</code> here.</p>
</div></div><div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co">#=== fit ===#</span>
<span class="va">gam_fit_cved</span> <span class="op">&lt;-</span> <span class="fu">gam</span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">x</span>, k <span class="op">=</span> <span class="fl">40</span>, bs <span class="op">=</span> <span class="st">"cr"</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span>

<span class="co">#=== assign the fitted values to a variable ===#</span>
<span class="va">data</span><span class="op">[</span>, <span class="va">y_hat</span> <span class="op">:=</span> <span class="va">gam_fit_cved</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">]</span>

<span class="co">#=== plot ===#</span>
<span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y_hat</span>, x <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span>, x <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="B01-gam_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>You can see that the tuning of <code>sp</code> is successful and has resulted in a much better fitted curve compared to the case where <code>sp</code> was forced to be 0. As you will see, hyper-parameter tuning will be critical for many of the machine learning methods we will look at later.</p>
</section><section id="flexible-representation-using-k-nearest-neighbor" class="level2" data-number="2.3"><h2 data-number="2.3" class="anchored" data-anchor-id="flexible-representation-using-k-nearest-neighbor">
<span class="header-section-number">2.3</span> Flexible representation using K-nearest neighbor</h2>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./basics.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Basics</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./B02-bias-variance-tradeoff.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Variance-Bias Trade-off</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>